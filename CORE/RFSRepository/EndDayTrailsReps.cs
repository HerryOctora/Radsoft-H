using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data;
using RFSModel;
using RFSUtility;
using System.Data.SqlClient;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.IO;
using System.Drawing;
using RFSRepository;
using RFSRepositoryOne;


namespace RFSRepository
{
    public class EndDayTrailsReps
    {
        Host _host = new Host();

        //1
        string _insertCommand = "INSERT INTO [dbo].[EndDayTrails] " +
                            "([EndDayTrailsPK],[HistoryPK],[Status],[BitValidate],[ValueDate],[LogMessages],";
        string _paramaterCommand = "@BitValidate,@ValueDate,@LogMessages,";

        //2
        private EndDayTrails setEndDayTrails(SqlDataReader dr)
        {
            EndDayTrails M_EndDayTrails = new EndDayTrails();
            M_EndDayTrails.EndDayTrailsPK = Convert.ToInt32(dr["EndDayTrailsPK"]);
            M_EndDayTrails.HistoryPK = Convert.ToInt32(dr["HistoryPK"]);
            M_EndDayTrails.Status = Convert.ToInt32(dr["Status"]);
            M_EndDayTrails.StatusDesc = Convert.ToString(dr["StatusDesc"]);
            M_EndDayTrails.Notes = Convert.ToString(dr["Notes"]);
            M_EndDayTrails.BitValidate = Convert.ToBoolean(dr["BitValidate"]);
            M_EndDayTrails.ValueDate = dr["ValueDate"].ToString();
            M_EndDayTrails.LogMessages = dr["LogMessages"].ToString();
            M_EndDayTrails.EntryUsersID = dr["EntryUsersID"].ToString();
            M_EndDayTrails.ApprovedUsersID = dr["ApprovedUsersID"].ToString();
            M_EndDayTrails.VoidUsersID = dr["VoidUsersID"].ToString();
            M_EndDayTrails.EntryTime = dr["EntryTime"].ToString();
            M_EndDayTrails.ApprovedTime = dr["ApprovedTime"].ToString();
            M_EndDayTrails.VoidTime = dr["VoidTime"].ToString();
            M_EndDayTrails.DBUserID = dr["DBUserID"].ToString();
            M_EndDayTrails.DBTerminalID = dr["DBTerminalID"].ToString();
            M_EndDayTrails.LastUpdate = dr["LastUpdate"].ToString();
            M_EndDayTrails.LastUpdateDB = dr["LastUpdateDB"].Equals(DBNull.Value) == true ? "" : Convert.ToString(dr["LastUpdateDB"]);
            return M_EndDayTrails;
        }

        //3
        public List<EndDayTrails> EndDayTrails_Select(int _status)
        {
            try
            {
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {

                    DbCon.Open();
                    List<EndDayTrails> L_EndDayTrails = new List<EndDayTrails>();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {


                        if (_status != 9)
                        {
                            cmd.CommandText = "Select case when status=1 then 'PENDING' else Case When status = 2 then 'APPROVED' else Case when Status = 3 then 'VOID' else 'WAITING' END END END StatusDesc,* from EndDayTrails where status = @status";
                            cmd.Parameters.AddWithValue("@status", _status);
                        }
                        else
                        {
                            cmd.CommandText = "Select case when status=1 then 'PENDING' else Case When status = 2 then 'APPROVED' else Case when Status = 3 then 'VOID' else 'WAITING' END END END StatusDesc,* from EndDayTrails";
                        }
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                while (dr.Read())
                                {
                                    L_EndDayTrails.Add(setEndDayTrails(dr));
                                }
                            }
                            return L_EndDayTrails;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public List<EndDayTrails> EndDayTrails_SelectEndDayTrailsDate(int _status, DateTime _date)
        {

            try
            {
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    List<EndDayTrails> L_EndDayTrails = new List<EndDayTrails>();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        if (_status != 9)
                        {
                            cmd.CommandText = "Select case when status=1 then 'PENDING' else Case When status = 2 then 'APPROVED' else Case when Status = 3 then 'VOID' else 'WAITING' END END END StatusDesc,* from EndDayTrails where status = @status and ValueDate = @Date";
                        }
                        else
                        {
                            cmd.CommandText = "Select case when status=1 then 'PENDING' else Case When status = 2 then 'APPROVED' else Case when Status = 3 then 'VOID' else 'WAITING' END END END StatusDesc,* from EndDayTrails where  ValueDate = @Date";
                        }
                  
                        cmd.Parameters.AddWithValue("@Status", _status);
                        cmd.Parameters.AddWithValue("@Date", _date);

                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                while (dr.Read())
                                {
                                    L_EndDayTrails.Add(setEndDayTrails(dr));
                                }
                            }
                            return L_EndDayTrails;
                        }
                    }
                }

            }
            catch (Exception err)
            {
                throw err;
            }

        }

        //5
        public void EndDayTrails_Add(EndDayTrails _EndDayTrails, bool _havePrivillege)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        if (_havePrivillege)
                        {
                            cmd.CommandText = _insertCommand + "[EntryUsersID],[EntryTime],[ApprovedUsersID],[ApprovedTime],[LastUpdate])" +
                                 "Select isnull(max(EndDayTrailsPk),0) + 1,1,@status," + _paramaterCommand + "@EntryUsersID,@EntryTime,@ApprovedUsersID,@ApprovedTime,@LastUpdate from EndDayTrails";
                            cmd.Parameters.AddWithValue("@ApprovedUsersID", _EndDayTrails.EntryUsersID);
                            cmd.Parameters.AddWithValue("@ApprovedTime", _dateTimeNow);

                        }
                        else
                        {
                            cmd.CommandText = _insertCommand + "[EntryUsersID],[EntryTime],[LastUpdate])" +
                                "Select isnull(max(EndDayTrailsPk),0) + 1,1,@status," + _paramaterCommand + "@EntryUsersID,@EntryTime,@LastUpdate from EndDayTrails";
                        }
                        cmd.Parameters.AddWithValue("@status", _havePrivillege ? 2 : 1);
                        cmd.Parameters.AddWithValue("@BitValidate", _EndDayTrails.BitValidate);
                        cmd.Parameters.AddWithValue("@ValueDate", _EndDayTrails.ValueDate);
                        cmd.Parameters.AddWithValue("@LogMessages", _EndDayTrails.LogMessages);
                        cmd.Parameters.AddWithValue("@EntryUsersID", _EndDayTrails.EntryUsersID);
                        cmd.Parameters.AddWithValue("@EntryTime", _dateTimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _dateTimeNow);

                        cmd.ExecuteNonQuery();
                    }


                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        //7
        public void EndDayTrails_Approved(EndDayTrails _EndDayTrails)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandText = "update EndDayTrails set status = 2,ApprovedUsersID = @ApprovedUsersID,ApprovedTime = @ApprovedTime,LastUpdate=@LastUpdate " +
                            "where EndDayTrailsPK = @PK and historypk = @historyPK and BitValidate = 1 \n " +
                            "Update FundPosition set status = 2,ApprovedUsersID = @ApprovedUsersID,ApprovedTime = @ApprovedTime,LastUpdate=@LastUpdate where TrailsPK = @PK and status = 1 " +
                            "Update FundJournal set status = 2,ApprovedUsersID = @ApprovedUsersID,ApprovedTime = @ApprovedTime,LastUpdate=@LastUpdate , posted= 1,postedby = @ApprovedUsersID,PostedTime = @ApprovedTime where TrxNo = @PK and status = 1 " ;

                        cmd.Parameters.AddWithValue("@PK", _EndDayTrails.EndDayTrailsPK);
                        cmd.Parameters.AddWithValue("@historyPK", _EndDayTrails.HistoryPK);
                        cmd.Parameters.AddWithValue("@ApprovedUsersID", _EndDayTrails.ApprovedUsersID);
                        cmd.Parameters.AddWithValue("@ApprovedTime", _dateTimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _dateTimeNow);
                        cmd.ExecuteNonQuery();
                    }
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandText = "Update EndDayTrails set status= 3,VoidUsersID=@VoidUsersID,VoidTime=@VoidTime,LastUpdate=@LastUpdate where EndDayTrailsPK = @PK and status = 4";
                        cmd.Parameters.AddWithValue("@PK", _EndDayTrails.EndDayTrailsPK);
                        cmd.Parameters.AddWithValue("@VoidUsersID", _EndDayTrails.ApprovedUsersID);
                        cmd.Parameters.AddWithValue("@VoidTime", _dateTimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _dateTimeNow);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        //8
        public void EndDayTrails_Reject(EndDayTrails _EndDayTrails)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandText = @"
                         update EndDayTrails set status = 3,VoidUsersID = @VoidUsersID,VoidTime = @VoidTime,LastUpdate=@lastUpdate    
                         where EndDayTrailsPK = @PK and historypk = @historyPK  

                        --  Delete FundClientPosition where Date = dbo.FWorkingDay(@ValueDate,1)

                         Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2
                         update CloseNav set status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 
                         where Date = @ValueDate and status not in (3,4)      

                         update FundJournal set Posted = 0,Status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 			
                         where ValueDate >= @ValueDate and TrxNo = @PK and Type not in (1,11) and Status = 1  and TrxName <> 'SUBSCRIPTION'          

                        ";
                        cmd.Parameters.AddWithValue("@PK", _EndDayTrails.EndDayTrailsPK);
                        cmd.Parameters.AddWithValue("@historyPK", _EndDayTrails.HistoryPK);
                        cmd.Parameters.AddWithValue("@ValueDate", _EndDayTrails.ValueDate);
                        cmd.Parameters.AddWithValue("@VoidUsersID", _EndDayTrails.VoidUsersID);
                        cmd.Parameters.AddWithValue("@VoidTime", _dateTimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _dateTimeNow);
                        cmd.ExecuteNonQuery();
                    }

                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public void EndDayTrails_Void(EndDayTrails _EndDayTrails)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        if (Tools.ClientCode == "10")
                        {
                            cmd.CommandText = @"
                         update EndDayTrails set status = 3,VoidUsersID = @VoidUsersID,VoidTime = @VoidTime,LastUpdate=@lastUpdate    
                         where EndDayTrailsPK = @PK and historypk = @historyPK      
                         
                         --  Delete FundClientPosition where Date = dbo.FWorkingDay(@ValueDate,1)
                         
                         Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2
 
                         update FundJournal set Posted = 0,Status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 			
                         where ValueDate >= @ValueDate  and TrxNo = @PK and Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION'
                         
                         --update CloseNav set status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 
                         --where Date = @ValueDate and status <> 3

                        ";
                        }
                        else if (Tools.ClientCode == "11")
                        {
                            cmd.CommandText = @"
                         update EndDayTrails set status = 3,VoidUsersID = @VoidUsersID,VoidTime = @VoidTime,LastUpdate=@lastUpdate    
                         where EndDayTrailsPK = @PK and historypk = @historyPK      
                         
                       --  Delete FundClientPosition where Date = dbo.FWorkingDay(@ValueDate,1)
                         
                         Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2
 
                         update FundJournal set Posted = 0,Status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 			
                         where  TrxNo = @PK and Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION'
                         
                         update CloseNav set status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 
                         where Date = @ValueDate and status <> 3
                        ";
                        }
                        else if (Tools.ClientCode == "02" || Tools.ClientCode == "03" || Tools.ClientCode == "21")
                        {
                            cmd.CommandText = @"

                         declare @FundPK int
                         select @FundPK = FundPK from EndDayTrails where EndDayTrailsPK = @PK and historypk = @historyPK 

                         update EndDayTrails set status = 3,VoidUsersID = @VoidUsersID,VoidTime = @VoidTime,LastUpdate=@lastUpdate    
                         where EndDayTrailsPK = @PK and historypk = @historyPK      
                         
                        --  Delete FundClientPosition where Date = dbo.FWorkingDay(@ValueDate,1)
                         
                         Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2 and FundPK = @FundPK
 
                         update FundJournal set Posted = 0,Status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 			
                         where ValueDate >= @ValueDate  and TrxNo = @PK and Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION'
                         
                         update CloseNav set status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 
                         where Date = @ValueDate and status <> 3 and FundPK = @FundPK
                        ";
                        }

                        else
                        {
                            cmd.CommandText = @"
                         update EndDayTrails set status = 3,VoidUsersID = @VoidUsersID,VoidTime = @VoidTime,LastUpdate=@lastUpdate    
                         where EndDayTrailsPK = @PK and historypk = @historyPK      
                         
                       --  Delete FundClientPosition where Date = dbo.FWorkingDay(@ValueDate,1)
                         
                         Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2
 
                         update FundJournal set Posted = 0,Status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 			
                         where ValueDate >= @ValueDate  and TrxNo = @PK and Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION'
                         
                         update CloseNav set status = 3,VoidUsersID = @VoidUsersID ,VoidTime= @VoidTime, LastUpdate = @LastUpdate 
                         where Date = @ValueDate and status <> 3
                        ";
                        }


                        cmd.Parameters.AddWithValue("@PK", _EndDayTrails.EndDayTrailsPK);
                        cmd.Parameters.AddWithValue("@historyPK", _EndDayTrails.HistoryPK);
                        cmd.Parameters.AddWithValue("@ValueDate", _EndDayTrails.ValueDate);
                        cmd.Parameters.AddWithValue("@VoidUsersID", _EndDayTrails.VoidUsersID);
                        cmd.Parameters.AddWithValue("@VoidTime", _dateTimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _dateTimeNow);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        //7
        public string EndDayTrails_ApproveByDate(string _usersID, DateTime _date)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandText = "update EndDayTrails set status = 2, ApprovedUsersID = @ApprovedUsersID, ApprovedTime = @ApprovedTime, LastUpdate = @LastUpdate " +
                            "where Status not in (2, 3, 4) and ValueDate = @Date and BitValidate = 1";
                        cmd.Parameters.AddWithValue("@Date", _date);
                        cmd.Parameters.AddWithValue("@ApprovedUsersID", _usersID);
                        cmd.Parameters.AddWithValue("@ApprovedTime", _datetimeNow);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.ExecuteNonQuery();

                        return "Success";
                    }
                }
            }
            catch (Exception err)
            {
                return err.Message.ToString();
                throw err;
            }

        }

        public int EndDayTrails_Generate(string _usersID, DateTime _valueDate)
        {
            try
            {

                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  
Declare @BDateFrom datetime
Declare @BTotalDays int

select @BDateFrom = DateFrom from Period where @ValueDate between DateFrom and DateTo and status = 2
select @BTotalDays = datediff(Day,@BDateFrom,dateadd(year,1,@BDateFrom))


Declare @MSG nvarchar (Max)   
Declare @PeriodPK int                  
Declare @maxEndDayTrailsPK int    
Declare @DateYesterday datetime 
Declare @DefaultCashAtBankPK int


set @DefaultCashAtBankPK = 3

Select  @DateYesterday  = ValueDate From enddaytrails
where status = 2 and valuedate =(
Select Max(valueDate) From EnddayTrails where status = 2 and ValueDate < @ValueDate
)


Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                
Select @maxEndDayTrailsPK = ISNULL(EndDayTrailsPK,0) + 1 from EndDayTrails     

set @maxEndDayTrailsPK = isnull(@maxEndDayTrailsPK,1)               

Create Table #Mature
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Create Table #RecCoupon
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),LastCouponDate datetime,NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Insert into EndDayTrails(EndDayTrailsPK,HistoryPK,Status,ValueDate,BitValidate,LogMessages
,EntryUsersID,EntryTime,LastUpdate)                    
Select @maxEndDayTrailsPK,1,1,@ValueDate,0,'',@UsersID,@LastUpdate,@LastUpdate  

---- NEW -----
if Not Exists(              
Select * from CloseNAV where Status = 2 and date = @DateYesterday             
)              
BEGIN              
Set @MSG = 'MISSING DATA: Close NAV Yesterday'              
Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1               
Select @maxEndDayTrailsPK LastPK                   
RETURN;                   
END              

--if Not Exists(              
--Select * from ClosePrice where Status = 2 and date = @ValueDate              
--)              
--BEGIN              
--Set @MSG = 'MISSING DATA: Close Price Today'              
--Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1               
--Select @maxEndDayTrailsPK LastPK                   
--RETURN;                   
--END    

-- Parameter untuk masuk Ke Jurnal                  
Declare @InvestmentAcc   int                  
Declare @PayablePurchaseAcc  int                  
Declare @CashAtBankAcc   int                  
Declare @CommissionAcc   int                  
Declare @LevyAcc    int                  
Declare @VatAcc     int                  
Declare @WhtAcc     int                  
                
Declare @TaxExpenseAcc   int                  
Declare @WHTTaxPayableAccrInterest int     
Declare @InterestRecAcc int 
--BOND
Declare @InvestmentAccBond   int 
Declare @InterestRecBuySellAccBond int      
Declare @InterestRecAccBond   int 
Declare @RealisedAccBond int   
Declare @ReceivableSaleAccBond int 
Declare @TaxCapitalGainAccBond int 
Declare @TaxInterestAccBond int 

-- Sell              
Declare @ReceivableSaleAcc int              
Declare @RealisedAcc int              
Declare @IncomeSaleTaxAcc int                 
-- Untuk variabel Posting                  
Declare @PValueDate        datetime                  
Declare @PPeriodPK        int                  
Declare @PReference        nvarchar(50)                  
Declare @PTrxType        int                
Declare @PCounterpartPK       int                  
Declare @PInstrumentPK       int                  
Declare @PInstrumentTypePK      int                  
Declare @PFundPK        int                  
Declare @PFundCashRefPK       int                  
Declare @PDoneAccruedInterest  Numeric(18,6)                  
Declare @PSettlementDate      Datetime       
Declare @PAcqDate      Datetime            
Declare @PDoneVolume       numeric(18,6)   
Declare @PAmount       numeric(18,6)               
Declare @PDoneAmount       numeric(18,6)                  
Declare @PCommissionAmount      numeric(18,6)                  
Declare @PLevyAmount       numeric(18,6)                  
Declare @PKPEIAmount       numeric(18,6)                  
Declare @PVATAmount        numeric(18,6)                  
Declare @PWHTAmount        numeric(18,6)                  
Declare @POTCAmount        numeric(18,6)                   
Declare @PIncomeTaxSellAmount     numeric(18,6)                   
Declare @PIncomeTaxInterestAmount    numeric(18,6)                   
Declare @PIncomeTaxGainAmount     numeric(18,6) 
Declare @PTotalAmount       numeric(19,6)                   
Declare @PCurrencyRate       numeric(18,8)                  
Declare @InstrumentType int                  
Declare @FundJournalPK int                  
Declare @InstrumentID nvarchar(30)                  
Declare @FPayablePurchaseAmount numeric(19,6)                  
Declare @InstrumentCurrencyPK int     
Declare @BondDayAccrued int      
Declare @PInterestPercent Numeric(22,6)          

Declare @SellAvgPrice numeric(18,6)  
Declare @SellArAmount numeric(22,6) 
Declare @AvgAmount numeric(22,6)              
Declare @RealisedAmount numeric(22,6)
Declare @InvestmentShareAmount numeric(22,6)   
Declare @ReceivableSellBondAmount numeric(22,6)    

Declare @PTaxExpenseAmount numeric(22,6) 
Declare @PTaxExpensePercent numeric(22,6) 
Declare @PInterestAmount numeric(22,6) 
Declare @PFinalAmount numeric(22,6)
     
Declare @WHTDueDate int

-- REKSADANA
Declare @ReksadanaTypePK int
Declare @CashForMutualFund int
Declare @MInterestAmount numeric(18,4)
Declare @BDate datetime
Declare @InterestReceivableSellMutualFund int
Declare @InvestmentMutualFundAmount numeric(18,4)
               
-- A. Posting Investment   
-- 1. BUY EQUITY --  
-- 2. SELL EQUITY --
-- 3. BUY BOND -- 
-- 4. SELL BOND -- 
-- 5. PLACEMENT DEPOSITO -- 
-- 6. LIQUIDATE DEPOSITO -- 
-- 7. ROLLOVER DEPOSITO -- 


-- B. Daily Fee dan Payment Fee 	 	            
-- 1. GENERATE DAILY FEE --    
-- 2. PAYMENT FEE -- 
-- 3. BANK INTEREST --
	                       
-- C. Reval, Interest Accrued Bond, Interest Accrued Time Deposit, Mature Bond, Mature Time Deposit
-- 1. REVALUATION EQUITY & BOND --   
-- 2. GENERATE INTEREST ACCRUED BOND           
-- 3. MATURE TIME DEPOSIT YANG BELOM SAMPE UJUNG           
-- 4. MATURE BOND & TIME DEPOSIT
-- 5. REC COUPON BOND
	
-- D. Copy Fund Client Position 

-- E. Pending Subscription

-- A. POSTING INVESTMENT --        

Declare @PBreakInterestPercent numeric(8,4)
Declare @PSettlementPK int

Declare A Cursor For                  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                   
FundPK,FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,Amount,DoneAmount,                  
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                  
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate            
From Investment         
Where StatusSettlement = 2 and Posted = 0 and Valuedate in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday)  and InstrumentTypePK <> 6

UNION ALL -- REKSADANA
  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                     
FundPK,case when FundCashRefPK = 0 then 3 else FundCashRefPK end FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,DoneAmount,isnull(DoneAmount,0),                    
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                    
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate             
From Investment           
Where StatusInvestment = 2 and StatusDealing <> 3 and StatusSettlement <> 3 and Valuedate = @ValueDate 
and InstrumentTypePK = 6
       
Open A                  
Fetch Next From A                  
Into @PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,
@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount
,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount
,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,@PBreakInterestPercent,@PSettlementPK ,@PTaxExpensePercent,@PInterestPercent,@PAcqDate             
While @@FETCH_STATUS = 0                  
Begin                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK              
-- 1 = REGULER                  
-- 2 = G-BOND                  
-- 3 = C-BOND                  
-- 4 = RI                  
-- 5 = DEPOSITO                  
-- 6 = WARRANT 
                
-- A1. BUY EQUITY --    
Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2               
if @PTrxType = 1 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentEquity,@PayablePurchaseAcc = PayablePurchaseEquity 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 EQUITY BUY: ' + @InstrumentID 
,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled EQUITY BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A2. SELL EQUITY --        
Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2        
if @PTrxType = 2 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentEquity,@ReceivableSaleAcc = AccountReceivableSaleEquity,@RealisedAcc = RealisedEquity From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 EQUITY SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             


    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED EQUITY SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

-- A3. BUY BOND --                  
if @PTrxType = 1 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15)                 
BEGIN  
              
-- 2 = G-BOND                  
-- 3 = C-BOND                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                                           

if @InstrumentType in (2,3,8,9,11,13,14,15)          
BEGIN                  
Select @InvestmentAcc = InvestmentBond,@InterestRecAcc = InterestRecBond,@PayablePurchaseAcc = PayablePurRecBond, 
@WHTTaxPayableAccrInterest = WHTTaxPayableAccrInterestBond,@BondDayAccrued = InterestAccrBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                   
END                  
                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
	
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,2,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,3,1,2,@WHTTaxPayableAccrInterest,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,                
0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,1,0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WHTTaxPayableAccrInterest and Status = 2                  

set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PDoneAccruedInterest,0) - isnull(@PIncomeTaxGainAmount,0) 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

-- T Settled                
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
	
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PTotalAmount,                   
@PTotalAmount,0,1,@PTotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,3,1,2,@BondDayAccrued,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BondDayAccrued and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                  
END                  


-- A4.SELL BOND --
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15) 
BEGIN               
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
Select @InvestmentAccBond = InvestmentBond,@InterestRecBuySellAccBond = InterestRecBond,@InterestRecAccBond = InterestAccrBond,
@RealisedAccBond = RealisedBond, @ReceivableSaleAccBond = AccountReceivableSaleBond,
@TaxCapitalGainAccBond = TaxCapitalGainBond,@TaxInterestAccBond = WHTTaxPayableAccrInterestBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
                                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

set @PTaxExpenseAmount = (@PTaxExpensePercent / 100) * @PDoneAccruedInterest                  
set @PFinalAmount = @PDoneAccruedInterest - @PTaxExpenseAmount   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                 
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  


declare @BondSellAmount numeric (19,2)

set @BondSellAmount = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)/100 * @PDoneVolume


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InvestmentAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@BondSellAmount,                   
0,@BondSellAmount,1,0,@BondSellAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAccBond and Status = 2    



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
--,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
--Select @FundJournalPK,2,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
--0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                  



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,3,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxGainAmount,                   
@PIncomeTaxGainAmount,0,1,@PIncomeTaxGainAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2        


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,4,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxInterestAmount,                   
@PIncomeTaxInterestAmount,0,1,@PIncomeTaxInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2            

         
	
--Select @SellAvgPrice = AvgPrice From FundPosition where Date = @DateYesterday and Status =  2 and FundPK = @PFundPK and InstrumentPK = @PInstrumentPK                              
--set @AvgAmount = (@SellAvgPrice/100) * @PDoneVolume              
--set @RealisedAmount = abs(@PDoneAmount - @AvgAmount)
set @RealisedAmount = abs(@PDoneAmount - @BondSellAmount)



-- Gain Realised
if @BondSellAmount > @PDoneAmount              
Begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
		@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                  

	set  @ReceivableSellBondAmount = @BondSellAmount - @RealisedAmount +@PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount               
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
End       
     
-- Loss Realised
if @BondSellAmount <= @PDoneAmount              
begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
		0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                 
			 
	set  @ReceivableSellBondAmount = @BondSellAmount + @RealisedAmount + @PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount              
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
end     

                        

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,6,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T Settled       
         
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@ReceivableSellBondAmount,                   
0,@ReceivableSellBondAmount,1,0,@ReceivableSellBondAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,3,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,4,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),                   
0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount) ,1,0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,5,1,2,@TaxInterestAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,                   
0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,1,0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxInterestAccBond and Status = 2                



END 

-- A5.PLACEMENT DEPOSITO & ROLLOVER DEPOSITO          
if @PTrxType in (1,3) and @PInstrumentTypePK in (5,10) -- 5 Deposito biasa 10 NCD
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                           

if @InstrumentType in (5,10)                  
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                                    

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                 

IF dbo.CheckTodayIsHoliday (@PValueDate) = 1
BEGIN
    select @PValueDate = dbo.Fworkingday(@PValueDate, 1)
END


-- T0                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                   

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
END                  

-- A6. LIQUIDATE DEPOSITO --            
if @PTrxType = 2 and @PInstrumentTypePK in (5,10)                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
	
if @InstrumentType in (5,10)
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T0              
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                        

Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               
	
	
-- LOGIK BREAK INTEREST DISINI
	
Declare @IncomeDeposito int
Declare @ARInterestDeposito int
Declare @TaxDeposito int
    
Select @ARInterestDeposito = InterestAccrTimeDeposit,@IncomeDeposito = IncomeInterestTimeDeposit, 
@TaxDeposito = TaxExpenseInterestIncomeTimeDeposit
From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
	
Declare @ARInterestDepositoAmount numeric(22,4)
Declare @IncomeDepositoAmount numeric(22,4)
Declare @TaxDepositoAmount numeric(22,4)


set @IncomeDepositoAmount = [dbo].FGetDepositoInterestAccruedForPayment (@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,DateAdd(day,1,@PAcqDate),1,@ValueDate,1)
set @ARInterestDepositoAmount = 0.8 * @IncomeDepositoAmount
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount

--set @ARInterestDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@ARInterestDeposito,@PInstrumentPK,@PFundPK)
--set @IncomeDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@IncomeDeposito,@PInstrumentPK,@PFundPK)
--set @TaxDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@TaxDeposito,@PInstrumentPK,@PFundPK)
	

if @PBreakInterestPercent > 0


BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @IncomeDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'D',@IncomeDepositoAmount,                   
	@IncomeDepositoAmount,0,1,@IncomeDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

if @ARInterestDepositoAmount > 0
BEGIN

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,                   
	0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    
END
IF (@IncomeDeposito <> @TaxDeposito)
BEGIN
    if @TaxDepositoAmount > 0
    BEGIN
	    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	    Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	    0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    
    END


END
ELSE
BEGIN
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

Declare @BDNewInterestAmount numeric(22,4)
Declare @BDBalance numeric(22,4)
Declare @BDInterestDaysType int
Declare @BDInterestPercent numeric(8,4)
Declare @BDAcqDate datetime
Declare @BDInterestPaymentType int
Declare @BDMaturityDate datetime
Declare @BDPaymentModeOnMaturity int
Declare @BDTaxPercent numeric(8,4)

Select @BDBalance = Balance,@BDInterestDaysType = InterestDaysType
,@BDInterestPercent = InterestPercent
,@BDAcqDate = AcqDate
,@BDInterestPaymentType = InterestPaymentType
,@BDMaturityDate = MaturityDate
,@BDPaymentModeOnMaturity = PaymentModeOnMaturity
,@BDTaxPercent = TaxExpensePercent
From FundPosition where Date = @DateYesterday and InstrumentPK = @PInstrumentPK


set @BDNewInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment](@ValueDate,@PInstrumentPK,@BDBalance,@BDInterestDaysType,@PBreakInterestPercent,@BDAcqDate,@BDInterestPaymentType,@ValueDate,@BDPaymentModeOnMaturity)
		
if @BDNewInterestAmount > 0
BEGIN
	Declare @BDTaxAmount numeric(22,4)
	Declare @BDIncomeAmount numeric(22,4)
	set @BDTaxAmount = @BDNewInterestAmount * @BDTaxPercent/100
	set @BDIncomeAmount = @BDNewInterestAmount - @BDTaxAmount
					
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
				
	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
		@PReference,'LIQUIDATE NEW INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDIncomeAmount,                   
	@BDIncomeAmount,0,1,@BDIncomeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2        
				
		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'C',@BDNewInterestAmount,0,@BDNewInterestAmount,1,0,@BDNewInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDTaxAmount,@BDTaxAmount,0,1,@BDTaxAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    

END
END
ELSE
BEGIN

set @IncomeDepositoAmount = dbo.FGetDepositoInterestAccrued(@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,@ValueDate)
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount


select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @ARInterestDepositoAmount > 0 and @PBreakInterestPercent > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,                   
	@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount ,0,1,@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@TaxDepositoAmount,                   
	@TaxDepositoAmount,0,1,@TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2             

 		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
 	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

 		Select  @FundJournalPK,4,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@IncomeDepositoAmount,
    0,@IncomeDepositoAmount,1,0,@IncomeDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2

END
ELSE IF @ARInterestDepositoAmount > 0 and @PBreakInterestPercent = 0
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount,                   
	@ARInterestDepositoAmount,0,1,@ARInterestDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    

END




END
	

END  



-- A8. BUY MUTUAL FUND --                    
if @PTrxType = 1 and @PInstrumentTypePK in (6)                   
BEGIN    
	 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)    
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@PayablePurchaseAcc = PayablePurchaseProtectedFund, @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@PayablePurchaseAcc = PayablePurchasePrivateEquityFund  , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE
	 BEGIN
	 	Select @InvestmentAcc = InvestmentMutualFund,@PayablePurchaseAcc = PayablePurchaseMutualFund , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END					                      
                   
               

 -- Setup Account kelar diatas, Next masukin ke Fund Journal   
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
 -- T0                    
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T0 MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,0,@UsersID,@LastUpdate,@LastUpdate                                        
  
   
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  
  
  
 -- T Settled                  
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
   
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T-Settled MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,0,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                     
  
    
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                    
  
  
  
   
              
END                    
  -- A9.SELL MUTUAL FUND --  
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (6)   
BEGIN               
 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)   
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@ReceivableSaleAcc = AccountReceivableSaleProtectedFund , @CashForMutualFund = CashForMutualFund, @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellProtectedFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@ReceivableSaleAcc = AccountReceivableSalePrivateEquityFund, @CashForMutualFund = CashForMutualFund , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellPrivateEquityFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE
	 BEGIN
		Select @InvestmentAcc = InvestmentMutualFund,@ReceivableSaleAcc = AccountReceivableSaleMutualFund, @CashForMutualFund = CashForMutualFund  , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK     
	 END			                
   
                                                     
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
  
-- T0                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                   
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T0 MUTUAL FUND SELL: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,0,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2      

set @MInterestAmount = 0
select @BDate = DATEADD(m, DATEDIFF(m, 0, @ValueDate), 0)
select @MInterestAmount = (InterestPercent/100 * @PDoneVolume/365) * datediff(day,@BDate,@ValueDate) from ReksadanaInstrument where ReksadanaPK = @PInstrumentPK and status in (1,2)
select @MInterestAmount = isnull(@MInterestAmount,0)


IF (@MInterestAmount <> 0)
BEGIN
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,4,1,2,@InterestReceivableSellMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@MInterestAmount,                     
0,@MInterestAmount,1,0,@MInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestReceivableSellMutualFund and Status = 2                    
END               
			
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                              
set @AvgAmount = @SellAvgPrice * @PDoneVolume                
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount) 

  -- Gain Realised  
  if @AvgAmount <= @PDoneAmount                
  Begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@RealisedAmount,                     
  0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                    
  
  set  @InvestmentMutualFundAmount = @PDoneAmount - @RealisedAmount                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)   - isnull(@MInterestAmount,0)
  End         
       
  -- Loss Realised  
  if @AvgAmount > @PDoneAmount                
  begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select  @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@RealisedAmount,                     
  @RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                   
      
  set  @InvestmentMutualFundAmount = @PDoneAmount + @RealisedAmount               
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  - isnull(@MInterestAmount,0)
  end                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  
 
 
    
        
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@InvestmentMutualFundAmount,                     
0,@InvestmentMutualFundAmount,1,0,@InvestmentMutualFundAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  






-- T Settled         
           
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T-Settled MUTUAL FUND SELL: ' + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,0,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'C',@PDoneAmount,                     
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                    
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                  
  
  
  
END   


-- A10. BUY RIGHTS --   

Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2  
if @PTrxType = 1 and @PInstrumentTypePK = 4                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentRights,@PayablePurchaseAcc = PayablePurchaseRights
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 RIGHTS BUY: ' + @InstrumentID 
,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled RIGHTS BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A11. SELL RIGHTS --              

Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2  
if @PTrxType = 2 and @PInstrumentTypePK = 4                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentRights,@ReceivableSaleAcc = AccountReceivableSaleRights,@RealisedAcc = RealisedRights From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 RIGHTS SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             


    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED RIGHTS SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

  
  

	           
Fetch next From A Into                  
@PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,
@PBreakInterestPercent,@PSettlementPK,@PTaxExpensePercent,@PInterestPercent,@PAcqDate       
END                  
Close A                  
Deallocate A                
-------------------------------------------------------------------------------------------------------------------
-- B. DAILY FEE & PAYMENT FEE --

Create Table #ZFundFee               
(                  
DateOfPayment int,  
FundPK int,                  
ManagementFeePercent numeric(18,8),
CustodiFeePercent numeric(18,8),
AuditFeeAmount numeric(18,4),
MovementFeeAmount numeric(18,4),
ManagementFeeDays int,
CustodiFeeDays int,
AuditFeeDays int,
SinvestFeeDays int,
FundType int,
BitSinvestFee bit,
OtherFeeOneAmount numeric(18,4),
OtherFeeTwoAmount numeric(18,4),
CBESTEquityAmount numeric(18,4),
CBESTCorpBondAmount numeric(18,4),
CBESTGovBondAmount numeric(18,4),
)   

Declare @DecimalPlaces   int                  
Declare @RoundingMode   int                  
Declare @FundID     nvarchar(50)       
Declare @LastEndDayTrailsDate datetime       

Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                

Declare @ManagementFeeExpAcc    int                  
Declare @CustodianFeeExpAcc     int                  
Declare @AuditFeeExpAcc      int    
Declare @SinvestFeeExpAcc      int   
Declare @MovementFeeExpAcc    int                
Declare @PayableManagementFeeAcc   int                  
Declare @PayableCustodianFeeAcc    int                  
Declare @PayableAuditFeeAcc     int      
Declare @PayableSinvestFeeAcc     int
Declare @PayableMovementFeeAcc     int                
               
Declare @feeDays  int          
Declare @PayableSubscriptionFee int,@PayableRedemptionFee int
declare @BPayableSwitchingFee int
    

Select @feeDays =  DateDiff(day,ValueDate,@ValueDate),@LastEndDayTrailsDate = ValueDate From EndDayTrails              
Where ValueDate = 
(
Select Max(ValueDate) From EndDayTrails Where ValueDate < @ValueDate and status = 2 
) 

set @feeDays = isnull(@feeDays,0)         

Declare @BFundPK int                  
Declare @BManagementFeePercent numeric(18,6)                  
Declare @BCustodiFeePercent  numeric(18,6)                  
Declare @BAuditFeePercent  numeric(18,6) 


Declare @BSinvestFeePercent  numeric(18,8) 

Declare @BManagementFeeDays  int                  
Declare @BCustodiFeeDays  int                  
Declare @BAuditFeeDays   int   
Declare @BSinvestFeeDays  int   
Declare @BFundType  int    
Declare @BBitSinvestFee  bit         

     

Declare @BDateOfPayment  int                  
Declare @BAum     numeric(22,8)                  
Declare @BManagementFeeAmount numeric(18,6)                  
Declare @BCustodiFeeAmount  numeric(18,6)                  
Declare @BAuditFeeAmount  numeric(18,6)   
Declare @BMovementFeeAmount  numeric(18,6)      

Declare @BSinvestFeeAmount  numeric(18,8)                  

Declare @BPayableSubscriptionFeeAmount numeric(18,6)
Declare @BPayableRedemptionFeeAmount numeric(18,6)
Declare @BPayableSwitchingFeeAmount numeric(18,6)

Declare @BOtherFeeOneAmount  numeric(18,6) 
Declare @BOtherFeeTwoAmount  numeric(18,6) 

Declare @BCBESTAmount  numeric(18,6) 
Declare @BCBESTEquityAmount  numeric(18,6) 
Declare @BCBESTCorpBondAmount  numeric(18,6) 
Declare @BCBESTGovBondAmount  numeric(18,6) 

Declare @BCBESTTrxEquity int
Declare @BCBESTTrxCorpBond int
Declare @BCBESTTrxGovBond int


Declare @BPayableOtherFeeOne  int    
Declare @BPayableOtherFeeTwo  int   
Declare @BOtherFeeOneExpense  int    
Declare @BOtherFeeTwoExpense  int 
Declare @BPayableCBEST  int    
Declare @BCBESTExpense  int 




Declare @FundFeeSetup Table
(
	FundPK int,
	MIFeePercent numeric(18,8)
)

insert into @FundFeeSetup
select FundPK,MiFeePercent from FundFeeSetup A
where A.Date = (
Select max(date) from FundFeeSetup B where B.date	<= @ValueDate     and B.status = 2 and A.FundPK = B.FundPK
) and A.status in (1,2)


insert into #ZFundFee
Select DateOfPayment,A.FundPK,D.MIFeePercent,CustodiFeePercent,
AuditFeeAmount,MovementFeeAmount, @BTotalDays,@BTotalDays,@BTotalDays,@BTotalDays,Type,B.BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount, CBESTEquityAmount, CBESTCorpBondAmount, CBESTGovBondAmount                  
From FundFee A
left join Fund B on A.FundPK = B.FundPK and B.Status = 2
left join @FundFeeSetup D on A.FundPK = D.FundPK
Where A.status = 2 and A.Date = (
Select max(date) from FundFee C where C.date	<= @ValueDate     and C.status = 2 and A.FundPK = C.FundPK
) 


Declare B Cursor For                  
Select FundPK,ManagementFeePercent ,CustodiFeePercent ,
 AuditFeeAmount,MovementFeeAmount, ManagementFeeDays ,CustodiFeeDays,AuditFeeDays,SInvestFeeDays,DateOfPayment,FundType,BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount, CBESTEquityAmount, CBESTCorpBondAmount, CBESTGovBondAmount     from #ZFundFee 
Open B                  
Fetch Next From B                  
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount, @BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount,@BCBESTEquityAmount,@BCBESTCorpBondAmount,@BCBESTGovBondAmount                   
While @@FETCH_STATUS = 0                  
Begin                  
Select @ManagementFeeExpAcc = ManagementFeeExpense, @CustodianFeeExpAcc =CustodianFeeExpense , @AuditFeeExpAcc = AuditFeeExpense,@MovementFeeExpAcc = MovementFeeExpense,                  
@PayableManagementFeeAcc = PayableManagementFee,@PayableCustodianFeeAcc = PayableCustodianFee,@PayableAuditFeeAcc = PayableAuditFee,@PayableMovementFeeAcc = PayableMovementFee    
,@PayableSubscriptionFee = PayableSubscriptionFee,@PayableRedemptionFee = PayableRedemptionFee 
,@BPayableSwitchingFee = PayableSwitchingFee,@PayableSinvestFeeAcc = PayableSInvestFee, @SinvestFeeExpAcc = SInvestFee
,@BPayableOtherFeeOne = PayableOtherFeeOne, @BPayableOtherFeeTwo = PayableOtherFeeTwo,@BOtherFeeOneExpense = OtherFeeOneExpense, @BOtherFeeTwoExpense = OtherFeeTwoExpense
, @BPayableCBEST = PayableCBEST ,@BCBESTExpense = CBESTExpense      
From FundAccountingSetup Where Status = 2    and FundPK = @BFundPK    

-- B1. GENERATE DAILY FEE                  
set @BAum = 0


Select @BAum =  AUM From CloseNAV where Date = @DateYesterday and Status =  2 and FundPK = @BFundPK                  
Select @DecimalPlaces = JournalDecimalPlaces, @RoundingMode = JournalRoundingMode, @FundID = A.ID From Fund A 
left join BankBranch B on A.BankBranchPK = B.BankBranchPK and B.status = 2
left join Bank C on B.BankPK = C.BankPK and C.status = 2
where A.Status = 2 and A.FundPK = @BFundPK        




--1	STRUCTURED FUND : GUARANTEED FUND ok
--2	FIXED INCOME FUND ok
--3	MONEY MARKET FUND ok
--4	STRUCTURED FUND : CAPITAL PROTECTED FUND ok
--5	EQUITY FUND ok
--6	STRUCTURED FUND : INDEX FUND ok
--7	CIC ASSET BACKED SECURITIES ok
--8	DISCETIONARY FUND ok
--9	MIXED ASSET FUND ok
--10 EXCHANGE TRADED FUND ok
--11 REAL ESTATE INVESTMENT TRUST ok
--12 PRIVATE EQUITY FUND ok

Select @BSinvestFeeDays = SinvestFeeDays from SInvestSetup where status = 2

IF (@BFundType in (1,3,4,6,8,11,12))
BEGIN
	Select @BSinvestFeePercent = SinvestMoneyMarketFeePercent from SInvestSetup where status = 2
END
ELSE IF (@BFundType in (2,7,9))
BEGIN
	Select @BSinvestFeePercent = SinvestBondFeePercent from SInvestSetup where status = 2
END
ELSE
BEGIN
	Select @BSinvestFeePercent = SinvestEquityFeePercent from SInvestSetup where status = 2
END



-- 1 = UP, 2 = DOWN , 3 = NONE                  	
If @RoundingMode = 1                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(CEILING((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0) * @FeeDays                      
Set @BCustodiFeeAmount = isnull(CEILING((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0)  * @FeeDays  
Set @BSinvestFeeAmount = isnull(CEILING((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(CEILING(@BAuditFeeAmount),0)  * @FeeDays  
Set @BMovementFeeAmount = isnull(CEILING(@BMovementFeeAmount),0)  * @FeeDays   
Set @BOtherFeeOneAmount = isnull(CEILING(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(CEILING(@BOtherFeeTwoAmount),0)  * @FeeDays                
END                  

If @RoundingMode = 2                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(FLOOR((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0)  * @FeeDays                    
Set @BCustodiFeeAmount = isnull(FLOOR((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0) * @FeeDays 
Set @BSinvestFeeAmount = isnull(FLOOR((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays  
END
Set @BAuditFeeAmount = isnull(FLOOR(@BAuditFeeAmount),0)  * @FeeDays 
Set @BMovementFeeAmount = isnull(FLOOR(@BMovementFeeAmount),0)  * @FeeDays  
Set @BOtherFeeOneAmount = isnull(FLOOR(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(FLOOR(@BOtherFeeTwoAmount),0)  * @FeeDays               
END                  

If @RoundingMode = 3                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(ROUND((@BAum * (@BManagementFeePercent/100))/@BManagementFeeDays,@DecimalPlaces),0)  * @FeeDays                 
Set @BCustodiFeeAmount = isnull(ROUND((@BAum * (@BCustodiFeePercent/100))/@BCustodiFeeDays,@DecimalPlaces),0)    * @FeeDays   
Set @BSinvestFeeAmount = isnull(ROUND((@BAum * (@BSinvestFeePercent/100))/@BSinvestFeeDays,@DecimalPlaces),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(@BAuditFeeAmount,0)  * @FeeDays    
Set @BMovementFeeAmount = isnull(@BMovementFeeAmount,0)  * @FeeDays      
Set @BOtherFeeOneAmount = isnull(@BOtherFeeOneAmount,0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(@BOtherFeeTwoAmount,0)  * @FeeDays       
END                  





if isnull(@BAum,0) = 0
begin
set @BManagementFeeAmount = 0
set @BCustodiFeeAmount = 0
set @BAuditFeeAmount = 0
set @BMovementFeeAmount = 0
set @BSinvestFeeAmount = 0
set @BOtherFeeOneAmount = 0
set @BOtherFeeTwoAmount = 0
end




-- Setup Account kelar diatas, Next masukin ke Fund Journal  
if @BManagementFeeAmount > 0 or @BCustodiFeeAmount > 0 or @BAuditFeeAmount > 0
BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'DAILY FEE',                  
'','FUND ID: ' + @FundID ,0,@UsersID,@LastUpdate,@LastUpdate                  
END    

if @BManagementFeeAmount > 0
BEGIN
		
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@ManagementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ManagementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                  

END

if @BCustodiFeeAmount > 0
BEGIN

	
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@CustodianFeeExpAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CustodianFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2       

END
  
if @BAuditFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@AuditFeeExpAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'D',@BAuditFeeAmount,                   
@BAuditFeeAmount,0,1,@BAuditFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @AuditFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@PayableAuditFeeAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'C',@BAuditFeeAmount,                   
0,@BAuditFeeAmount,1,0,@BAuditFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableAuditFeeAcc and Status = 2                  
		
END

IF (@BBitSInvestFee = 1)
BEGIN

    if @BSinvestFeeAmount > 0
    BEGIN

	
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,7,1,2,@SinvestFeeExpAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
    @BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SinvestFeeExpAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
    0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2       

    END
END


if @BMovementFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,9,1,2,@MovementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'D',@BMovementFeeAmount,                   
@BMovementFeeAmount,0,1,@BMovementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @MovementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,10,1,2,@PayableMovementFeeAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'C',@BMovementFeeAmount,                   
0,@BMovementFeeAmount,1,0,@BMovementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableMovementFeeAcc and Status = 2                  
		
END


if @BOtherFeeOneAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,11,1,2,@BOtherFeeOneExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeOneAmount,                   
@BOtherFeeOneAmount,0,1,@BOtherFeeOneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeOneExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,12,1,2,@BPayableOtherFeeOne,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeOneAmount,                   
0,@BOtherFeeOneAmount,1,0,@BOtherFeeOneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeOne and Status = 2                  
		
END


if @BOtherFeeTwoAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,13,1,2,@BOtherFeeTwoExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeTwoAmount,                   
@BOtherFeeTwoAmount,0,1,@BOtherFeeTwoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeTwoExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,14,1,2,@BPayableOtherFeeTwo,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeTwoAmount,                   
0,@BOtherFeeTwoAmount,1,0,@BOtherFeeTwoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeTwo and Status = 2                  
		
END



-- BUAT CBEST TRX     
set @BCBESTTrxEquity = 0
set @BCBESTTrxCorpBond = 0
set @BCBESTTrxGovBond = 0


Select @BCBESTTrxEquity = COUNT(InvestmentPK) from Investment
where StatusSettlement = 2 and FundPK = @BFundPK and ValueDate = @ValueDate  and InstrumentTypePK in (1,4,6)

Select @BCBESTTrxCorpBond = COUNT(InvestmentPK) from Investment
where StatusSettlement = 2 and FundPK = @BFundPK and ValueDate = @ValueDate  and InstrumentTypePK in (3)

Select @BCBESTTrxGovBond = COUNT(InvestmentPK) from Investment
where StatusSettlement = 2 and FundPK = @BFundPK and ValueDate = @ValueDate  and InstrumentTypePK in (2,9,12,13,14,15)

--select @BCBESTEquityAmount = @BCBESTTrxEquity * @BCBESTEquityAmount
--select @BCBESTCorpBondAmount = @BCBESTTrxCorpBond * @BCBESTCorpBondAmount
--select @BCBESTGovBondAmount = @BCBESTTrxGovBond * @BCBESTGovBondAmount

select @BCBESTAmount = (isnull(@BCBESTTrxEquity,0) * isnull(@BCBESTEquityAmount,0)) + (isnull(@BCBESTTrxCorpBond,0) * isnull(@BCBESTCorpBondAmount,0)) + (isnull(@BCBESTTrxGovBond,0) * isnull(@BCBESTGovBondAmount,0))

if isnull(@BCBESTAmount,0) > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,15,1,2,@BCBESTExpense,CurrencyPK,@BFundPK,0,0,'C-BEST FEE FUND ID: ' + @FundID,'D',@BCBESTAmount,                   
@BCBESTAmount,0,1,@BCBESTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BCBESTExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,16,1,2,@BPayableCBEST,CurrencyPK,@BFundPK,0,0,'C-BEST FEE FUND ID: ' + @FundID,'C',@BCBESTAmount,                   
0,@BCBESTAmount,1,0,@BCBESTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableCBEST and Status = 2                  
		
END

	            

---------------- TINGGAL TEST SUDAH TAMBAH PAYABLE SUBS DAN REDEMPT FEE
-- B2. GENERATE PAYMENT FEE

Declare @EOMonthForFee datetime
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @BFundPK
if(@BDateOfPayment = day(@ValueDate) or (@BDateOfPayment >= day(@LastEndDayTrailsDate) and @BDateOfPayment <= day(@ValueDate)))
BEGIN
Declare @BManagementFeeAmountCheck numeric(22,4)
Declare @BCustodiFeeAmountCheck numeric(22,4)
Declare @BSinvestFeeAmountCheck numeric(22,4)
Declare @BPayableRedemptionFeeAmountCheck numeric(22,4)
Declare @BPayableSubscriptionFeeAmountCheck numeric(22,4)
Declare @BPayableSwitchingFeeAmountCheck numeric(22,4)

set @EOMonthForFee = dateadd(month,-1,@ValueDate)
set @EOMonthForFee = EOMONTH (@EOMonthForFee)
	
set @BManagementFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@BPayableSwitchingFee,@BFundPK)

set @BManagementFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@BPayableSwitchingFee,@BFundPK)

Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
			                    
if @BManagementFeeAmount > 0  or @BCustodiFeeAmount > 0 or @BSinvestFeeAmount > 0 or @BPayableRedemptionFeeAmount > 0   or  
@BPayableSubscriptionFeeAmount > 0  or 
@BPayableSwitchingFeeAmount > 0   
Begin                                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
                      
Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'PAYMENT FEE',                  
'','FUND ID: ' + @FundID ,0,@UsersID,@LastUpdate,@LastUpdate                  
                        
if @BManagementFeeAmount > 0  and @BManagementFeeAmount < @BManagementFeeAmountCheck                
Begin                       
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,1,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
		@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
		0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
end                  
if @BCustodiFeeAmount > 0  and @BCustodiFeeAmount < @BCustodiFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,3,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
		@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,4,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
		0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BSinvestFeeAmount > 0  and @BSinvestFeeAmount < @BSinvestFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,5,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
		@BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,6,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
		0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableRedemptionFeeAmount > 0   and @BPayableRedemptionFeeAmount < @BPayableRedemptionFeeAmountCheck               
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,7,1,2,@PayableRedemptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'D',@BPayableRedemptionFeeAmount,                   
		@BPayableRedemptionFeeAmount,0,1,@BPayableRedemptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableRedemptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,8,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'C',@BPayableRedemptionFeeAmount,                   
		0,@BPayableRedemptionFeeAmount,1,0,@BPayableRedemptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSubscriptionFeeAmount > 0        and @BPayableSubscriptionFeeAmount < @BPayableSubscriptionFeeAmountCheck           
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,9,1,2,@PayableSubscriptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSubscriptionFeeAmount,                					@BPayableSubscriptionFeeAmount,0,1,@BPayableSubscriptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSubscriptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,10,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSubscriptionFeeAmount,                   
		0,@BPayableSubscriptionFeeAmount,1,0,@BPayableSubscriptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSwitchingFeeAmount > 0    and @BPayableSwitchingFeeAmount < @BPayableSwitchingFeeAmountCheck              
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,11,1,2,@BPayableSwitchingFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSwitchingFeeAmount,@BPayableSwitchingFeeAmount,0,1,@BPayableSwitchingFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableSwitchingFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,12,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSwitchingFeeAmount,                   
		0,@BPayableSwitchingFeeAmount,1,0,@BPayableSwitchingFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

End

END

Fetch next From B   
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount,@BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount,@BCBESTEquityAmount,@BCBESTCorpBondAmount,@BCBESTGovBondAmount
                     
End                  
Close B                  
Deallocate B   
---------------------------------------------------------------------------------------------------------------------------
 -- B3. BANK INTEREST


declare @EFundPK int
declare @EFundCashRefPK int
declare @EFundID nvarchar(50)
declare @ECashAcc int
declare @EInterestPercent numeric (18,6)
declare @EInterestDays numeric (22,6)
declare @EBalance numeric (22,6)
declare @EMinimumBalance numeric (18,6)
declare @EBankInterestAmount numeric (22,6)
declare @EBankInterestAcc int
declare @EBankInterestIncomeAcc int


DECLARE E CURSOR FOR 
Select A.FundCashRefPK,A.FundPK,B.ID From FundCashRef A left join Fund B on A.FundPK = B.FundPK and B.status in (1,2)
where A.status in (1,2)
        	
Open E
Fetch Next From E
Into @EFundCashRefPK,@EFundPK,@EFundID       
While @@FETCH_STATUS = 0
BEGIN  
    set @EBankInterestAmount = 0

    IF EXISTS(select * from BankInterestSetup A left join FundCashRef B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
    where A.status in (1,2) and B.FundPK = @EFundPK and B.FundCashRefPK = @EFundCashRefPK)
    BEGIN
        DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join FundCashRef B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and B.FundCashRefPK = @EFundCashRefPK and Date = (
        Select max(date) from BankInterestSetup A 
		left join FundCashRef B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and B.FundCashRefPK = @EFundCashRefPK and Date <= @ValueDate
        )
        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3 and FundCashRefPK = @EFundCashRefPK
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
			    set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END
	ELSE
	BEGIN
		DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join FundCashRef B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date = (
        Select max(date) from BankInterestSetup A 
		left join FundCashRef B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date <= @ValueDate
        )

        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3 and FundCashRefPk = @EFundCashRefPK
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
				set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END
				
			--select @EFundPK,@EBalance,@EInterestPercent,@EInterestDays

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END


	
	-- Setup Account kelar diatas, Next masukin ke Fund Journal  
	if @EBankInterestAmount > 0
	BEGIN
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

	Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'BANK DAILY INTEREST',                  
	'','FUND ID: ' + @EFundID,0,@UsersID,@LastUpdate,@LastUpdate                  
	END    

	if @EBankInterestAmount > 0
	BEGIN
		
		select @EBankInterestAcc = InterestAccrGiro,@EBankInterestIncomeAcc = IncomeInterestGiro from FundAccountingSetup where FundPK = @EFundPK and status in (1,2)

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select  @FundJournalPK,1,1,2,@EBankInterestAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'D',@EBankInterestAmount,                   
	@EBankInterestAmount,0,1,@EBankInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestAcc and Status = 2                   

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select @FundJournalPK,2,1,2,@EBankInterestIncomeAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'C',@EBankInterestAmount,                   
	0,@EBankInterestAmount,1,0,@EBankInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestIncomeAcc and Status = 2                  

	END


	
Fetch next From E Into @EFundCashRefPK,@EFundPK,@EFundID 
END
Close E
Deallocate E 

---------------------------------------------------------------------------------------------------------------------------

-- C. REVAL,GENERATE BOND,DEPOSITO ACCRUED  --             

declare @RevalEquity int
declare @InvestEquity int
declare @RevalRights int
declare @InvestRights int
declare @RevalBond int
declare @InvestBond int
declare @MarketValue numeric(22,6)   
declare @PrevMarketValue numeric(22,6) 

Declare @RevaluationAcc    int                  
Declare @UnrealisedAcc    int                  
Declare @FInstrumentPK    int         
Declare @FInstrumentID    nvarchar(100)                  
Declare @FFundPK     int                  
Declare @FTrxAmount     numeric(22,6)                  
Declare @FMarketValue    numeric(22,6)                  
Declare @FInstrumentTypePK   int                  
Declare @FCurrencyPK    int                  
Declare @FPrevRevaluationAmount  numeric(22,6)                  
Declare @FFinalAmount    numeric(22,6)                  
Declare @FLastCouponDate   datetime                  
Declare @FInterestAmount   numeric(18,6)                  
Declare @FBalance     numeric(18,0)                  
Declare @FTaxExpenseAmount   numeric(18,6)                  
Declare @FTaxExpensePercent   numeric(18,8)                  
Declare @FAcqDate   datetime                                  
Declare @FMaturityDate  datetime  
Declare @FSell   int 
Declare @FBuy   int 
Declare @FDoneAmount    numeric(22,6) 
Declare @FInterestDaysType int
Declare @FInterestPaymentType int
Declare @FInterestPercent numeric(18,8)
Declare @FPaymentModeOnMaturity int
Declare @FReksadanaTypePK int

--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)

Declare D Cursor For   


    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK  


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2  and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate)

    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 

-- REKSADANA
union all

	Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)                  
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (6)
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (6)
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 ,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate)

    and B.InstrumentTypePK in (6)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 




Open D                  
Fetch Next From D                  
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance
,@FTaxExpensePercent,@FMaturityDate,@FSell,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent ,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK    
While @@FETCH_STATUS = 0                  
Begin  
    -- C1. REVALUATION EQUITY & BOND --

    select @RevalEquity = RevaluationEquity,@InvestEquity = InvestmentEquity,@RevalBond = RevaluationBond,@InvestBond = InvestmentBond,
	@RevalRights = RevaluationRights,@InvestRights = InvestmentRights from FundAccountingSetup where status = 2 and fundPK = @FFundPK
    IF(@RevalEquity = @InvestEquity) OR (@RevalBond = @InvestBond) OR (@RevalRights = @InvestRights)
    BEGIN
	    IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK  
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK   


            IF (@FBuy = 1)
            BEGIN

                --select @MarketValue =  dbo.FGetLastVolumeInv(@valuedate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                --select @PrevMarketValue = dbo.FGetLastVolumeInv(dbo.FWorkingDay(@valuedate,-1),@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.FWorkingDay(@valuedate,-1),@FInstrumentPK,@FFundPK)/100)     
                --select @FDoneAmount = dbo.FGetDoneAmountInv(@valuedate,@FFundPK,@FInstrumentPK)
                --set @FFinalAmount = @MarketValue - (@PrevMarketValue + @FDoneAmount) 
                
                
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 


            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)/100) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue  
				   
            END
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
			IF(@FInstrumentTypePK = 1)
			BEGIN
			    Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
				Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2  and fundPK = @FFundPK
			END
			ELSE IF(@FInstrumentTypePK = 4)
			BEGIN
			    Select @RevaluationAcc = RevaluationRights From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
				Select @UnrealisedAcc = UnrealisedRights From FundAccountingSetup where Status = 2  and fundPK = @FFundPK
			END


            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END  

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    
	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END


            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END   


    END
    ELSE
    BEGIN
        IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2    and fundPK = @FFundPK
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK      
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
			IF @FInstrumentTypePK = 1
			BEGIN
			Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
			END 
			ELSE
			BEGIN
			Select @RevaluationAcc = RevaluationRights From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedRights From FundAccountingSetup where Status = 2   and fundPK = @FFundPK
			END

        END    

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    

	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END

        END   

        IF @FInstrumentTypePK in(1,2,3,4,6,8,9,13,14,15,16)    
        BEGIN  
            IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)
				
            END
            ELSE
            BEGIN

                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FMarketValue,0) - isnull(@FTrxAmount,0) - @FPrevRevaluationAmount 
			
            END
        END
   
    END






	IF Exists(              
    Select * from ClosePrice where Status = 2 and date = @ValueDate              
    )  
    BEGIN
        IF isnull(@FFinalAmount,0) > 0 --Nilai Revaluasi Acc di Debit    
        BEGIN    
        -- Setup Account kelar diatas, Next masukin ke Fund Journal  
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal     
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)  


        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
    
        Select @FundJournalPK,2,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2        
        END  

        IF isnull(@FFinalAmount,0) < 0    
        BEGIN  
        -- Setup Account kelar diatas, Next masukin ke Fund Journal    
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)    
        
        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
        
        Select @FundJournalPK,2,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2    
        END  
    END  	 







	    
Fetch next From D                   
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance,@FTaxExpensePercent,@FMaturityDate,@FSell    
,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK   
END        
Close D                  
Deallocate D


--AAAAAAAA


Declare @IncDays int            
Declare @CInstrumentPK    int         
Declare @CInstrumentID    nvarchar(100)                  
Declare @CFundPK     int                  
Declare @CTrxAmount     numeric(22,6)                  
Declare @CMarketValue    numeric(22,6)                  
Declare @CInstrumentTypePK   int                  
Declare @CCurrencyPK    int                  
Declare @CPrevRevaluationAmount  numeric(22,6)                  
Declare @CFinalAmount    numeric(22,6)                  
Declare @CLastCouponDate   datetime                  
Declare @CInterestAmount   numeric(18,6)                  
Declare @CBalance     numeric(18,0)                  
Declare @CTaxExpenseAmount   numeric(18,6)                  
Declare @CTaxExpensePercent   numeric(18,8)                  
Declare @CAcqDate   datetime                  
Declare @InterestIncometAcc   int                  
Declare @CMaturityDate  datetime  
Declare @CSell   int
Declare @CRoll   int  

Declare @CInterestDaysType int
Declare @CInterestPaymentType int
Declare @CInterestPercent numeric(18,8)
Declare @CPaymentModeOnMaturity int

--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)


Declare C Cursor For   
 
  
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)-- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
and B.InstrumentTypePK <> 5 

and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and @ValueDate <= SettlementDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity
 
UNION ALL

--JUAL BOND MASIH BELUM SETTLED

Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)-- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and B.InstrumentTypePK <> 5 
and EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and StatusSettlement  = 2 and TrxType = 2 and @ValueDate between ValueDate and SettlementDate  and A.[Identity] = C.TrxBuy)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 

 
UNION ALL

-- MATURE DIHITUNG

Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)-- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@ValueDate,-1)
)
and B.InstrumentTypePK not in (1,5)
and   EXISTS 
(  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK  and Status  = 2 and MaturityDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
 and A.AcqDate not in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday  and statussettlement = 2)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity





--MATURE INTEREST WEEKEND
UNION ALL       
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)
)
and A.MaturityDate <= @valuedate and B.InstrumentTypePK = 5 

and  NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity


--ROLLOVER INTEREST WEEKEND
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
 and A.AcqDate  in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

UNION ALL

-- JUAL H+1 HARI LIBUR
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 Roll             
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
and exists (
	select * from investment C where TrxType = 2 and valuedate = @valuedate and A.InstrumentPK = C.InstrumentPK and A.AcqDate = C.AcqDate  and A.FundPK = C.FundPK  and C.statussettlement = 2)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity




Open C                  
Fetch Next From C                  
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance
,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent ,@CPaymentModeOnMaturity,@CRoll     
While @@FETCH_STATUS = 0                  
Begin              

  
-- C2. GENERATE INTEREST ACCRUED BOND                  

IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)             
BEGIN                  
Select @InterestRecAcc = InterestAccrBond
,@TaxExpenseAcc = TaxExpenseInterestIncomeBond,@InterestIncometAcc = IncomeInterestBond
From FundAccountingSetup where Status = 2  and FundPK = @CFundPK                  
END                  

IF @CInstrumentTypePK = 5 -- NCD INTEREST BLOM TAU GIMANA PAS MATURED
BEGIN                  
Select @InterestRecAcc = InterestAccrTimeDeposit,@TaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@InterestIncometAcc = IncomeInterestTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @CFundPK
END                  
IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)     -- and  @CLastCouponDate < @ValueDate        
BEGIN       
if @CAcqDate < @Valuedate
BEGIN

        IF (@CMarketValue = 0)
        BEGIN
            set @CInterestAmount  = 0
            set @CTaxExpenseAmount = 0 
            set @CFinalAmount = 0 
        END
        ELSE
        BEGIN
            Select @CInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@ValueDate,@CInstrumentPK,@CBalance)            
		    set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
		    set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)  
        END

      
		IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)                    
		BEGIN                 	         
		-- Setup Account kelar diatas, Next masukin ke Fund Journal   
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

		IF @CInterestAmount > 0                  
		BEGIN           
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

        IF((day(@valuedate) <> 31 AND @CInterestDaysType in (3,5,6,7)) OR (@CInterestDaysType not in (3,5,6,7)))
        BEGIN

            INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            '','INSTRUMENT: ' + @CInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            @CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            @CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
        END

            --IF(@CInterestDaysType not in (3,5,6,7))
            --BEGIN
            --INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            --,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            --Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            --'','INSTRUMENT: ' + @CInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            --@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            --0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            --@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
            --END
	                              
		END
		END            
END
END        

IF @CInstrumentTypePK = 5  
BEGIN   
--IF NOT EXISTS(
--Select * from investment
--where ValueDate = @ValueDate and StatusSettlement = 2 and TrxType = 2 and InstrumentPK = @CInstrumentPK
--)
BEGIN
	
    IF (@CRoll = 0 AND @CSell = 0)
    BEGIN
        IF  @CMaturityDate > @DateYesterday and @CMaturityDate <= @ValueDate
        BEGIN
            Declare @RealMaturedDate datetime
            if @CPaymentModeOnMaturity = 1
            begin
            set @RealMaturedDate = @CMaturityDate
            end
            if @CPaymentModeOnMaturity = 2
            begin
            set @RealMaturedDate = @ValueDate
            end
            Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@RealMaturedDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)           

            if @CPaymentModeOnMaturity = 3
            begin
            set @CInterestAmount = 0
            end

        END
        ELSE
        BEGIN
	
            if (@ValueDate = @CAcqDate)
            BEGIN
                Select @CInterestAmount = 0
            END
            ELSE
            BEGIN
                Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@ValueDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)        
            END
	
		 
        END
    END
    ELSE IF (@CRoll = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,@CAcqDate,@ValueDate)

    END
    ELSE IF (@CSell = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) *  DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),dateadd(day,-1,@valuedate))

    END
    ELSE
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),@CMaturityDate)
    END


--       select @ValueDate,@CAcqDate,@CInterestAmount,@CInstrumentPK,@CInterestPercent,@CFundPK
-- where @CInstrumentPK in 
-- (
	--select A.instrumentPK from fundposition A
	--left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.status = 2

	--where fundpk = 2 and trailsPK = 2 and B.InstrumentTypePK = 5		   
-- )
-- CEK LOGIK PAYMENT INTEREST TYPE DISINI

-- Setup Account kelar diatas, Next masukin ke Fund Journal   
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

IF @CInterestAmount > 0                  
BEGIN                  
set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
set @CFinalAmount = @CInterestAmount - @CTaxExpenseAmount       

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,7,@maxEndDayTrailsPK,'INTEREST DEPOSIT',                  
'','INSTRUMENT: ' + @CInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2                   
END        
END

	          
END

                                              
	
 

 
Fetch next From C                   
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell    
,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent,@CPaymentModeOnMaturity,@CRoll
END        
Close C                  
Deallocate C

                          
-- C4. MATURE BOND & TIME DEPOSIT & DEPOSITO BELUM SAMPE UJUNG   
Declare @DInstrumentPK    int  
Declare @DRealisedAccBond    int      
Declare @DRevaluationAccBond    int         
Declare @DInstrumentID    nvarchar(100)                  
Declare @DFundPK     int                  
Declare @DTrxAmount     numeric(22,6)                  
Declare @DMarketValue    numeric(22,6)                  
Declare @DInstrumentTypePK   int                  
Declare @DCurrencyPK    int                                   
Declare @DFinalAmount    numeric(22,6)                  
Declare @DNextCouponDate   datetime                  
Declare @DInterestAmount   numeric(18,6)                  
Declare @DBalance     numeric(18,0)                  
Declare @DTaxExpenseAmount   numeric(18,6)                  
Declare @DTaxExpensePercent   numeric(18,8)                  
Declare @DAcqDate   datetime                                  
Declare @DMaturityDate  datetime  
Declare @PrevInterestAmount numeric(22,6)
Declare @PrevFinalAmount numeric(22,6)
Declare @PrevTaxExpenseAmount numeric(22,6)
declare @divdays int
declare @intdays int

Declare @DInterestRecAcc int
Declare @DTaxExpenseAcc int
Declare @DInterestIncometAcc int
Declare @DCashAtBankAcc   int  
Declare @DInvestmentBond int
Declare @DInvestmentTimeDeposit int
Declare @DInterestPaymentType int


Declare @DPaymentModeOnMaturity int
Declare @DInterestDaysType int
Declare @DInterestPercent numeric(18,4)
Declare @DInterestPeriod int


--DISINI

insert into #Mature(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetNextCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and A.MaturityDate >= @DateYesterday and A.MaturityDate <= @valuedate and B.InstrumentTypePK in (5,10) and A.InterestPaymentType <> 7
and A.[Identity] not in(
Select isnull(TrxBuy,0) from Investment C where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and A.FundPK = C.FundPK and A.InstrumentPK = C.InstrumentPK
)


-- INI UNTUK KASUS TERIMA KUPON BULANAN, PAKAI INTERESTPAYMENTTYPE = 7 (MONTHLY)
union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,cast(cast(DATEPART(MONTH, @valuedate) as nvarchar(2)) + '/' + cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime),A.Balance                   
,B.TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime) AcqDate,A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              

Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and A.MaturityDate >= @DateYesterday and A.InterestPaymentType = 7 
--and DATEPART(DAY,A.MaturityDate) >= DATEPART(DAY,@DateYesterday) and DATEPART(DAY,A.MaturityDate) <= DATEPART(DAY,@valuedate) 
and B.InstrumentTypePK in (5,10)
and A.InstrumentPK not in(
Select InstrumentPK from Investment C where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and A.FundPK = C.FundPK and A.InstrumentPK = C.InstrumentPK
)


union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (             
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate       


DECLARE D CURSOR FOR 

-- ni buat bulanan
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, dateadd(month,-1,NextCouponDate), MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where NextCouponDate > @DateYesterday and NextCouponDate <= @valuedate  and NextCouponDate <> MaturityDate  and InstrumentTypePK in (5,10) and InterestPaymentType = 7	
union all
-- ni buat bulanan tapi udah mature
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,MaturityDate,Balance                   
,TaxExpensePercent, dateadd(month,-1,MaturityDate), MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate > @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType = 7

union all

select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType <> 7	
union all
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate and InstrumentTypePK in (2,3,8,9,11,13,14,15)

Open D
Fetch Next From D
Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate   
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent ,@DInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN       
  

IF @DInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @DInterestRecAcc = InterestAccrBond
,@DTaxExpenseAcc = TaxExpenseInterestIncomeBond,@DInterestIncometAcc = IncomeInterestBond,@DInvestmentBond = InvestmentBond,
@DRealisedAccBond = RealisedBond,@DRevaluationAccBond = RevaluationBond
From FundAccountingSetup where Status = 2  and FundPK = @DFundPK  

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

               

Begin           
Select @intdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@DInterestPaymentType in (10,11,12,13)) 
BEGIN
	select @divdays = 90
END
ELSE
IF(@DInterestPaymentType in (16,17,18)) 
BEGIN
	select @divdays = 180
END
ELSE
IF(@DInterestPaymentType in (7,8,9)) 
BEGIN
	select @divdays = 30
END
ELSE
BEGIN
	select @divdays = datediff(day,@DAcqDate,@DMaturityDate)   
END       
Select @DInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@DInstrumentPK,@DBalance) / @intdays *  @divdays                                                 
End               

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@DInstrumentPK,@DBalance) * (datediff(day,@DAcqDate,@DMaturityDate) - 1)                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

  

IF @DInterestAmount > 0                  
BEGIN    
	
IF (@DMaturityDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'MATURE TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@DRealisedAccBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DTrxAmount - @DBalance,                   
    @DTrxAmount - @DBalance,0,1,@DTrxAmount - @DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DRealisedAccBond and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DTrxAmount - @DBalance,                   
    0,@DTrxAmount - @DBalance,1,0,@DTrxAmount - @DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

END

ELSE
BEGIN
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal           
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                  
END
END               
END                  

ELSE IF @DInstrumentTypePK in (5,10)                
BEGIN   

Select @intdays =  DateDiff(day,@DateYesterday,@valuedate) 
Select @DInterestRecAcc = InterestAccrTimeDeposit,@DTaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@DInterestIncometAcc = IncomeInterestTimeDeposit, @DInvestmentTimeDeposit = InvestmentTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @DFundPK

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

Begin      

select @DInterestPeriod = InterestDaysType from Instrument where InstrumentPK = @DInstrumentPK and status in (1,2)   
	
IF (@DInterestPaymentType = 7)
BEGIN
    Select @DInterestAmount = @DBalance * (@DInterestPercent / 100) / @DInterestPeriod *  DATEDIFF(day,@DAcqDate,@DNextCouponDate)    
END
ELSE
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment]  (@DMaturityDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate,@DInterestPaymentType,@DMaturityDate,@DPaymentModeOnMaturity)  End              
END


set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * @DInterestAmount                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

IF @DInterestAmount > 0                  
BEGIN    

--BALIKIN NILAI INTEREST KE BANK
             
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR INTEREST TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestIncometAcc and Status = 2                  
END


    IF (@DInterestPaymentType not in (7)) OR (@DInterestPaymentType in (7) and @DMaturityDate >= @DateYesterday and @DMaturityDate <= @valuedate)
    BEGIN


        IF @DPaymentModeOnMaturity = 2 -- ACQ TO MATURITY DATE NWD
        BEGIN
        set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
        END
        ELSE IF @DPaymentModeOnMaturity = 3 -- ACQ TO MATURITY DATE BWD
        BEGIN
        set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
        END 
        ELSE
        BEGIN
        set @DMaturityDate = @DMaturityDate
        END

        select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal          
       
        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

        Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'INV DEPOSIT TO BANK',                  
        '','INSTRUMENT: ' + @DInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
        @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select @FundJournalPK,2,1,2,@DInvestmentTimeDeposit,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
        0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentTimeDeposit and Status = 2                 



    END       

        

END

		
Fetch next From D Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate      
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent     ,@DInterestPaymentType                  
END
Close D
Deallocate D    
-------------------------------------------------------------------
-- C5. REC COUPON BOND

Declare @GInstrumentPK    int       
Declare @GInstrumentID    nvarchar(100)                  
Declare @GFundPK     int                  
Declare @GTrxAmount     numeric(22,6)                  
Declare @GMarketValue    numeric(22,6)                  
Declare @GInstrumentTypePK   int                  
Declare @GCurrencyPK    int                                   
Declare @GFinalAmount    numeric(22,6)   
Declare @GLastCouponDate   datetime                  
Declare @GNextCouponDate   datetime                  
Declare @GInterestAmount   numeric(18,6)                  
Declare @GBalance     numeric(18,0)                  
Declare @GTaxExpenseAmount   numeric(18,6)                  
Declare @GTaxExpensePercent   numeric(18,8)                  
Declare @GAcqDate   datetime                                  
Declare @GMaturityDate  datetime  
Declare @GPrevInterestAmount numeric(22,6)
Declare @GPrevFinalAmount numeric(22,6)
Declare @GPrevTaxExpenseAmount numeric(22,6)
declare @Gdivdays int
declare @Gintdays int

Declare @GInterestRecAcc int
Declare @GTaxExpenseAcc int
Declare @GInterestIncometAcc int
Declare @GCashAtBankAcc   int  
Declare @GInterestAccrBond int
Declare @GInvestmentTimeDeposit int
Declare @GInterestPaymentType int


Declare @GPaymentModeOnMaturity int
Declare @GInterestDaysType int
Declare @GInterestPercent numeric(18,4)


--DISINI

insert into #RecCoupon(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.TrxAmount,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,
case when A.InterestPaymentType in (10,11,12,13) then dateadd(month,-3,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) else case when A.InterestPaymentType in (16,17,18) then dateadd(month,-6,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK))
else case when A.InterestPaymentType in (7,8,9) then dateadd(month,-1,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) end end end
,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate 

DECLARE G CURSOR FOR 
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #RecCoupon where (NextCouponDate >= @DateYesterday and NextCouponDate <= @valuedate) and InstrumentTypePK in (2,3,8,9,11,13,14,15)
Open G
Fetch Next From G
Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate   
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent ,@GInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN      
  

IF @GInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @GInterestRecAcc = InterestAccrBond
,@GTaxExpenseAcc = TaxExpenseInterestIncomeBond,@GInterestIncometAcc = IncomeInterestBond,@GInterestAccrBond = InterestAccrBond
From FundAccountingSetup where Status = 2  and FundPK = @GFundPK  

Select @GCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @GFundPK

            

Begin           
Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@GInterestPaymentType in (10,11,12,13)) 
BEGIN
	select @Gdivdays = 90
END
ELSE
IF(@GInterestPaymentType in (16,17,18)) 
BEGIN
	select @Gdivdays = 180
END
ELSE
IF(@GInterestPaymentType in (7,8,9)) 
BEGIN
	select @Gdivdays = 30
END
ELSE
BEGIN
	select @Gdivdays = datediff(day,@GAcqDate,@GNextCouponDate)   
END    

    Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@GInstrumentPK,@GBalance) / @Gintdays *  @Gdivdays

   
                                                 
End               

IF (@GAcqDate > @GLastCouponDate)
BEGIN
    set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@GInstrumentPK,@GBalance) * (datediff(day,@GAcqDate,@GNextCouponDate))                  
END
ELSE
BEGIN
    set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
END

set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount

  

IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
END

END               
END                  

		
Fetch next From G Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate      
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent,@GInterestPaymentType                  
END
Close G
Deallocate G   



-----------------------------------------------------------------------------------------------------------
-- CLIENT SUBS WITH INTEREST -- 

IF (@ClientCode = '09')
BEGIN 
    DECLARE @RClientSubsPK INT
    DECLARE @RClientName NVARCHAR(500)
    DECLARE @RFundName NVARCHAR(500)
    DECLARE @RTotalCashAmount NUMERIC(22,4)
    DECLARE @RValueDate DATETIME
    DECLARE @RTenor INT
    DECLARE @RPaymentTerm INT
    DECLARE @RInterestRate NUMERIC(18,8)
    DECLARE @RFundPK INT
    DECLARE @RFundClientPK INT

    DECLARE @RMaxDate DATETIME
    DECLARE @RStartFrom DATETIME


    SELECT @RMaxDate = MAX(Date) FROM dbo.ZDT_WorkingDays

    select @RStartFrom = dateadd(month,-12,dateadd(day,1,@ValueDate))

    --
    DECLARE @RMaturityDate datetime
    DECLARE @RCounterDate DATETIME
    DECLARE @RLastDate DATETIME
    DECLARE @RRedempPK INT

    DECLARE @Result TABLE
    (
    FundClientPK INT,
    FundPK INT,
    ClientName NVARCHAR(500),
    FundName NVARCHAR(500),
    InterestRate NUMERIC(18,8),
    Tenor INT,
    PaymentTerm INT,
    ValueDate DATETIME,
    PaymentDate DATETIME,
    RedemptDate DATETIME,
    RedemptAmount NUMERIC(22,4),
    ClientSubsPK int
    )

    Declare A Cursor For
	    SELECT A.ClientSubscriptionPK 
	    ,A.FundClientPK,ISNULL(B.Name,'') ClientName
	    ,A.FundPK,ISNULL(C.Name,'') FundName
	    ,A.TotalCashAmount
	    ,A.ValueDate
	    ,CASE WHEN A.Tenor = 1 THEN 3 WHEN A.Tenor = 2 THEN 6 ELSE 12 END
	    ,CASE WHEN A.PaymentTerm = 1 THEN 3 WHEN A.PaymentTerm = 2 THEN 6 ELSE 12 END
	    ,A.InterestRate
	    FROM dbo.ClientSubscription A
	    LEFT JOIN FundClient B ON A.FundClientPK = B.FundClientPK AND B.Status IN (1,2)
	    LEFT JOIN Fund C ON A.FundPK = C.FundpK AND C.status IN (1,2)
	    WHERE 
		    isnull(A.Tenor,0) > 0
		    AND isnull(A.InterestRate,0) > 0
		    AND isnull(A.PaymentTerm,0) > 0
		
		    -- PARAM DARI REPORT
		    AND A.ValueDate BETWEEN @RStartFrom AND @valuedate



    Open A
    Fetch Next From A
    INTO @RClientSubsPK,@RFundClientPK,@RClientName,@RFundPK,@RFundName,@RTotalCashAmount,@RValueDate,@RTenor,@RPaymentTerm,@RInterestRate

    While @@FETCH_STATUS = 0  
    BEGIN
	    SET @RMaturityDate = NULL
	    SET @RCounterDate = NULL
	    SET @RLastDate = null
	    SET @RCounterDate = @RValueDate
	    SET @RMaturityDate = DATEADD(MONTH,@RTenor,@RValueDate)

	    SELECT @RMaturityDate = CASE WHEN isholiday = 1 THEN DTM1 ELSE @RMaturityDate END  FROM dbo.ZDT_WorkingDays WHERE date = @RMaturityDate

	    WHILE @RCounterDate < @RMaturityDate AND @RCounterDate <= @RMaxDate
	    BEGIN
		    SET @RLastDate = @RCounterDate
		    SELECT @RCounterDate =  CASE WHEN isholiday = 1 THEN DT1 ELSE  DATEADD(MONTH,@RPaymentTerm,@RCounterDate)  END  FROM dbo.ZDT_WorkingDays WHERE date = DATEADD(MONTH,@RPaymentTerm,@RCounterDate) 
		
		    delete @Result
		    INSERT INTO @Result
		            ( FundClientPK ,
		              FundPK ,
		              ClientName ,
		              FundName ,
		              InterestRate ,
		              Tenor ,
		              PaymentTerm ,
		              ValueDate ,
				      PaymentDate,
		              RedemptDate ,
		              RedemptAmount,
				      ClientSubsPK
		            )
		
		    SELECT @RFundClientPK FundClientPK
		    ,@RFundPK FundPK
		    ,@RClientName ClientName
		    ,@RFundName FundName
		    ,@RInterestRate InterestRate
		    ,@RTenor Tenor
		    ,@RPaymentTerm PaymentTerm
		    ,@RValueDate ValueDate
		    ,@RCounterDate PaymentDate
		    , CASE WHEN B.IsHoliday = 1 THEN A.DT1 ELSE B.Date END RedemptDate
		    ,(@RInterestRate/100/365) * DATEDIFF(day,@RLastDate,@RCounterDate) * @RTotalCashAmount RedemptAmount
		    ,@RClientSubsPK
		    FROM dbo.ZDT_WorkingDays A 
		    LEFT JOIN dbo.ZDT_WorkingDays B ON A.DTM3 = B.Date
		    WHERE A.Date = @RCounterDate

		
		
		    Select @RRedempPK = max(ClientRedemptionPK) + 1 From ClientRedemption


		    INSERT INTO [dbo].[ClientRedemption]
		    ([ClientRedemptionPK],[HistoryPK],[Status],[NAVDate],[ValueDate],[PaymentDate],
		    [NAV],[FundPK],[FundClientPK],[CashRefPK],[CurrencyPK],[Type],[BitRedemptionAll],[Description],[CashAmount],[UnitAmount],[TotalCashAmount],[TotalUnitAmount],
		    [RedemptionFeePercent],[RedemptionFeeAmount],[AgentPK],[AgentFeePercent],[AgentFeeAmount],[UnitPosition],[BankRecipientPK],[TransferType],[FeeType],[ReferenceSInvest],
		    [IsBOTransaction],[EntryUsersID],[EntryTime],[ApprovedUsersID],[ApprovedTime],[LastUpdate])


		    SELECT @RRedempPK,1,1,RedemptDate,RedemptDate,PaymentDate,
		    0,FundPK,FundClientPK,0,0,1,0,'Interest',RedemptAmount,0,RedemptAmount,0,
		    0,0,0,0,0,0,0,0,0,'',
		    0,@UsersID,@LastUpdate,null,null,@LastUpdate FROM @Result
		    where RedemptDate > @DateYesterday and RedemptDate <= DATEADD(day,1,@valuedate)

	    END


	    Fetch Next From A 
	    INTO @RClientSubsPK,@RFundClientPK,@RClientName,@RFundPK,@RFundName,@RTotalCashAmount,@RValueDate,@RTenor,@RPaymentTerm,@RInterestRate
    End	
    Close A
    Deallocate A

END







-----------------------------------------------------------------------------------------------------------

-- D. COPY FUND CLIENT POSITION --    
    

if not exists(
	select * from FundClientPosition where date = dbo.FWorkingDay(@ValueDate, 1)
)
BEGIN

    
Declare @CPFundPK int           
Declare A Cursor For              
Select FundPK From Fund Where status = 2              
Open  A              
Fetch Next From  A              
into @CPFundPK              
While @@Fetch_Status = 0              
BEGIN              
Insert into FundClientPosition(Date,FundClientPk,FundPK,CashAmount,UnitAmount,LastUpdate)              
Select dbo.FWorkingDay(@ValueDate, 1),FundClientPK,FundPK,CashAmount,UnitAmount,@LastUpdate              
From FundClientPosition where Date = @ValueDate and FundPK = @CPFundPK           
Fetch next From A                   
Into @CPFundPK              
END                  
Close A                  
Deallocate A


END    


-- E. PENDING UNIT REGISTRY
-- 1. SUBSCRIPTION
Declare @SValueDate Datetime,@SFundPK int,@SCashRefPK int,@SFundClientPK int,@SFundClientName nvarchar(100),@STotalCashAmount numeric(22,4),@SCurrencyPK int ,@SType nvarchar(5)  
Declare @SPendingSubscription int,@SSubscription int,@SCashAtBankAcc int   
Declare @SPendingRedemption int,@SRedemption int
Declare @SCashAmount numeric(22,4), @SFeeAmount numeric(22,4)
Declare @SPayableSubsAcc int                 
DECLARE @BitPendingSubscription bit		
Declare @UnitRegistryPK int    				 
Declare @IssueDate datetime

Declare A Cursor For                  
Select ClientSubscriptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,TotalCashAmount,CurrencyPK,'SUBS' Type
,CashAmount, SubscriptionFeeAmount          
From ClientSubscription A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.status not in (3,4) and ValueDate = @ValueDate  
union all
Select ClientRedemptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,case when TotalCashAmount = 0 then TotalUnitAmount * dbo.FgetCloseNav(@DateYesterday,A.FundPK) else TotalCashAmount End TotalCashAmount,CurrencyPK,'RED' Type         
,CashAmount, RedemptionFeeAmount
From ClientRedemption A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.Status <>  3  and ValueDate = @ValueDate
	            
Open A                  
Fetch Next From A                  
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK,@SType,
@SCashAmount,@SFeeAmount
While @@FETCH_STATUS = 0                  
Begin 
IF (@SType = 'SUBS')
BEGIN

select @IssueDate = IssueDate from Fund where status in (1,2) and FundPK = @SFundPK

SELECT @BitPendingSubscription = ISNULL(BitPendingSubscription,1) FROM dbo.FundFee WHERE fundPK = @SFundPK
AND date = 
(
SELECT MAX(Date) FROM dbo.FundFee WHERE Date <= @SValueDate AND FundPK = @SFundPK
AND status = 2
) and STATUS = 2

set @BitPendingSubscription = isnull(@BitPendingSubscription,0)

set @SCashAtBankAcc = NULL

Select @SCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @SCashRefPK
if (@SCashAtBankAcc is null or @SCashAtBankAcc  = '')
BEGIN
set @SCashAtBankAcc = 3
END

IF (@ValueDate = @IssueDate)
BEGIN

    Select @SSubscription = Subscription From FundAccountingSetup where Status = 2  and FundPK = @SFundPK
                     
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SSubscription and Status = 2   


END
ELSE 
BEGIN

    IF(@BitPendingSubscription = 1)
    BEGIN
    Select @SPendingSubscription = PendingSubscription,@SSubscription = Subscription
    ,@SPayableSubsAcc = payablesubscriptionfee
    From FundAccountingSetup 
    where Status = 2  and FundPK = @SFundPK

                       
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SPendingSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPendingSubscription and Status = 2   

        if @SFeeAmount > 0
        BEGIN

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select @FundJournalPK,3,1,2,@SPayableSubsAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@SFeeAmount,                   
        0,@SFeeAmount,1,0,@SFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPayableSubsAcc and Status = 2   
        END

    END


END                                  

  

         
END
         
Fetch next From A                   
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK ,@SType,@SCashAmount,@SFeeAmount
END                  
Close A                  
Deallocate A

  UPDATE A 
SET A.AvgNAV = dbo.FGetAVGForFundClientPosition(@ValueDate,A.FundClientPK,A.FundPK), A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
FROM FundClientPosition A
    LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
    LEFT JOIN FundClientPosition C ON A.FundPK = C.FundPK AND A.FundClientPK = C.FundClientPK AND C.Date = @DateYesterday
WHERE A.Date = @ValueDate

UPDATE A 
SET A.AUM = ISNULL(B.AUM,0),A.AvgNAV = ISNULL(B.AvgNAV,0) 
FROM dbo.FundClientPositionSummary A
    LEFT JOIN dbo.FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK AND B.Date  = @ValueDate

-------------------------------------------
-- JOURNAL CORPORATE ACTION

Create Table #ZDividenSaham                  
(                  
InstrumentPK int,     
FundPK int,                  
LastVolume numeric(18,4),
PaymentDate datetime,
RecordingDate datetime,
Earn numeric(22,4),
Hold numeric(22,4)
)   


--DIVIDEN SAHAM
-- Tarik Balance Cum / Valuedate - 1 + movement dengan batas settleddate <= recordingDate and ValueDate >= CumDate 
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select  B.FundPK,B.InstrumentPK,B.Balance + ISNULL(C.BalanceFromInv,0) LastBalance,
A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
and C.ValueDate >= A.ValueDate
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate



Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select B.FundPK,B.InstrumentPK,isnull(B.BalanceFromInv,0),A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
from CorporateAction A
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)B on  B.SettlementDate <= A.RecordingDate and  A.InstrumentPK = B.InstrumentPK
and B.ValueDate >= A.ValueDate
left join #ZDividenSaham C on B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK 
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate
and C.FundPK is null and C.InstrumentPK is null

Declare @TIncomeDividend int
Declare @TARDividend int
Declare @TotalAmount numeric(22,4)
Declare @TWithHoldingTaxPPH23 int


Declare @TInstrumentPK int
declare @TFundPK int
declare @TLastVolume numeric(22,4)
declare @TPaymentDate datetime
declare @TRecordingDate datetime
declare @TEarn numeric(22,4)
declare @THold numeric(22,4)

Declare @TTaxPercentage numeric(8,4)

Declare A Cursor For   
Select * From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TIncomeDividend = IncomeDividend,@TARDividend = ARDividend,@TWithHoldingTaxPPH23 = prepaidTaxDividend 
,@TTaxPercentage = TaxPercentageDividend
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume/@THold * @TEarn
   
if @TotalAmount > 0
BEGIN
	
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH CUM DATE' ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TIncomeDividend,CurrencyPK,@TFundPK,0,0,'INCOME DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TIncomeDividend and Status = 2   

--------------- PAYMENT DATE

declare @pph23Amount numeric(22,4)
set @pph23Amount = @TotalAmount * @TTaxPercentage/100

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@TPaymentDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH PAYMENT DATE' ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DefaultCashAtBankPK,CurrencyPK,@TFundPK,0,0,'DIVIDEND','D',@TotalAmount - @pph23Amount,                   
@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DefaultCashAtBankPK and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@TWithHoldingTaxPPH23,CurrencyPK,@TFundPK,0,0,'TAX DIVIDEND','D',@pph23Amount,                   
@pph23Amount,0,1,@pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TWithHoldingTaxPPH23 and Status = 2     

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A



---BOND AMORTIZE
TRUNCATE TABLE #ZDividenSaham
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,Earn,Hold)
Select  B.FundPK,B.InstrumentPK,B.Balance  LastBalance,A.PaymentDate,A.Earn,A.Hold
--B.Balance + C.BalanceFromInv LastBalance
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
--Left join (
--	select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
--	, SettlementDate, ValueDate 
--	from Investment where statusSettlement = 2
--	and InstrumentTypePK  in (2,3,9,15)
--	Group by InstrumentPK,FundPK,SettlementDate,ValueDate
--)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
--and C.ValueDate >= A.ValueDate
where A.Type = 6 and A.Status = 2 and A.PaymentDate = @ValueDate


Declare @TInvestmentInBond int
Declare @TBondAmortized int


Declare A Cursor For   
Select InstrumentPK,FundPK,LastVolume,PaymentDate,PaymentDate,Earn,Hold From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TInvestmentInBond = InvestmentBond,@TBondAmortized = BondAmortization
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume *  @TEarn / @THold * -1
   
if @TotalAmount < 0
BEGIN
SET @TotalAmount = ABS(@TotalAmount)
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'BOND AMORTIZE',                  
'','CORPORATE ACTION BOND AMORTIZE' ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TBondAmortized,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TBondAmortized and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TInvestmentInBond,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TInvestmentInBond and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A
------------------------------------------------------------------------------




Declare @MaxEDT datetime
Select @MaxEDT = max(Valuedate) from EndDayTrails where status = 2

set @MaxEDT = dbo.FWorkingDay(@MaxEDT,1)

truncate table FundClientPositionSummary

Insert into FundClientPositionSummary(userID,FundPK,FundClientPK,Unit,LastUpdate,AvgNAV,AUM,FirstNAV)

Select @UsersID,A.FundPK,A.FundClientPK,isnull(A.UnitAmount,0) - isnull(B.UnitAmount,0) - isnull(C.UnitAmount,0),getdate(),A.AvgNAV,0,0 from FundClientPosition A
left join (
	SELECT FundClientPK,FundPK, sum(isnull(case when UnitAmount > 0 then UnitAmount else CashAmount / dbo.FgetLastCloseNav(NAVDate,FundPK) end,0)) UnitAmount FROM ClientRedemption  WHERE status not in (3,4) and posted = 0 and Revised = 0
	group by FundClientPK,FundPK
) B on A.FundClientPK = B.FundClientPK and A.FundPK = B.FundPK 

left join 
(
	SELECT FundClientPK,FundPKFrom, sum(isnull(case when UnitAmount > 0 then UnitAmount else CashAmount / dbo.FgetLastCloseNav(NAVDate,FundPKFrom) end,0)) UnitAmount FROM ClientSwitching  WHERE status not in (3,4) and posted = 0 and Revised = 0
	group by FundClientPK,FundPKFrom
) C on A.FundClientPK = C.FundClientPK and A.FundPK = C.FundPKFrom 
where Date = @MaxEDT  


-------------------------------------------
                        
 
Update EndDayTrails set BitValidate = 1,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1                    

Declare @ClientSubscriptionPK int
Declare @ClientRedemptionPK int
Declare @DateWorkingTo datetime

set @DateWorkingTo = dbo.FWorkingDay(@ValueDate, 1)

Create table #dayTemp
(
IntDay  int
)

WHILE (@Valuedate < @DateWorkingTo)
BEGIN
set @Valuedate = DATEADD(day,1,@Valuedate)
insert into #dayTemp
Select day(@Valuedate)
END

select @ClientSubscriptionPK = isnull(max(ClientSubscriptionPK),0)  + 1 from ClientSubscription
select @ClientRedemptionPK = isnull(max(ClientRedemptionPK),0)  + 1 from ClientRedemption
    
INSERT INTO [dbo].[ClientSubscription]    
([ClientSubscriptionPK],[HistoryPK],[Status],[NAVDate],[ValueDate],   
[NAV],[FundPK],[FundClientPK],[CashRefPK],[CurrencyPK],[Description],[CashAmount],[UnitAmount],[TotalCashAmount],[TotalUnitAmount],   
[SubscriptionFeePercent],[SubscriptionFeeAmount],[AgentPK],[AgentFeePercent],[AgentFeeAmount],[Type],[AutoDebitDate],[EntryUsersID],[EntryTime],[LastUpdate])   
select @ClientSubscriptionPK + ROW_NUMBER() OVER(ORDER BY A.FundClientPK ASC),1,1,@DateWorkingTo,@DateWorkingTo,   
0,FundPK,A.FundClientPK,FundCashRefPK,1,'',GrossAmount,0,NetAmount,0,    
FeePercent,FeeAmount,isnull(B.SellingAgentPK,0),0,0,2,@ValueDate,@UsersID,@LastUpdate,@LastUpdate    
From RegulerInstruction A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.Status = 2
where AutoDebitDate in (
select IntDay From #dayTemp
) and  A.status = 2 and A.TrxType = 1

INSERT INTO [dbo].[ClientRedemption]    
([ClientRedemptionPK],[HistoryPK],[Status],[NAVDate],[ValueDate],   
[NAV],[FundPK],[FundClientPK],[CashRefPK],[CurrencyPK],[Description],[CashAmount],[UnitAmount],[TotalCashAmount],[TotalUnitAmount],   
[RedemptionFeePercent],[RedemptionFeeAmount],[AgentPK],[AgentFeePercent],[AgentFeeAmount],[BankRecipientPK],[Type],[EntryUsersID],[EntryTime],[LastUpdate])   
select @ClientRedemptionPK + ROW_NUMBER() OVER(ORDER BY A.FundClientPK ASC),1,1,@DateWorkingTo,@DateWorkingTo,   
0,FundPK,A.FundClientPK,FundCashRefPK,1,'',GrossAmount,0,NetAmount,0,    
FeePercent,FeeAmount,isnull(B.SellingAgentPK,0),0,0,BankRecipientPK,2,@UsersID,@LastUpdate,@LastUpdate    
From RegulerInstruction A left join FundClient B on A.FundClientPK = B.FundClientPK and B.Status = 2
where AutoDebitDate in (
select IntDay From #dayTemp
) and  A.status = 2 and A.TrxType = 2


Select @maxEndDayTrailsPK LastPK     
                             
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.Parameters.AddWithValue("@ClientCode", Tools.ClientCode);

                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToInt32(dr["LastPK"]);

                            }
                            return 0;
                        }

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        } 

        public bool ValidateGenerate(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        cmd.CommandText = @" if Exists(select * From EndDayTrails where Status in (1,2) and ValueDate = @Valuedate)  
                                             BEGIN Select 1 Result END ELSE IF
		                                     Not Exists(select * From EndDayTrails where Status = 2 and ValueDate = dbo.FWorkingDay(@Valuedate,-1))	
											 BEGIN Select 1 Result END ELSE 
											 BEGIN   
                                            Select 0 Result END   ";



                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public bool ValidateVoid(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        //cmd.CommandText = "if Exists(select * From EndDayTrails where Status in (1,2) and ValueDate = @ValueDate) BEGIN Select 1 Result END ELSE BEGIN Select 0 Result END";

                        cmd.CommandText = @" if Exists(
	
	                    select '1' A From ClientSubscription where ValueDate = dbo.FWorkingDay(@ValueDate,1)
	                    and Posted = 1 and status = 2 and Revised = 0
	                    UNION ALL
	                    select '1' A From ClientRedemption where ValueDate = dbo.FWorkingDay(@ValueDate,1)
	                    and Posted = 1 and status = 2 and Revised = 0
	                    UNION ALL
	                    select '1' A From ClientSwitching where ValueDate = dbo.FWorkingDay(@ValueDate,1)
	                    and Posted = 1 and status = 2 and Revised = 0
	                    )  
                            BEGIN Select 1 Result END ELSE BEGIN   
                        Select 0 Result END  ";



                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public bool ValidateGenerateUnit(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        //cmd.CommandText = "if Exists(select * From EndDayTrails where Status in (1,2) and ValueDate = @ValueDate) BEGIN Select 1 Result END ELSE BEGIN Select 0 Result END";

                        //RHB
                        cmd.CommandText = " if Exists(select * From EndDayTrails where Status in (1,2) and ValueDate = @ValueDate)  " +
                                          " BEGIN Select 1 Result END ELSE BEGIN     " +
                                          " if Exists(select * From ClientSubscription where  ValueDate = dbo.FNextWorkingDay(@ValueDate,-1) and (Status = 1 or (status = 2 and Posted = 0)))    " +
                                          " BEGIN Select 1 Result END   " +
                                          " ELSE if Exists(select * From ClientRedemption where  ValueDate = dbo.FNextWorkingDay(@ValueDate,-1) and (Status = 1 or (status = 2 and Posted = 0)))    " +
                                          " BEGIN Select 1 Result END   " +
                                          " ELSE BEGIN Select 0 Result END END ";

                    

                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public Boolean Download_TBReconcile(string _userID, EndDayTrails _endDayTrails)
        {
            try
            {
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandText = " Select F.ID FundID,C.ID AccountID,C.Name AccountName,case when C.Type in (1,4) then SUM(basedebit-basecredit) else SUM(basedebit-basecredit) * -1 end Amount From FundJournal A " +
                        " Left join FundJournalDetail  B on A.FundJournalPK = B.FundJournalPK " +
                        " left join Fund F on B.FundPK = F.FundPK and F.Status = 2 " +
                        " left join FundJournalAccount C on B.FundJournalAccountPK = C.FundJournalAccountPK and B.Status = 2 " +
                        " Where A.ValueDate <= @Date " +
                        " Group by  F.ID,C.Type,C.ID,C.Name " +
                        " Order By  F.ID,C.Type,C.ID ";

                        cmd.Parameters.AddWithValue("@Date", _endDayTrails.ValueDate);


                        using (SqlDataReader dr0 = cmd.ExecuteReader())
                        {
                            if (!dr0.HasRows)
                            {
                                return false;
                            }
                            else
                            {
                                string filePath = Tools.ReportsPath + "templateReconcile" + _endDayTrails.ValueDate.ToString().Replace("/", "") + ".xlsx";
                        
                                FileInfo excelFile = new FileInfo(filePath);
                                if (excelFile.Exists)
                                {
                                    excelFile.Delete();  // MASTIIN INI FILE BARU, JADI KITA HAPUS YANG LAMA
                                    excelFile = new FileInfo(filePath);
                                }

                                // SETUP EXCEL FILENYA DAN KASI NILAI KE PROPERTIES
                                using (ExcelPackage package = new ExcelPackage(excelFile))
                                {
                                    package.Workbook.Properties.Title = "TBReconcileReport";
                                    package.Workbook.Properties.Author = Tools.DefaultReportAuthor();
                                    package.Workbook.Properties.Comments = Tools.DefaultReportComments();
                                    package.Workbook.Properties.Company = Tools.DefaultReportCompany();
                                    package.Workbook.Properties.SetCustomPropertyValue("Checked by", _userID);
                                    package.Workbook.Properties.SetCustomPropertyValue("AssemblyName", Tools.DefaultReportAssemblyName());

                                    ExcelWorksheet worksheet = package.Workbook.Worksheets.Add("TBReconcile");


                                    //ATUR DATA GROUPINGNYA DULU
                                    List<TBReconcileTemp> rList = new List<TBReconcileTemp>();
                                    while (dr0.Read())
                                    {
                                        TBReconcileTemp rSingle = new TBReconcileTemp();

                                        rSingle.FundID = Convert.ToString(dr0["FundID"]);
                                        rSingle.AccountID = Convert.ToString(dr0["AccountID"]);
                                        rSingle.AccountName = Convert.ToString(dr0["AccountName"]);
                                        rSingle.Amount = Convert.ToDecimal(dr0["Amount"]);
                                        rList.Add(rSingle);

                                    }

                                    var GroupByReference =
                                        from r in rList
                                        group r by new { } into rGroup
                                        select rGroup;

                                    int incRowExcel = 0;

                                    foreach (var rsHeader in GroupByReference)
                                    {
                                        incRowExcel++;
                                      
                                        worksheet.Cells[incRowExcel, 1].Value = "FundID";
                                        worksheet.Cells[incRowExcel, 2].Value = "AccountID";
                                        worksheet.Cells[incRowExcel, 3].Value = "AccountName";
                                        worksheet.Cells[incRowExcel, 4].Value = "Amount";
                                      
                                        string _range = "A" + incRowExcel + ":D" + incRowExcel;
                                        using (ExcelRange r = worksheet.Cells[_range]) // KALO  KOLOM 1 SAMPE 9 A-I
                                        {
                                            //NILAINYA NGAMBIL DARI DEFAULT DI TOOLS, KLO MAU BEDA SENDIRI BOLEH2 AJA.
                                            r.Style.Font.Color.SetColor(Tools.DefaultReportColumnHeaderFontColor());
                                            r.Style.HorizontalAlignment = Tools.DefaultReportColumnHeaderHorizontalAlignment();
                                            r.Style.Fill.PatternType = ExcelFillStyle.Solid;
                                            r.Style.Fill.BackgroundColor.SetColor(Tools.DefaultReportColumnHeaderBackgroundColor());
                                            r.Style.Font.Size = Tools.DefaultReportColumnHeaderFontSize();
                                            r.Style.Font.Bold = Tools.DefaultReportColumnHeaderFontBold();
                                            r.Style.Border.Top.Style = Tools.DefaultReportColumnHeaderBorderTop();
                                            r.Style.Border.Bottom.Style = Tools.DefaultReportColumnHeaderBorderBottom();
                                        }
                                        incRowExcel++;
                                 

                                        int _startRowDetail = incRowExcel;
                                        int _endRowDetail = 0;
                                        //end area header
                                        foreach (var rsDetail in rsHeader)
                                        {
                                            //area detail
                                            worksheet.Cells[incRowExcel, 1].Value = rsDetail.FundID;
                                            worksheet.Cells[incRowExcel, 2].Value = rsDetail.AccountID;
                                            worksheet.Cells[incRowExcel, 3].Value = rsDetail.AccountName;
                                            worksheet.Cells[incRowExcel, 4].Value = rsDetail.Amount;
                                            worksheet.Cells[incRowExcel, 4].Style.Numberformat.Format = "#,##0";                   
                                            _endRowDetail = incRowExcel;
                                            incRowExcel++;

                                        }

                                    }

                                    // BAGIAN INI DI EDIT MANUAL PER REPORT SESUAI KEBUTUHAN
                                    worksheet.Cells.AutoFitColumns(0);
                                    worksheet.PrinterSettings.Orientation = eOrientation.Landscape; // INI PER REPORT BEDA2 KEBUTUHANNYA JADI DI CEK WAKTU DESIGN REPORTNYA
                                    // worksheet.PrinterSettings.RepeatRows = new ExcelAddress("1:1");// INI PERLU AGAR BARIS 1 MUNCUL TERUS WAKTU PRINT DI TIAP HALAMAN
                                    // worksheet.PrinterSettings.FitToPage = true;
                                    //worksheet.HeaderFooter.OddHeader.RightAlignedText = "&14 PAYMENT VOUCHER";
                                    // BAGIAN INI BIASANYA AMBIL DARI DEFAULT SETTING DI TOOLS, TPI BISA DIUBAH SENDIRI SESUAI KEBUTUHAN PER REPORT
                                    worksheet.PrinterSettings.TopMargin = Tools.DefaultReportTopMargin();
                                    worksheet.PrinterSettings.PaperSize = Tools.DefaultReportPaperSize();
                                    //worksheet.View.PageLayoutView = Tools.DefaultReportPageLayoutView();
                                    worksheet.View.ShowGridLines = Tools.DefaultReportShowGridLines();
                                    worksheet.HeaderFooter.OddHeader.CenteredText = "&14 TB RECONCILE";
                                    worksheet.HeaderFooter.OddHeader.LeftAlignedText = Tools.DefaultReportHeaderLeftText();

                                    worksheet.HeaderFooter.OddFooter.RightAlignedText =
                                    string.Format("Page {0} of {1}", ExcelHeaderFooter.PageNumber, ExcelHeaderFooter.NumberOfPages);

                                    //worksheet.HeaderFooter.OddFooter.CenteredText = Tools.DefaultReportFooterCenterText();
                                    worksheet.HeaderFooter.OddFooter.LeftAlignedText = Tools.DefaultReportFooterLeftText();

                                    package.Save();
                                    return true;
                                }

                            }
                        }
                    }
                }
            }
            catch (Exception err)
            {
                return false;
                throw err;
            }

        }

        public bool ValidateGenerateCheckSubsRedemp(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        //RHB
                        cmd.CommandText =
                            " if Exists(select * From ClientSubscription where  ValueDate = dbo.FWorkingDay(@ValueDate,-1) and (Status = 1 or (status = 2 and Posted = 0)))    " +
                            " BEGIN Select 1 Result END   " +
                            " ELSE if Exists(select * From ClientRedemption where  ValueDate = dbo.FWorkingDay(@ValueDate,-1) and (Status = 1 or (status = 2 and Posted = 0)))    " +
                            " BEGIN Select 1 Result END   " +
                            " ELSE BEGIN Select 0 Result END ";

                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public void EndDayTrails_UpdateAUMbyDate(DateTime _dateFrom, DateTime _dateTo, EndDayTrails _endDayTrails)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        string _paramFund = "";

                        if (!_host.findString(_endDayTrails.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundFrom))
                        {
                            _paramFund = "And FundPK in ( " + _endDayTrails.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        cmd.CommandText = @" 
                                            DECLARE @DateYesterday datetime 
                                            DECLARE @ValueDate datetime
                                            WHILE @From <= @To
	                                            BEGIN
		                                            SET @ValueDate = @From

		                                            SELECT  @DateYesterday  = ValueDate 
		                                            FROM Enddaytrails
		                                            WHERE status = 2 
			                                            and valuedate = (Select Max(valueDate) From EnddayTrails where status = 2 and ValueDate < @ValueDate)

		                                            UPDATE A 
		                                            SET A.AvgNAV = dbo.FGetAVGForFundClientPosition(@ValueDate,A.FundClientPK,A.FundPK)
			                                            , A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
			                                            , A.NilaiInvestasi = ISNULL(A.UnitAmount,0) * ISNULL(B.Nav,0)
		                                            FROM FundClientPosition A
			                                            LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
			                                            LEFT JOIN FundClientPosition C ON A.FundPK = C.FundPK AND A.FundClientPK = C.FundClientPK AND C.Date = @DateYesterday
		                                            WHERE A.Date = @ValueDate
    
                                                    UPDATE A 
		                                            SET A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
		                                            FROM FundAgentPosition A
			                                            LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
			                                            LEFT JOIN FundAgentPosition C ON A.FundClientPK = C.FundClientPK AND A.FundPK = C.FundPK AND A.AgentPK = C.AgentPK AND C.Date = @DateYesterday
		                                            WHERE A.Date = @ValueDate

		                                            UPDATE A 
		                                            SET A.AUM = ISNULL(B.AUM,0), A.NilaiInvestasi = ISNULL(B.NilaiInvestasi,0), A.AvgNAV = ISNULL(B.AvgNAV,0) 
		                                            FROM dbo.FundClientPositionSummary A 
			                                            LEFT JOIN dbo.FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK AND B.Date  = @ValueDate

	                                            DECLARE @CFundClientPK INT
	                                            DECLARE @CFundPK INT
	                                            DECLARE @CNAV NUMERIC(18,8)

	                                            DECLARE A CURSOR FOR
	                                            SELECT DISTINCT A.FundPK,A.FundClientPK,NAV 
	                                            FROM dbo.ClientSubscription A
		                                            LEFT JOIN FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK 
			                                            AND B.Date = @DateYesterday	AND B.UnitAmount > 0
	                                            WHERE A.ValueDate = @ValueDate AND A.Posted = 1 AND A.status = 2 AND B.FundPK IS null

	                                            OPEN A
	                                            FETCH NEXT FROM A
	                                            INTO @CFundPK,@CFundClientPK,@CNAV
	                                            WHILE @@FETCH_STATUS = 0  
	                                            BEGIN 
		                                            UPDATE dbo.FundClientPositionSummary SET FirstNAV = @CNAV 
		                                            WHERE fundPK = @CFundPK AND FundClientPK = @CFundClientPK
		                                            FETCH NEXT FROM A INTO @CFundPK,@CFundClientPK,@CNAV
	                                            END 
	
	                                            CLOSE A  
	                                            DEALLOCATE A 

	                                            SET @From = dbo.FWorkingDay(@from,1)
                                            END";

                        cmd.Parameters.AddWithValue("@From", _dateFrom);
                        cmd.Parameters.AddWithValue("@To", _dateTo);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public void GenerateUnitFeeSummary(EndDayTrails _endDayTrails)
        {
            try
            {
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        string _paramFund = "";
                        string _paramFundClient = "";

                        if (!_host.findString(_endDayTrails.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundFrom))
                        {
                            _paramFund = "And FundPK in ( " + _endDayTrails.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        if (!_host.findString(_endDayTrails.FundClientFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundClientFrom))
                        {
                            _paramFundClient = "And FundClientPK in ( " + _endDayTrails.FundClientFrom + " ) ";
                        }
                        else
                        {
                            _paramFundClient = "";
                        }

                        cmd.CommandText = @"
                        
                        DELETE [DailyDataForCommissionRpt]
                        where Mfeedate between @dateFrom and @Dateto " + _paramFund + _paramFundClient + @"

	
	                        DECLARE @StartDate datetime
                            Declare @EndDate DATETIME
    

                            set @StartDate =  dbo.FWorkingDay(@dateFrom,-3)
                            set @EndDate = dbo.fworkingday(@DateTo,-1)

                            CREATE table #FCP  
	                            (
	                                FundPK int,
		                            FundClientPK int,
		                            Unit numeric(22,4),
		                            UnitDate datetime,
		                            NAVDate datetime,
		                            MFeeDate DATETIME,
			                        MfeeMethod INT,
			                        CurrencyPK INT,
			                        SharingFeeCalculation INT,
			                        IsHoliday BIT,
			                        SellingAgentPK int
	                            )

                            insert into #FCP
                            Select A.FundPK,A.FundClientPK,sum(isnull(UnitAmount,0)) Unit,A.Date UnitDate,B.DT1 NAVDate,B.DT2 MFeeDate
	                        ,ISNULL(C.MFeeMethod,1)
	                        ,ISNULL(C.CurrencyPK,1) 
	                        ,ISNULL(C.SharingFeeCalculation,1) 
	                        ,ISNULL(B.IsHoliday,0) 
	                        ,ISNULL(D.SellingAgentPK,0) 
                            from FundClientPosition A
	                        LEFT JOIN ZDT_WorkingDays B ON A.Date = B.Date
	                        LEFT JOIN Fund C ON A.FundPK = C.FundPK AND C.status IN (1,2)
	                        LEFT JOIN FundClient D ON A.FundClientPK = D.FundClientPK AND D.status IN (1,2)
                            where A.Date between @StartDate and @EndDate

                            " + _paramFund + _paramFundClient + @"

                            group by A.FundPK,A.FundClientPK,A.Date,B.DT1,B.DT2,C.MFeeMethod,C.CurrencyPK,C.SharingFeeCalculation,B.IsHoliday
	                        ,D.SellingAgentPK
                            --having sum(isnull(UnitAmount,0)) > 1
                            order by MfeeDate

	


                            Declare @FlagDate datetime
                            Declare @CFundPK int
                            declare @CFundClientPK int



                            Declare @MaxMfeeDate datetime
                            Declare @MinMfeeDate datetime
                            Select @MinMfeeDate = min(UnitDate) From #FCP
                            Select @MaxMfeeDate = max(MFeeDate) From #FCP

                            Declare @UnitBal numeric(22,4)

                            --select * from #FCP
                            --order by unitdate asc


                            DECLARE @cDate TABLE
                            (
		                        Date Datetime
	                        )

	                        INSERT INTO @cDate
	                        Select distinct MFeeDate From #FCP


	                        DECLARE @CList TABLE
                            (
		                        FundPK INT,
		                        FundClientPK int
	                        )
	                        INSERT INTO @CList
	                        SELECT Distinct FundPK, FundClientPK FROM #FCP
	
	                        INSERT #FCP
	                                ( FundPK ,
	                                  FundClientPK ,
	                                  Unit ,
	                                  UnitDate ,
	                                  NAVDate ,
	                                  MFeeDate,
			                          IsHoliday,
			                          SellingAgentPK,
			                          CurrencyPK
			                          )
	        
	                        SELECT   B.FundPK,B.FundClientPK,CASE WHEN B.UnitDate < @StartDate THEN 0 ELSE  ISNULL(B.Unit,0) END
	                        ,A.DTM2 UnitDate,A.DTM1 NAVDate,A.Date,A.IsHoliday,ISNULL(C.SellingAgentPK,0),ISNULL(D.CurrencyPK,0)
	                        FROM dbo.ZDT_WorkingDays A
	                        LEFT JOIN #FCP B ON B.UnitDate = A.DTM2
	                        LEFT JOIN FundClient C ON B.FundClientPK = C.FundClientPK AND C.status IN (1,2)
	                        LEFT JOIN Fund D ON B.FundPK = D.FundPK AND D.status IN (1,2)
	                        WHERE A.Date NOT IN
		                        (
		                        SELECT Date FROM @cDate
		                        ) AND DAte BETWEEN @DateFrom AND @Dateto	
	                        AND B.FundPK IS NOT NULL
	                        AND A.Date BETWEEN @StartDate AND @EndDate
    
                        DECLARE @FCPDate TABLE
                        (
	                        Date DATETIME
                        )
                        INSERT INTO @FCPDate
                        SELECT DISTINCT MFeeDate FROM #FCP

                        INSERT INTO #FCP
                                ( FundPK ,
                                  FundClientPK ,
                                  Unit ,
                                  UnitDate ,
                                  NAVDate ,
                                  MFeeDate,
		                          IsHoliday,
		                          SellingAgentPK,
			                          CurrencyPK
                                )
                        SELECT B.FundPK,B.FundClientPK,0,A.DTM2,A.DTM1,Date,A.IsHoliday 
                        ,ISNULL(C.SellingAgentPK,0)
                        ,ISNULL(D.CurrencyPK,0)
                        FROM dbo.ZDT_WorkingDays A,@CList B
                        LEFT JOIN FundClient C ON B.FundClientPK = C.FundClientPK AND C.status IN (1,2)
                        LEFT JOIN Fund D ON B.FundPK = D.FundPK AND D.status IN (1,2)
                        WHERE A.Date BETWEEN @DateFrom AND @DateTo
                        AND A.Date NOT IN
                        (
                        SELECT Date FROM @FCPDate
                        )
                        AND A.Date BETWEEN @StartDate AND @EndDate
    

                        DECLARE @FPCFundAndDate TABLE
                        (
	                        FundPK INT,
	                        Date DATETIME
                        )

                        INSERT INTO @FPCFundAndDate
                        SELECT DISTINCT FundPK,MFeeDate FROM #FCP


                        DECLARE @LastFundInformation TABLE
                        (
	                        Date DATETIME,
	                        FundPK int,
	                        NAV NUMERIC(22,8),
	                        Days INT,
	                        FeePercent NUMERIC(18,8)
                        )

                        INSERT INTO @LastFundInformation
                        SELECT Date
                        ,FundPK
                        ,ISNULL(dbo.FgetLastCloseNav(Date,FundPK),0) 
                        ,ISNULL([dbo].[FgetManagementFeeDaysByDate](Date,FundPK),0)
                        ,ISNULL([dbo].[FgetManagementFeePercentByDate] (Date,FundPK),0)
                        FROM @FPCFundAndDate



                        DECLARE @FPCAgentAndDate TABLE
                        (
	                        Date DATETIME,
	                        AgentPK INT,
	                        FundPK INT
                        )

                        INSERT INTO @FPCAgentAndDate
                                ( Date, AgentPK, FundPK )
                        SELECT DISTINCT A.MFeeDate,ISNULL(B.SellingAgentPK,0),A.FundPk FROM #FCP A
                        LEFT JOIN FundClient B ON A.FundClientPK = B.FundClientPK AND B.status IN (1,2)



                        DECLARE @LastAgentInformaton TABLE
                        (
	                        Date DATETIME,
	                        FundPK int,
	                        AgentPK INT,
	                        FeePercent NUMERIC(18,8)
                        )
                        INSERT INTO @LastAgentInformaton
                                ( Date, FundPK, AgentPK, FeePercent )
                        SELECT Date,FundPK,AgentPK,ISNULL([dbo].[FgetAgentManagementFeePercent](Date,AgentPK,FundPK),0) FROM @FPCAgentAndDate

                        DECLARE @ClientRedemption TABLE
                        (
	                        ValueDate DATETIME,
	                        FundPK INT,
	                        FundClientPK INT,
	                        TotalUnitAmount NUMERIC(22,4),
	                        TotalCashAmount NUMERIC(22,4)
                        )

                        INSERT INTO @ClientRedemption
                                ( ValueDate ,
                                  FundPK ,
                                  FundClientPK ,
                                  TotalUnitAmount ,
                                  TotalCashAmount
                                )
                        Select ValueDate,FundPK,FundClientPK, sum(UnitAmount) TotalUnitAmount, sum(CashAmount) TotalCashAmount
                            from ClientRedemption where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
                            group by FundClientPK,ValueDate,FundPK

                        DECLARE @ClientSwitching TABLE
                        (
	                        ValueDate DATETIME,
	                        FundPK INT,
	                        FundClientPK INT,
	                        TotalUnitAmountFundTo NUMERIC(22,4),
	                        TotalCashAmountFundTo NUMERIC(22,4)
                        )

                        INSERT INTO @ClientSwitching
                                ( ValueDate ,
                                  FundPK ,
                                  FundClientPK ,
                                  TotalUnitAmountFundTo ,
                                  TotalCashAmountFundTo
                                )
                            Select ValueDate,FundPKTo FundPK,FundClientPK, sum(TotalUnitAmountFundTo) TotalUnitAmountFundTo, sum(TotalCashAmountFundTo) TotalCashAmountFundTo
                            from ClientSwitching where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
                            group by FundClientPK,ValueDate,FundPKTo




                        DECLARE @ClientSwitchingFrom TABLE
                        (
	                        ValueDate DATETIME,
	                        FundPK INT,
	                        FundClientPK INT,
	                        TotalUnitAmountFundFrom NUMERIC(22,4),
	                        TotalCashAmountFundFrom NUMERIC(22,4)
                        )
                        INSERT INTO @ClientSwitchingFrom
                                ( ValueDate ,
                                  FundPK ,
                                  FundClientPK ,
                                  TotalUnitAmountFundFrom ,
                                  TotalCashAmountFundFrom
                                )
                        Select ValueDate,FundPKFrom FundPK,FundClientPK, sum(UnitAmount) TotalUnitAmountFundFrom, sum(CashAmount) TotalCashAmountFundFrom
                        from ClientSwitching where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
                        group by FundClientPK,ValueDate,FundPKFrom


                        DECLARE @ClientSubscription TABLE
                        (
	                        ValueDate DATETIME,
	                        FundPK INT,
	                        FundClientPK INT,
	                        TotalUnitAmount NUMERIC(22,4),
	                        TotalCashAmount NUMERIC(22,4)
                        )

                        INSERT INTO @ClientSubscription
                                ( ValueDate ,
                                  FundPK ,
                                  FundClientPK ,
                                  TotalUnitAmount ,
                                  TotalCashAmount
                                )
                          Select ValueDate,FundPK,FundClientPK, sum(TotalUnitamount) TotalUnitAmount, sum(TotalCashAmount) TotalCashAmount
                            from ClientSubscription where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
                            group by FundClientPK,ValueDate,FundPK



		                        INSERT into [dbo].[DailyDataForCommissionRpt]
                                ( [UnitDate] ,
                                  [NAVDate] ,
                                  [MFeeDate] ,
                                  [FundPK] ,
                                  [FundClientPK] ,
                                  [NAV] ,
                                  [ManagementFeeAmount] ,
                                  [TrailFeeAmount] ,
                                  [AUM] ,
                                  [ManagementFeePercent] ,
                                  [RebateFeePercent] ,
                                  [CurrencyPK] ,
                                  [SubsUnit] ,
                                  [SubsAmount] ,
                                  [RedemptionUnit] ,
                                  [RedemptionAmount] ,
                                  [UnitAmount]
                                )




                        SELECT A.UnitDate,A.NAVDate,A.MFeeDate,A.FundPK
                        ,A.FundClientPK  
	
                        --NAV
                        ,case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
                        else  ISNULL(B.NAV,0)
                        end END
	
                        --MGT FEE
                        ,isnull(A.Unit  *  case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
                        else  B.NAV 
                        end END * B.FeePercent / 100 
                        / B.Days,0)

                        --SHARING FEE
                        ,isnull(Case when A.SharingFeeCalculation = 1 then A.Unit 
                        *  case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
                        else  ISNULL(B.NAV,0) 
                        end end else  K.UnitAmount * 
                            case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
                        ELSE case when A.IsHoliday = 1 THEN B.NAV ELSE Y.NAV END
                        end end end
                        * B.FeePercent / 100 
                        / B.Days * Z1.FeePercent / 100,0) 

                        --AUM
                        ,isnull(case when A.IsHoliday = 1 then isnull(L.UnitAmount,0)  else isnull(J.UnitAmount,0)  end 
                        * case when A.IsHoliday = 1 THEN ISNULL(B.NAV,0) ELSE ISNULL(Y.NAV,0) END,0) AUM

                        --MGTFeePercent
                        ,ISNULL(B.FeePercent,0) ManagementFeePercent

                        --RebateFeePercent
                        ,ISNULL(Z1.FeePercent,0) RebateFeePercent

                        ,isnull(A.CurrencyPK,'') Currency

                        ,isnull(I.TotalUnitAmount,0) + isnull(G.TotalUnitAmountFundTo,0) SubsUnit
                        ,isnull(I.TotalCashAmount,0) + isnull(G.TotalCashAmountFundTo,0) SubsAmount
                        ,isnull(F.TotalUnitAmount,0) + isnull(H.TotalUnitAmountFundFrom,0) RedempUnit
                        ,isnull(F.TotalCashAmount,0) + isnull(H.TotalCashAmountFundFrom,0) RedempAmount
                        , case when A.IsHoliday = 1 then isnull(L.UnitAmount,0)  else isnull(J.UnitAmount,0)  end UnitAmount
  
                        FROM #FCP A
                        Left join @LastFundInformation B on A.FundPK = B.FundPK and A.MFeeDate = B.Date 
                        left join FundClientPosition K on A.FundPK = K.FundPK and A.FundClientPK = K.FundClientPK and K.Date =  case when A.IsHoliday = 1 then A.UnitDate else A.NAVDate END
                        LEFT JOIN @LastAgentInformaton Z1 ON A.FundPK = Z1.FundPK AND A.MFeeDate = Z1.Date AND A.SellingAgentPK = Z1.AgentPK
                        Left join @LastFundInformation Y on A.FundPK = Y.FundPK and A.MFeeDate = Y.Date 
                        left join FundClientPosition J on A.FundPK = J.FundPK and A.FundClientPK = J.FundClientPK and J.Date =  A.NAVDate
                        left join FundClientPosition L on A.FundPK = L.FundPK and A.FundClientPK = L.FundClientPK and L.Date =  A.UnitDate
                        left join @ClientRedemption F on A.FundPK = F.FundPK and A.FundClientPK = F.FundClientPK and A.MFeeDate = F.ValueDate
                        left JOIN @ClientSwitching G on A.FundPK = G.FundPK and A.FundClientPK = G.FundClientPK and A.MFeeDate = G.ValueDate
                        left JOIN @ClientSwitchingFrom H on A.FundPK = H.FundPK and A.FundClientPK = H.FundClientPK and A.MFeeDate = H.ValueDate
                        left join @ClientSubscription I on A.FundPK = I.FundPK and A.FundClientPK = I.FundClientPK and A.MFeeDate = I.ValueDate
                        WHERE A.MFeeDate BETWEEN @dateFrom AND @DateTo
                        ORDER BY A.MFeeDate ASC

                        SELECT * FROM dbo.DailyDataForCommissionRpt
                        WHERE MFeeDate BETWEEN @DateFrom AND @DateTo
                        ORDER BY MFeeDate asc";

                        cmd.CommandTimeout = 0;
                        cmd.Parameters.AddWithValue("@DateFrom", _endDayTrails.ValueDateFrom);
                        cmd.Parameters.AddWithValue("@DateTo", _endDayTrails.ValueDateTo);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }



        public int EndDayTrails_GenerateUnitOnly(string _usersID, DateTime _valueDate)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  
-- VOID EDT UNIT ONLY
update EndDayTrails set status = 3,VoidUsersID = @UsersID,VoidTime = @LastUpdate,LastUpdate=@lastUpdate    
where ValueDate = @ValueDate  and status = 2  and Notes = 'Unit'
                         
Update ClientSubscription set status = 3 where Valuedate = dbo.FWorkingDay(@ValueDate,1) and  [type] = 2
 
update CloseNav set status = 3,VoidUsersID = @UsersID ,VoidTime= @LastUpdate, LastUpdate = @LastUpdate 
where Date = @ValueDate and status <> 3
-------------------------------------------------------------

Declare @MSG nvarchar (Max)   
Declare @PeriodPK int                  
Declare @maxEndDayTrailsPK int    
Declare @DateYesterday datetime 
Declare @DefaultCashAtBankPK int


set @DefaultCashAtBankPK = 3

Select  @DateYesterday  = ValueDate From enddaytrails
where status = 2 and valuedate =(
Select Max(valueDate) From EnddayTrails where status = 2 and ValueDate < @ValueDate
)


Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                
Select @maxEndDayTrailsPK = ISNULL(EndDayTrailsPK,0) + 1 from EndDayTrails     

set @maxEndDayTrailsPK = isnull(@maxEndDayTrailsPK,1)               


Insert into EndDayTrails(EndDayTrailsPK,HistoryPK,Status,Notes,ValueDate,BitValidate,LogMessages
,EntryUsersID,EntryTime,LastUpdate)                    
Select @maxEndDayTrailsPK,1,2,'Unit',@ValueDate,0,'',@UsersID,@LastUpdate,@LastUpdate  

---- NEW -----
if Not Exists(              
Select * from CloseNAV where Status = 2 and date = @DateYesterday             
)              
BEGIN              
Set @MSG = 'MISSING DATA: Close NAV Yesterday'              
Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1 and Notes = 'Unit'              
Select @maxEndDayTrailsPK LastPK                   
RETURN;                   
END              




-- D. COPY FUND CLIENT POSITION --    
    

if not exists(
	select * from FundClientPosition where date = dbo.FWorkingDay(@ValueDate, 1)
)
BEGIN

    
Declare @CPFundPK int           
Declare A Cursor For              
Select FundPK From Fund Where status = 2              
Open  A              
Fetch Next From  A              
into @CPFundPK              
While @@Fetch_Status = 0              
BEGIN              
Insert into FundClientPosition(Date,FundClientPk,FundPK,CashAmount,UnitAmount,LastUpdate)              
Select dbo.FWorkingDay(@ValueDate, 1),FundClientPK,FundPK,CashAmount,UnitAmount,@LastUpdate              
From FundClientPosition where Date = @ValueDate and FundPK = @CPFundPK           
Fetch next From A                   
Into @CPFundPK              
END                  
Close A                  
Deallocate A


END    

  UPDATE A 
SET A.AvgNAV = dbo.FGetAVGForFundClientPosition(@ValueDate,A.FundClientPK,A.FundPK), A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
FROM FundClientPosition A
    LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
    LEFT JOIN FundClientPosition C ON A.FundPK = C.FundPK AND A.FundClientPK = C.FundClientPK AND C.Date = @DateYesterday
WHERE A.Date = @ValueDate

--UPDATE A 
--SET A.AUM = ISNULL(B.AUM,0),A.AvgNAV = ISNULL(B.AvgNAV,0) 
--FROM dbo.FundClientPositionSummary A
--    LEFT JOIN dbo.FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK AND B.Date  = @ValueDate



Declare @MaxEDT datetime
Select @MaxEDT = max(Valuedate) from EndDayTrails where status = 2

set @MaxEDT = dbo.FWorkingDay(@MaxEDT,1)

--truncate table FundClientPositionSummary

--Insert into FundClientPositionSummary(userID,FundPK,FundClientPK,Unit,LastUpdate,AvgNAV,AUM,FirstNAV)

--Select @UsersID,A.FundPK,A.FundClientPK,isnull(A.UnitAmount,0) - isnull(B.UnitAmount,0) - isnull(C.UnitAmount,0),getdate(),A.AvgNAV,0,0 from FundClientPosition A
--left join (
--	SELECT FundClientPK,FundPK, sum(isnull(case when UnitAmount > 0 then UnitAmount else CashAmount / dbo.FgetLastCloseNav(NAVDate,FundPK) end,0)) UnitAmount FROM ClientRedemption  WHERE status not in (3,4) and posted = 0 and Revised = 0
--	group by FundClientPK,FundPK
--) B on A.FundClientPK = B.FundClientPK and A.FundPK = B.FundPK 

--left join 
--(
--	SELECT FundClientPK,FundPKFrom, sum(isnull(case when UnitAmount > 0 then UnitAmount else CashAmount / dbo.FgetLastCloseNav(NAVDate,FundPKFrom) end,0)) UnitAmount FROM ClientSwitching  WHERE status not in (3,4) and posted = 0 and Revised = 0
--	group by FundClientPK,FundPKFrom
--) C on A.FundClientPK = C.FundClientPK and A.FundPK = C.FundPKFrom 
--where Date = @MaxEDT  


-------------------------------------------
                        
 
                

Declare @ClientSubscriptionPK int
Declare @ClientRedemptionPK int
Declare @DateWorkingTo datetime

set @DateWorkingTo = dbo.FWorkingDay(@ValueDate, 1)

Create table #dayTemp
(
IntDay  int
)

WHILE (@Valuedate < @DateWorkingTo)
BEGIN
set @Valuedate = DATEADD(day,1,@Valuedate)
insert into #dayTemp
Select day(@Valuedate)
END

select @ClientSubscriptionPK = isnull(max(ClientSubscriptionPK),0)  + 1 from ClientSubscription
select @ClientRedemptionPK = isnull(max(ClientRedemptionPK),0)  + 1 from ClientRedemption
    
INSERT INTO [dbo].[ClientSubscription]    
([ClientSubscriptionPK],[HistoryPK],[Status],[NAVDate],[ValueDate],   
[NAV],[FundPK],[FundClientPK],[CashRefPK],[CurrencyPK],[Description],[CashAmount],[UnitAmount],[TotalCashAmount],[TotalUnitAmount],   
[SubscriptionFeePercent],[SubscriptionFeeAmount],[AgentPK],[AgentFeePercent],[AgentFeeAmount],[Type],[AutoDebitDate],[EntryUsersID],[EntryTime],[LastUpdate])   
select @ClientSubscriptionPK + ROW_NUMBER() OVER(ORDER BY A.FundClientPK ASC),1,1,@DateWorkingTo,@DateWorkingTo,   
0,FundPK,A.FundClientPK,FundCashRefPK,1,'',GrossAmount,0,NetAmount,0,    
FeePercent,FeeAmount,isnull(B.SellingAgentPK,0),0,0,2,@ValueDate,@UsersID,@LastUpdate,@LastUpdate    
From RegulerInstruction A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.Status = 2
where AutoDebitDate in (
select IntDay From #dayTemp
) and  A.status = 2 and A.TrxType = 1

INSERT INTO [dbo].[ClientRedemption]    
([ClientRedemptionPK],[HistoryPK],[Status],[NAVDate],[ValueDate],   
[NAV],[FundPK],[FundClientPK],[CashRefPK],[CurrencyPK],[Description],[CashAmount],[UnitAmount],[TotalCashAmount],[TotalUnitAmount],   
[RedemptionFeePercent],[RedemptionFeeAmount],[AgentPK],[AgentFeePercent],[AgentFeeAmount],[BankRecipientPK],[Type],[EntryUsersID],[EntryTime],[LastUpdate])   
select @ClientRedemptionPK + ROW_NUMBER() OVER(ORDER BY A.FundClientPK ASC),1,1,@DateWorkingTo,@DateWorkingTo,   
0,FundPK,A.FundClientPK,FundCashRefPK,1,'',GrossAmount,0,NetAmount,0,    
FeePercent,FeeAmount,isnull(B.SellingAgentPK,0),0,0,BankRecipientPK,2,@UsersID,@LastUpdate,@LastUpdate    
From RegulerInstruction A left join FundClient B on A.FundClientPK = B.FundClientPK and B.Status = 2
where AutoDebitDate in (
select IntDay From #dayTemp
) and  A.status = 2 and A.TrxType = 2

--Update EndDayTrails set BitValidate = 1,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1    

Select @maxEndDayTrailsPK LastPK  
                             
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);

                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToInt32(dr["LastPK"]);

                            }
                            return 0;
                        }

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }

        public bool Validate_GenerateYesterday(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        cmd.CommandText = @" IF
		                                     Not Exists(select * From EndDayTrails where Status = 2 and ValueDate = dbo.FWorkingDay(@Valuedate,-1))	
											 BEGIN Select 1 Result END ELSE 
											 BEGIN   
                                            Select 0 Result END   ";



                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public int EndDayTrails_GenerateFundJournalOnly(string _usersID, DateTime _valueDate)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  
--VOID EDT FUND JOURNAL ONLY

update FundJournal set Posted = 0,Status = 3,VoidUsersID = @UsersID ,VoidTime= @lastUpdate, LastUpdate = @LastUpdate 			
where  Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION' and TrxNo =
(
Select EndDayTrailsPK from EndDayTrails where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal'
)

update EndDayTrails set status = 3,VoidUsersID = @UsersID,VoidTime = @LastUpdate,LastUpdate=@lastUpdate    
where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal'  
                        

                         
update CloseNav set status = 3,VoidUsersID = @UsersID ,VoidTime= @LastUpdate, LastUpdate = @LastUpdate 
where Date = @ValueDate and status <> 3

-------------------



Declare @MSG nvarchar (Max)   
Declare @PeriodPK int                  
Declare @maxEndDayTrailsPK int    
Declare @DateYesterday datetime 
Declare @DefaultCashAtBankPK int


set @DefaultCashAtBankPK = 3

Select  @DateYesterday  = ValueDate From enddaytrails
where status = 2 and valuedate =(
Select Max(valueDate) From EnddayTrails where status = 2 and ValueDate < @ValueDate
)


Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                
Select @maxEndDayTrailsPK = ISNULL(EndDayTrailsPK,0) + 1 from EndDayTrails     

set @maxEndDayTrailsPK = isnull(@maxEndDayTrailsPK,1)               

Create Table #Mature
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Create Table #RecCoupon
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),LastCouponDate datetime,NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Insert into EndDayTrails(EndDayTrailsPK,HistoryPK,Status,Notes,ValueDate,BitValidate,LogMessages
,EntryUsersID,EntryTime,LastUpdate)                    
Select @maxEndDayTrailsPK,1,2,'Fund Journal',@ValueDate,1,'',@UsersID,@LastUpdate,@LastUpdate  

---- NEW -----
if Not Exists(              
Select * from CloseNAV where Status = 2 and date = @DateYesterday             
)              
BEGIN              
Set @MSG = 'MISSING DATA: Close NAV Yesterday'              
Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1  and Notes = 'Fund Journal'             
Select @maxEndDayTrailsPK LastPK                   
RETURN;                   
END              

--if Not Exists(              
--Select * from ClosePrice where Status = 2 and date = @ValueDate              
--)              
--BEGIN              
--Set @MSG = 'MISSING DATA: Close Price Today'              
--Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1               
--Select @maxEndDayTrailsPK LastPK                   
--RETURN;                   
--END    


Declare @BDateFrom datetime
Declare @BTotalDays int

select @BDateFrom = DateFrom from Period where @ValueDate between DateFrom and DateTo and status = 2
select @BTotalDays = datediff(Day,@BDateFrom,dateadd(year,1,@BDateFrom))

-- Parameter untuk masuk Ke Jurnal                  
Declare @InvestmentAcc   int                  
Declare @PayablePurchaseAcc  int                  
Declare @CashAtBankAcc   int                  
Declare @CommissionAcc   int                  
Declare @LevyAcc    int                  
Declare @VatAcc     int                  
Declare @WhtAcc     int                  
                
Declare @TaxExpenseAcc   int                  
Declare @WHTTaxPayableAccrInterest int     
Declare @InterestRecAcc int 
--BOND
Declare @InvestmentAccBond   int 
Declare @InterestRecBuySellAccBond int      
Declare @InterestRecAccBond   int 
Declare @RealisedAccBond int   
Declare @ReceivableSaleAccBond int 
Declare @TaxCapitalGainAccBond int 
Declare @TaxInterestAccBond int 

-- Sell              
Declare @ReceivableSaleAcc int              
Declare @RealisedAcc int              
Declare @IncomeSaleTaxAcc int                 
-- Untuk variabel Posting                  
Declare @PValueDate        datetime                  
Declare @PPeriodPK        int                  
Declare @PReference        nvarchar(50)                  
Declare @PTrxType        int                
Declare @PCounterpartPK       int                  
Declare @PInstrumentPK       int                  
Declare @PInstrumentTypePK      int                  
Declare @PFundPK        int                  
Declare @PFundCashRefPK       int                  
Declare @PDoneAccruedInterest  Numeric(18,6)                  
Declare @PSettlementDate      Datetime       
Declare @PAcqDate      Datetime            
Declare @PDoneVolume       numeric(18,0)   
Declare @PAmount       numeric(18,0)               
Declare @PDoneAmount       numeric(18,0)                  
Declare @PCommissionAmount      numeric(18,6)                  
Declare @PLevyAmount       numeric(18,6)                  
Declare @PKPEIAmount       numeric(18,6)                  
Declare @PVATAmount        numeric(18,6)                  
Declare @PWHTAmount        numeric(18,6)                  
Declare @POTCAmount        numeric(18,6)                   
Declare @PIncomeTaxSellAmount     numeric(18,6)                   
Declare @PIncomeTaxInterestAmount    numeric(18,6)                   
Declare @PIncomeTaxGainAmount     numeric(18,6) 
Declare @PTotalAmount       numeric(19,6)                   
Declare @PCurrencyRate       numeric(18,8)                  
Declare @InstrumentType int                  
Declare @FundJournalPK int                  
Declare @InstrumentID nvarchar(30)                  
Declare @FPayablePurchaseAmount numeric(19,6)                  
Declare @InstrumentCurrencyPK int     
Declare @BondDayAccrued int      
Declare @PInterestPercent Numeric(22,6)          

Declare @SellAvgPrice numeric(18,6)  
Declare @AvgAmount numeric(22,6)              
Declare @RealisedAmount numeric(22,6)
Declare @InvestmentShareAmount numeric(22,6)   
Declare @ReceivableSellBondAmount numeric(22,6)    

Declare @PTaxExpenseAmount numeric(22,6) 
Declare @PTaxExpensePercent numeric(22,6) 
Declare @PInterestAmount numeric(22,6) 
Declare @PFinalAmount numeric(22,6)
     
Declare @WHTDueDate int
               
-- A. Posting Investment   
-- 1. BUY EQUITY --  
-- 2. SELL EQUITY --
-- 3. BUY BOND -- 
-- 4. SELL BOND -- 
-- 5. PLACEMENT DEPOSITO -- 
-- 6. LIQUIDATE DEPOSITO -- 
-- 7. ROLLOVER DEPOSITO -- 


-- B. Daily Fee dan Payment Fee 	 	            
-- 1. GENERATE DAILY FEE --    
-- 2. PAYMENT FEE -- 
-- 3. BANK INTEREST --
	                       
-- C. Reval, Interest Accrued Bond, Interest Accrued Time Deposit, Mature Bond, Mature Time Deposit
-- 1. REVALUATION EQUITY & BOND --   
-- 2. GENERATE INTEREST ACCRUED BOND           
-- 3. MATURE TIME DEPOSIT YANG BELOM SAMPE UJUNG           
-- 4. MATURE BOND & TIME DEPOSIT
-- 5. REC COUPON BOND
	
-- D. Copy Fund Client Position 

-- E. Pending Subscription

-- A. POSTING INVESTMENT --        

Declare @PBreakInterestPercent numeric(8,4)
Declare @PSettlementPK int

Declare A Cursor For                  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                   
FundPK,FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,Amount,DoneAmount,                  
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                  
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate            
From Investment         
Where StatusSettlement = 2 and Posted = 0 and Valuedate in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday)              
Open A                  
Fetch Next From A                  
Into @PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,
@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount
,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount
,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,@PBreakInterestPercent,@PSettlementPK ,@PTaxExpensePercent,@PInterestPercent,@PAcqDate             
While @@FETCH_STATUS = 0                  
Begin                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK              
-- 1 = REGULER                  
-- 2 = G-BOND                  
-- 3 = C-BOND                  
-- 4 = RI                  
-- 5 = DEPOSITO                  
-- 6 = WARRANT 
                
-- A1. BUY EQUITY --                 
if @PTrxType = 1 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentEquity,@PayablePurchaseAcc = PayablePurchaseEquity 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 EQUITY BUY: ' + @InstrumentID 
,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled EQUITY BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A2. SELL EQUITY --              
if @PTrxType = 2 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentEquity,@ReceivableSaleAcc = AccountReceivableSaleEquity,@RealisedAcc = RealisedEquity From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             

Declare @SellArAmount numeric(22,6) 
    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

-- A3. BUY BOND --                  
if @PTrxType = 1 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15)                 
BEGIN  
              
-- 2 = G-BOND                  
-- 3 = C-BOND                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                                           

if @InstrumentType in (2,3,8,9,11,13,14,15)          
BEGIN                  
Select @InvestmentAcc = InvestmentBond,@InterestRecAcc = InterestRecBond,@PayablePurchaseAcc = PayablePurRecBond, 
@WHTTaxPayableAccrInterest = WHTTaxPayableAccrInterestBond,@BondDayAccrued = InterestAccrBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                   
END                  
                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
	
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PAmount,                   
@PAmount,0,1,@PAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,2,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,3,1,2,@WHTTaxPayableAccrInterest,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,                
0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,1,0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WHTTaxPayableAccrInterest and Status = 2                  

set @FPayablePurchaseAmount = @PAmount + isnull(@PDoneAccruedInterest,0) - isnull(@PIncomeTaxGainAmount,0) 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

-- T Settled                
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
	
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PTotalAmount,                   
@PTotalAmount,0,1,@PTotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,3,1,2,@BondDayAccrued,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BondDayAccrued and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                  
END                  

-- A4.SELL BOND --
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15) 
BEGIN               
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
Select @InvestmentAccBond = InvestmentBond,@InterestRecBuySellAccBond = InterestRecBond,@InterestRecAccBond = InterestAccrBond,
@RealisedAccBond = RealisedBond, @ReceivableSaleAccBond = AccountReceivableSaleBond,
@TaxCapitalGainAccBond = TaxCapitalGainBond,@TaxInterestAccBond = WithHoldingTaxPPH23
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
                                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

set @PTaxExpenseAmount = (@PTaxExpensePercent / 100) * @PDoneAccruedInterest                  
set @PFinalAmount = @PDoneAccruedInterest - @PTaxExpenseAmount   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                 
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


declare @BondSellAmount numeric (19,2)

set @BondSellAmount = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)/100 * @PDoneVolume


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InvestmentAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@BondSellAmount,                   
0,@BondSellAmount,1,0,@BondSellAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAccBond and Status = 2    



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
--,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
--Select @FundJournalPK,2,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
--0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                  



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,3,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxGainAmount,                   
@PIncomeTaxGainAmount,0,1,@PIncomeTaxGainAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2        


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,4,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxInterestAmount,                   
@PIncomeTaxInterestAmount,0,1,@PIncomeTaxInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2            

         
	
--Select @SellAvgPrice = AvgPrice From FundPosition where Date = @DateYesterday and Status =  2 and FundPK = @PFundPK and InstrumentPK = @PInstrumentPK                              
--set @AvgAmount = (@SellAvgPrice/100) * @PDoneVolume              
--set @RealisedAmount = abs(@PDoneAmount - @AvgAmount)
set @RealisedAmount = abs(@PDoneAmount - @BondSellAmount)



-- Gain Realised
if @BondSellAmount > @PDoneAmount              
Begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
		@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                  

	set  @ReceivableSellBondAmount = @BondSellAmount - @RealisedAmount +@PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount               
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
End       
     
-- Loss Realised
if @BondSellAmount <= @PDoneAmount              
begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
		0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                 
			 
	set  @ReceivableSellBondAmount = @BondSellAmount + @RealisedAmount + @PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount              
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
end     

                        

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,6,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T Settled       
         
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@ReceivableSellBondAmount,                   
0,@ReceivableSellBondAmount,1,0,@ReceivableSellBondAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,3,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,4,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),                   
0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount) ,1,0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,5,1,2,@TaxInterestAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,                   
0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,1,0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxInterestAccBond and Status = 2                



END 

-- A5.PLACEMENT DEPOSITO & ROLLOVER DEPOSITO          
if @PTrxType in (1,3) and @PInstrumentTypePK in (5,10) -- 5 Deposito biasa 10 NCD
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                           

if @InstrumentType in (5,10)                  
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                                    

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                 

IF dbo.CheckTodayIsHoliday (@PValueDate) = 1
BEGIN
    select @PValueDate = dbo.Fworkingday(@PValueDate, 1)
END


-- T0                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                   

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
END                  

-- A6. LIQUIDATE DEPOSITO --            
if @PTrxType = 2 and @PInstrumentTypePK in (5,10)                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
	
if @InstrumentType in (5,10)
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T0              
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                        

Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               
	
	
-- LOGIK BREAK INTEREST DISINI
	
Declare @IncomeDeposito int
Declare @ARInterestDeposito int
Declare @TaxDeposito int
    
Select @ARInterestDeposito = InterestAccrTimeDeposit,@IncomeDeposito = IncomeInterestTimeDeposit, 
@TaxDeposito = TaxExpenseInterestIncomeTimeDeposit
From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
	
Declare @ARInterestDepositoAmount numeric(22,4)
Declare @IncomeDepositoAmount numeric(22,4)
Declare @TaxDepositoAmount numeric(22,4)


set @IncomeDepositoAmount = [dbo].FGetDepositoInterestAccruedForPayment (@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,DateAdd(day,1,@PAcqDate),1,@ValueDate,1)
set @ARInterestDepositoAmount = 0.8 * @IncomeDepositoAmount
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount

--set @ARInterestDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@ARInterestDeposito,@PInstrumentPK,@PFundPK)
--set @IncomeDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@IncomeDeposito,@PInstrumentPK,@PFundPK)
--set @TaxDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@TaxDeposito,@PInstrumentPK,@PFundPK)
	

if @PBreakInterestPercent > 0


BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @IncomeDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'D',@IncomeDepositoAmount,                   
	@IncomeDepositoAmount,0,1,@IncomeDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

if @ARInterestDepositoAmount > 0
BEGIN

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,                   
	0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    
END
IF (@IncomeDeposito <> @TaxDeposito)
BEGIN
    if @TaxDepositoAmount > 0
    BEGIN
	    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	    Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	    0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    
    END


END
ELSE
BEGIN
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

Declare @BDNewInterestAmount numeric(22,4)
Declare @BDBalance numeric(22,4)
Declare @BDInterestDaysType int
Declare @BDInterestPercent numeric(8,4)
Declare @BDAcqDate datetime
Declare @BDInterestPaymentType int
Declare @BDMaturityDate datetime
Declare @BDPaymentModeOnMaturity int
Declare @BDTaxPercent numeric(8,4)

Select @BDBalance = Balance,@BDInterestDaysType = InterestDaysType
,@BDInterestPercent = InterestPercent
,@BDAcqDate = AcqDate
,@BDInterestPaymentType = InterestPaymentType
,@BDMaturityDate = MaturityDate
,@BDPaymentModeOnMaturity = PaymentModeOnMaturity
,@BDTaxPercent = TaxExpensePercent
From FundPosition where Date = @DateYesterday and InstrumentPK = @PInstrumentPK


set @BDNewInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment](@ValueDate,@PInstrumentPK,@BDBalance,@BDInterestDaysType,@PBreakInterestPercent,@BDAcqDate,@BDInterestPaymentType,@ValueDate,@BDPaymentModeOnMaturity)
		
if @BDNewInterestAmount > 0
BEGIN
	Declare @BDTaxAmount numeric(22,4)
	Declare @BDIncomeAmount numeric(22,4)
	set @BDTaxAmount = @BDNewInterestAmount * @BDTaxPercent/100
	set @BDIncomeAmount = @BDNewInterestAmount - @BDTaxAmount
					
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
				
	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
		@PReference,'LIQUIDATE NEW INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDIncomeAmount,                   
	@BDIncomeAmount,0,1,@BDIncomeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2        
				
		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'C',@BDNewInterestAmount,0,@BDNewInterestAmount,1,0,@BDNewInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDTaxAmount,@BDTaxAmount,0,1,@BDTaxAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    

END
END
ELSE
BEGIN

set @IncomeDepositoAmount = dbo.FGetDepositoInterestAccrued(@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,@ValueDate)
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount


select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @ARInterestDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,                   
	@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount ,0,1,@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@TaxDepositoAmount,                   
	@TaxDepositoAmount,0,1,@TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2             

 		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
 	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

 		Select  @FundJournalPK,4,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@IncomeDepositoAmount,
    0,@IncomeDepositoAmount,1,0,@IncomeDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2

END
END
	

END  

	           
Fetch next From A Into                  
@PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,
@PBreakInterestPercent,@PSettlementPK,@PTaxExpensePercent,@PInterestPercent,@PAcqDate       
END                  
Close A                  
Deallocate A                
-------------------------------------------------------------------------------------------------------------------
-- B. DAILY FEE & PAYMENT FEE --

Create Table #ZFundFee               
(                  
DateOfPayment int,  
FundPK int,                  
ManagementFeePercent numeric(18,8),
CustodiFeePercent numeric(18,8),
AuditFeeAmount numeric(18,4),
MovementFeeAmount numeric(18,4),
ManagementFeeDays int,
CustodiFeeDays int,
AuditFeeDays int,
SinvestFeeDays int,
FundType int,
BitSinvestFee bit,
OtherFeeOneAmount numeric(18,4),
OtherFeeTwoAmount numeric(18,4),
)   

Declare @DecimalPlaces   int                  
Declare @RoundingMode   int                  
Declare @FundID     nvarchar(50)       
Declare @LastEndDayTrailsDate datetime       

Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                

Declare @ManagementFeeExpAcc    int                  
Declare @CustodianFeeExpAcc     int                  
Declare @AuditFeeExpAcc      int    
Declare @SinvestFeeExpAcc      int   
Declare @MovementFeeExpAcc    int                
Declare @PayableManagementFeeAcc   int                  
Declare @PayableCustodianFeeAcc    int                  
Declare @PayableAuditFeeAcc     int      
Declare @PayableSinvestFeeAcc     int
Declare @PayableMovementFeeAcc     int                
               
Declare @feeDays  int          
Declare @PayableSubscriptionFee int,@PayableRedemptionFee int
declare @BPayableSwitchingFee int
    

Select @feeDays =  DateDiff(day,ValueDate,@ValueDate),@LastEndDayTrailsDate = ValueDate From EndDayTrails              
Where ValueDate = 
(
Select Max(ValueDate) From EndDayTrails Where ValueDate < @ValueDate and status = 2 
)  

set @feeDays = isnull(@feeDays,0)         

Declare @BFundPK int                  
Declare @BManagementFeePercent numeric(18,6)                  
Declare @BCustodiFeePercent  numeric(18,6)                  
Declare @BAuditFeePercent  numeric(18,6) 


Declare @BSinvestFeePercent  numeric(18,8) 

Declare @BManagementFeeDays  int                  
Declare @BCustodiFeeDays  int                  
Declare @BAuditFeeDays   int   
Declare @BSinvestFeeDays  int   
Declare @BFundType  int    
Declare @BBitSinvestFee  bit         

     

Declare @BDateOfPayment  int                  
Declare @BAum     numeric(22,8)                  
Declare @BManagementFeeAmount numeric(18,6)                  
Declare @BCustodiFeeAmount  numeric(18,6)                  
Declare @BAuditFeeAmount  numeric(18,6)   
Declare @BMovementFeeAmount  numeric(18,6)      

Declare @BSinvestFeeAmount  numeric(18,8)                  

Declare @BPayableSubscriptionFeeAmount numeric(18,6)
Declare @BPayableRedemptionFeeAmount numeric(18,6)
Declare @BPayableSwitchingFeeAmount numeric(18,6)

Declare @BOtherFeeOneAmount  numeric(18,6) 
Declare @BOtherFeeTwoAmount  numeric(18,6) 

Declare @BPayableOtherFeeOne  int    
Declare @BPayableOtherFeeTwo  int   
Declare @BOtherFeeOneExpense  int    
Declare @BOtherFeeTwoExpense  int 



Declare @FundFeeSetup Table
(
	FundPK int,
	MIFeePercent numeric(18,8)
)

insert into @FundFeeSetup
select FundPK,MiFeePercent from FundFeeSetup A
where A.Date = (
Select max(date) from FundFeeSetup B where B.date	<= @ValueDate     and B.status = 2 and A.FundPK = B.FundPK
) and A.status in (1,2)


insert into #ZFundFee
Select DateOfPayment,A.FundPK,D.MIFeePercent,CustodiFeePercent,
AuditFeeAmount,MovementFeeAmount, @BTotalDays,@BTotalDays,@BTotalDays,@BTotalDays,Type,B.BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount                  
From FundFee A
left join Fund B on A.FundPK = B.FundPK and B.Status = 2
left join @FundFeeSetup D on A.FundPK = D.FundPK
Where A.status = 2 and A.Date = (
Select max(date) from FundFee C where C.date	<= @ValueDate     and C.status = 2 and A.FundPK = C.FundPK
) 


Declare B Cursor For                  
Select FundPK,ManagementFeePercent ,CustodiFeePercent ,
 AuditFeeAmount,MovementFeeAmount, ManagementFeeDays ,CustodiFeeDays,AuditFeeDays,SInvestFeeDays,DateOfPayment,FundType,BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount   from #ZFundFee 
Open B                  
Fetch Next From B                  
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount, @BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount                   
While @@FETCH_STATUS = 0                  
Begin                  
Select @ManagementFeeExpAcc = ManagementFeeExpense, @CustodianFeeExpAcc =CustodianFeeExpense , @AuditFeeExpAcc = AuditFeeExpense,@MovementFeeExpAcc = MovementFeeExpense,                  
@PayableManagementFeeAcc = PayableManagementFee,@PayableCustodianFeeAcc = PayableCustodianFee,@PayableAuditFeeAcc = PayableAuditFee,@PayableMovementFeeAcc = PayableMovementFee    
,@PayableSubscriptionFee = PayableSubscriptionFee,@PayableRedemptionFee = PayableRedemptionFee 
,@BPayableSwitchingFee = PayableSwitchingFee,@PayableSinvestFeeAcc = PayableSInvestFee, @SinvestFeeExpAcc = SInvestFee
,@BPayableOtherFeeOne = PayableOtherFeeOne, @BPayableOtherFeeTwo = PayableOtherFeeTwo,@BOtherFeeOneExpense = OtherFeeOneExpense, @BOtherFeeTwoExpense = OtherFeeTwoExpense             
From FundAccountingSetup Where Status = 2    and FundPK = @BFundPK    

-- B1. GENERATE DAILY FEE                  
set @BAum = 0


Select @BAum =  AUM From CloseNAV where Date = @DateYesterday and Status =  2 and FundPK = @BFundPK                  
Select @DecimalPlaces = JournalDecimalPlaces, @RoundingMode = JournalRoundingMode, @FundID = A.ID From Fund A 
left join BankBranch B on A.BankBranchPK = B.BankBranchPK and B.status = 2
left join Bank C on B.BankPK = C.BankPK and C.status = 2
where A.Status = 2 and A.FundPK = @BFundPK             


--1	STRUCTURED FUND : GUARANTEED FUND ok
--2	FIXED INCOME FUND ok
--3	MONEY MARKET FUND ok
--4	STRUCTURED FUND : CAPITAL PROTECTED FUND ok
--5	EQUITY FUND ok
--6	STRUCTURED FUND : INDEX FUND ok
--7	CIC ASSET BACKED SECURITIES ok
--8	DISCETIONARY FUND ok
--9	MIXED ASSET FUND ok
--10 EXCHANGE TRADED FUND ok
--11 REAL ESTATE INVESTMENT TRUST ok
--12 PRIVATE EQUITY FUND ok

Select @BSinvestFeeDays = SinvestFeeDays from SInvestSetup where status = 2

IF (@BFundType in (1,3,4,6,8,11,12))
BEGIN
	Select @BSinvestFeePercent = SinvestMoneyMarketFeePercent from SInvestSetup where status = 2
END
ELSE IF (@BFundType in (2,7,9))
BEGIN
	Select @BSinvestFeePercent = SinvestBondFeePercent from SInvestSetup where status = 2
END
ELSE
BEGIN
	Select @BSinvestFeePercent = SinvestEquityFeePercent from SInvestSetup where status = 2
END



-- 1 = UP, 2 = DOWN , 3 = NONE                  	
If @RoundingMode = 1                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(CEILING((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0) * @FeeDays                      
Set @BCustodiFeeAmount = isnull(CEILING((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0)  * @FeeDays  
Set @BSinvestFeeAmount = isnull(CEILING((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(CEILING(@BAuditFeeAmount),0)  * @FeeDays  
Set @BMovementFeeAmount = isnull(CEILING(@BMovementFeeAmount),0)  * @FeeDays   
Set @BOtherFeeOneAmount = isnull(CEILING(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(CEILING(@BOtherFeeTwoAmount),0)  * @FeeDays                
END                  

If @RoundingMode = 2                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(FLOOR((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0)  * @FeeDays                    
Set @BCustodiFeeAmount = isnull(FLOOR((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0) * @FeeDays 
Set @BSinvestFeeAmount = isnull(FLOOR((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays  
END
Set @BAuditFeeAmount = isnull(FLOOR(@BAuditFeeAmount),0)  * @FeeDays 
Set @BMovementFeeAmount = isnull(FLOOR(@BMovementFeeAmount),0)  * @FeeDays  
Set @BOtherFeeOneAmount = isnull(FLOOR(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(FLOOR(@BOtherFeeTwoAmount),0)  * @FeeDays               
END                  

If @RoundingMode = 3                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(ROUND((@BAum * (@BManagementFeePercent/100))/@BManagementFeeDays,@DecimalPlaces),0)  * @FeeDays                 
Set @BCustodiFeeAmount = isnull(ROUND((@BAum * (@BCustodiFeePercent/100))/@BCustodiFeeDays,@DecimalPlaces),0)    * @FeeDays   
Set @BSinvestFeeAmount = isnull(ROUND((@BAum * (@BSinvestFeePercent/100))/@BSinvestFeeDays,@DecimalPlaces),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(@BAuditFeeAmount,0)  * @FeeDays    
Set @BMovementFeeAmount = isnull(@BMovementFeeAmount,0)  * @FeeDays      
Set @BOtherFeeOneAmount = isnull(@BOtherFeeOneAmount,0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(@BOtherFeeTwoAmount,0)  * @FeeDays       
END                  





if isnull(@BAum,0) = 0
begin
set @BManagementFeeAmount = 0
set @BCustodiFeeAmount = 0
set @BAuditFeeAmount = 0
set @BMovementFeeAmount = 0
set @BSinvestFeeAmount = 0
set @BOtherFeeOneAmount = 0
set @BOtherFeeTwoAmount = 0
end




-- Setup Account kelar diatas, Next masukin ke Fund Journal  
if @BManagementFeeAmount > 0 or @BCustodiFeeAmount > 0 or @BAuditFeeAmount > 0
BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'DAILY FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
END    

if @BManagementFeeAmount > 0
BEGIN
		
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@ManagementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ManagementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                  

END

if @BCustodiFeeAmount > 0
BEGIN

	
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@CustodianFeeExpAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CustodianFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2       

END
  
if @BAuditFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@AuditFeeExpAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'D',@BAuditFeeAmount,                   
@BAuditFeeAmount,0,1,@BAuditFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @AuditFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@PayableAuditFeeAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'C',@BAuditFeeAmount,                   
0,@BAuditFeeAmount,1,0,@BAuditFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableAuditFeeAcc and Status = 2                  
		
END

IF (@BBitSInvestFee = 1)
BEGIN

    if @BSinvestFeeAmount > 0
    BEGIN

	
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,7,1,2,@SinvestFeeExpAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
    @BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SinvestFeeExpAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
    0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2       

    END
END


if @BMovementFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,9,1,2,@MovementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'D',@BMovementFeeAmount,                   
@BMovementFeeAmount,0,1,@BMovementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @MovementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,10,1,2,@PayableMovementFeeAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'C',@BMovementFeeAmount,                   
0,@BMovementFeeAmount,1,0,@BMovementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableMovementFeeAcc and Status = 2                  
		
END


if @BOtherFeeOneAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,11,1,2,@BOtherFeeOneExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeOneAmount,                   
@BOtherFeeOneAmount,0,1,@BOtherFeeOneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeOneExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,12,1,2,@BPayableOtherFeeOne,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeOneAmount,                   
0,@BOtherFeeOneAmount,1,0,@BOtherFeeOneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeOne and Status = 2                  
		
END


if @BOtherFeeTwoAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,13,1,2,@BOtherFeeTwoExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeTwoAmount,                   
@BOtherFeeTwoAmount,0,1,@BOtherFeeTwoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeTwoExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,14,1,2,@BPayableOtherFeeTwo,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeTwoAmount,                   
0,@BOtherFeeTwoAmount,1,0,@BOtherFeeTwoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeTwo and Status = 2                  
		
END

	            

---------------- TINGGAL TEST SUDAH TAMBAH PAYABLE SUBS DAN REDEMPT FEE
-- B2. GENERATE PAYMENT FEE

Declare @EOMonthForFee datetime
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @BFundPK
if(@BDateOfPayment = day(@ValueDate) or (@BDateOfPayment >= day(@LastEndDayTrailsDate) and @BDateOfPayment <= day(@ValueDate)))
BEGIN
Declare @BManagementFeeAmountCheck numeric(22,4)
Declare @BCustodiFeeAmountCheck numeric(22,4)
Declare @BSinvestFeeAmountCheck numeric(22,4)
Declare @BPayableRedemptionFeeAmountCheck numeric(22,4)
Declare @BPayableSubscriptionFeeAmountCheck numeric(22,4)
Declare @BPayableSwitchingFeeAmountCheck numeric(22,4)

set @EOMonthForFee = dateadd(month,-1,@ValueDate)
set @EOMonthForFee = EOMONTH (@EOMonthForFee)
	
set @BManagementFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@BPayableSwitchingFee,@BFundPK)

set @BManagementFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@BPayableSwitchingFee,@BFundPK)

Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
			                    
if @BManagementFeeAmount > 0  or @BCustodiFeeAmount > 0 or @BSinvestFeeAmount > 0 or @BPayableRedemptionFeeAmount > 0   or  
@BPayableSubscriptionFeeAmount > 0  or 
@BPayableSwitchingFeeAmount > 0   
Begin                                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
                      
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'PAYMENT FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
                        
if @BManagementFeeAmount > 0  and @BManagementFeeAmount < @BManagementFeeAmountCheck                
Begin                       
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,1,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
		@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
		0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
end                  
if @BCustodiFeeAmount > 0  and @BCustodiFeeAmount < @BCustodiFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,3,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
		@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,4,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
		0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BSinvestFeeAmount > 0  and @BSinvestFeeAmount < @BSinvestFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,5,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
		@BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,6,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
		0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableRedemptionFeeAmount > 0   and @BPayableRedemptionFeeAmount < @BPayableRedemptionFeeAmountCheck               
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,7,1,2,@PayableRedemptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'D',@BPayableRedemptionFeeAmount,                   
		@BPayableRedemptionFeeAmount,0,1,@BPayableRedemptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableRedemptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,8,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'C',@BPayableRedemptionFeeAmount,                   
		0,@BPayableRedemptionFeeAmount,1,0,@BPayableRedemptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSubscriptionFeeAmount > 0        and @BPayableSubscriptionFeeAmount < @BPayableSubscriptionFeeAmountCheck           
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,9,1,2,@PayableSubscriptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSubscriptionFeeAmount,                					@BPayableSubscriptionFeeAmount,0,1,@BPayableSubscriptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSubscriptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,10,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSubscriptionFeeAmount,                   
		0,@BPayableSubscriptionFeeAmount,1,0,@BPayableSubscriptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSwitchingFeeAmount > 0    and @BPayableSwitchingFeeAmount < @BPayableSwitchingFeeAmountCheck              
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,11,1,2,@BPayableSwitchingFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSwitchingFeeAmount,                					@BPayableSwitchingFeeAmount,0,1,@BPayableSwitchingFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableSwitchingFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,12,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSwitchingFeeAmount,                   
		0,@BPayableSwitchingFeeAmount,1,0,@BPayableSwitchingFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

End

END

Fetch next From B   
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount,@BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount
                     
End                  
Close B                  
Deallocate B   
---------------------------------------------------------------------------------------------------------------------------
 -- B3. BANK INTEREST


declare @EFundPK int
declare @EFundID nvarchar(50)
declare @ECashAcc int
declare @EInterestPercent numeric (18,6)
declare @EInterestDays numeric (22,6)
declare @EBalance numeric (22,6)
declare @EMinimumBalance numeric (18,6)
declare @EBankInterestAmount numeric (22,6)
declare @EBankInterestAcc int
declare @EBankInterestIncomeAcc int

--declare @DateYesterDay datetime
--set @DateYesterDay = dbo.FWorkingDay(@ValueDate, - 1)

DECLARE E CURSOR FOR 
Select FundPK,ID From Fund where status in (1,2)
        	
Open E
Fetch Next From E
Into @EFundPK,@EFundID
        
While @@FETCH_STATUS = 0
BEGIN  
    set @EBankInterestAmount = 0

    IF EXISTS(select * from BankInterestSetup A left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
    where A.status in (1,2) and B.FundPK = @EFundPK)
    BEGIN
        DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date <= @ValueDate
        )
        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
			    set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END
	ELSE
	BEGIN
		DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date <= @ValueDate
        )

        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
				set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END
				
			--select @EFundPK,@EBalance,@EInterestPercent,@EInterestDays

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END


	
	-- Setup Account kelar diatas, Next masukin ke Fund Journal  
	if @EBankInterestAmount > 0
	BEGIN
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

	Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'BANK DAILY INTEREST',                  
	'','FUND ID: ' + @EFundID,1,@UsersID,@LastUpdate,@LastUpdate                  
	END    

	if @EBankInterestAmount > 0
	BEGIN
		
		select @EBankInterestAcc = InterestAccrGiro,@EBankInterestIncomeAcc = IncomeInterestGiro from FundAccountingSetup where FundPK = @EFundPK and status in (1,2)

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select  @FundJournalPK,1,1,2,@EBankInterestAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'D',@EBankInterestAmount,                   
	@EBankInterestAmount,0,1,@EBankInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestAcc and Status = 2                   

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select @FundJournalPK,2,1,2,@EBankInterestIncomeAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'C',@EBankInterestAmount,                   
	0,@EBankInterestAmount,1,0,@EBankInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestIncomeAcc and Status = 2                  

	END


	
Fetch next From E Into @EFundPK,@EFundID
END
Close E
Deallocate E 

---------------------------------------------------------------------------------------------------------------------------

-- C. REVAL,GENERATE BOND,DEPOSITO ACCRUED  --             

declare @RevalEquity int
declare @InvestEquity int
declare @RevalBond int
declare @InvestBond int
declare @MarketValue numeric(22,6)   
declare @PrevMarketValue numeric(22,6) 

Declare @RevaluationAcc    int                  
Declare @UnrealisedAcc    int                  
Declare @FInstrumentPK    int         
Declare @FInstrumentID    nvarchar(100)                  
Declare @FFundPK     int                  
Declare @FTrxAmount     numeric(22,6)                  
Declare @FMarketValue    numeric(22,6)                  
Declare @FInstrumentTypePK   int                  
Declare @FCurrencyPK    int                  
Declare @FPrevRevaluationAmount  numeric(22,6)                  
Declare @FFinalAmount    numeric(22,6)                  
Declare @FLastCouponDate   datetime                  
Declare @FInterestAmount   numeric(18,6)                  
Declare @FBalance     numeric(18,0)                  
Declare @FTaxExpenseAmount   numeric(18,6)                  
Declare @FTaxExpensePercent   numeric(18,8)                  
Declare @FAcqDate   datetime                                  
Declare @FMaturityDate  datetime  
Declare @FSell   int 
Declare @FBuy   int 
Declare @FDoneAmount    numeric(22,6) 
Declare @FInterestDaysType int
Declare @FInterestPaymentType int
Declare @FInterestPercent numeric(18,8)
Declare @FPaymentModeOnMaturity int


--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)

Declare D Cursor For   


    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16) 
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity 


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)  
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity 


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate)

    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity 

Open D                  
Fetch Next From D                  
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance
,@FTaxExpensePercent,@FMaturityDate,@FSell,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent ,@FPaymentModeOnMaturity,@FBuy     
While @@FETCH_STATUS = 0                  
Begin                  
    -- C1. REVALUATION EQUITY & BOND --

    select @RevalEquity = RevaluationEquity,@InvestEquity = InvestmentEquity,@RevalBond = RevaluationBond,@InvestBond = InvestmentBond from FundAccountingSetup where status = 2 and fundPK = @FFundPK
    IF(@RevalEquity = @InvestEquity) OR (@RevalBond = @InvestBond)
    BEGIN
	    IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK  
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK   


            IF (@FBuy = 1)
            BEGIN

                --select @MarketValue =  dbo.FGetLastVolumeInv(@valuedate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                --select @PrevMarketValue = dbo.FGetLastVolumeInv(dbo.FWorkingDay(@valuedate,-1),@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.FWorkingDay(@valuedate,-1),@FInstrumentPK,@FFundPK)/100)     
                --select @FDoneAmount = dbo.FGetDoneAmountInv(@valuedate,@FFundPK,@FInstrumentPK)
                --set @FFinalAmount = @MarketValue - (@PrevMarketValue + @FDoneAmount) 
                
                
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 


            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)/100) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue  
				   
            END
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2  and fundPK = @FFundPK

            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END   


    END
    ELSE
    BEGIN
        IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2    and fundPK = @FFundPK
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK      
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
        END    

        IF @FInstrumentTypePK in(1,2,3,4,8,9,13,14,15,16)    
        BEGIN  
            IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)
				
            END
            ELSE
            BEGIN

                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FMarketValue,0) - isnull(@FTrxAmount,0) - @FPrevRevaluationAmount 
			
            END
        END
   
    END






	IF Exists(              
    Select * from ClosePrice where Status = 2 and date = @ValueDate              
    )  
    BEGIN
        IF isnull(@FFinalAmount,0) > 0 --Nilai Revaluasi Acc di Debit    
        BEGIN    
        -- Setup Account kelar diatas, Next masukin ke Fund Journal  
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal     
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)  


        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
    
        Select @FundJournalPK,2,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2        
        END  
        --CEK DISINI YA AZIZ
        IF isnull(@FFinalAmount,0) < 0    
        BEGIN  
        -- Setup Account kelar diatas, Next masukin ke Fund Journal    
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)    
        
        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
        
        Select @FundJournalPK,2,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2    
        END  
    END  	 







	    
Fetch next From D                   
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance,@FTaxExpensePercent,@FMaturityDate,@FSell    
,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent,@FPaymentModeOnMaturity,@FBuy  
END        
Close D                  
Deallocate D

--AAAAAAAA


Declare @IncDays int            
Declare @CInstrumentPK    int         
Declare @CInstrumentID    nvarchar(100)                  
Declare @CFundPK     int                  
Declare @CTrxAmount     numeric(22,6)                  
Declare @CMarketValue    numeric(22,6)                  
Declare @CInstrumentTypePK   int                  
Declare @CCurrencyPK    int                  
Declare @CPrevRevaluationAmount  numeric(22,6)                  
Declare @CFinalAmount    numeric(22,6)                  
Declare @CLastCouponDate   datetime                  
Declare @CInterestAmount   numeric(18,6)                  
Declare @CBalance     numeric(18,0)                  
Declare @CTaxExpenseAmount   numeric(18,6)                  
Declare @CTaxExpensePercent   numeric(18,8)                  
Declare @CAcqDate   datetime                  
Declare @InterestIncometAcc   int                  
Declare @CMaturityDate  datetime  
Declare @CSell   int
Declare @CRoll   int  

Declare @CInterestDaysType int
Declare @CInterestPaymentType int
Declare @CInterestPercent numeric(18,8)
Declare @CPaymentModeOnMaturity int

--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)


Declare C Cursor For   
 
  
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)-- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
and B.InstrumentTypePK <> 5 

and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and @ValueDate <= SettlementDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity
 

 
UNION ALL

-- MATURE DIHITUNG

Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)-- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@ValueDate,-1)
)
and B.InstrumentTypePK not in (1,5)
and   EXISTS 
(  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK  and Status  = 2 and MaturityDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
 and A.AcqDate not in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity





--MATURE INTEREST WEEKEND
UNION ALL       
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)
)
and A.MaturityDate <= @valuedate and B.InstrumentTypePK = 5 

and  NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity


--ROLLOVER INTEREST WEEKEND
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
 and A.AcqDate  in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

UNION ALL

-- JUAL H+1 HARI LIBUR
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,B.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 Roll             
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)
)
 and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5
 and A.AcqDate in (
select AcqDate from investment where TrxType = 2 and valuedate = @valuedate)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity




Open C                  
Fetch Next From C                  
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance
,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent ,@CPaymentModeOnMaturity,@CRoll     
While @@FETCH_STATUS = 0                  
Begin              

  
-- C2. GENERATE INTEREST ACCRUED BOND                  

IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)             
BEGIN                  
Select @InterestRecAcc = InterestAccrBond
,@TaxExpenseAcc = TaxExpenseInterestIncomeBond,@InterestIncometAcc = IncomeInterestBond
From FundAccountingSetup where Status = 2  and FundPK = @CFundPK                  
END                  

IF @CInstrumentTypePK = 5 -- NCD INTEREST BLOM TAU GIMANA PAS MATURED
BEGIN                  
Select @InterestRecAcc = InterestAccrTimeDeposit,@TaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@InterestIncometAcc = IncomeInterestTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @CFundPK
END                  
IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)     -- and  @CLastCouponDate < @ValueDate        
BEGIN       
if @CAcqDate < @Valuedate
BEGIN

        IF (@CMarketValue = 0)
        BEGIN
            set @CInterestAmount  = 0
            set @CTaxExpenseAmount = 0 
            set @CFinalAmount = 0 
        END
        ELSE
        BEGIN
            Select @CInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@ValueDate,@CInstrumentPK,@CBalance)            
		    set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
		    set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)  
        END

      
		IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)                    
		BEGIN                 	         
		-- Setup Account kelar diatas, Next masukin ke Fund Journal   
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

		IF @CInterestAmount > 0                  
		BEGIN           
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

        IF((day(@valuedate) <> 31 AND @CInterestDaysType in (3,5,6,7)) OR (@CInterestDaysType not in (3,5,6,7)))
        BEGIN

            INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            '','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            @CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            @CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
        END

            --IF(@CInterestDaysType not in (3,5,6,7))
            --BEGIN
            --INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            --,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            --Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            --'','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            --@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            --0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            --@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
            --END
	                              
		END
		END            
END
END        

IF @CInstrumentTypePK = 5  
BEGIN   
--IF NOT EXISTS(
--Select * from investment
--where ValueDate = @ValueDate and StatusSettlement = 2 and TrxType = 2 and InstrumentPK = @CInstrumentPK
--)
BEGIN
	
    IF (@CRoll = 0 AND @CSell = 0)
    BEGIN
        IF  @CMaturityDate > @DateYesterday and @CMaturityDate <= @ValueDate
        BEGIN
            Declare @RealMaturedDate datetime
            if @CPaymentModeOnMaturity = 1
            begin
            set @RealMaturedDate = @CMaturityDate
            end
            if @CPaymentModeOnMaturity = 2
            begin
            set @RealMaturedDate = @ValueDate
            end
            Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@RealMaturedDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)           

            if @CPaymentModeOnMaturity = 3
            begin
            set @CInterestAmount = 0
            end

        END
        ELSE
        BEGIN
	
            if (@ValueDate = @CAcqDate)
            BEGIN
                Select @CInterestAmount = 0
            END
            ELSE
            BEGIN
                Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@ValueDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)        
            END
	
		 
        END
    END
    ELSE IF (@CRoll = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,@CAcqDate,@ValueDate)

    END
    ELSE IF (@CSell = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) *  DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),dateadd(day,-1,@valuedate))

    END
    ELSE
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccrued] (@CAcqDate,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),@CMaturityDate)
    END


--       select @ValueDate,@CAcqDate,@CInterestAmount,@CInstrumentPK,@CInterestPercent,@CFundPK
-- where @CInstrumentPK in 
-- (
	--select A.instrumentPK from fundposition A
	--left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.status = 2

	--where fundpk = 2 and trailsPK = 2 and B.InstrumentTypePK = 5		   
-- )
-- CEK LOGIK PAYMENT INTEREST TYPE DISINI

-- Setup Account kelar diatas, Next masukin ke Fund Journal   
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

IF @CInterestAmount > 0                  
BEGIN                  
set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
set @CFinalAmount = @CInterestAmount - @CTaxExpenseAmount       

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,7,@maxEndDayTrailsPK,'INTEREST DEPOSIT',                  
'','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2                   
END        
END

	          
END

                                              
	
 

 
Fetch next From C                   
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell    
,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent,@CPaymentModeOnMaturity,@CRoll
END        
Close C                  
Deallocate C

                          
-- C4. MATURE BOND & TIME DEPOSIT & DEPOSITO BELUM SAMPE UJUNG   
Declare @DInstrumentPK    int  
Declare @DRealisedAccBond    int      
Declare @DRevaluationAccBond    int         
Declare @DInstrumentID    nvarchar(100)                  
Declare @DFundPK     int                  
Declare @DTrxAmount     numeric(22,6)                  
Declare @DMarketValue    numeric(22,6)                  
Declare @DInstrumentTypePK   int                  
Declare @DCurrencyPK    int                                   
Declare @DFinalAmount    numeric(22,6)                  
Declare @DNextCouponDate   datetime                  
Declare @DInterestAmount   numeric(18,6)                  
Declare @DBalance     numeric(18,0)                  
Declare @DTaxExpenseAmount   numeric(18,6)                  
Declare @DTaxExpensePercent   numeric(18,8)                  
Declare @DAcqDate   datetime                                  
Declare @DMaturityDate  datetime  
Declare @PrevInterestAmount numeric(22,6)
Declare @PrevFinalAmount numeric(22,6)
Declare @PrevTaxExpenseAmount numeric(22,6)
declare @divdays int
declare @intdays int

Declare @DInterestRecAcc int
Declare @DTaxExpenseAcc int
Declare @DInterestIncometAcc int
Declare @DCashAtBankAcc   int  
Declare @DInvestmentBond int
Declare @DInvestmentTimeDeposit int
Declare @DInterestPaymentType int


Declare @DPaymentModeOnMaturity int
Declare @DInterestDaysType int
Declare @DInterestPercent numeric(18,4)


--DISINI

insert into #Mature(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetNextCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and A.MaturityDate >= @DateYesterday and A.MaturityDate <= @valuedate and B.InstrumentTypePK in (5,10) and A.InterestPaymentType <> 7
and A.[Identity] not in(
Select isnull(TrxBuy,0) from Investment where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2)
)


-- INI UNTUK KASUS TERIMA KUPON BULANAN, PAKAI INTERESTPAYMENTTYPE = 7 (MONTHLY)
union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetNextCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) = 31 then '30' else cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime) AcqDate, cast(cast(DATEPART(MONTH, @valuedate) as nvarchar(2)) + '/' + cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime)  MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and A.MaturityDate >= @DateYesterday and A.InterestPaymentType = 7 and DATEPART(DAY,A.MaturityDate) >= DATEPART(DAY,@DateYesterday) and DATEPART(DAY,A.MaturityDate) <= DATEPART(DAY,@valuedate) and B.InstrumentTypePK in (5,10)
and A.InstrumentPK not in(
Select InstrumentPK from Investment C where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and A.FundPK = C.FundPK and A.InstrumentPK = C.InstrumentPK
)

union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate       


DECLARE D CURSOR FOR 
-- ni buat bulanan
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where NextCouponDate > @DateYesterday and NextCouponDate <= @valuedate and NextCouponDate <> MaturityDate and InstrumentTypePK in (5,10) and InterestPaymentType = 7	
union all
-- ni buat bulanan tapi udah mature
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,MaturityDate,Balance                   
,TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime), MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate > @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType = 7
union all

select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType <> 7	
union all
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate and InstrumentTypePK in (2,3,8,9,11,13,14,15)
Open D
Fetch Next From D
Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate   
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent ,@DInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN       
  

IF @DInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @DInterestRecAcc = InterestAccrBond
,@DTaxExpenseAcc = TaxExpenseInterestIncomeBond,@DInterestIncometAcc = IncomeInterestBond,@DInvestmentBond = InvestmentBond,
@DRealisedAccBond = RealisedBond,@DRevaluationAccBond = RevaluationBond
From FundAccountingSetup where Status = 2  and FundPK = @DFundPK  

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

               

Begin           
Select @intdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@DInterestPaymentType in (10,11,12,13)) 
BEGIN
	select @divdays = 90
END
ELSE
IF(@DInterestPaymentType in (16,17,18)) 
BEGIN
	select @divdays = 180
END
ELSE
IF(@DInterestPaymentType in (7,8,9)) 
BEGIN
	select @divdays = 30
END
ELSE
BEGIN
	select @divdays = datediff(day,@DAcqDate,@DMaturityDate)   
END       
Select @DInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@DInstrumentPK,@DBalance) / @intdays *  @divdays                                                 
End               

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@DInstrumentPK,@DBalance) * (datediff(day,@DAcqDate,@DMaturityDate) - 1)                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

  

IF @DInterestAmount > 0                  
BEGIN    
	
IF (@DMaturityDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'MATURE TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@DRealisedAccBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DTrxAmount - @DBalance,                   
    @DTrxAmount - @DBalance,0,1,@DTrxAmount - @DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DRealisedAccBond and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DTrxAmount - @DBalance,                   
    0,@DTrxAmount - @DBalance,1,0,@DTrxAmount - @DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

END

ELSE
BEGIN
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal           
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                  
END
END               
END                  

ELSE IF @DInstrumentTypePK in (5,10)                
BEGIN   


Select @DInterestRecAcc = InterestAccrTimeDeposit,@DTaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@DInterestIncometAcc = IncomeInterestTimeDeposit, @DInvestmentTimeDeposit = InvestmentTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @DFundPK

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

Begin         
	
IF (@DInterestPaymentType = 7)
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccrued]  (@ValueDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate) / @intdays *  DATEDIFF(day,dateadd(month,-1,@DAcqDate),@DNextCouponDate)               
END
ELSE
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment]  (@DMaturityDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate,@DInterestPaymentType,@DMaturityDate,@DPaymentModeOnMaturity)  End              
END

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * @DInterestAmount                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

IF @DInterestAmount > 0                  
BEGIN    

--BALIKIN NILAI INTEREST KE BANK
             
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR INTEREST TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestIncometAcc and Status = 2                  
END


IF @DInterestPaymentType not in (7) 
BEGIN


    if @DPaymentModeOnMaturity = 2 -- ACQ TO MATURITY DATE NWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end
    else if @DPaymentModeOnMaturity = 3 -- ACQ TO MATURITY DATE BWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end else
    BEGIN
    set @DMaturityDate = @DMaturityDate
    END

    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal          
       
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'INV DEPOSIT TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentTimeDeposit,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentTimeDeposit and Status = 2                 



    END       

        

END

		
Fetch next From D Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate      
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent     ,@DInterestPaymentType                  
END
Close D
Deallocate D    
-------------------------------------------------------------------
-- C5. REC COUPON BOND

Declare @GInstrumentPK    int       
Declare @GInstrumentID    nvarchar(100)                  
Declare @GFundPK     int                  
Declare @GTrxAmount     numeric(22,6)                  
Declare @GMarketValue    numeric(22,6)                  
Declare @GInstrumentTypePK   int                  
Declare @GCurrencyPK    int                                   
Declare @GFinalAmount    numeric(22,6)   
Declare @GLastCouponDate   datetime                  
Declare @GNextCouponDate   datetime                  
Declare @GInterestAmount   numeric(18,6)                  
Declare @GBalance     numeric(18,0)                  
Declare @GTaxExpenseAmount   numeric(18,6)                  
Declare @GTaxExpensePercent   numeric(18,8)                  
Declare @GAcqDate   datetime                                  
Declare @GMaturityDate  datetime  
Declare @GPrevInterestAmount numeric(22,6)
Declare @GPrevFinalAmount numeric(22,6)
Declare @GPrevTaxExpenseAmount numeric(22,6)
declare @Gdivdays int
declare @Gintdays int

Declare @GInterestRecAcc int
Declare @GTaxExpenseAcc int
Declare @GInterestIncometAcc int
Declare @GCashAtBankAcc   int  
Declare @GInterestAccrBond int
Declare @GInvestmentTimeDeposit int
Declare @GInterestPaymentType int


Declare @GPaymentModeOnMaturity int
Declare @GInterestDaysType int
Declare @GInterestPercent numeric(18,4)


--DISINI

insert into #RecCoupon(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.TrxAmount,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,
case when A.InterestPaymentType in (10,11,12,13) then dateadd(month,-3,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) else case when A.InterestPaymentType in (16,17,18) then dateadd(month,-6,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK))
else case when A.InterestPaymentType in (7,8,9) then dateadd(month,-1,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) end end end
,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate 

DECLARE G CURSOR FOR 
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #RecCoupon where (NextCouponDate >= @DateYesterday and NextCouponDate <= @valuedate) and InstrumentTypePK in (2,3,8,9,11,13,14,15)
Open G
Fetch Next From G
Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate   
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent ,@GInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN      
  

IF @GInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @GInterestRecAcc = InterestAccrBond
,@GTaxExpenseAcc = TaxExpenseInterestIncomeBond,@GInterestIncometAcc = IncomeInterestBond,@GInterestAccrBond = InterestAccrBond
From FundAccountingSetup where Status = 2  and FundPK = @GFundPK  

Select @GCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @GFundPK

            

Begin           
Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@GInterestPaymentType in (10,11,12,13)) 
BEGIN
	select @Gdivdays = 90
END
ELSE
IF(@GInterestPaymentType in (16,17,18)) 
BEGIN
	select @Gdivdays = 180
END
ELSE
IF(@GInterestPaymentType in (7,8,9)) 
BEGIN
	select @Gdivdays = 30
END
ELSE
BEGIN
	select @Gdivdays = datediff(day,@GAcqDate,@GNextCouponDate)   
END    

    Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@GInstrumentPK,@GBalance) / @Gintdays *  @Gdivdays

   
                                                 
End               

IF (@GAcqDate > @GLastCouponDate)
BEGIN
    set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournal] (@valuedate,@GInstrumentPK,@GBalance) * (datediff(day,@GAcqDate,@GNextCouponDate))                  
END
ELSE
BEGIN
    set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
END

set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount

  

IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
END

END               
END                  

		
Fetch next From G Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate      
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent,@GInterestPaymentType                  
END
Close G
Deallocate G   









-----------------------------------------------------------------------------------------------------------


-- E. PENDING UNIT REGISTRY
-- 1. SUBSCRIPTION
Declare @SValueDate Datetime,@SFundPK int,@SCashRefPK int,@SFundClientPK int,@SFundClientName nvarchar(100),@STotalCashAmount numeric(22,4),@SCurrencyPK int ,@SType nvarchar(5)  
Declare @SPendingSubscription int,@SSubscription int,@SCashAtBankAcc int   
Declare @SPendingRedemption int,@SRedemption int
Declare @SCashAmount numeric(22,4), @SFeeAmount numeric(22,4)
Declare @SPayableSubsAcc int                 
DECLARE @BitPendingSubscription bit		
Declare @UnitRegistryPK int    				 
Declare @IssueDate datetime

Declare A Cursor For                  
Select ClientSubscriptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,TotalCashAmount,CurrencyPK,'SUBS' Type
,CashAmount, SubscriptionFeeAmount          
From ClientSubscription A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.status not in (3,4) and ValueDate = @ValueDate  
union all
Select ClientRedemptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,case when TotalCashAmount = 0 then TotalUnitAmount * dbo.FgetCloseNav(@DateYesterday,A.FundPK) else TotalCashAmount End TotalCashAmount,CurrencyPK,'RED' Type         
,CashAmount, RedemptionFeeAmount
From ClientRedemption A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.Status <>  3  and ValueDate = @ValueDate
	            
Open A                  
Fetch Next From A                  
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK,@SType,
@SCashAmount,@SFeeAmount
While @@FETCH_STATUS = 0                  
Begin 
IF (@SType = 'SUBS')
BEGIN

select @IssueDate = IssueDate from Fund where status in (1,2) and FundPK = @SFundPK

SELECT @BitPendingSubscription = ISNULL(BitPendingSubscription,1) FROM dbo.FundFee WHERE fundPK = @SFundPK
AND date = 
(
SELECT MAX(Date) FROM dbo.FundFee WHERE Date <= @SValueDate AND FundPK = @SFundPK
AND status = 2
) and STATUS = 2

set @BitPendingSubscription = isnull(@BitPendingSubscription,0)

set @SCashAtBankAcc = NULL

Select @SCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @SCashRefPK
if (@SCashAtBankAcc is null or @SCashAtBankAcc  = '')
BEGIN
set @SCashAtBankAcc = 3
END

IF (@ValueDate = @IssueDate)
BEGIN

    Select @SSubscription = Subscription From FundAccountingSetup where Status = 2  and FundPK = @SFundPK
                     
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SSubscription and Status = 2   


END
ELSE 
BEGIN

    IF(@BitPendingSubscription = 1)
    BEGIN
    Select @SPendingSubscription = PendingSubscription,@SSubscription = Subscription
    ,@SPayableSubsAcc = payablesubscriptionfee
    From FundAccountingSetup 
    where Status = 2  and FundPK = @SFundPK

                       
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SPendingSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPendingSubscription and Status = 2   

        if @SFeeAmount > 0
        BEGIN

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select @FundJournalPK,3,1,2,@SPayableSubsAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@SFeeAmount,                   
        0,@SFeeAmount,1,0,@SFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPayableSubsAcc and Status = 2   
        END

    END


END                                  

  

         
END
         
Fetch next From A                   
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK ,@SType,@SCashAmount,@SFeeAmount
END                  
Close A                  
Deallocate A

-------------------------------------------
-- JOURNAL CORPORATE ACTION

Create Table #ZDividenSaham                  
(                  
InstrumentPK int,     
FundPK int,                  
LastVolume numeric(18,4),
PaymentDate datetime,
RecordingDate datetime,
Earn numeric(22,4),
Hold numeric(22,4)
)   


--DIVIDEN SAHAM
-- Tarik Balance Cum / Valuedate - 1 + movement dengan batas settleddate <= recordingDate and ValueDate >= CumDate 
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select  B.FundPK,B.InstrumentPK,B.Balance + ISNULL(C.BalanceFromInv,0) LastBalance,
A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
and C.ValueDate >= A.ValueDate
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate



Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select B.FundPK,B.InstrumentPK,isnull(B.BalanceFromInv,0),A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
from CorporateAction A
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)B on  B.SettlementDate <= A.RecordingDate and  A.InstrumentPK = B.InstrumentPK
and B.ValueDate >= A.ValueDate
left join #ZDividenSaham C on B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK 
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate
and C.FundPK is null and C.InstrumentPK is null

Declare @TIncomeDividend int
Declare @TARDividend int
Declare @TotalAmount numeric(22,4)
Declare @TWithHoldingTaxPPH23 int


Declare @TInstrumentPK int
declare @TFundPK int
declare @TLastVolume numeric(22,4)
declare @TPaymentDate datetime
declare @TRecordingDate datetime
declare @TEarn numeric(22,4)
declare @THold numeric(22,4)

Declare @TTaxPercentage numeric(8,4)

Declare A Cursor For   
Select * From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TIncomeDividend = IncomeDividend,@TARDividend = ARDividend,@TWithHoldingTaxPPH23 = prepaidTaxDividend 
,@TTaxPercentage = TaxPercentageDividend
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume/@THold * @TEarn
   
if @TotalAmount > 0
BEGIN
	
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH CUM DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TIncomeDividend,CurrencyPK,@TFundPK,0,0,'INCOME DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TIncomeDividend and Status = 2   

--------------- PAYMENT DATE

declare @pph23Amount numeric(22,4)
set @pph23Amount = @TotalAmount * @TTaxPercentage/100

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@TPaymentDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH PAYMENT DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DefaultCashAtBankPK,CurrencyPK,@TFundPK,0,0,'DIVIDEND','D',@TotalAmount - @pph23Amount,                   
@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DefaultCashAtBankPK and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@TWithHoldingTaxPPH23,CurrencyPK,@TFundPK,0,0,'TAX DIVIDEND','D',@pph23Amount,                   
@pph23Amount,0,1,@pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TWithHoldingTaxPPH23 and Status = 2     

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A



---BOND AMORTIZE
TRUNCATE TABLE #ZDividenSaham
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,Earn,Hold)
Select  B.FundPK,B.InstrumentPK,B.Balance  LastBalance,A.PaymentDate,A.Earn,A.Hold
--B.Balance + C.BalanceFromInv LastBalance
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
--Left join (
--	select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
--	, SettlementDate, ValueDate 
--	from Investment where statusSettlement = 2
--	and InstrumentTypePK  in (2,3,9,15)
--	Group by InstrumentPK,FundPK,SettlementDate,ValueDate
--)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
--and C.ValueDate >= A.ValueDate
where A.Type = 6 and A.Status = 2 and A.PaymentDate = @ValueDate


Declare @TInvestmentInBond int
Declare @TBondAmortized int


Declare A Cursor For   
Select InstrumentPK,FundPK,LastVolume,PaymentDate,PaymentDate,Earn,Hold From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TInvestmentInBond = InvestmentBond,@TBondAmortized = BondAmortization
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume *  @TEarn / @THold * -1
   
if @TotalAmount < 0
BEGIN
SET @TotalAmount = ABS(@TotalAmount)
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'BOND AMORTIZE',                  
'','CORPORATE ACTION BOND AMORTIZE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TBondAmortized,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TBondAmortized and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TInvestmentInBond,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TInvestmentInBond and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A
------------------------------------------------------------------------------

    
 
--Update EndDayTrails set BitValidate = 1,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 1                    

Select @maxEndDayTrailsPK LastPK     
                             
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);

                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToInt32(dr["LastPK"]);

                            }
                            return 0;
                        }

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }

        public void Revise_ByFund(EndDayTrails _endDayTrails)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        string _paramFund = "";


                        if (!_host.findString(_endDayTrails.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundFrom))
                        {
                            _paramFund = "And FundPK in ( " + _endDayTrails.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }



                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  

declare @FundPK int,@BFundPK int,@BType nvarchar(50),@BPK int,@BHistoryPK int,@BFundClientPK int,@BUnitAmount numeric(22,8),@BCashAmount numeric(22,4)
Declare @MaxClientSubscriptionPK int, @MaxClientRedemptionPK int, @MaxClientSwitchingPK int
Declare @counterDate datetime 

declare @BTotalUnitAmountFundFrom numeric(22,4), @BTotalUnitAmountFundTo numeric(22,4),@BFundPKFrom int,@BFundPKTo int

DECLARE A CURSOR FOR 
select FundPK from Fund where status in (1,2) and FundPK in
(select FundPK from ClientSubscription where ValueDate = @Date and Posted = 1 and Revised = 0
union all
select FundPK from ClientRedemption where ValueDate = @Date and Posted = 1 and Revised = 0
union all
select FundPKFrom from ClientSwitching where ValueDate = @Date and Posted = 1 and Revised = 0
union all
select FundPKTo from ClientSwitching where ValueDate = @Date and Posted = 1 and Revised = 0
)  " + _paramFund + @"

order by FundPK


Open A
Fetch Next From A
Into @FundPK

While @@FETCH_STATUS = 0
BEGIN

	DECLARE B CURSOR FOR 
	select FundPK,'SUB' Type,ClientSubscriptionPK PK,HistoryPK,FundClientPK,TotalUnitAmount,TotalCashAmount from ClientSubscription where ValueDate = @Date and Posted = 1 and Revised = 0 and FundPK = @FundPK
	union all
	select FundPK,'RED' Type,ClientRedemptionPK PK,HistoryPK,FundClientPK,UnitAmount,TotalCashAmount from ClientRedemption where ValueDate = @Date and Posted = 1 and Revised = 0 and FundPK = @FundPK
	union all
	select FundPKFrom,'SWI' Type,ClientSwitchingPK PK,HistoryPK,FundClientPK,UnitAmount,CashAmount from ClientSwitching where ValueDate = @Date and Posted = 1 and Revised = 0 and (FundPKFrom = @FundPK or FundPKTo = @FundPK) 


	Open B
	Fetch Next From B
	Into @BFundPK,@BType,@BPK,@BHistoryPK,@BFundClientPK,@BUnitAmount,@BCashAmount

	While @@FETCH_STATUS = 0
	BEGIN

		IF (@BType = 'SUB')
		BEGIN
		
		    update FundJournal set Status = 3,VoidTime = @LastUpdate,VoidUsersID = @UsersID  where Type = 2 and TrxNo = @BPK 
            and Posted = 1 

            select * from FundClientPosition 
            where Date = @Date and FundClientPK = @BFundClientPK and FundPK = @BFundPK 
            if @@rowCount > 0 
            begin 
            Update FundClientPosition set CashAmount = CashAmount - @BCashAmount, 
            UnitAmount = UnitAmount - @BUnitAmount where Date = @Date and FundClientPK = @BFundClientPK 
            and FundPK = @BFundPK 
            end 
                        
            Select @MaxClientSubscriptionPK = ISNULL(MAX(ClientSubscriptionPK),0) + 1 From ClientSubscription   
            INSERT INTO [dbo].[ClientSubscription]  
            ([ClientSubscriptionPK],[HistoryPK] ,[Status],[Notes], [NAVDate] ,[ValueDate],
            [NAV] ,[FundPK], [FundClientPK] , [CashRefPK] , [Description] ,
            [CashAmount] ,[UnitAmount] ,[TotalCashAMount] ,[TotalUnitAmount] ,[SubscriptionFeePercent] ,[SubscriptionFeeAmount] ,
            [AgentPK] ,[AgentFeePercent],[AgentFeeAmount],[CurrencyPK],[DepartmentPK],[AutoDebitDate],[Type],
            [EntryUsersID],[EntryTime],[LastUpdate],[BitImmediateTransaction],[FeeType],[TransactionPK],[IsFrontSync])
                        
            SELECT @MaxClientSubscriptionPK,1,1,'Pending Revised' ,[NAVDate] ,
            [ValueDate],[NAV] ,[FundPK],[FundClientPK] ,
            [CashRefPK] ,[Description] ,[CashAmount] ,[UnitAmount] ,[TotalCashAMount] ,[TotalUnitAmount] ,
            [SubscriptionFeePercent] ,[SubscriptionFeeAmount] ,[AgentPK] ,[AgentFeePercent],[AgentFeeAmount],[CurrencyPK],[DepartmentPK],[AutoDebitDate],[Type],
            [EntryUsersID],[EntryTime] , @LastUpdate, [BitImmediateTransaction],[FeeType],[TransactionPK],0
            FROM ClientSubscription  
            WHERE ClientSubscriptionPK = @BPK and HistoryPK = @BHistoryPK   and status = 2 and posted = 1 
                       
                        
            update ClientSubscription 
            set RevisedBy = @UsersID,RevisedTime = @LastUpdate,Revised = 1 , status = 3 , IsFrontSync = 0
            where ClientSubscriptionPK = @BPK and HistoryPK = @BHistoryPK and Status = 2 and posted = 1 

						  
            set @counterDate = @Date 
            while @counterDate < (select max(date) from fundClientPosition where FundClientPK = @BFundClientPK and FundPK = @BFundPK)
            BEGIN
            set @counterDate = dbo.fworkingday(@counterDate,1)
            update fundClientPosition set UnitAmount = UnitAmount - @BUnitAmount,CashAmount = CashAmount - @BCashAmount
            where FundClientPK = @BFundClientPK and FundPK = @BFundPK and Date = @counterDate 
            end 


		END
		ELSE IF (@BType = 'RED')
		BEGIN
			update FundJournal set Status = 3,VoidTime = @LastUpdate,VoidUsersID = @UsersID  where Type = 3 and TrxNo = @BPK 
			and Posted = 1 

			if exists(select * from FundClientPosition 
			where Date = @Date and FundClientPK = @BFundClientPK and FundPK = @BFundPK 
			)
			begin 
			Update FundClientPosition set CashAmount = CashAmount + @BCashAmount, 
			UnitAmount = UnitAmount + @BUnitAmount where Date = @Date and FundClientPK = @BFundClientPK 
			and FundPK = @BFundPK 
			end 
                        
                       
			Select @MaxClientRedemptionPK = ISNULL(MAX(ClientRedemptionPK),0) + 1 From ClientRedemption   
			INSERT INTO [dbo].[ClientRedemption]  
			([ClientRedemptionPK],[HistoryPK] ,[Status],[Notes], [NAVDate] ,[ValueDate],
			[PaymentDate],[BitRedemptionAll], [NAV] ,[FundPK], [FundClientPK] , [CashRefPK] ,[Description] ,
			[CashAmount] ,[UnitAmount] ,[TotalCashAMount] ,[TotalUnitAmount] ,[RedemptionFeePercent] ,[RedemptionFeeAmount] ,
			[AgentPK] ,[AgentFeePercent],[AgentFeeAmount],[CurrencyPK],
			[DepartmentPK],[Type],[BankRecipientPK],[TransferType],[FeeType],
			[EntryUsersID],[EntryTime],[LastUpdate],[TransactionPK],[IsFrontSync])
                       
			SELECT @MaxClientRedemptionPK,1,1,'Pending Revised' ,[NAVDate] ,
			[ValueDate],[PaymentDate],[BitRedemptionAll],[NAV] ,[FundPK],[FundClientPK] ,
			[CashRefPK] ,[Description] ,[CashAmount] ,[UnitAmount] ,[TotalCashAMount] ,[TotalUnitAmount] ,
			[RedemptionFeePercent] ,[RedemptionFeeAmount] ,[AgentPK] ,[AgentFeePercent],[AgentFeeAmount],[CurrencyPK],
			[DepartmentPK],[Type],[BankRecipientPK],[TransferType],[FeeType],
			[EntryUsersID],[EntryTime] , @LastUpdate,[TransactionPK],0
			FROM ClientRedemption   
			WHERE ClientRedemptionPK = @BPK   and status = 2 and posted = 1  

			update ClientRedemption 
            set RevisedBy = @UsersID,RevisedTime = @LastUpdate,Revised = 1, status = 3 , IsFrontSync = 0
            where ClientRedemptionPK = @BPK and Status = 2 and posted = 1 
                        
            set @counterDate = @Date 
            while @counterDate < (select max(date) from fundClientPosition where FundClientPK = @BFundClientPK and FundPK = @BFundPK )
            BEGIN 
            set @counterDate = dbo.fworkingday(@counterDate,1)
            update fundClientPosition set UnitAmount = UnitAmount + @BUnitAmount,CashAmount = CashAmount + @BCashAmount
            where FundClientPK = @BFundClientPK and FundPK = @BFundPK and Date = @counterDate 
            END 
		END
		ELSE
		BEGIN
			update FundJournal set Status = 3,VoidTime = @LastUpdate,VoidUsersID = @UsersID  where Type = 13 and TrxNo = @BPK 
			and Posted = 1 

			select @BTotalUnitAmountFundFrom=UnitAmount,@BTotalUnitAmountFundTo=TotalUnitAmountFundTo,
			@Date = NAVDate, @BFundPKFrom = FundPKFrom, @BFundPKTo = FundPKTo, @BFundClientPK = FundClientPK
			from ClientSwitching where  Status = 2 and clientSwitchingPK = @BPK and Posted  = 1 and Revised  = 0 

			if Exists(Select *from FundClientPosition where date = @Date and FundClientPK = @BFundClientPK and FundPK = @BFundPKTo)
			begin 
			Update FundClientPosition set  
			UnitAmount = UnitAmount - @BTotalUnitAmountFundTo where Date = @Date and FundClientPK = @BFundClientPK 
			and FundPK = @BFundPKTo 
			end 

			if Exists(Select *from FundClientPosition where date = @Date and FundClientPK = @BFundClientPK and FundPK = @BFundPKFrom)
			begin 
			Update FundClientPosition set  
			UnitAmount = UnitAmount + @BTotalUnitAmountFundFrom where Date = @Date and FundClientPK = @BFundClientPK 
			and FundPK = @BFundPKFrom 
			end 
                            


			Select @MaxClientSwitchingPK = ISNULL(MAX(ClientSwitchingPK),0) + 1 From ClientSwitching   
			INSERT INTO [dbo].[ClientSwitching]  
			([ClientSwitchingPK],[HistoryPK] ,[Status],[Notes], [NAVDate] ,[ValueDate],
			[PaymentDate], [NAVFundFrom] ,[NAVFundTo] ,[FundPKFrom],[FundPKTo], [FundClientPK] , [CashRefPKFrom] ,[CashRefPKTo] ,[BitSwitchingAll], [Description] ,
			[CashAmount] ,[UnitAmount] ,[TotalCashAmountFundFrom] ,[TotalCashAmountFundTo] ,
			[TotalUnitAmountFundFrom] ,[TotalUnitAmountFundTo] ,[SwitchingFeePercent] ,[SwitchingFeeAmount],[CurrencyPK],
			[TransferType],[FeeType],[FeeTypeMethod],
			[EntryUsersID],[EntryTime],[LastUpdate],IsProcessed,[IsFrontSync],userswitchingPK,TransactionPK)
                        
			SELECT @MaxClientSwitchingPK,1,1,'Pending Revised' ,[NAVDate] ,
			[ValueDate],[PaymentDate],[NAVFundFrom],[NAVFundTo] ,[FundPKFrom],[FundPKTo],[FundClientPK] ,
			[CashRefPKFrom] ,[CashRefPKTo] ,[BitSwitchingAll],[Description] ,[CashAmount] ,[UnitAmount] ,[TotalCashAmountFundFrom] ,[TotalCashAmountFundTo] ,[TotalUnitAmountFundFrom] ,[TotalUnitAmountFundTo] ,
			[SwitchingFeePercent] ,[SwitchingFeeAmount] ,[CurrencyPK],
			[TransferType],[FeeType],[FeeTypeMethod],
			[EntryUsersID],[EntryTime] ,@LastUpdate,0,0,userswitchingPK,TransactionPK 
			FROM ClientSwitching  
			where ClientSwitchingPK = @BPK

			update ClientSwitching 
			set RevisedBy = @UsersID,RevisedTime = @LastUpdate,Revised = 1,Lastupdate = @LastUpdate, status = 3 ,IsFrontSync = 0
			where  clientSwitchingPK = @BPK and Status = 2 and Revised = 0 and Posted  = 1

			Declare @counterDateFrom datetime    
			Declare @counterDateTo datetime      
			set @counterDateFrom = @Date  
			set @counterDateTo = @Date  

			while @counterDateTo < 
			(select max(date) from fundClientPosition where FundClientPK = @BFundClientPK)    
			BEGIN 
				set @counterDateTo = dbo.FWorkingDay(@counterDateTo,1)    
				update fundClientPosition set UnitAmount = UnitAmount  - @BTotalUnitAmountFundTo    
				where FundClientPK = @BFundClientPK and FundPK = @BFundPKTo and Date = @counterDateTo 
	                            
			END

			while @counterDateFrom < (select max(date) from fundClientPosition where FundClientPK = @BFundClientPK)    
			BEGIN    
				set @counterDateFrom = dbo.FWorkingDay(@counterDateFrom,1)    
				update fundClientPosition set UnitAmount = UnitAmount  + @BTotalUnitAmountFundFrom 
				where FundClientPK = @BFundClientPK and FundPK = @BFundPKFrom and Date = @counterDateFrom 
			END
		END



	Fetch next From B Into @BFundPK,@BType,@BPK,@BHistoryPK,@BFundClientPK,@BUnitAmount,@BCashAmount
	END
	Close B
	Deallocate B 

Fetch next From A Into @FundPK
END
Close A
Deallocate A 
select 1 Result
                             
                        ";

                        cmd.Parameters.AddWithValue("@Date", _endDayTrails.ValueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _endDayTrails.EntryUsersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.ExecuteNonQuery();

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }


        public void Generate_UnitFeeSummaryNew(EndDayTrails _endDayTrails)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        string _paramFund = "";
                        string _paramFundClient = "";
                        string _paramFundText = "";
                        string _paramFundClientText = "";

                        if (!_host.findString(_endDayTrails.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundFrom))
                        {
                            _paramFund = " And A.FundPK in ( " + _endDayTrails.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }




                        if (!_host.findString(_endDayTrails.FundClientFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_endDayTrails.FundClientFrom))
                        {
                            _paramFundClient = " And A.FundClientPK in ( " + _endDayTrails.FundClientFrom + " ) ";
                        }
                        else
                        {
                            _paramFundClient = "";
                        }


                        cmd.CommandText = @"
    

DELETE A from [DailyDataForCommissionRptNew] A
where A.Mfeedate between @dateFrom and @Dateto 

" + _paramFund + _paramFundClient + @"
	
	DECLARE @StartDate datetime
    Declare @EndDate DATETIME
    

    set @StartDate =  dbo.FWorkingDay(@dateFrom,-3)
    set @EndDate = dbo.fworkingday(@DateTo,-1)


	DECLARE @FCAgent TABLE
    (
		Date DATETIME,
		FundClientPK INT,
		AgentPK int
	)

	DECLARE @FCFundClientPK int
	DECLARE @FCDate datetime

	Declare A Cursor For
		SELECT DISTINCT A.Date,FundClientPK FROM dbo.ZDT_WorkingDays A,dbo.FundClientAgentSetup WHERE status = 2
		AND A.date BETWEEN @StartDate AND @DateTo
	Open A
	Fetch Next From A
	INTO @FCDate,@FCFundClientPK
	
	WHILE @@FETCH_STATUS = 0  
	BEGIN
		INSERT INTO @FCAgent
		        ( Date, FundClientPK, AgentPK )
		
		SELECT  @FCDate,FundClientPK,AgentPK FROM dbo.FundClientAgentSetup 
		WHERE Status = 2 AND Date =
		(
			SELECT MAX(Date) FROM dbo.FundClientAgentSetup WHERE status = 2 AND Date<= @FCDate
			AND FundClientPK = @FCFundClientPK
		) AND FundClientPK = @FCFundClientPK
		

		FETCH NEXT FROM A 
		INTO @FCDate,@FCFundClientPK
	END	
	CLOSE A
	DEALLOCATE A


	DECLARE @FFSetup TABLE
    (
		Date DATETIME,
		FundPK INT,
		MfeeType INT
	)

	DECLARE @FFSetupDetail TABLE
    (
		Date DATETIME,
		FundPK INT,
		MfeeType INT,
		FeePercent NUMERIC(18,8),
		RangeFrom Numeric(22,4),
		RangeTo NUMERIC(22,4),
		AmortizeDate DATETIME,
		AmortizeAmount NUMERIC(22,4),
		FirstAmortizeDate datetime

	)

	DECLARE @FFFundPK INT
	DECLARE @FFDate DATETIME

	DECLARE A CURSOR FOR
		SELECT DISTINCT A.Date,FundPK FROM dbo.ZDT_WorkingDays A,Fund WHERE status = 2
		AND A.date BETWEEN @StartDate AND @DateTo
	OPEN A
	FETCH NEXT FROM A
	INTO @FFDate,@FFFundPK
	
	WHILE @@FETCH_STATUS = 0  
	BEGIN
		
		IF EXISTS(
			SELECT TOP 1 '1' FROM dbo.FundFeeSetup 
		WHERE Status = 2 AND Date =
		(
			SELECT MAX(Date) FROM dbo.FundFeeSetup WHERE status = 2 AND Date<= @FFDate AND FundPK = @FFFundPK
		)AND FundPK = @FFFundPK 
		)
		BEGIN
			INSERT INTO @FFSetup
		        ( Date, FundPK, MfeeType )
		
		SELECT TOP 1 @FFDate,FundPK,FeeType FROM dbo.FundFeeSetup 
		WHERE Status = 2 AND Date =
		(
			SELECT MAX(Date) FROM dbo.FundFeeSetup WHERE status = 2 AND Date<= @FFDate AND FundPK = @FFFundPK
		)AND FundPK = @FFFundPK 
		ORDER BY FundFeeSetupPK DESC
		END
		ELSE
		BEGIN
				INSERT INTO @FFSetup
		        ( Date, FundPK, MfeeType )
				SELECT @FFDate,@FFFundPK,1
		END
		
		IF EXISTS(
			SELECT TOP 1 '1' FROM dbo.FundFeeSetup 
			WHERE Status = 2 AND Date =
			(
				SELECT MAX(Date) FROM dbo.FundFeeSetup WHERE status = 2 AND Date<= @FFDate AND FundPK = @FFFundPK
			)AND FundPK = @FFFundPK 
		)
		BEGIN
				INSERT INTO @FFSetupDetail
		        ( Date ,
		          FundPK ,
		          MfeeType ,
		          FeePercent ,
		          RangeFrom ,
		          RangeTo ,
		          AmortizeDate ,
		          AmortizeAmount,
				  FirstAmortizeDate
		        )
				SELECT  @FFDate,FundPK,FeeType,MiFeePercent,RangeFrom,RangeTo,DateAmortize,MiFeeAmount,Date FROM dbo.FundFeeSetup 
				WHERE Status = 2 AND Date =
				(
					SELECT MAX(Date) FROM dbo.FundFeeSetup WHERE status = 2 AND Date<= @FFDate AND FundPK = @FFFundPK
				)AND FundPK = @FFFundPK 
		END
		ELSE
		BEGIN
			INSERT INTO @FFSetupDetail
		        ( Date ,
		          FundPK ,
		          MfeeType ,
		          FeePercent ,
		          RangeFrom ,
		          RangeTo ,
		          AmortizeDate ,
		          AmortizeAmount,
				  FirstAmortizeDate
		        )
				SELECT @FFDate,@FFFundPK,1,ISNULL(ManagementFeePercent,0)  
				,0,0,'',0,''
				FROM Fund WHERE status = 2 AND FundPK = @FFFundPK
		END
        

	
		

		FETCH NEXT FROM A 
		INTO @FFDate,@FFFundPK
	END	
	CLOSE A
	DEALLOCATE A


	DECLARE @AFFundPK INT
	DECLARE @AFAgentPK INT
	DECLARE @AFDate DATETIME
	
	DECLARE @AFSetup TABLE
    (
		Date DATETIME,
		FundPK INT,
		AgentPK INT,
		FeeType INT
	)

	DECLARE @AFSetupDetail TABLE
    (
		Date DATETIME,
		FundPK INT,
		AgentPK INT,
		FeeType INT,
		FeePercent NUMERIC(18,8),
		RangeFrom Numeric(22,4),
		RangeTo NUMERIC(22,4),
		AmortizeDate DATETIME,
		AmortizeAmount NUMERIC(22,4),
		FirstAmortizeDate datetime

	)

	DECLARE @AFFlagAllDate DATETIME
	DECLARE @AFFlagFundDate datetime

	DECLARE A CURSOR FOR
		SELECT DISTINCT A.Date,AgentPK,FundPK FROM dbo.ZDT_WorkingDays A,dbo.AgentFeeSetup WHERE status = 2
		AND A.date BETWEEN @StartDate AND @DateTo
	OPEN A
	FETCH NEXT FROM A
	INTO @AFDate,@AFAgentPK,@AFFundPK
	WHILE @@FETCH_STATUS = 0  
	BEGIN
				SET @AFFlagAllDate = ''
				SET @AFFlagFundDate = ''

			
				SELECT @AFFlagFundDate = MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
					AND AgentPK = @AFAgentPK AND FundPK = @AFFundPK

				SELECT @AFFlagAllDate =  MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
					AND AgentPK = @AFAgentPK AND FundPK = 0

				
				    IF @AFFlagAllDate > ISNULL(@AFFlagFundDate,'01/01/1900')  and @AFFlagFundDate is null
                    --IF (ISNULL(@AFFlagFundDate,'01/01/1900') = '01/01/1900')				
                    BEGIN
					INSERT INTO @AFSetup
					( Date, FundPK, AgentPK, FeeType )
					SELECT top 1 @AFDate Date,@AFFundPK FundPK,AgentPK,FeeType FROM dbo.AgentFeeSetup WHERE status = 2 AND Date =
					(
						SELECT MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
						AND AgentPK = @AFAgentPK AND FundPK = 0
						
					)AND FundPK = 0 AND AgentPK = @AFAgentPK

					INSERT INTO @AFSetupDetail
				        ( Date ,
				          FundPK ,
				          AgentPK ,
				          FeeType ,
				          FeePercent ,
				          RangeFrom ,
				          RangeTo ,
				          AmortizeDate ,
				          AmortizeAmount ,
				          FirstAmortizeDate
				        )
					SELECT @AFDate Date,@AFFundPK FundPK,AgentPK,FeeType,MiFeePercent
					,RangeFrom,RangeTo,DateAmortize,MiFeeAmount,Date
					FROM dbo.AgentFeeSetup WHERE status = 2 AND Date =
					(
						SELECT MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
						AND AgentPK = @AFAgentPK AND FundPK = 0

					)AND FundPK = 0 AND AgentPK = @AFAgentPK
				END
				ELSE
				BEGIN
					INSERT INTO @AFSetup
					( Date, FundPK, AgentPK, FeeType )

					SELECT top 1 @AFDate Date,FundPK,AgentPK,FeeType FROM dbo.AgentFeeSetup WHERE status = 2 AND Date =
					(
						SELECT MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
						AND AgentPK = @AFAgentPK AND FundPK = @AFFundPK

					)AND FundPK = @AFFundPK AND AgentPK = @AFAgentPK


						INSERT INTO @AFSetupDetail
				        ( Date ,
				          FundPK ,
				          AgentPK ,
				          FeeType ,
				          FeePercent ,
				          RangeFrom ,
				          RangeTo ,
				          AmortizeDate ,
				          AmortizeAmount ,
				          FirstAmortizeDate
				        )
						SELECT @AFDate Date,@AFFundPK FundPK,AgentPK,FeeType,MiFeePercent
						,RangeFrom,RangeTo,DateAmortize,MiFeeAmount,Date 
						FROM dbo.AgentFeeSetup WHERE status = 2 AND Date =
							(
								SELECT MAX(Date) FROM dbo.AgentFeeSetup WHERE Status = 2 AND Date <= @AFDate
								AND AgentPK = @AFAgentPK AND FundPK = @AFFundPK

							)AND FundPK = @AFFundPK AND AgentPK = @AFAgentPK
				END



				
				

		FETCH NEXT FROM A 
		INTO @AFDate,@AFAgentPK,@AFFundPK
	END	
	CLOSE A
	DEALLOCATE A


    CREATE table #FCP  
	    (
	        FundPK int,
		    FundClientPK int,
		    Unit numeric(22,4),
		    UnitDate datetime,
		    NAVDate datetime,
		    MFeeDate DATETIME,
			MfeeMethod INT,
			CurrencyPK INT,
			SharingFeeCalculation INT,
			IsHoliday BIT,
			SellingAgentPK INT,
			MFeeType INT,
			SharingFeeType INT,
			IssueDate Datetime
			
	    )

    insert into #FCP
    Select A.FundPK,A.FundClientPK,sum(isnull(UnitAmount,0)) Unit
	,CASE WHEN B.DT1 = C.IssueDate THEN B.DT1 ELSE  A.Date END UnitDate
	,B.DT1 NAVDate,B.DT2 MFeeDate
	,ISNULL(C.MFeeMethod,1)
	,ISNULL(C.CurrencyPK,1) 
	,ISNULL(C.SharingFeeCalculation,1) 
	,ISNULL(B.IsHoliday,0) 
	,ISNULL(E.AgentPK,D.SellingAgentPK) 
	,ISNULL(F.MfeeType,1) 
	,ISNULL(G.FeeType,1) 
	,C.IssueDate
    from FundClientPosition A
	LEFT JOIN ZDT_WorkingDays B ON A.Date = B.Date
	LEFT JOIN Fund C ON A.FundPK = C.FundPK AND C.status IN (1,2)
	LEFT JOIN FundClient D ON A.FundClientPK = D.FundClientPK AND D.status IN (1,2)
	LEFT JOIN @FCAgent E ON A.FundClientPK = E.FundClientPK AND B.DT2 = E.Date
	LEFT JOIN @FFSetup F ON A.FundPK = F.FundPK AND B.DT2 = F.Date
	LEFT JOIN @AFSetup G ON A.FundPK = G.FundPK AND ISNULL(E.AgentPK,D.SellingAgentPK) = G.AgentPK AND B.DT2 = G.Date
    where A.Date between @StartDate and @EndDate

	
	----------PARAM DISINI
" + _paramFund + _paramFundClient + @"

    group by A.FundPK,A.FundClientPK,A.Date,B.DT1,B.DT2,C.MFeeMethod,C.CurrencyPK,C.SharingFeeCalculation,B.IsHoliday
	,D.SellingAgentPK,E.AgentPK,F.MfeeType,G.FeeType,C.IssueDate
    --having sum(isnull(UnitAmount,0)) > 1
    order by MfeeDate


	--- BUAT HANDLE SUBS DI ISSUE DATE BIAR MUNCUL DI RESULT AKHIR

	
	
		DECLARE @FundFC TABLE
        (
			FundPK INT,
			FundClientPK INT,
			AgentPK int
		)

		INSERT INTO @FundFC
		SELECT DISTINCT FundPK,FundCLientPK,SellingAgentPK FROM #FCP


	INSERT INTO #FCP
	        ( FundPK ,
	          FundClientPK ,
	          Unit ,
	          UnitDate ,
	          NAVDate ,
	          MFeeDate ,
	          MfeeMethod ,
	          CurrencyPK ,
	          SharingFeeCalculation ,
	          IsHoliday ,
	          SellingAgentPK , 
	          MFeeType ,
	          SharingFeeType ,
	          IssueDate
	        )

		SELECT  
		Z.FundPK,Z.FundClientPK,H.TotalUnitAmount Unit
	,H.ValueDate UnitDate
	,H.ValueDate NAVDate
	,H.ValueDate MFeeDate
	,ISNULL(B.MFeeMethod,1)
	,ISNULL(B.CurrencyPK,1) 
	,ISNULL(B.SharingFeeCalculation,1) 
	,ISNULL(C.IsHoliday,0) 
	,ISNULL(Z.AgentPK,0) 
	,ISNULL(F.MfeeType,1) 
	,ISNULL(G.FeeType,1) 
	,B.IssueDate
		
		FROM @FundFC Z
		INNER JOIN Fund B ON Z.FundPK = B.FundPK AND B.status  IN (1,2)
		INNER JOIN dbo.ClientSubscription H ON Z.FundPK = H.FundPK AND Z.FundClientPK = H.FundClientPK AND B.IssueDate = H.ValueDate AND H.status = 2 AND H.Posted = 1 AND H.Revised = 0
		INNER JOIN @FFSetup F ON Z.FundPK = F.FundPK AND B.IssueDate = F.Date
		INNER JOIN @AFSetup G ON Z.FundPK = G.FundPK AND Z.AgentPK	 = G.AgentPK AND B.IssueDate = G.Date
		INNER JOIN dbo.ZDT_WorkingDays C ON B.IssueDate = C.Date 
		WHERE ValueDate BETWEEN @DateFrom AND @DateTo 


		 
		
		
	Declare @FlagDate datetime
    Declare @CFundPK int
    declare @CFundClientPK int
    Declare @UnitBal numeric(22,4)

    DECLARE @cDate TABLE
    (
		Date Datetime
	)

	INSERT INTO @cDate
	Select distinct MFeeDate From #FCP
	
	INSERT #FCP
	        ( FundPK ,
	          FundClientPK ,
	          Unit ,
	          UnitDate ,
	          NAVDate ,
	          MFeeDate,
			  IsHoliday,
			  SellingAgentPK,
			  CurrencyPK,
			  MfeeMethod,
			  SharingFeeCalculation,
			  MFeeType,
			  SharingFeeType,
			  IssueDate
			  )
	        
	  
	SELECT   B.FundPK,B.FundClientPK
	
	,CASE WHEN B.UnitDate < @StartDate THEN 0 ELSE  ISNULL(B.Unit,0) END
	,CASE WHEN D.IssueDate = A.DTM1 THEN A.DTM1 ELSE A.DTM2 END UnitDate
	,A.DTM1 NAVDate,A.Date
	--,ISNULL(B.UNIT,0)
	--,B.UnitDate
	--,B.NAVDate NAVDate,A.Date

	,A.IsHoliday,ISNULL(E.AgentPK,C.SellingAgentPK),ISNULL(D.CurrencyPK,0)
	,ISNULL(B.MFeeMethod,1)
	,ISNULL(B.SharingFeeCalculation,1) 
	,ISNULL(F.MfeeType,1) 
	,ISNULL(G.FeeType,1) 
	,B.IssueDate
	FROM dbo.ZDT_WorkingDays A
	LEFT JOIN #FCP B ON B.UnitDate = CASE WHEN B.IssueDate = A.DTM1 THEN A.DTM1 else A.DTM2 END AND B.MFeeDate <> B.IssueDate --AND B.Unit > 0
	--LEFT JOIN #FCP B ON B.MFeeDate = CASE WHEN B.IssueDate = A.DTM1 THEN A.DTM1 else A.DTM2 END --AND B.Unit > 0
	LEFT JOIN FundClient C ON B.FundClientPK = C.FundClientPK AND C.status IN (1,2)
	LEFT JOIN Fund D ON B.FundPK = D.FundPK AND D.status IN (1,2)
	LEFT JOIN @FCAgent E ON B.FundClientPK = E.FundClientPK AND A.Date = E.Date
	LEFT JOIN @FFSetup F ON B.FundPK = F.FundPK AND A.Date = F.Date
	LEFT JOIN @AFSetup G ON B.FundPK = G.FundPK AND ISNULL(E.AgentPK,C.SellingAgentPK) = G.AgentPK AND A.Date = G.Date
	WHERE A.Date NOT IN
		(
		SELECT Date FROM @cDate
		) AND A.Date BETWEEN @DateFrom AND @Dateto	
	AND B.FundPK IS NOT NULL
	AND A.Date BETWEEN @DateFrom AND @DateTo
	
DECLARE @FPCFundAndDate TABLE
(
	FundPK INT,
	Date DATETIME
)

INSERT INTO @FPCFundAndDate
SELECT DISTINCT FundPK,MFeeDate FROM #FCP

DECLARE @tableFund TABLE
(
	FundPK INT
)

INSERT into @tableFund
        ( FundPK )
SELECT DISTINCT FundPK FROM #FCP

INSERT INTO @FPCFundAndDate
SELECT FundPK,Date FROM dbo.ZDT_WorkingDays,@tableFund
WHERE Date BETWEEN @DateFrom AND @DateTo
AND Date NOT IN
(
	SELECT DISTINCT Date FROM @FPCFundAndDate
)


DECLARE @LastFundInformation TABLE
(
	Date DATETIME,
	FundPK int,
	NAV NUMERIC(22,8),
	Days INT
)

INSERT INTO @LastFundInformation
SELECT Date
,FundPK
,ISNULL(dbo.FgetLastCloseNav(Date,FundPK),0) 
,ISNULL([dbo].[FgetManagementFeeDaysByDate](Date,FundPK),0)
FROM @FPCFundAndDate



DECLARE @ClientRedemption TABLE
(
	ValueDate DATETIME,
	FundPK INT,
	FundClientPK INT,
	TotalUnitAmount NUMERIC(22,4),
	TotalCashAmount NUMERIC(22,4),
	RedemptionFee NUMERIC(22,4)
)

INSERT INTO @ClientRedemption
        ( ValueDate ,
          FundPK ,
          FundClientPK ,
          TotalUnitAmount ,
          TotalCashAmount,
		  RedemptionFee
        )
	SELECT ValueDate,FundPK,FundClientPK, sum(ISNULL(UnitAmount,0)) TotalUnitAmount
	, sum(ISNULL(CashAmount,0)) TotalCashAmount
	, sum(ISNULL(RedemptionFeeAmount,0)) FeeAmount
    from ClientRedemption where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
    group by FundClientPK,ValueDate,FundPK


DECLARE @ClientSubscription TABLE
(
	ValueDate DATETIME,
	FundPK INT,
	FundClientPK INT,
	TotalUnitAmount NUMERIC(22,4),
	TotalCashAmount NUMERIC(22,4),
	SubscriptionFee NUMERIC(22,4)
)

INSERT INTO @ClientSubscription
        ( ValueDate ,
          FundPK ,
          FundClientPK ,
          TotalUnitAmount ,
          TotalCashAmount,
		  SubscriptionFee
        )
  Select ValueDate,FundPK,FundClientPK, sum(ISNULL(TotalUnitamount,0)) TotalUnitAmount
  , sum(ISNULL(TotalCashAmount,0)) TotalCashAmount
  ,sum(ISNULL(SubscriptionFeeAmount,0)) TotalCashAmount
    from ClientSubscription where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
    group by FundClientPK,ValueDate,FundPK


DECLARE @ClientSwitchingFrom TABLE
(
	ValueDate DATETIME,
	FundPK INT,
	FundClientPK INT,
	TotalUnitAmountFundFrom NUMERIC(22,4),
	TotalCashAmountFundFrom NUMERIC(22,4),
	SwitchingFee NUMERIC(22,4)
)
INSERT INTO @ClientSwitchingFrom
        ( ValueDate ,
          FundPK ,
          FundClientPK ,
          TotalUnitAmountFundFrom ,
          TotalCashAmountFundFrom,
		  SwitchingFee
        )
Select ValueDate,FundPKFrom FundPK,FundClientPK, sum(ISNULL(UnitAmount,0)) TotalUnitAmountFundFrom
, sum(ISNULL(CashAmount,0)) TotalCashAmountFundFrom
, sum(ISNULL(SwitchingFeeAmount,0)) FeeAmount
from ClientSwitching where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
group by FundClientPK,ValueDate,FundPKFrom



DECLARE @ClientSwitching TABLE
(
	ValueDate DATETIME,
	FundPK INT,
	FundClientPK INT,
	TotalUnitAmountFundTo NUMERIC(22,4),
	TotalCashAmountFundTo NUMERIC(22,4),
	SwitchingFee NUMERIC(22,4)
)

INSERT INTO @ClientSwitching
        ( ValueDate ,
          FundPK ,
          FundClientPK ,
          TotalUnitAmountFundTo ,
          TotalCashAmountFundTo,
		  SwitchingFee
        )
    Select ValueDate,FundPKTo FundPK,FundClientPK, sum(ISNULL(TotalUnitAmountFundTo,0)) TotalUnitAmountFundTo
	, sum(ISNULL(TotalCashAmountFundTo,0)) TotalCashAmountFundTo
	, SUM(ISNULL(SwitchingFeeAmount,0)) FeeAmount
    from ClientSwitching where posted = 1 and revised = 0 and status = 2 and ValueDate between @DateFrom and @DateTo
    group by FundClientPK,ValueDate,FundPKTo



CREATE table #MFeeInformation 
(
	MfeeDate DATETIME,
	AUMForMFee NUMERIC(22,4),
	MFeeType INT,
	FundClientPK INT,
	FundPK INT,
	Days INT
	--MfeePercent NUMERIC(18,8),
	--MFeeAmount NUMERIC(22,4)
)

INSERT INTO #MFeeInformation
        ( MfeeDate, AUMForMFee, MFeeType,FundClientPK,FundPK,days )

SELECT A.MFeeDate
,isnull(A.Unit  *  case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
else  B.NAV 
end END,0)  AUMForMFee
,A.MFeeType
,A.FundClientPK
,A.FundPK
,ISNULL(B.Days,365)

FROM #FCP A
Left join @LastFundInformation B on A.FundPK = B.FundPK and A.NAVDate = B.Date

WHERE A.MFeeDate BETWEEN @dateFrom AND @DateTo
ORDER BY A.MFeeDate ASC


CREATE Table #MFeeCal 
(
	MFeeDate datetime,
	MFeeAmount numeric(22,4),
	MFeePercent numeric(18,8),
	FundClientPK INT,
	FundPK INT
	)

INSERT INTO #MFeeCal
        ( MFeeDate, MFeeAmount, MFeePercent,FundClientPK,FundPK )

SELECT 
A.MfeeDate

--MFeeAmount
,ISNULL(CASE WHEN A.MFeeType = 1 THEN A.AUMForMFee * B.FeePercent / 100 / A.Days
WHEN A.MFeeType = 2 THEN 
	CASE WHEN A.AUMForMFee > B.RangeTo then
		(B.RangeTo - B.RangeFrom) * B.FeePercent / 100 / A.Days 
		ELSE CASE WHEN A.AUMForMFee > B.RangeFrom THEN (A.AUMForMFee - B.RangeFrom) * B.FeePercent / 100 / A.Days ELSE 0 END END
WHEN A.MFeeType = 3 THEN
	CASE WHEN A.AUMForMfee BETWEEN B.RangeFrom AND B.RangeTo 
		THEN A.AUMForMFee * B.FeePercent / 100 / A.Days ELSE 0 END
WHEN A.MFeeType = 4 AND A.MfeeDate <= B.AmortizeDate THEN
	CASE WHEN DATEDIFF(DAY,B.FirstAmortizeDate,B.AmortizeDate) > 0 AND B.AmortizeAmount > 0 
		THEN B.AmortizeAmount / (DATEDIFF(DAY,B.FirstAmortizeDate,B.AmortizeDate) + 1) ELSE 0 END
END,0) 

,ISNULL(B.FeePercent,0)
,A.FundClientPK
,A.FundPK
FROM #MFeeInformation A
LEFT JOIN @FFSetupDetail B ON A.MfeeDate = B.Date AND A.MFeeType = B.MfeeType
AND A.FundPK = B.FundPK


-- CHECK PERHITUNGAN FEE DETAIL DISINI
--SELECT * FROM #MFeeInformation ORDER BY MfeeDate
--SELECT * FROM @FFSetupDetail WHERE fundPK = 235 ORDER BY date asc
--SELECT * FROM #MFeeCal ORDER BY MFeeDate asc
---------
 




CREATE table #MFeeCalSummary 
(
	MFeeDate datetime,
	MFeeAmount numeric(22,4),
	MFeePercent numeric(18,8),
	FundClientPK INT,
	FundPK INT
)

INSERT INTO #MFeeCalSummary

        ( MFeeDate ,
          MFeeAmount ,
          MFeePercent ,
          FundClientPK ,
          FundPK
        )
SELECT MfeeDate,SUM(ISNULL(MFeeAmount,0)),AVG(MfeePercent),FundClientPK,FundPK FROM #MFeeCal
GROUP BY MFeeDate,FundClientPK,FundPK



 
CREATE table #MAgentFeeInformation 
(
	MfeeDate DATETIME,
	AgentFeeType INT,
	AgentPK INT,
	FundPK INT,
	FundClientPK INT,
	AUMForMFee NUMERIC(22,4),
	MFeeAmount NUMERIC(22,4),
	Days INT,
	MFeePercent NUMERIC(18,8)
)

INSERT INTO #MAgentFeeInformation
SELECT A.MFeeDate
,ISNULL(A.SharingFeeType,1)
,A.SellingAgentPK
,A.FundPK
,A.FundClientPK
,isnull(Case when A.SharingFeeCalculation = 1 then A.Unit 
*  case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
else  ISNULL(B.NAV,0) 
end end else  K.UnitAmount * 
    case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
ELSE case when A.IsHoliday = 1 THEN B.NAV ELSE Y.NAV END
end end END,0)  AUMForMFee
,ISNULL(M.MFeeAmount,0) MFee
,ISNULL(B.Days,365)
,M.MFeePercent
FROM #FCP A
Left join @LastFundInformation B on A.FundPK = B.FundPK and A.NAVDate = B.Date
LEFT JOIN #MFeeCalSummary M ON A.FundPK = M.FundPK  AND A.FundClientPK = M.FundClientPK AND A.MFeeDate = M.MFeeDate
left join FundClientPosition K on A.FundPK = K.FundPK and A.FundClientPK = K.FundClientPK and K.Date =  case when A.IsHoliday = 1 then A.UnitDate else A.NAVDate END
Left join @LastFundInformation Y on A.FundPK = Y.FundPK and A.MFeeDate = Y.Date 
WHERE A.MFeeDate BETWEEN @dateFrom AND @DateTo
ORDER BY A.MFeeDate ASC

--SELECT * FROM #MAgentFeeInformation ORDER BY MfeeDate

CREATE Table #MAgentFeeCal 
(
	MFeeDate datetime,
	AgentFeeAmount numeric(22,4),
	AgentFeePercent numeric(18,8),
	FundClientPK INT,
	FundPK INT,
	AgentPK int
)

--1 FLAT
--2 Tiering By Aum
--3 Tiering By MFee
--4 Prog by Aum
--5 Prog by MFee
--6 Amortize

INSERT INTO #MAgentFeeCal
SELECT A.MfeeDate
,ISNULL(CASE WHEN A.AgentFeeType = 1 THEN CASE WHEN A.MfeePercent > 0 THEN A.AUMForMFee * A.MFeePercent/100 / A.Days * ISNULL(B.FeePercent,C.Feepercent) / 100 
ELSE A.MFeeAmount * ISNULL(B.FeePercent,C.Feepercent) / 100 END
	 WHEN A.AgentFeeType = 2 THEN 
		CASE WHEN A.AUMForMFee > B.RangeTo THEN  	
		(B.RangeTo - B.RangeFrom) * ISNULL(B.FeePercent,C.Feepercent) / 100 / A.Days 
		 ELSE CASE WHEN A.AUMForMFee > B.RangeFrom THEN (A.AUMForMFee - B.RangeFrom) * ISNULL(B.FeePercent,C.Feepercent) / 100 / A.Days ELSE 0 END END
	WHEN A.AgentFeeType = 3 THEN          
		CASE WHEN A.MFeeAmount > B.RangeTo THEN  	
		(B.RangeTo - B.RangeFrom) * ISNULL(B.FeePercent,C.Feepercent) / 100 
		ELSE CASE WHEN A.MFeeAmount > B.RangeFrom THEN  (A.MFeeAmount - B.RangeFrom) * ISNULL(B.FeePercent,C.Feepercent) / 100 ELSE 0 END  END    
	WHEN A.AgentFeeType = 4 THEN
		CASE WHEN A.AUMForMfee BETWEEN B.RangeFrom AND B.RangeTo 
		THEN A.AUMForMFee * ISNULL(B.FeePercent,C.Feepercent) / 100 / A.Days ELSE 0 END
	WHEN A.AgentFeeType = 5 THEN
		CASE WHEN A.MFeeAmount BETWEEN B.RangeFrom AND B.RangeTo 
		THEN A.MFeeAmount * ISNULL(B.FeePercent,C.Feepercent) / 100  ELSE 0 END
	WHEN A.AgentFeeType = 6 AND A.MfeeDate <= B.AmortizeDate THEN
		CASE WHEN DATEDIFF(DAY,B.FirstAmortizeDate,B.AmortizeDate) > 0 AND B.AmortizeAmount > 0 
		THEN B.AmortizeAmount / (DATEDIFF(DAY,B.FirstAmortizeDate,B.AmortizeDate) + 1) ELSE 0 END
 END,0)
 ,case when B.fundPK is not null and B.FeeType = 6 then 0     
    when C.FundPK is not null and C.FeeType =6 then 0 else
Case when ISNULL(B.FeePercent,0) > 0  then B.FeePercent else isnull(C.FeePercent,0) end end
 ,A.FundClientPK
 ,A.FundPK
 ,A.AgentPK
FROM #MAgentFeeInformation A
LEFT JOIN @AFSetupDetail B ON A.FundPK = B.FundPK AND A.AgentPK = B.AgentPK AND A.MfeeDate = B.Date
LEFT JOIN @AFSetupDetail C ON C.FundPK = 0 AND A.MfeeDate = C.Date AND A.AgentPK = C.AgentPK


CREATE table #AgentFeeCalSummary 
(
	MFeeDate datetime,
	AgentFeeAmount numeric(22,4),
	AgentFeePercent numeric(18,8),
	FundClientPK INT,
	FundPK INT,
	AgentPK INT
)
INSERT INTO #AgentFeeCalSummary
SELECT MFeeDate,SUM(ISNULL(AgentFeeAmount,0)),AVG(AgentFeePercent) 
,FundClientPK,FundPK,AgentPK
FROM #MAgentFeeCal
GROUP BY MFeeDate,FundClientPK,FundPK,AgentPK


-- BIKIN TABLE DailyDataForCommissionRptNEW

INSERT INTO DailyDataForCommissionRptNEW
SELECT  A.UnitDate,A.NAVDate,A.MFeeDate,A.FundPK
,A.FundClientPK,A.SellingAgentPK  
--NAV
,case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
else  ISNULL(Y.NAV,0)
END END NAV

,isnull(case when A.IsHoliday = 1 then isnull(L.UnitAmount,0)  else isnull(J.UnitAmount,0)  end 
* case when A.IsHoliday = 1 THEN ISNULL(B.NAV,0) ELSE ISNULL(Y.NAV,0) END,0) AUM


--,A.MFeeType

-- AUM FOR Mfee
,isnull(A.Unit  *  case when A.MFeeMethod = 2 and A.CurrencyPK = 1 then 1000 else case when A.MFeeMethod = 2 and A.CurrencyPK <> 1 then 1
else  B.NAV 
end END,0)  AUMForMFee

--MFee
,ISNULL(M.MFeeAmount,0) MFee
,ISNULL(M.MFeePercent,0) MFeePercent
,A.MFeeType

--AgentFee
,ISNULL(P.AgentFeeAmount,0) AgentFee
,ISNULL(P.AgentFeePercent,0) AgentFeePercent
,A.SharingFeeType
, case when A.IsHoliday = 1 then isnull(L.UnitAmount,0)  else isnull(J.UnitAmount,0)  end UnitAmount

,isnull(A.CurrencyPK,'') Currency
,isnull(I.TotalCashAmount,0) SubsAmount
,isnull(F.TotalCashAmount,0) RedempAmount
,isnull(G.TotalCashAmountFundTo,0) SwitchInAmount
,isnull(H.TotalCashAmountFundFrom,0) SwitchOutAmount
,isnull(I.TotalUnitAmount,0) SubsUnit
,isnull(F.TotalUnitAmount,0) RedempUnit
,isnull(G.TotalUnitAmountFundTo,0) SwitchInUnit
,ISNULL(H.TotalUnitAmountFundFrom,0) SwitchOutUnit


FROM #FCP A
Left join @LastFundInformation B on A.FundPK = B.FundPK and A.NAVDate = B.Date
Left join @LastFundInformation Y on A.FundPK = Y.FundPK and A.MFeeDate = Y.Date 
left join @ClientRedemption F on A.FundPK = F.FundPK and A.FundClientPK = F.FundClientPK and A.MFeeDate = F.ValueDate
left JOIN @ClientSwitching G on A.FundPK = G.FundPK and A.FundClientPK = G.FundClientPK and A.MFeeDate = G.ValueDate
left JOIN @ClientSwitchingFrom H on A.FundPK = H.FundPK and A.FundClientPK = H.FundClientPK and A.MFeeDate = H.ValueDate
left join @ClientSubscription I on A.FundPK = I.FundPK and A.FundClientPK = I.FundClientPK and A.MFeeDate = I.ValueDate
LEFT JOIN #MFeeCalSummary M ON A.FundPK = M.FundPK  AND A.FundClientPK = M.FundClientPK AND A.MFeeDate = M.MFeeDate
left join FundClientPosition L on A.FundPK = L.FundPK and A.FundClientPK = L.FundClientPK and L.Date =  A.UnitDate
left join FundClientPosition J on A.FundPK = J.FundPK and A.FundClientPK = J.FundClientPK and J.Date =  A.NAVDate
LEFT JOIN #AgentFeeCalSummary P ON A.SellingAgentPK = P.AgentPK AND A.MFeeDate = P.MFeeDate AND A.FundPK = P.FundPK AND A.FundClientPK = P.FundClientPK
WHERE A.MFeeDate BETWEEN @dateFrom AND @DateTo
ORDER BY A.MFeeDate ASC


CREATE TABLE #Subs
(
	FundClientPK INT,
	FundPK INT,
	MinMfeeDate DATETIME,
	MfeePercent NUMERIC(8,4),
	AgentFeePercent NUMERIC(8,4)
)

INSERT INTO #Subs
        ( FundClientPK, FundPK, MinMfeeDate )
SELECT FundClientPK,FundPK, MIN(MFeeDate) FROM dbo.DailyDataForCommissionRptNew A
WHERE 1=1 

" + _paramFund + _paramFundClient + @"


-- PARAM DISINI
 
GROUP BY FundClientPK,FundPK



UPDATE A SET  A.MfeePercent = B.MFeePercent, A.AgentFeePercent = B.AgentFeePercent FROM #Subs A
LEFT JOIN dbo.DailyDataForCommissionRptNew B ON A.FundClientPK = B.FundClientPK AND A.FundPK = B.FundPK AND A.MinMfeeDate = B.MFeeDate




INSERT INTO dbo.DailyDataForCommissionRptNew
        ( UnitDate ,
          NAVDate ,
          MFeeDate ,
          FundPK ,
          FundClientPK ,
          SellingAgentPK ,
          NAV ,
          AUM ,
          AUMForMFee ,
          MFee ,
          MFeePercent ,
          MFeeType ,
          AgentFee ,
          AgentFeePercent ,
          SharingFeeType ,
          UnitAmount ,
          Currency ,
          SubsAmount ,
          RedempAmount ,
          SwitchInAmount ,
          SwitchOutAmount ,
          SubsUnit ,
          RedempUnit ,
          SwitchInUnit ,
          SwitchOutUnit
        )
SELECT B.ValueDate,Valuedate,B.ValueDate,B.FundPK,B.FundClientPK,ISNULL(C.AgentPK,D.SellingAgentPK)
,B.NAV,0,0,0,A.MfeePercent,1,0,A.AgentFeePercent,1,0,B.CurrencyPK,B.CashAmount,0,0,0,B.UnitAmount,0,0,0
FROM #Subs A
LEFT JOIN dbo.ClientSubscription B ON A.FundClientPK = B.FundClientPK AND A.FundPK = B.FundPK AND B.ValueDate < A.MinMfeeDate AND B.Posted = 1 AND B.Status <> 3
LEFT JOIN @FCAgent C ON A.FundClientPK = C.FundClientPK AND C.Date = B.ValueDate
LEFT JOIN FundClient D ON A.FundClientPK = D.FundClientPK AND D.Status IN (1,2)
WHERE B.ClientSubscriptionPK IS NOT NULL and B.ValueDate between @datefrom and @Dateto



INSERT INTO dbo.DailyDataForCommissionRptNew
        ( UnitDate ,
          NAVDate ,
          MFeeDate ,
          FundPK ,
          FundClientPK ,
          SellingAgentPK ,
          NAV ,
          AUM ,
          AUMForMFee ,
          MFee ,
          MFeePercent ,
          MFeeType ,
          AgentFee ,
          AgentFeePercent ,
          SharingFeeType ,
          UnitAmount ,
          Currency ,
          SubsAmount ,
          RedempAmount ,
          SwitchInAmount ,
          SwitchOutAmount ,
          SubsUnit ,
          RedempUnit ,
          SwitchInUnit ,
          SwitchOutUnit
        )
SELECT B.ValueDate,Valuedate,B.ValueDate,B.FundPKTo,B.FundClientPK,ISNULL(C.AgentPK,D.SellingAgentPK)
,B.NAVFundTo,0,0,0,A.MfeePercent,1,0,A.AgentFeePercent,1,0,B.CurrencyPK,B.TotalCashAmountFundTo,0,0,0,B.TotalUnitAmountFundTo,0,0,0
FROM #Subs A
LEFT JOIN dbo.ClientSwitching B ON A.FundClientPK = B.FundClientPK AND A.FundPK = B.FundPKTo AND B.ValueDate < A.MinMfeeDate AND B.Posted = 1 AND B.Status <> 3
LEFT JOIN @FCAgent C ON A.FundClientPK = C.FundClientPK AND C.Date = B.ValueDate
LEFT JOIN FundClient D ON A.FundClientPK = D.FundClientPK AND D.Status IN (1,2)
WHERE B.ClientSwitchingPK IS NOT NULL  and B.ValueDate between @datefrom and @Dateto



DECLARE @ZCFundClientPK INT
DECLARE @ZCFundPK INT
DECLARE @ZCMinMfeeDate Datetime
DECLARE @ZCMIFeePercent NUMERIC(18,4)
DECLARE @ZCMIAgentPercent NUMERIC(18,4)

Declare A Cursor For
	SELECT A.FundClientPK,A.FundPK,A.MinMfeeDate,A.MfeePercent,A.AgentFeePercent FROM #Subs A
	WHERE MinMfeeDate > @DateFrom
Open A
Fetch Next From A
INTO @ZCFundClientPK,@ZCFundPK,@ZCMinMfeeDate,@ZCMIFeePercent,@ZCMIAgentPercent
While @@FETCH_STATUS = 0  
Begin




INSERT INTO dbo.DailyDataForCommissionRptNew
        ( UnitDate ,
          NAVDate ,
          MFeeDate ,
          FundPK ,
          FundClientPK ,
          SellingAgentPK ,
          NAV ,
          AUM ,
          AUMForMFee ,
          MFee ,
          MFeePercent ,
          MFeeType ,
          AgentFee ,
          AgentFeePercent ,
          SharingFeeType ,
          UnitAmount ,
          Currency ,
          SubsAmount ,
          RedempAmount ,
          SwitchInAmount ,
          SwitchOutAmount ,
          SubsUnit ,
          RedempUnit ,
          SwitchInUnit ,
          SwitchOutUnit
        )
	SELECT A.Date,A.Date,A.Date,@ZCFundPK,@ZCFundClientPK,ISNULL(C.AgentPK,B.SellingAgentPK)
	,ISNULL(D.NAV,F.NAV),ISNULL(G.UnitAmount * D.Nav,0),0,0,@ZCMIFeePercent,1,0,@ZCMIAgentPercent,1,isnull(G.UnitAmount,0),E.CurrencyPK,0,0,0,0,0,0,0,0 
	FROM dbo.ZDT_WorkingDays A
	LEFT JOIN FundClient B ON B.FundClientPK = @ZCFundClientPK AND B.status IN (1,2)
	LEFT JOIN @FCAgent C ON C.FundClientPK = @ZCFundClientPK  AND C.Date = A.Date
	LEFT JOIN CloseNAV D ON D.FundPK = @ZCFundPK AND D.Date = A.Date AND D.Status IN (1,2)
	LEFT JOIN Fund E ON E.FundPK = @ZCFundPK AND E.status IN (1,2) 
	LEFT JOIN CloseNAV F ON F.FundPK = @ZCFundPK AND F.Date = A.DTM1 AND F.Status IN (1,2)
LEFT JOIN dbo.FundClientPosition G ON A.DTM1 = G.Date AND G.FundClientPK = @ZCFundClientPK AND G.FundPK = @ZCFundPK
	WHERE A.date NOT IN
    (
		SELECT MFeeDate FROM dbo.DailyDataForCommissionRptNew
		WHERE fundClientPK = @ZCFundClientPK AND FundPK = @ZCFundPK
		AND MFeeDate BETWEEN @DateFrom AND @ZCMinMfeeDate
	)
	AND A.Date >
    (
		SELECT MIN(A.Date) FROM (
			SELECT ISNULL(MIN(NAVDate),'01/01/2099') Date FROM dbo.ClientSubscription WHERE fundclientPK = @ZCFundClientPK AND FundPK = @ZCFundPK
			AND Posted = 1 AND status = 2 AND Revised = 0 AND NAVDate < @ZCMinMfeeDate
			UNION ALL
			SELECT ISNULL(MIN(NAVDate),'01/01/2099') Date FROM dbo.ClientSwitching WHERE fundclientPK = @ZCFundClientPK AND FundPKTo = @ZCFundPK
			AND Posted = 1 AND status = 2 AND Revised = 0 AND NAVDate < @ZCMinMfeeDate
			) A
	)
	AND A.Date BETWEEN @DateFrom AND @ZCMinMfeeDate

	Fetch Next From A 
	INTO @ZCFundClientPK,@ZCFundPK,@ZCMinMfeeDate,@ZCMIFeePercent,@ZCMIAgentPercent
End	
Close A
Deallocate A



";

                        cmd.CommandTimeout = 0;
                        cmd.Parameters.AddWithValue("@DateFrom", _endDayTrails.ValueDateFrom);
                        cmd.Parameters.AddWithValue("@DateTo", _endDayTrails.ValueDateTo);
                        cmd.ExecuteNonQuery();


                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }

        public void DailyDataForCommissionRptNew_LogInsert(EndDayTrails _endDayTrails)
        {
            try
            {

                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
                        insert into DailyDataForCommissionRptNewLog(DailyDataForCommissionRptNewLogPK,DateFrom,DateTo,UsersID,GenerateTime,Fund,Client,LastUpdate)
                        select isnull(max(DailyDataForCommissionRptNewLogPK),0) + 1,@DateFrom,@DateTo,@UsersID,@Time,@Fund,@Client,@Time from DailyDataForCommissionRptNewLog  
                        ";

                        cmd.Parameters.AddWithValue("@DateFrom", _endDayTrails.ValueDateFrom);
                        cmd.Parameters.AddWithValue("@DateTo", _endDayTrails.ValueDateTo);
                        cmd.Parameters.AddWithValue("@UsersID", _endDayTrails.EntryUsersID);
                        cmd.Parameters.AddWithValue("@Time", _datetimeNow);
                        cmd.Parameters.AddWithValue("@Fund", _endDayTrails.FundText);
                        if (_endDayTrails.FundClientText == "")
                        {
                            cmd.Parameters.AddWithValue("@Client","ALL");
                        }
                        else
                        {
                            cmd.Parameters.AddWithValue("@Client", _endDayTrails.FundClientText);
                        }
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }


        public int EndDayTrails_GenerateFundJournalOnlyWithParamFund(string _usersID, DateTime _valueDate, EndDayTrails _edt)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        string _paramFund = "";

                        if (!_host.findString(_edt.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_edt.FundFrom))
                        {
                            _paramFund = "And A.FundPK in ( " + _edt.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
                        Declare @XFundPK int
                        Declare @XFundID nvarchar(50)
                        Declare @TrailsPK int

                        DECLARE X CURSOR FOR     

                        select FundPK,ID from Fund A where status in (1,2)  " + _paramFund + @" and MaturityDate >= @ValueDate

                        Open X
                        Fetch Next From X
                        Into @XFundPK,@XFundID

                        While @@FETCH_STATUS = 0
                        BEGIN  

                      
                        --VOID EDT FUND JOURNAL ONLY

                        update FundJournal set Posted = 0,Status = 3,VoidUsersID = @UsersID ,VoidTime= @lastUpdate, LastUpdate = @LastUpdate 			
                        where  Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION' and TrxNo =
                        (
                        Select EndDayTrailsPK from EndDayTrails where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal' and FundPK = @XFundPK
                        )  

                        update EndDayTrails set status = 3,VoidUsersID = @UsersID,VoidTime = @LastUpdate,LastUpdate=@lastUpdate    
                        where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal'   and FundPK = @XFundPK
                        

                         
                        update CloseNav set status = 3,VoidUsersID = @UsersID ,VoidTime= @LastUpdate, LastUpdate = @LastUpdate 
                        where Date = @ValueDate and status <> 3  and FundPK = @XFundPK

                        Fetch next From X   
                        Into @XFundPK,@XFundID                
                        End                  
                        Close X                  
                        Deallocate X 
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.ExecuteNonQuery();



                    }
                }

                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        string _paramFund = "";

                        if (!_host.findString(_edt.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_edt.FundFrom))
                        {
                            _paramFund = "And A.FundPK in ( " + _edt.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  

Declare @BDateFrom datetime
Declare @BTotalDays int

select @BDateFrom = DateFrom from Period where @ValueDate between DateFrom and DateTo and status = 2
select @BTotalDays = datediff(Day,@BDateFrom,dateadd(year,1,@BDateFrom))

Create Table #TempInterest
(
InstrumentID nvarchar(100),
InterestAmount numeric(22,4),
TaxAmount numeric(22,4),
FinalAmount numeric(22,4)
)


Create Table #Mature
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Create Table #RecCoupon
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),LastCouponDate datetime,NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int, RecCouponDate datetime
)

Create Table #ZFundFee               
(                  
DateOfPayment int,  
FundPK int,                  
ManagementFeePercent numeric(18,8),
CustodiFeePercent numeric(18,8),
AuditFeeAmount numeric(18,4),
MovementFeeAmount numeric(18,4),
ManagementFeeDays int,
CustodiFeeDays int,
AuditFeeDays int,
SinvestFeeDays int,
FundType int,
BitSinvestFee bit,
OtherFeeOneAmount numeric(18,4),
OtherFeeTwoAmount numeric(18,4),
)   

Create Table #ZDividenSaham                  
(                  
InstrumentPK int,     
FundPK int,                  
LastVolume numeric(18,4),
PaymentDate datetime,
RecordingDate datetime,
Earn numeric(22,4),
Hold numeric(22,4),
TaxDueDate int
)   

Create table #dayTemp
(
IntDay  int
)


Declare @XFundPK int
Declare @XFundID nvarchar(50)
Declare @TrailsPK int

DECLARE X CURSOR FOR     


select FundPK,ID from Fund A where status in (1,2)  " + _paramFund + @" and MaturityDate >= @ValueDate

Open X
Fetch Next From X
Into @XFundPK,@XFundID

While @@FETCH_STATUS = 0
BEGIN  


Declare @MSG nvarchar (Max)   
Declare @PeriodPK int                  
Declare @maxEndDayTrailsPK int    
Declare @DateYesterday datetime 
Declare @DefaultCashAtBankPK int


set @DefaultCashAtBankPK = 3

Select  @DateYesterday  = ValueDate From EndDayTrailsFundPortfolio
where status = 2 and valuedate =(
Select Max(valueDate) From EndDayTrailsFundPortfolio where status = 2 and ValueDate < @ValueDate and FundPK = @XFundPK
) and FundPK = @XFundPK


Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                
Select @maxEndDayTrailsPK = ISNULL(EndDayTrailsPK,0) + 1 from EndDayTrails     

set @maxEndDayTrailsPK = isnull(@maxEndDayTrailsPK,1)               



Insert into EndDayTrails(EndDayTrailsPK,HistoryPK,Status,Notes,ValueDate,FundPK,BitValidate,LogMessages
,EntryUsersID,EntryTime,LastUpdate)                    
Select @maxEndDayTrailsPK,1,2,'Fund Journal',@ValueDate,@XFundPK,1,'',@UsersID,@LastUpdate,@LastUpdate  

---- NEW -----
--if Not Exists(              
--Select * from CloseNAV where Status = 2 and date = @DateYesterday             
--)              
--BEGIN              
--Set @MSG = 'MISSING DATA: Close NAV Yesterday For Fund : ' + @XFundID              
--Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 2 and FundPK = @XFundPK              
--Select @maxEndDayTrailsPK LastPK                   
--RETURN;                   
--END              



-- Parameter untuk masuk Ke Jurnal                  
Declare @InvestmentAcc   int                  
Declare @PayablePurchaseAcc  int                  
Declare @CashAtBankAcc   int                  
Declare @CommissionAcc   int                  
Declare @LevyAcc    int                  
Declare @VatAcc     int                  
Declare @WhtAcc     int                  
                
Declare @TaxExpenseAcc   int                  
Declare @WHTTaxPayableAccrInterest int     
Declare @InterestRecAcc int 
--BOND
Declare @InvestmentAccBond   int 
Declare @InterestRecBuySellAccBond int      
Declare @InterestRecAccBond   int 
Declare @RealisedAccBond int   
Declare @ReceivableSaleAccBond int 
Declare @TaxCapitalGainAccBond int 
Declare @TaxInterestAccBond int 

-- Sell              
Declare @ReceivableSaleAcc int              
Declare @RealisedAcc int              
Declare @IncomeSaleTaxAcc int                 
-- Untuk variabel Posting                  
Declare @PValueDate        datetime                  
Declare @PPeriodPK        int                  
Declare @PReference        nvarchar(50)                  
Declare @PTrxType        int                
Declare @PCounterpartPK       int                  
Declare @PInstrumentPK       int                  
Declare @PInstrumentTypePK      int                  
Declare @PFundPK        int                  
Declare @PFundCashRefPK       int                  
Declare @PDoneAccruedInterest  Numeric(18,6)                  
Declare @PSettlementDate      Datetime       
Declare @PAcqDate      Datetime            
Declare @PDoneVolume       numeric(18,0)   
Declare @PAmount       numeric(18,0)               
Declare @PDoneAmount       numeric(18,0)                  
Declare @PCommissionAmount      numeric(18,6)                  
Declare @PLevyAmount       numeric(18,6)                  
Declare @PKPEIAmount       numeric(18,6)                  
Declare @PVATAmount        numeric(18,6)                  
Declare @PWHTAmount        numeric(18,6)                  
Declare @POTCAmount        numeric(18,6)                   
Declare @PIncomeTaxSellAmount     numeric(18,6)                   
Declare @PIncomeTaxInterestAmount    numeric(18,6)                   
Declare @PIncomeTaxGainAmount     numeric(18,6) 
Declare @PTotalAmount       numeric(19,6)                   
Declare @PCurrencyRate       numeric(18,8)                  
Declare @InstrumentType int                  
Declare @FundJournalPK int                  
Declare @InstrumentID nvarchar(30)                  
Declare @FPayablePurchaseAmount numeric(19,6)                  
Declare @InstrumentCurrencyPK int     
Declare @BondDayAccrued int      
Declare @PInterestPercent Numeric(22,6)          

Declare @SellAvgPrice numeric(18,6)  
Declare @AvgAmount numeric(22,6)              
Declare @RealisedAmount numeric(22,6)
Declare @InvestmentShareAmount numeric(22,6)   
Declare @ReceivableSellBondAmount numeric(22,6)    

Declare @PTaxExpenseAmount numeric(22,6) 
Declare @PTaxExpensePercent numeric(22,6) 
Declare @PInterestAmount numeric(22,6) 
Declare @PFinalAmount numeric(22,6)
     
Declare @WHTDueDate int

-- REKSADANA
Declare @ReksadanaTypePK int
Declare @CashForMutualFund int
Declare @MInterestAmount numeric(18,4)
Declare @BDate datetime
Declare @InterestReceivableSellMutualFund int
Declare @InvestmentMutualFundAmount numeric(18,4)

               
-- A. Posting Investment   
-- 1. BUY EQUITY --  
-- 2. SELL EQUITY --
-- 3. BUY BOND -- 
-- 4. SELL BOND -- 
-- 5. PLACEMENT DEPOSITO -- 
-- 6. LIQUIDATE DEPOSITO -- 
-- 7. ROLLOVER DEPOSITO -- 


-- B. Daily Fee dan Payment Fee 	 	            
-- 1. GENERATE DAILY FEE --    
-- 2. PAYMENT FEE -- 
-- 3. BANK INTEREST --
	                       
-- C. Reval, Interest Accrued Bond, Interest Accrued Time Deposit, Mature Bond, Mature Time Deposit
-- 1. REVALUATION EQUITY & BOND --   
-- 2. GENERATE INTEREST ACCRUED BOND           
-- 3. MATURE TIME DEPOSIT YANG BELOM SAMPE UJUNG           
-- 4. MATURE BOND & TIME DEPOSIT
-- 5. REC COUPON BOND
	
-- D. Copy Fund Client Position 

-- E. Pending Subscription

-- A. POSTING INVESTMENT --        

Declare @PBreakInterestPercent numeric(8,4)
Declare @PSettlementPK int

Declare A Cursor For                  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                   
FundPK,FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,Amount,DoneAmount,                  
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                  
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate            
From Investment         
Where StatusSettlement = 2 and Posted = 0 and Valuedate in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday and FundPK = @XFundPK)  and InstrumentTypePK <> 6  and FundPK = @XFundPK 

UNION ALL -- REKSADANA
  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                     
FundPK,case when FundCashRefPK = 0 then 3 else FundCashRefPK end FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,DoneAmount,isnull(DoneAmount,0),                    
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                    
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate             
From Investment           
Where StatusInvestment = 2 and StatusDealing <> 3 and StatusSettlement <> 3 and Valuedate = @ValueDate 
and InstrumentTypePK = 6 and FundPK = @XFundPK
     
   
Open A                  
Fetch Next From A                  
Into @PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,
@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount
,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount
,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,@PBreakInterestPercent,@PSettlementPK ,@PTaxExpensePercent,@PInterestPercent,@PAcqDate             
While @@FETCH_STATUS = 0                  
Begin                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK              
-- 1 = REGULER                  
-- 2 = G-BOND                  
-- 3 = C-BOND                  
-- 4 = RI                  
-- 5 = DEPOSITO                  
-- 6 = WARRANT 
                
-- A1. BUY EQUITY --                 
if @PTrxType = 1 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentEquity,@PayablePurchaseAcc = PayablePurchaseEquity 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 EQUITY BUY: ' + @InstrumentID 
,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled EQUITY BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A2. SELL EQUITY --              
if @PTrxType = 2 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentEquity,@ReceivableSaleAcc = AccountReceivableSaleEquity,@RealisedAcc = RealisedEquity From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             

Declare @SellArAmount numeric(22,6) 
    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

-- A3. BUY BOND --                  
if @PTrxType = 1 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15)                 
BEGIN  
              
-- 2 = G-BOND                  
-- 3 = C-BOND                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                                           

if @InstrumentType in (2,3,8,9,11,13,14,15)          
BEGIN                  
Select @InvestmentAcc = InvestmentBond,@InterestRecAcc = InterestRecBond,@PayablePurchaseAcc = PayablePurRecBond, 
@WHTTaxPayableAccrInterest = WHTTaxPayableAccrInterestBond,@BondDayAccrued = InterestAccrBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                   
END                  
                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
	
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,2,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,3,1,2,@WHTTaxPayableAccrInterest,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,                
0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,1,0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WHTTaxPayableAccrInterest and Status = 2                  

set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PDoneAccruedInterest,0) - isnull(@PIncomeTaxGainAmount,0) 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

-- T Settled                
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
	
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PTotalAmount,                   
@PTotalAmount,0,1,@PTotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,3,1,2,@BondDayAccrued,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BondDayAccrued and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                  
END                  


-- A4.SELL BOND --
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15) 
BEGIN               
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
Select @InvestmentAccBond = InvestmentBond,@InterestRecBuySellAccBond = InterestRecBond,@InterestRecAccBond = InterestAccrBond,
@RealisedAccBond = RealisedBond, @ReceivableSaleAccBond = AccountReceivableSaleBond,
@TaxCapitalGainAccBond = TaxCapitalGainBond,@TaxInterestAccBond = WHTTaxPayableAccrInterestBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
                                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

set @PTaxExpenseAmount = (@PTaxExpensePercent / 100) * @PDoneAccruedInterest                  
set @PFinalAmount = @PDoneAccruedInterest - @PTaxExpenseAmount   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                 
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


declare @BondSellAmount numeric (19,2)

set @BondSellAmount = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)/100 * @PDoneVolume


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InvestmentAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@BondSellAmount,                   
0,@BondSellAmount,1,0,@BondSellAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAccBond and Status = 2    



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
--,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
--Select @FundJournalPK,2,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
--0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                  



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,3,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxGainAmount,                   
@PIncomeTaxGainAmount,0,1,@PIncomeTaxGainAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2        


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,4,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxInterestAmount,                   
@PIncomeTaxInterestAmount,0,1,@PIncomeTaxInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2            

         
	
--Select @SellAvgPrice = AvgPrice From FundPosition where Date = @DateYesterday and Status =  2 and FundPK = @PFundPK and InstrumentPK = @PInstrumentPK                              
--set @AvgAmount = (@SellAvgPrice/100) * @PDoneVolume              
--set @RealisedAmount = abs(@PDoneAmount - @AvgAmount)
set @RealisedAmount = abs(@PDoneAmount - @BondSellAmount)



-- Gain Realised
if @BondSellAmount > @PDoneAmount              
Begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
		@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                  

	set  @ReceivableSellBondAmount = @BondSellAmount - @RealisedAmount +@PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount               
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
End       
     
-- Loss Realised
if @BondSellAmount <= @PDoneAmount              
begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
		0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                 
			 
	set  @ReceivableSellBondAmount = @BondSellAmount + @RealisedAmount + @PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount              
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
end     

                        

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,6,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T Settled       
         
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@ReceivableSellBondAmount,                   
0,@ReceivableSellBondAmount,1,0,@ReceivableSellBondAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,3,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,4,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),                   
0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount) ,1,0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,5,1,2,@TaxInterestAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,                   
0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,1,0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxInterestAccBond and Status = 2                



END 


-- A5.PLACEMENT DEPOSITO & ROLLOVER DEPOSITO          
if @PTrxType in (1,3) and @PInstrumentTypePK in (5,10) -- 5 Deposito biasa 10 NCD
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                           

if @InstrumentType in (5,10)                  
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                                    

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                 

IF dbo.CheckTodayIsHoliday (@PValueDate) = 1
BEGIN
    select @PValueDate = dbo.Fworkingday(@PValueDate, 1)
END


-- T0                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                   

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
END                  

-- A6. LIQUIDATE DEPOSITO --            
if @PTrxType = 2 and @PInstrumentTypePK in (5,10)                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
	
if @InstrumentType in (5,10)
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T0              
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                        

Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               
	
	
-- LOGIK BREAK INTEREST DISINI
	
Declare @IncomeDeposito int
Declare @ARInterestDeposito int
Declare @TaxDeposito int
    
Select @ARInterestDeposito = InterestAccrTimeDeposit,@IncomeDeposito = IncomeInterestTimeDeposit, 
@TaxDeposito = TaxExpenseInterestIncomeTimeDeposit
From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
	
Declare @ARInterestDepositoAmount numeric(22,4)
Declare @IncomeDepositoAmount numeric(22,4)
Declare @TaxDepositoAmount numeric(22,4)


set @IncomeDepositoAmount = [dbo].FGetDepositoInterestAccruedForPayment (@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,DateAdd(day,1,@PAcqDate),1,@ValueDate,1)
set @ARInterestDepositoAmount = 0.8 * @IncomeDepositoAmount
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount

--set @ARInterestDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@ARInterestDeposito,@PInstrumentPK,@PFundPK)
--set @IncomeDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@IncomeDeposito,@PInstrumentPK,@PFundPK)
--set @TaxDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@TaxDeposito,@PInstrumentPK,@PFundPK)
	

if @PBreakInterestPercent > 0


BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @IncomeDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'D',@IncomeDepositoAmount,                   
	@IncomeDepositoAmount,0,1,@IncomeDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

if @ARInterestDepositoAmount > 0
BEGIN

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,                   
	0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    
END
IF (@IncomeDeposito <> @TaxDeposito)
BEGIN
    if @TaxDepositoAmount > 0
    BEGIN
	    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	    Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	    0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    
    END


END
ELSE
BEGIN
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

Declare @BDNewInterestAmount numeric(22,4)
Declare @BDBalance numeric(22,4)
Declare @BDInterestDaysType int
Declare @BDInterestPercent numeric(8,4)
Declare @BDAcqDate datetime
Declare @BDInterestPaymentType int
Declare @BDMaturityDate datetime
Declare @BDPaymentModeOnMaturity int
Declare @BDTaxPercent numeric(8,4)

Select @BDBalance = Balance,@BDInterestDaysType = InterestDaysType
,@BDInterestPercent = InterestPercent
,@BDAcqDate = AcqDate
,@BDInterestPaymentType = InterestPaymentType
,@BDMaturityDate = MaturityDate
,@BDPaymentModeOnMaturity = PaymentModeOnMaturity
,@BDTaxPercent = TaxExpensePercent
From FundPosition where Date = @DateYesterday and InstrumentPK = @PInstrumentPK


set @BDNewInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment](@ValueDate,@PInstrumentPK,@BDBalance,@BDInterestDaysType,@PBreakInterestPercent,@BDAcqDate,@BDInterestPaymentType,@ValueDate,@BDPaymentModeOnMaturity)
		
if @BDNewInterestAmount > 0
BEGIN
	Declare @BDTaxAmount numeric(22,4)
	Declare @BDIncomeAmount numeric(22,4)
	set @BDTaxAmount = @BDNewInterestAmount * @BDTaxPercent/100
	set @BDIncomeAmount = @BDNewInterestAmount - @BDTaxAmount
					
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
				
	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
		@PReference,'LIQUIDATE NEW INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDIncomeAmount,                   
	@BDIncomeAmount,0,1,@BDIncomeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2        
				
		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'C',@BDNewInterestAmount,0,@BDNewInterestAmount,1,0,@BDNewInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDTaxAmount,@BDTaxAmount,0,1,@BDTaxAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    

END
END
ELSE
BEGIN

set @IncomeDepositoAmount = dbo.FGetDepositoInterestAccrued(@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,@ValueDate)
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount


select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @ARInterestDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,                   
	@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount ,0,1,@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@TaxDepositoAmount,                   
	@TaxDepositoAmount,0,1,@TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2             

 		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
 	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

 		Select  @FundJournalPK,4,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@IncomeDepositoAmount,
    0,@IncomeDepositoAmount,1,0,@IncomeDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2

END
END
	

END  

-- A8. BUY MUTUAL FUND --                    
if @PTrxType = 1 and @PInstrumentTypePK in (6)                   
BEGIN    
	 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)    
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@PayablePurchaseAcc = PayablePurchaseProtectedFund, @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@PayablePurchaseAcc = PayablePurchasePrivateEquityFund  , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE
	 BEGIN
	 	Select @InvestmentAcc = InvestmentMutualFund,@PayablePurchaseAcc = PayablePurchaseMutualFund , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END					                      
                   
               

 -- Setup Account kelar diatas, Next masukin ke Fund Journal   
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
 -- T0                    
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T0 MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
   
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  
  
  
 -- T Settled                  
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
   
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T-Settled MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                     
  
    
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                    
  
  
  
   
              
END                    
  -- A9.SELL MUTUAL FUND --  
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (6)   
BEGIN               
 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)   
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@ReceivableSaleAcc = AccountReceivableSaleProtectedFund , @CashForMutualFund = CashForMutualFund, @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellProtectedFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@ReceivableSaleAcc = AccountReceivableSalePrivateEquityFund, @CashForMutualFund = CashForMutualFund , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellPrivateEquityFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE
	 BEGIN
		Select @InvestmentAcc = InvestmentMutualFund,@ReceivableSaleAcc = AccountReceivableSaleMutualFund, @CashForMutualFund = CashForMutualFund  , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK     
	 END			                
   
                                                     
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
  
-- T0                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                   
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T0 MUTUAL FUND SELL: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2      

set @MInterestAmount = 0
select @BDate = DATEADD(m, DATEDIFF(m, 0, @ValueDate), 0)
select @MInterestAmount = (InterestPercent/100 * @PDoneVolume/365) * datediff(day,@BDate,@ValueDate) from ReksadanaInstrument where ReksadanaPK = @PInstrumentPK and status in (1,2)
select @MInterestAmount = isnull(@MInterestAmount,0)


IF (@MInterestAmount <> 0)
BEGIN
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,4,1,2,@InterestReceivableSellMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@MInterestAmount,                     
0,@MInterestAmount,1,0,@MInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestReceivableSellMutualFund and Status = 2                    
END               
			
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                              
set @AvgAmount = @SellAvgPrice * @PDoneVolume                
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount) 

  -- Gain Realised  
  if @AvgAmount <= @PDoneAmount                
  Begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@RealisedAmount,                     
  0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                    
  
  set  @InvestmentMutualFundAmount = @PDoneAmount - @RealisedAmount                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)   - isnull(@MInterestAmount,0)
  End         
       
  -- Loss Realised  
  if @AvgAmount > @PDoneAmount                
  begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select  @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@RealisedAmount,                     
  @RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                   
      
  set  @InvestmentMutualFundAmount = @PDoneAmount + @RealisedAmount               
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  - isnull(@MInterestAmount,0)
  end                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  
 
 
    
        
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@InvestmentMutualFundAmount,                     
0,@InvestmentMutualFundAmount,1,0,@InvestmentMutualFundAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  






-- T Settled         
           
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T-Settled MUTUAL FUND SELL: ' + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'C',@PDoneAmount,                     
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                    
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                  
  
  
  
END   
  
  

	           
Fetch next From A Into                  
@PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,
@PBreakInterestPercent,@PSettlementPK,@PTaxExpensePercent,@PInterestPercent,@PAcqDate       
END                  
Close A                  
Deallocate A                
-------------------------------------------------------------------------------------------------------------------
-- B. DAILY FEE & PAYMENT FEE --

Declare @DecimalPlaces   int                  
Declare @RoundingMode   int                  
Declare @FundID     nvarchar(50)       
Declare @LastEndDayTrailsDate datetime       

Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                

Declare @ManagementFeeExpAcc    int                  
Declare @CustodianFeeExpAcc     int                  
Declare @AuditFeeExpAcc      int    
Declare @SinvestFeeExpAcc      int   
Declare @MovementFeeExpAcc    int                
Declare @PayableManagementFeeAcc   int                  
Declare @PayableCustodianFeeAcc    int                  
Declare @PayableAuditFeeAcc     int      
Declare @PayableSinvestFeeAcc     int
Declare @PayableMovementFeeAcc     int                
               
Declare @feeDays  int          
Declare @PayableSubscriptionFee int,@PayableRedemptionFee int
declare @BPayableSwitchingFee int
    

Select @feeDays =  DateDiff(day,ValueDate,@ValueDate),@LastEndDayTrailsDate = ValueDate From EndDayTrailsFundPortfolio              
Where ValueDate = 
(
Select Max(ValueDate) From EndDayTrailsFundPortfolio Where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK
)  and FundPK = @XFundPK           

set @feeDays = isnull(@feeDays,0)         

Declare @BFundPK int                  
Declare @BManagementFeePercent numeric(18,6)                  
Declare @BCustodiFeePercent  numeric(18,6)                  
Declare @BAuditFeePercent  numeric(18,6) 


Declare @BSinvestFeePercent  numeric(18,8) 

Declare @BManagementFeeDays  int                  
Declare @BCustodiFeeDays  int                  
Declare @BAuditFeeDays   int   
Declare @BSinvestFeeDays  int   
Declare @BFundType  int    
Declare @BBitSinvestFee  bit         

     

Declare @BDateOfPayment  int                  
Declare @BAum     numeric(22,8)                  
Declare @BManagementFeeAmount numeric(18,6)                  
Declare @BCustodiFeeAmount  numeric(18,6)                  
Declare @BAuditFeeAmount  numeric(18,6)   
Declare @BMovementFeeAmount  numeric(18,6)      

Declare @BSinvestFeeAmount  numeric(18,8)                  

Declare @BPayableSubscriptionFeeAmount numeric(18,6)
Declare @BPayableRedemptionFeeAmount numeric(18,6)
Declare @BPayableSwitchingFeeAmount numeric(18,6)

Declare @BOtherFeeOneAmount  numeric(18,6) 
Declare @BOtherFeeTwoAmount  numeric(18,6) 

Declare @BPayableOtherFeeOne  int    
Declare @BPayableOtherFeeTwo  int   
Declare @BOtherFeeOneExpense  int    
Declare @BOtherFeeTwoExpense  int 




Declare @FundFeeSetup Table
(
	FundPK int,
	MIFeePercent numeric(18,8)
)

insert into @FundFeeSetup
select FundPK,MiFeePercent from FundFeeSetup A
where A.Date = (
Select max(date) from FundFeeSetup B where B.date	<= @ValueDate     and B.status = 2 and A.FundPK = B.FundPK
) and A.status in (1,2) and A.FundPK = @XFundPK


insert into #ZFundFee
Select DateOfPayment,A.FundPK,D.MIFeePercent,CustodiFeePercent,
AuditFeeAmount,MovementFeeAmount, @BTotalDays,@BTotalDays,@BTotalDays,@BTotalDays,Type,B.BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount                  
From FundFee A
left join Fund B on A.FundPK = B.FundPK and B.Status = 2
left join @FundFeeSetup D on A.FundPK = D.FundPK
Where A.status = 2 and A.Date = (
Select max(date) from FundFee C where C.date	<= @ValueDate     and C.status = 2 and A.FundPK = C.FundPK
) and A.FundPK = @XFundPK


Declare B Cursor For                  
Select FundPK,ManagementFeePercent ,CustodiFeePercent ,
 AuditFeeAmount,MovementFeeAmount, ManagementFeeDays ,CustodiFeeDays,AuditFeeDays,SInvestFeeDays,DateOfPayment,FundType,BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount   from #ZFundFee where FundPK = @XFundPK
Open B                  
Fetch Next From B                  
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount, @BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount                   
While @@FETCH_STATUS = 0                  
Begin                  
Select @ManagementFeeExpAcc = ManagementFeeExpense, @CustodianFeeExpAcc =CustodianFeeExpense , @AuditFeeExpAcc = AuditFeeExpense,@MovementFeeExpAcc = MovementFeeExpense,                  
@PayableManagementFeeAcc = PayableManagementFee,@PayableCustodianFeeAcc = PayableCustodianFee,@PayableAuditFeeAcc = PayableAuditFee,@PayableMovementFeeAcc = PayableMovementFee    
,@PayableSubscriptionFee = PayableSubscriptionFee,@PayableRedemptionFee = PayableRedemptionFee 
,@BPayableSwitchingFee = PayableSwitchingFee,@PayableSinvestFeeAcc = PayableSInvestFee, @SinvestFeeExpAcc = SInvestFee
,@BPayableOtherFeeOne = PayableOtherFeeOne, @BPayableOtherFeeTwo = PayableOtherFeeTwo,@BOtherFeeOneExpense = OtherFeeOneExpense, @BOtherFeeTwoExpense = OtherFeeTwoExpense             
From FundAccountingSetup Where Status = 2    and FundPK = @BFundPK    

-- B1. GENERATE DAILY FEE                  
set @BAum = 0


Select @BAum =  AUM From CloseNAV where Date = @DateYesterday and Status =  2 and FundPK = @BFundPK                  
Select @DecimalPlaces = JournalDecimalPlaces, @RoundingMode = JournalRoundingMode, @FundID = A.ID From Fund A 
left join BankBranch B on A.BankBranchPK = B.BankBranchPK and B.status = 2
left join Bank C on B.BankPK = C.BankPK and C.status = 2
where A.Status = 2 and A.FundPK = @BFundPK             


--1	STRUCTURED FUND : GUARANTEED FUND ok
--2	FIXED INCOME FUND ok
--3	MONEY MARKET FUND ok
--4	STRUCTURED FUND : CAPITAL PROTECTED FUND ok
--5	EQUITY FUND ok
--6	STRUCTURED FUND : INDEX FUND ok
--7	CIC ASSET BACKED SECURITIES ok
--8	DISCETIONARY FUND ok
--9	MIXED ASSET FUND ok
--10 EXCHANGE TRADED FUND ok
--11 REAL ESTATE INVESTMENT TRUST ok
--12 PRIVATE EQUITY FUND ok

Select @BSinvestFeeDays = SinvestFeeDays from SInvestSetup where status = 2

IF (@BFundType in (1,3,4,6,8,11,12))
BEGIN
	Select @BSinvestFeePercent = SinvestMoneyMarketFeePercent from SInvestSetup where status = 2
END
ELSE IF (@BFundType in (2,7,9))
BEGIN
	Select @BSinvestFeePercent = SinvestBondFeePercent from SInvestSetup where status = 2
END
ELSE
BEGIN
	Select @BSinvestFeePercent = SinvestEquityFeePercent from SInvestSetup where status = 2
END



-- 1 = UP, 2 = DOWN , 3 = NONE                  	
If @RoundingMode = 1                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(CEILING((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0) * @FeeDays                      
Set @BCustodiFeeAmount = isnull(CEILING((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0)  * @FeeDays  
Set @BSinvestFeeAmount = isnull(CEILING((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(CEILING(@BAuditFeeAmount),0)  * @FeeDays  
Set @BMovementFeeAmount = isnull(CEILING(@BMovementFeeAmount),0)  * @FeeDays   
Set @BOtherFeeOneAmount = isnull(CEILING(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(CEILING(@BOtherFeeTwoAmount),0)  * @FeeDays                
END                  

If @RoundingMode = 2                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(FLOOR((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0)  * @FeeDays                    
Set @BCustodiFeeAmount = isnull(FLOOR((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0) * @FeeDays 
Set @BSinvestFeeAmount = isnull(FLOOR((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays  
END
Set @BAuditFeeAmount = isnull(FLOOR(@BAuditFeeAmount),0)  * @FeeDays 
Set @BMovementFeeAmount = isnull(FLOOR(@BMovementFeeAmount),0)  * @FeeDays  
Set @BOtherFeeOneAmount = isnull(FLOOR(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(FLOOR(@BOtherFeeTwoAmount),0)  * @FeeDays               
END                  

If @RoundingMode = 3                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(ROUND((@BAum * (@BManagementFeePercent/100))/@BManagementFeeDays,@DecimalPlaces),0)  * @FeeDays                 
Set @BCustodiFeeAmount = isnull(ROUND((@BAum * (@BCustodiFeePercent/100))/@BCustodiFeeDays,@DecimalPlaces),0)    * @FeeDays   
Set @BSinvestFeeAmount = isnull(ROUND((@BAum * (@BSinvestFeePercent/100))/@BSinvestFeeDays,@DecimalPlaces),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(@BAuditFeeAmount,0)  * @FeeDays    
Set @BMovementFeeAmount = isnull(@BMovementFeeAmount,0)  * @FeeDays      
Set @BOtherFeeOneAmount = isnull(@BOtherFeeOneAmount,0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(@BOtherFeeTwoAmount,0)  * @FeeDays       
END                  





if isnull(@BAum,0) = 0
begin
set @BManagementFeeAmount = 0
set @BCustodiFeeAmount = 0
set @BAuditFeeAmount = 0
set @BMovementFeeAmount = 0
set @BSinvestFeeAmount = 0
set @BOtherFeeOneAmount = 0
set @BOtherFeeTwoAmount = 0
end




-- Setup Account kelar diatas, Next masukin ke Fund Journal  
if @BManagementFeeAmount > 0 or @BCustodiFeeAmount > 0 or @BAuditFeeAmount > 0
BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'DAILY FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
END    

if @BManagementFeeAmount > 0
BEGIN
		
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@ManagementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ManagementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                  

END

if @BCustodiFeeAmount > 0
BEGIN

	
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@CustodianFeeExpAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CustodianFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2       

END
  
if @BAuditFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@AuditFeeExpAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'D',@BAuditFeeAmount,                   
@BAuditFeeAmount,0,1,@BAuditFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @AuditFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@PayableAuditFeeAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'C',@BAuditFeeAmount,                   
0,@BAuditFeeAmount,1,0,@BAuditFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableAuditFeeAcc and Status = 2                  
		
END

IF (@BBitSInvestFee = 1)
BEGIN

    if @BSinvestFeeAmount > 0
    BEGIN

	
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,7,1,2,@SinvestFeeExpAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
    @BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SinvestFeeExpAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
    0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2       

    END
END


if @BMovementFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,9,1,2,@MovementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'D',@BMovementFeeAmount,                   
@BMovementFeeAmount,0,1,@BMovementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @MovementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,10,1,2,@PayableMovementFeeAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'C',@BMovementFeeAmount,                   
0,@BMovementFeeAmount,1,0,@BMovementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableMovementFeeAcc and Status = 2                  
		
END


if @BOtherFeeOneAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,11,1,2,@BOtherFeeOneExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeOneAmount,                   
@BOtherFeeOneAmount,0,1,@BOtherFeeOneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeOneExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,12,1,2,@BPayableOtherFeeOne,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeOneAmount,                   
0,@BOtherFeeOneAmount,1,0,@BOtherFeeOneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeOne and Status = 2                  
		
END


if @BOtherFeeTwoAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,13,1,2,@BOtherFeeTwoExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeTwoAmount,                   
@BOtherFeeTwoAmount,0,1,@BOtherFeeTwoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeTwoExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,14,1,2,@BPayableOtherFeeTwo,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeTwoAmount,                   
0,@BOtherFeeTwoAmount,1,0,@BOtherFeeTwoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeTwo and Status = 2                  
		
END

	            

---------------- TINGGAL TEST SUDAH TAMBAH PAYABLE SUBS DAN REDEMPT FEE
-- B2. GENERATE PAYMENT FEE

Declare @EOMonthForFee datetime
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @BFundPK
if(@BDateOfPayment = day(@ValueDate) or (@BDateOfPayment >= day(@LastEndDayTrailsDate) and @BDateOfPayment <= day(@ValueDate)))
BEGIN
Declare @BManagementFeeAmountCheck numeric(22,4)
Declare @BCustodiFeeAmountCheck numeric(22,4)
Declare @BSinvestFeeAmountCheck numeric(22,4)
Declare @BPayableRedemptionFeeAmountCheck numeric(22,4)
Declare @BPayableSubscriptionFeeAmountCheck numeric(22,4)
Declare @BPayableSwitchingFeeAmountCheck numeric(22,4)

set @EOMonthForFee = dateadd(month,-1,@ValueDate)
set @EOMonthForFee = EOMONTH (@EOMonthForFee)
	
set @BManagementFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@BPayableSwitchingFee,@BFundPK)

set @BManagementFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@BPayableSwitchingFee,@BFundPK)

Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
			                    
if @BManagementFeeAmount > 0  or @BCustodiFeeAmount > 0 or @BSinvestFeeAmount > 0 or @BPayableRedemptionFeeAmount > 0   or  
@BPayableSubscriptionFeeAmount > 0  or 
@BPayableSwitchingFeeAmount > 0   
Begin                                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
                      
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'PAYMENT FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
                        
if @BManagementFeeAmount > 0  and @BManagementFeeAmount < @BManagementFeeAmountCheck                
Begin                       
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,1,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
		@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
		0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
end                  
if @BCustodiFeeAmount > 0  and @BCustodiFeeAmount < @BCustodiFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,3,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
		@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,4,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
		0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BSinvestFeeAmount > 0  and @BSinvestFeeAmount < @BSinvestFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,5,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
		@BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,6,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
		0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableRedemptionFeeAmount > 0   and @BPayableRedemptionFeeAmount < @BPayableRedemptionFeeAmountCheck               
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,7,1,2,@PayableRedemptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'D',@BPayableRedemptionFeeAmount,                   
		@BPayableRedemptionFeeAmount,0,1,@BPayableRedemptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableRedemptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,8,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'C',@BPayableRedemptionFeeAmount,                   
		0,@BPayableRedemptionFeeAmount,1,0,@BPayableRedemptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSubscriptionFeeAmount > 0        and @BPayableSubscriptionFeeAmount < @BPayableSubscriptionFeeAmountCheck           
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,9,1,2,@PayableSubscriptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSubscriptionFeeAmount,                					@BPayableSubscriptionFeeAmount,0,1,@BPayableSubscriptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSubscriptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,10,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSubscriptionFeeAmount,                   
		0,@BPayableSubscriptionFeeAmount,1,0,@BPayableSubscriptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSwitchingFeeAmount > 0    and @BPayableSwitchingFeeAmount < @BPayableSwitchingFeeAmountCheck              
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,11,1,2,@BPayableSwitchingFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSwitchingFeeAmount,                					@BPayableSwitchingFeeAmount,0,1,@BPayableSwitchingFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableSwitchingFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,12,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSwitchingFeeAmount,                   
		0,@BPayableSwitchingFeeAmount,1,0,@BPayableSwitchingFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

End

END

Fetch next From B   
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount,@BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount
                     
End                  
Close B                  
Deallocate B    
---------------------------------------------------------------------------------------------------------------------------
 -- B3. BANK INTEREST


declare @EFundPK int
declare @EFundID nvarchar(50)
declare @ECashAcc int
declare @EInterestPercent numeric (18,6)
declare @EInterestDays numeric (22,6)
declare @EBalance numeric (22,6)
declare @EMinimumBalance numeric (18,6)
declare @EBankInterestAmount numeric (22,6)
declare @EBankInterestAcc int
declare @EBankInterestIncomeAcc int

--declare @DateYesterDay datetime
--set @DateYesterDay = dbo.FWorkingDay(@ValueDate, - 1)

DECLARE E CURSOR FOR 
Select FundPK,ID From Fund where status in (1,2) and FundPK = @XFundPK
        	
Open E
Fetch Next From E
Into @EFundPK,@EFundID
        
While @@FETCH_STATUS = 0
BEGIN  
    set @EBankInterestAmount = 0

    IF EXISTS(select * from BankInterestSetup A left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
    where A.status in (1,2) and B.FundPK = @EFundPK)
    BEGIN
        DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date <= @ValueDate
        )
        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
			    set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END
	ELSE
	BEGIN
		DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date <= @ValueDate
        )

        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
				set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END
				
			--select @EFundPK,@EBalance,@EInterestPercent,@EInterestDays

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END


	
	-- Setup Account kelar diatas, Next masukin ke Fund Journal  
	if @EBankInterestAmount > 0
	BEGIN
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

	Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'BANK DAILY INTEREST',                  
	'','FUND ID: ' + @EFundID,1,@UsersID,@LastUpdate,@LastUpdate                  
	END    

	if @EBankInterestAmount > 0
	BEGIN
		
		select @EBankInterestAcc = InterestAccrGiro,@EBankInterestIncomeAcc = IncomeInterestGiro from FundAccountingSetup where FundPK = @EFundPK and status in (1,2)

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select  @FundJournalPK,1,1,2,@EBankInterestAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'D',@EBankInterestAmount,                   
	@EBankInterestAmount,0,1,@EBankInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestAcc and Status = 2                   

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select @FundJournalPK,2,1,2,@EBankInterestIncomeAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'C',@EBankInterestAmount,                   
	0,@EBankInterestAmount,1,0,@EBankInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestIncomeAcc and Status = 2                  

	END


	
Fetch next From E Into @EFundPK,@EFundID
END
Close E
Deallocate E 

---------------------------------------------------------------------------------------------------------------------------

-- C. REVAL,GENERATE BOND,DEPOSITO ACCRUED  --             

declare @RevalEquity int
declare @InvestEquity int
declare @RevalBond int
declare @InvestBond int
declare @MarketValue numeric(22,6)   
declare @PrevMarketValue numeric(22,6) 

Declare @RevaluationAcc    int                  
Declare @UnrealisedAcc    int                  
Declare @FInstrumentPK    int         
Declare @FInstrumentID    nvarchar(100)                  
Declare @FFundPK     int                  
Declare @FTrxAmount     numeric(22,6)                  
Declare @FMarketValue    numeric(22,6)                  
Declare @FInstrumentTypePK   int                  
Declare @FCurrencyPK    int                  
Declare @FPrevRevaluationAmount  numeric(22,6)                  
Declare @FFinalAmount    numeric(22,6)                  
Declare @FLastCouponDate   datetime                  
Declare @FInterestAmount   numeric(18,6)                  
Declare @FBalance     numeric(18,0)                  
Declare @FTaxExpenseAmount   numeric(18,6)                  
Declare @FTaxExpensePercent   numeric(18,8)                  
Declare @FAcqDate   datetime                                  
Declare @FMaturityDate  datetime  
Declare @FSell   int 
Declare @FBuy   int 
Declare @FDoneAmount    numeric(22,6) 
Declare @FInterestDaysType int
Declare @FInterestPaymentType int
Declare @FInterestPercent numeric(18,8)
Declare @FPaymentModeOnMaturity int
Declare @FReksadanaTypePK int


--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)

Declare D Cursor For   


    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16) and FundPK = @XFundPK
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK  


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)  and FundPK = @XFundPK
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2  and FundPK = @XFundPK and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate and C.FundPK = @XFundPK)

    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16) and FundPK = @XFundPK
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 

-- REKSADANA
union all

	Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)                  
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (6) and FundPK = @XFundPK
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (6) and FundPK = @XFundPK 
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 ,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and FundPK = @XFundPK and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate and C.FundPK = @XFundPK)

    and B.InstrumentTypePK in (6) and FundPK = @XFundPK
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 




Open D                  
Fetch Next From D                  
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance
,@FTaxExpensePercent,@FMaturityDate,@FSell,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent ,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK    
While @@FETCH_STATUS = 0                  
Begin                  
    -- C1. REVALUATION EQUITY & BOND --

    select @RevalEquity = RevaluationEquity,@InvestEquity = InvestmentEquity,@RevalBond = RevaluationBond,@InvestBond = InvestmentBond from FundAccountingSetup where status = 2 and fundPK = @FFundPK
    IF(@RevalEquity = @InvestEquity) OR (@RevalBond = @InvestBond)
    BEGIN
	    IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK  
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK   


            IF (@FBuy = 1)
            BEGIN

                --select @MarketValue =  dbo.FGetLastVolumeInv(@valuedate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                --select @PrevMarketValue = dbo.FGetLastVolumeInv(dbo.FWorkingDay(@valuedate,-1),@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.FWorkingDay(@valuedate,-1),@FInstrumentPK,@FFundPK)/100)     
                --select @FDoneAmount = dbo.FGetDoneAmountInv(@valuedate,@FFundPK,@FInstrumentPK)
                --set @FFinalAmount = @MarketValue - (@PrevMarketValue + @FDoneAmount) 
                
                
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 


            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)/100) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue  
				   
            END
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2  and fundPK = @FFundPK

            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END  

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    
	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END


            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END   


    END
    ELSE
    BEGIN
        IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2    and fundPK = @FFundPK
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK      
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
        END    

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    

	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END

        END   

        IF (@ClientCode = 21)
        BEGIN
            IF (@FBuy = 1)
            BEGIN

                --select @MarketValue =  dbo.FGetLastVolumeInv(@valuedate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                --select @PrevMarketValue = dbo.FGetLastVolumeInv(dbo.FWorkingDay(@valuedate,-1),@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.FWorkingDay(@valuedate,-1),@FInstrumentPK,@FFundPK)/100)     
                --select @FDoneAmount = dbo.FGetDoneAmountInv(@valuedate,@FFundPK,@FInstrumentPK)
                --set @FFinalAmount = @MarketValue - (@PrevMarketValue + @FDoneAmount) 
                
                
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 


            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                IF @FInstrumentTypePK in(1,4,6,16)    
                BEGIN
                    select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK))           
                    select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)) 
                    set @FFinalAmount = @MarketValue - @PrevMarketValue  
		        END 
                ELSE
                BEGIN
                    select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                    select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)/100) 
                    set @FFinalAmount = @MarketValue - @PrevMarketValue  
                END
            END

        END
        ELSE
        BEGIN
            IF @FInstrumentTypePK in(1,2,3,4,6,8,9,13,14,15,16)    
            BEGIN  
                IF (@FSell  = 1)
                BEGIN
                    select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                    Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)
				
                END
                ELSE
                BEGIN

                    select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                    Set @FFinalAmount = isnull(@FMarketValue,0) - isnull(@FTrxAmount,0) - @FPrevRevaluationAmount 
			
                END
            END
        END

        



   
    END






	IF Exists(              
    Select * from ClosePrice where Status = 2 and date = @ValueDate              
    )  
    BEGIN
        IF isnull(@FFinalAmount,0) > 0 --Nilai Revaluasi Acc di Debit    
        BEGIN    
        -- Setup Account kelar diatas, Next masukin ke Fund Journal  
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal     
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)  


        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
    
        Select @FundJournalPK,2,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2        
        END  

        IF isnull(@FFinalAmount,0) < 0    
        BEGIN  
        -- Setup Account kelar diatas, Next masukin ke Fund Journal    
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)    
        
        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
        
        Select @FundJournalPK,2,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2    
        END  
    END  	 







	    
Fetch next From D                   
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance,@FTaxExpensePercent,@FMaturityDate,@FSell    
,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK   
END        
Close D                  
Deallocate D

--AAAAAAAA



Declare @IncDays int            
Declare @CInstrumentPK    int         
Declare @CInstrumentID    nvarchar(100)                  
Declare @CFundPK     int                  
Declare @CTrxAmount     numeric(22,6)                  
Declare @CMarketValue    numeric(22,6)                  
Declare @CInstrumentTypePK   int                  
Declare @CCurrencyPK    int                  
Declare @CPrevRevaluationAmount  numeric(22,6)                  
Declare @CFinalAmount    numeric(22,6)                  
Declare @CLastCouponDate   datetime                  
Declare @CInterestAmount   numeric(18,6)                  
Declare @CBalance     numeric(18,0)                  
Declare @CTaxExpenseAmount   numeric(18,6)                  
Declare @CTaxExpensePercent   numeric(18,8)                  
Declare @CAcqDate   datetime                  
Declare @InterestIncometAcc   int                  
Declare @CMaturityDate  datetime  
Declare @CSell   int
Declare @CRoll   int  
Declare @FundTypeInternal int
Declare @KPDTaxPercent numeric(18,2)


declare @CPaymentDays int
declare @CHoldDays int
declare @CPrevHoldDays int
declare @CGrossInterestAmountRound numeric(19,2)
declare @CPrevGrossInterestAmountRound numeric(19,2)
declare @CLastGrossInterestAmountRound numeric(19,2)
declare @CLastPrevGrossInterestAmountRound numeric(19,2)
declare @CGrossInterestAmount numeric(19,2)
declare @CPrevGrossInterestAmount numeric(19,2)
declare @CTaxGrossInterestAmount numeric(19,2)
declare @CPrevTaxGrossInterestAmount numeric(19,2)
declare @CGrossInterestAmountA numeric(19,2)


declare @CNetInterestAmount numeric(19,2)
declare @CPrevNetInterestAmount numeric(19,2)
declare @CTaxNetInterestAmount numeric(19,2)
declare @CPrevTaxNetInterestAmount numeric(19,2)

declare @CGrossDaily numeric(19,2)
declare @CTaxDaily numeric(19,2)
declare @CDivDays int
declare @CLastAcqDays int
declare @CLastPrevAcqDays int
declare @CAcqDays int
declare @CPrevAcqDays int
declare @CDivGrossInterestAmount numeric(19,2)
declare @CPrevDivGrossInterestAmount numeric(19,2)
declare @CInterestDays int

Declare @CInterestDaysType int
Declare @CInterestPaymentType int
Declare @CInterestPercent numeric(18,8)
Declare @CPaymentModeOnMaturity int
declare @ZValueDate datetime

Declare C Cursor For   
 


    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    )
    and B.InstrumentTypePK <> 5 and FundPK = @XFundPK


    --and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <> @ValueDate

    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and C.StatusSettlement  = 2 and @ValueDate <= SettlementDate and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity
 

    UNION ALL

    --JUAL BOND MASIH BELUM SETTLED

    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and B.InstrumentTypePK <> 5 and FundPK = @XFundPK
    and EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and StatusSettlement  = 2 and TrxType = 2 and @ValueDate between ValueDate and SettlementDate   and A.[Identity] = C.TrxBuy and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
    UNION ALL

    -- MATURE DIHITUNG

    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@ValueDate,-1) and FundPK = @XFundPK
    )
    and B.InstrumentTypePK not in (1,5) and FundPK = @XFundPK
    and   EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK  and Status  = 2 and MaturityDate = @ValueDate and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
    UNION ALL
              
    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
    where  A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    )
    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
    and A.AcqDate not in (
    select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.statussettlement = 2 and D.FundPK = @XFundPK)
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity





    --MATURE INTEREST WEEKEND
    UNION ALL       
    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) 
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
    where  A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1) and FundPK = @XFundPK
    )
    and A.MaturityDate <= @valuedate and B.InstrumentTypePK = 5 and FundPK = @XFundPK

    and  NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity


    --ROLLOVER INTEREST WEEKEND
    UNION ALL
              
    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
    where  A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    )
    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
    and A.AcqDate  in (
    select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.FundPK = @XFundPK)
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

    UNION ALL

    -- JUAL H+1 HARI LIBUR
    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 Roll             
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
    where  A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)  and FundPK = @XFundPK
    )
    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
    and exists (
    select * from investment C where TrxType = 2 and valuedate = @valuedate and A.InstrumentPK = C.InstrumentPK and A.AcqDate = C.AcqDate  and C.FundPK = A.FundPK  and C.statussettlement = 2 and C.FundPK = @XFundPK)
    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity




Open C                  
Fetch Next From C                  
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance
,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent ,@CPaymentModeOnMaturity,@CRoll     
While @@FETCH_STATUS = 0                  
Begin              

  
-- C2. GENERATE INTEREST ACCRUED BOND                  

IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)             
BEGIN                  
Select @InterestRecAcc = InterestAccrBond
,@TaxExpenseAcc = TaxExpenseInterestIncomeBond,@InterestIncometAcc = IncomeInterestBond
From FundAccountingSetup where Status = 2  and FundPK = @CFundPK                  
END                  

IF @CInstrumentTypePK = 5 -- NCD INTEREST BLOM TAU GIMANA PAS MATURED
BEGIN                  
Select @InterestRecAcc = InterestAccrTimeDeposit,@TaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@InterestIncometAcc = IncomeInterestTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @CFundPK
END                  
IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)     -- and  @CLastCouponDate < @ValueDate        
BEGIN       
if @CAcqDate < @Valuedate
BEGIN

        IF (@CMarketValue = 0)
        BEGIN
            set @CInterestAmount  = 0
            set @CTaxExpenseAmount = 0 
            set @CFinalAmount = 0 
        END
        ELSE
        BEGIN
            Select @CInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance)            
		    set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
		    set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)  
        END

      
		IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)                    
		BEGIN                 	         
		-- Setup Account kelar diatas, Next masukin ke Fund Journal   
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

		IF @CInterestAmount > 0                  
		BEGIN           
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

        IF((day(@valuedate) <> 31 AND @CInterestDaysType in (3,5,6,7)) OR (@CInterestDaysType not in (3,5,6,7)))
        BEGIN

            INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            '','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            @CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            @CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
        END

            --IF(@CInterestDaysType not in (3,5,6,7))
            --BEGIN
            --INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
            --,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

            --Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
            --'','INSTRUMENT: ' + @CInstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
            --@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
            --0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

            --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
            --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

            --Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
            --@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
            --END
	                              
		END
		END            
END
END        

IF @CInstrumentTypePK = 5  
BEGIN   
--IF NOT EXISTS(
--Select * from investment
--where ValueDate = @ValueDate and StatusSettlement = 2 and TrxType = 2 and InstrumentPK = @CInstrumentPK
--)
BEGIN
	
    IF (@CRoll = 0 AND @CSell = 0)
    BEGIN
        IF  @CMaturityDate > @DateYesterday and @CMaturityDate <= @ValueDate
        BEGIN
            Declare @RealMaturedDate datetime
            if @CPaymentModeOnMaturity = 1
            begin
            set @RealMaturedDate = @CMaturityDate
            end
            if @CPaymentModeOnMaturity = 2
            begin
            set @RealMaturedDate = @ValueDate
            end
            Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@RealMaturedDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)           

            if @CPaymentModeOnMaturity = 3
            begin
            set @CInterestAmount = 0
            end

        END
        ELSE
        BEGIN
	
            if (@ValueDate = @CAcqDate)
            BEGIN
                Select @CInterestAmount = 0
            END
            ELSE
            BEGIN
                Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)        
            END
	
		 
        END
    END
    ELSE IF (@CRoll = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,@CAcqDate,@ValueDate)

    END
    ELSE IF (@CSell = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) *  DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),dateadd(day,-1,@valuedate))

    END
    ELSE
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),@CMaturityDate)
    END


--       select @ValueDate,@CAcqDate,@CInterestAmount,@CInstrumentPK,@CInterestPercent,@CFundPK
-- where @CInstrumentPK in 
-- (
	--select A.instrumentPK from fundposition A
	--left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.status = 2

	--where fundpk = 2 and trailsPK = 2 and B.InstrumentTypePK = 5		   
-- )
-- CEK LOGIK PAYMENT INTEREST TYPE DISINI

-- Setup Account kelar diatas, Next masukin ke Fund Journal   
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

IF @CInterestAmount > 0                  
BEGIN                  
set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
set @CFinalAmount = @CInterestAmount - @CTaxExpenseAmount       

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,7,@maxEndDayTrailsPK,'INTEREST DEPOSIT',                  
'','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2                   
END        
END

	          
END

 

 
Fetch next From C                   
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell    
,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent,@CPaymentModeOnMaturity,@CRoll
END        
Close C                  
Deallocate C



--Declare @IncDays int            
--Declare @CInstrumentPK    int         
--Declare @CInstrumentID    nvarchar(100)                  
--Declare @CFundPK     int                  
--Declare @CTrxAmount     numeric(22,6)                  
--Declare @CMarketValue    numeric(22,6)                  
--Declare @CInstrumentTypePK   int                  
--Declare @CCurrencyPK    int                  
--Declare @CPrevRevaluationAmount  numeric(22,6)                  
--Declare @CFinalAmount    numeric(22,6)                  
--Declare @CLastCouponDate   datetime                  
--Declare @CInterestAmount   numeric(18,6)                  
--Declare @CBalance     numeric(18,0)                  
--Declare @CTaxExpenseAmount   numeric(18,6)                  
--Declare @CTaxExpensePercent   numeric(18,8)                  
--Declare @CAcqDate   datetime                  
--Declare @InterestIncometAcc   int                  
--Declare @CMaturityDate  datetime  
--Declare @CSell   int
--Declare @CRoll   int  
--Declare @FundTypeInternal int
--Declare @KPDTaxPercent numeric(18,2)


--declare @CPaymentDays int
--declare @CHoldDays int
--declare @CPrevHoldDays int
--declare @CGrossInterestAmountRound numeric(19,2)
--declare @CPrevGrossInterestAmountRound numeric(19,2)
--declare @CLastGrossInterestAmountRound numeric(19,2)
--declare @CLastPrevGrossInterestAmountRound numeric(19,2)
--declare @CGrossInterestAmount numeric(19,2)
--declare @CPrevGrossInterestAmount numeric(19,2)
--declare @CTaxGrossInterestAmount numeric(19,2)
--declare @CPrevTaxGrossInterestAmount numeric(19,2)
--declare @CGrossInterestAmountA numeric(19,2)


--declare @CNetInterestAmount numeric(19,2)
--declare @CPrevNetInterestAmount numeric(19,2)
--declare @CTaxNetInterestAmount numeric(19,2)
--declare @CPrevTaxNetInterestAmount numeric(19,2)

--declare @CGrossDaily numeric(19,2)
--declare @CTaxDaily numeric(19,2)
--declare @CDivDays int
--declare @CLastAcqDays int
--declare @CLastPrevAcqDays int
--declare @CAcqDays int
--declare @CPrevAcqDays int
--declare @CDivGrossInterestAmount numeric(19,2)
--declare @CPrevDivGrossInterestAmount numeric(19,2)
--declare @CInterestDays int

--Declare @CInterestDaysType int
--Declare @CInterestPaymentType int
--Declare @CInterestPercent numeric(18,8)
--Declare @CPaymentModeOnMaturity int
--declare @ZValueDate datetime

--Declare C Cursor For   
 


--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

--    where A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
--    )
--    and B.InstrumentTypePK <> 5 and FundPK = @XFundPK


--    --and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <> @ValueDate

--    and NOT EXISTS 
--    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and C.StatusSettlement  = 2 and @ValueDate <= SettlementDate and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity
 

--    UNION ALL

--    --JUAL BOND MASIH BELUM SETTLED

--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

--    where A.status = 2 and B.InstrumentTypePK <> 5 and FundPK = @XFundPK
--    and EXISTS 
--    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and StatusSettlement  = 2 and TrxType = 2 and @ValueDate between ValueDate and SettlementDate   and A.[Identity] = C.TrxBuy and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
--    UNION ALL

--    -- MATURE DIHITUNG

--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

--    where A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@ValueDate,-1) and FundPK = @XFundPK
--    )
--    and B.InstrumentTypePK not in (1,5) and FundPK = @XFundPK
--    and   EXISTS 
--    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK  and Status  = 2 and MaturityDate = @ValueDate and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
--    UNION ALL
              
--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
--    where  A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
--    )
--    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
--    and A.AcqDate not in (
--    select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.statussettlement = 2 and D.FundPK = @XFundPK)
--    and NOT EXISTS 
--    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity





--    --MATURE INTEREST WEEKEND
--    UNION ALL       
--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue) 
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
--    where  A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1) and FundPK = @XFundPK
--    )
--    and A.MaturityDate <= @valuedate and B.InstrumentTypePK = 5 and FundPK = @XFundPK

--    and  NOT EXISTS 
--    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity


--    --ROLLOVER INTEREST WEEKEND
--    UNION ALL
              
--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
--    where  A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
--    )
--    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
--    and A.AcqDate  in (
--    select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.FundPK = @XFundPK)
--    and NOT EXISTS 
--    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

--    UNION ALL

--    -- JUAL H+1 HARI LIBUR
--    Select A.InstrumentPK,A.FundPK
--    ,sum(A.CostValue) -- isnull(C.CostValueSell,0)
--    ,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
--    ,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 Roll             
--    From FundPosition A                 
--    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
--    where  A.status = 2 and TrailsPK = 
--    (              
--    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)  and FundPK = @XFundPK
--    )
--    and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
--    and exists (
--    select * from investment C where TrxType = 2 and valuedate = @valuedate and A.InstrumentPK = C.InstrumentPK and A.AcqDate = C.AcqDate  and C.FundPK = A.FundPK  and C.statussettlement = 2 and C.FundPK = @XFundPK)
--    Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity




--Open C                  
--Fetch Next From C                  
--Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance
--,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent ,@CPaymentModeOnMaturity,@CRoll     
--While @@FETCH_STATUS = 0                  
--Begin              

  
---- C2. GENERATE INTEREST ACCRUED BOND                  

--IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)             
--BEGIN                  
--Select @InterestRecAcc = InterestAccrBond
--,@TaxExpenseAcc = TaxExpenseInterestIncomeBond,@InterestIncometAcc = IncomeInterestBond
--From FundAccountingSetup where Status = 2  and FundPK = @CFundPK                  
--END                  

--IF @CInstrumentTypePK = 5 -- NCD INTEREST BLOM TAU GIMANA PAS MATURED
--BEGIN                  
--Select @InterestRecAcc = InterestAccrTimeDeposit,@TaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
--,@InterestIncometAcc = IncomeInterestTimeDeposit
--From FundAccountingSetup 
--where Status = 2  and FundPK = @CFundPK
--END              

---- KPD TAX
--select @FundTypeInternal = FundTypeInternal from Fund where status = 2 and FundPK = @CFundPK 
--select @KPDTaxPercent = KPDTaxExpenseForBond from SettlementSetup where status = 2

--IF(@FundTypeInternal = 2)
--BEGIN
--   set @CTaxExpensePercent = @KPDTaxPercent
--END
    
--IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)     -- and  @CLastCouponDate < @ValueDate        
--BEGIN       
--if @CAcqDate < @Valuedate
--BEGIN


--        IF (@CMarketValue = 0)
--        BEGIN
--            set @CInterestAmount  = 0
--            set @CTaxExpenseAmount = 0 
--            set @CFinalAmount = 0 
--        END
--        ELSE
--        BEGIN

--            IF (@CInstrumentTypePK in (2,13)) -- BOND DAN SUKUK
--            BEGIN

--            select @CPaymentDays = 12 / [priority] FROM instrument A
--            LEFT JOIN mastervalue B ON A.interestpaymenttype = B.code AND B.id = 'InterestPaymentType' AND B.status = 2 
--            where A.InstrumentPK = @CInstrumentPK and A.status = 2


--            truncate table #TempInterest

--            DECLARE ZZ CURSOR FOR

--            SELECT  TOP (DATEDIFF(DAY, dbo.FworkingDay(@ValueDate,-1), @ValueDate)) Dates = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id), dbo.FworkingDay(@ValueDate,-1))
--            FROM sys.all_objects a CROSS JOIN sys.all_objects b

--            Open ZZ
--            Fetch Next From ZZ
--            Into @ZValueDate

--            While @@FETCH_STATUS = 0
--            BEGIN


--            set @CDivDays = datediff(day,@CLastCouponDate,dbo.FGetNextCouponDate(@valuedate,@CInstrumentPK)) 

--            set @CHoldDays = datediff(day,@CLastCouponDate,@ZValueDate)  
--            set @CPrevHoldDays = datediff(day,@CLastCouponDate,@ZValueDate - 1) 

--			set @CLastAcqDays = datediff(day,@CLastCouponDate,@CAcqDate) 
--            set @CLastPrevAcqDays = datediff(day,@CAcqDate,@ZValueDate - 1)

--            set @CAcqDays = datediff(day,@CAcqDate,@ZValueDate) 
--            set @CPrevAcqDays = datediff(day,@CAcqDate,@ZValueDate - 1)




--IF (@CAcqDate <= @CLastCouponDate)
--BEGIN

--set @CGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
--set @CPrevGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)

----Untuk Tax

--set @CTaxGrossInterestAmount =  (@CTaxExpensePercent/100) * @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
--set @CPrevTaxGrossInterestAmount = (@CTaxExpensePercent/100) * @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)

--END
--ELSE
--BEGIN



----Last Coupon ke AcqDate
--set @CGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
--set @CPrevGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)


----Untuk Tax
--set @CTaxGrossInterestAmount =  (@CTaxExpensePercent/100) *@CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CAcqDays * 1000000,0)
--set @CPrevTaxGrossInterestAmount =  (@CTaxExpensePercent/100) *@CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevAcqDays * 1000000,0)


----set @CTaxGrossInterestAmount =  round((@CTaxExpensePercent/100) * @CBalance * @CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CAcqDays/500,0)*500
----set @CPrevTaxGrossInterestAmount = round((@CTaxExpensePercent/100) * @CBalance * @CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevAcqDays/500,0)*500

				
--END

--set @CInterestAmount = (@CGrossInterestAmountRound) - (@CPrevGrossInterestAmountRound)

--set @CTaxExpenseAmount =  @CTaxGrossInterestAmount - @CPrevTaxGrossInterestAmount


--set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)

--insert into #TempInterest(InterestAmount,TaxAmount,FinalAmount)
--select @CInterestAmount,@CTaxExpenseAmount,@CFinalAmount
         

--                Fetch next From ZZ Into @ZValueDate
--                END
--                Close ZZ
--                Deallocate ZZ

--                    select @CInterestAmount = sum(InterestAmount) from #TempInterest
--                    select @CTaxExpenseAmount = sum(TaxAmount) from #TempInterest
--                    select @CFinalAmount = sum(FinalAmount) from #TempInterest
--            END
--            ELSE
--            BEGIN
--                Select @CInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance)            
--	            set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
--	            set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)  
--            END
--        END



      
--		IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)                    
--		BEGIN                 	         
--		-- Setup Account kelar diatas, Next masukin ke Fund Journal   
--		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

--		IF @CInterestAmount > 0                  
--		BEGIN           
--		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

--        IF((day(@valuedate) <> 31 AND @CInstrumentTypePK not in (2,13)) OR (@CInstrumentTypePK in (2,13)))
--        BEGIN
--                INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
--                ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

--                Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
--                '','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

--                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--                Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
--                @CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

--                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--                Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
--                0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

--                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--                Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
--                @CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
        
           

--        END

	                              
--		END
--		END            
--END
--END        

--IF @CInstrumentTypePK = 5  
--BEGIN   
----IF NOT EXISTS(
----Select * from investment
----where ValueDate = @ValueDate and StatusSettlement = 2 and TrxType = 2 and InstrumentPK = @CInstrumentPK
----)
--BEGIN
	
--    IF (@CRoll = 0 AND @CSell = 0)
--    BEGIN
--        IF  @CMaturityDate > @DateYesterday and @CMaturityDate <= @ValueDate
--        BEGIN
--            Declare @RealMaturedDate datetime
--            if @CPaymentModeOnMaturity = 1
--            begin
--            set @RealMaturedDate = @CMaturityDate
--            end
--            if @CPaymentModeOnMaturity = 2
--            begin
--            set @RealMaturedDate = @ValueDate
--            end
--            Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@RealMaturedDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)           

--            if @CPaymentModeOnMaturity = 3
--            begin
--            set @CInterestAmount = 0
--            end

--        END
--        ELSE
--        BEGIN
	
--            if (@ValueDate = @CAcqDate)
--            BEGIN
--                Select @CInterestAmount = 0
--            END
--            ELSE
--            BEGIN
--                Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)        
--            END
	
		 
--        END
--    END
--    ELSE IF (@CRoll = 1 and @CMaturityDate > @ValueDate)
--    BEGIN
--        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,@CAcqDate,@ValueDate)

--    END
--    ELSE IF (@CSell = 1 and @CMaturityDate > @ValueDate)
--    BEGIN
--        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) *  DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),dateadd(day,-1,@valuedate))

--    END
--    ELSE
--    BEGIN
--        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),@CMaturityDate)
--    END


----       select @ValueDate,@CAcqDate,@CInterestAmount,@CInstrumentPK,@CInterestPercent,@CFundPK
---- where @CInstrumentPK in 
---- (
--	--select A.instrumentPK from fundposition A
--	--left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.status = 2

--	--where fundpk = 2 and trailsPK = 2 and B.InstrumentTypePK = 5		   
---- )
---- CEK LOGIK PAYMENT INTEREST TYPE DISINI

---- Setup Account kelar diatas, Next masukin ke Fund Journal   
--select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

--IF @CInterestAmount > 0                  
--BEGIN                  
--set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
--set @CFinalAmount = @CInterestAmount - @CTaxExpenseAmount       

--INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
--,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

--Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,7,@maxEndDayTrailsPK,'INTEREST DEPOSIT',                  
--'','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
--@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
--0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
--,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

--Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
--@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2                   
--END        
--END

	          
--END

                                              
	
 

 
--Fetch next From C                   
--Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell    
--,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent,@CPaymentModeOnMaturity,@CRoll
--END        
--Close C                  
--Deallocate

                          
-- C4. MATURE BOND & TIME DEPOSIT & DEPOSITO BELUM SAMPE UJUNG   
Declare @DInstrumentPK    int  
Declare @DRealisedAccBond    int      
Declare @DRevaluationAccBond    int         
Declare @DInstrumentID    nvarchar(100)                  
Declare @DFundPK     int                  
Declare @DTrxAmount     numeric(22,6)                  
Declare @DMarketValue    numeric(22,6)                  
Declare @DInstrumentTypePK   int                  
Declare @DCurrencyPK    int                                   
Declare @DFinalAmount    numeric(22,6)                  
Declare @DNextCouponDate   datetime                  
Declare @DInterestAmount   numeric(18,6)                  
Declare @DBalance     numeric(18,0)                  
Declare @DTaxExpenseAmount   numeric(18,6)                  
Declare @DTaxExpensePercent   numeric(18,8)                  
Declare @DAcqDate   datetime                                  
Declare @DMaturityDate  datetime  
Declare @PrevInterestAmount numeric(22,6)
Declare @PrevFinalAmount numeric(22,6)
Declare @PrevTaxExpenseAmount numeric(22,6)
declare @divdays int
declare @intdays int

Declare @DInterestRecAcc int
Declare @DTaxExpenseAcc int
Declare @DInterestIncometAcc int
Declare @DCashAtBankAcc   int  
Declare @DInvestmentBond int
Declare @DInvestmentTimeDeposit int
Declare @DInterestPaymentType int


Declare @DPaymentModeOnMaturity int
Declare @DInterestDaysType int
Declare @DInterestPercent numeric(18,4)


--DISINI

insert into #Mature(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetNextCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and A.MaturityDate >= @DateYesterday and A.MaturityDate <= @valuedate and B.InstrumentTypePK in (5,10) and FundPK = @XFundPK and A.InterestPaymentType <> 7
and A.[Identity] not in(
Select isnull(TrxBuy,0) from Investment where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and FundPK = @XFundPK
)


-- INI UNTUK KASUS TERIMA KUPON BULANAN, PAKAI INTERESTPAYMENTTYPE = 7 (MONTHLY)
union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,cast(cast(DATEPART(MONTH, @valuedate) as nvarchar(2)) + '/' + cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime),A.Balance                   
,B.TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime) AcqDate,A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              

Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and A.MaturityDate >= @DateYesterday and A.InterestPaymentType = 7 
--and DATEPART(DAY,A.MaturityDate) >= DATEPART(DAY,@DateYesterday) and DATEPART(DAY,A.MaturityDate) <= DATEPART(DAY,@valuedate) 
and B.InstrumentTypePK in (5,10)

and A.InstrumentPK not in(
Select InstrumentPK from Investment C where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and A.FundPK = C.FundPK and A.InstrumentPK = C.InstrumentPK
)

union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15) and FundPK = @XFundPK
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate       


DECLARE D CURSOR FOR 
-- ni buat bulanan
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where NextCouponDate > @DateYesterday and NextCouponDate <= @valuedate and NextCouponDate <> MaturityDate and InstrumentTypePK in (5,10) and InterestPaymentType = 7	 and FundPK = @XFundPK
union all
-- ni buat bulanan tapi udah mature
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,MaturityDate,Balance                   
,TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime), MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate > @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType = 7  and FundPK = @XFundPK
union all

select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType <> 7	 and FundPK = @XFundPK
union all
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate and InstrumentTypePK in (2,3,8,9,11,13,14,15) and FundPK = @XFundPK


Open D
Fetch Next From D
Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate   
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent ,@DInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN       
  

IF @DInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @DInterestRecAcc = InterestAccrBond
,@DTaxExpenseAcc = TaxExpenseInterestIncomeBond,@DInterestIncometAcc = IncomeInterestBond,@DInvestmentBond = InvestmentBond,
@DRealisedAccBond = RealisedBond,@DRevaluationAccBond = RevaluationBond
From FundAccountingSetup where Status = 2  and FundPK = @DFundPK  

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

               

Begin           
Select @intdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@DInterestPaymentType in (10,11,12)) 
BEGIN
	select @divdays = 90
END
ELSE
IF(@DInterestPaymentType in (16,17,18)) 
BEGIN
	select @divdays = 180
END
ELSE
IF(@DInterestPaymentType in (7,8,9)) 
BEGIN
	select @divdays = 30
END
ELSE
BEGIN
	select @divdays = datediff(day,@DAcqDate,@DMaturityDate)   
END       
Select @DInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@DFundPK,@DInstrumentPK,@DBalance) / @intdays *  @divdays                                                 
End               

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@DFundPK,@DInstrumentPK,@DBalance) * (datediff(day,@DAcqDate,@DMaturityDate) - 1)                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

  

IF @DInterestAmount > 0                  
BEGIN    
	
IF (@DMaturityDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'MATURE TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@DRealisedAccBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DTrxAmount - @DBalance,                   
    @DTrxAmount - @DBalance,0,1,@DTrxAmount - @DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DRealisedAccBond and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DTrxAmount - @DBalance,                   
    0,@DTrxAmount - @DBalance,1,0,@DTrxAmount - @DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

END

ELSE
BEGIN
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal           
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                  
END
END               
END                  

ELSE IF @DInstrumentTypePK in (5,10)                
BEGIN   


Select @DInterestRecAcc = InterestAccrTimeDeposit,@DTaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@DInterestIncometAcc = IncomeInterestTimeDeposit, @DInvestmentTimeDeposit = InvestmentTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @DFundPK

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

Begin         
	
IF (@DInterestPaymentType = 7)
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccrued]  (@ValueDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate) / @intdays *  DATEDIFF(day,dateadd(month,-1,@DAcqDate),@DNextCouponDate)               
END
ELSE
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment]  (@DMaturityDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate,@DInterestPaymentType,@DMaturityDate,@DPaymentModeOnMaturity)  End              
END

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * @DInterestAmount                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

IF @DInterestAmount > 0                  
BEGIN    

--BALIKIN NILAI INTEREST KE BANK
             
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR INTEREST TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestIncometAcc and Status = 2                  
END


IF @DInterestPaymentType not in (7) 
BEGIN


    if @DPaymentModeOnMaturity = 2 -- ACQ TO MATURITY DATE NWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end
    else if @DPaymentModeOnMaturity = 3 -- ACQ TO MATURITY DATE BWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end else
    BEGIN
    set @DMaturityDate = @DMaturityDate
    END

    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal          
       
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'INV DEPOSIT TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentTimeDeposit,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentTimeDeposit and Status = 2                 



    END       

        

END

		
Fetch next From D Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate      
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent     ,@DInterestPaymentType                  
END
Close D
Deallocate D    
-------------------------------------------------------------------
-- C5. REC COUPON BOND

Declare @GInstrumentPK    int       
Declare @GInstrumentID    nvarchar(100)                  
Declare @GFundPK     int                  
Declare @GTrxAmount     numeric(22,6)                  
Declare @GMarketValue    numeric(22,6)                  
Declare @GInstrumentTypePK   int                  
Declare @GCurrencyPK    int                                   
Declare @GFinalAmount    numeric(22,6)   
Declare @GLastCouponDate   datetime                  
Declare @GNextCouponDate   datetime                  
Declare @GInterestAmount   numeric(18,6)                  
Declare @GBalance     numeric(18,0)                  
Declare @GTaxExpenseAmount   numeric(18,6)                  
Declare @GTaxExpensePercent   numeric(18,8)                  
Declare @GAcqDate   datetime                                  
Declare @GMaturityDate  datetime  
Declare @GPrevInterestAmount numeric(22,6)
Declare @GPrevFinalAmount numeric(22,6)
Declare @GPrevTaxExpenseAmount numeric(22,6)
declare @Gdivdays int
declare @Gintdays int

Declare @GInterestRecAcc int
Declare @GTaxExpenseAcc int
Declare @GInterestIncometAcc int
Declare @GCashAtBankAcc   int  
Declare @GInterestAccrBond int
Declare @GInvestmentTimeDeposit int
Declare @GInterestPaymentType int


Declare @GPaymentModeOnMaturity int
Declare @GInterestDaysType int
Declare @GInterestPercent numeric(18,4)
Declare @GRecCouponDate   datetime   


--DISINI

insert into #RecCoupon(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType,RecCouponDate)


Select A.InstrumentPK,A.FundPK,A.TrxAmount,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,
case when A.InterestPaymentType in (10,11,12) then dateadd(month,-3,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) else case when A.InterestPaymentType in (16,17,18) then dateadd(month,-6,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK))
else case when A.InterestPaymentType in (7,8,9) then dateadd(month,-1,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) end end end
,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType,case when C.SettlementDate is null then dbo.FgetLastCouponDate(A.Date,A.InstrumentPK) else C.SettlementDate end RecCouponDate                       
From FundPosition A                 
left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2  
left join 
(
select InstrumentPK,FundPK,SettlementDate,sum(DoneVolume) DoneVolume from 
Investment  where  StatusSettlement = 2 and TrxType = 1 
group by InstrumentPK,FundPK,SettlementDate
)C on A.InstrumentPK = C.InstrumentPK and A.FundPK = C.FundPK and A.AcqDate = C.SettlementDate            
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio D where D.status = 2 and D.ValueDate = @DateYesterday and D.FundPK = @XFundPK
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and A.AcqDate  < @valuedate and A.FundPK = @XFundPK


DECLARE G CURSOR FOR 
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType,RecCouponDate
from #RecCoupon where (NextCouponDate >= @DateYesterday and NextCouponDate <= @valuedate) and InstrumentTypePK in (2,3,8,9,11,13,14,15) and FundPK = @XFundPK
Open G
Fetch Next From G
Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate   
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent ,@GInterestPaymentType,@GRecCouponDate         
While @@FETCH_STATUS = 0
BEGIN      
  

IF @GInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @GInterestRecAcc = InterestAccrBond
,@GTaxExpenseAcc = WHTTaxPayableAccrInterestBond,@GInterestIncometAcc = IncomeInterestBond,@GInterestAccrBond = InterestAccrBond
From FundAccountingSetup where Status = 2  and FundPK = @GFundPK  

Select @GCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @GFundPK


---- TERIMA KUPON 
IF(datediff(day,@GNextCouponDate,@GMaturityDate)) > 15
BEGIN
    Begin           
	Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate) 
	IF(@GInterestPaymentType in (10,11,12,13)) 
	BEGIN
		select @Gdivdays = 90
	END
	ELSE
	IF(@GInterestPaymentType in (16,17,18)) 
	BEGIN
		select @Gdivdays = 180
	END
	ELSE
	IF(@GInterestPaymentType in (7,8,9)) 
	BEGIN
		select @Gdivdays = 30
	END
	ELSE
	BEGIN
		select @Gdivdays = datediff(day,@GAcqDate,@GNextCouponDate)   
	END    

		Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance) / @Gintdays *  (@Gdivdays)

                                                  
	End               

	IF (@GRecCouponDate > @GLastCouponDate)
	BEGIN
        if @GInstrumentTypePK in (2,9,13,15)
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FGetDateDIffGovermentBond](@GRecCouponDate,@GNextCouponDate)) 
        END
        ELSE
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FgetDateDiffCorporateBond](@GRecCouponDate,@GNextCouponDate)) 
        END
	END
	ELSE
	BEGIN
		set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
	END

	set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount

	
IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
    --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    --Select  @FundJournalPK,3,1,2,@GTaxExpenseAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GTaxExpenseAmount,                   
    --@GTaxExpenseAmount,0,1,@GTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GTaxExpenseAcc and Status = 2                   

    --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    --Select @FundJournalPK,4,1,2,@GInterestIncometAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GTaxExpenseAmount,                   
    --0,@GTaxExpenseAmount,1,0,@GTaxExpenseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestIncometAcc and Status = 2  



END

END    



END  
ELSE
BEGIN
	Begin      
	Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate)      
	IF(@GInterestPaymentType in (10,11,12,13)) 
	BEGIN
		select @Gdivdays = 90 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)

	END
	ELSE
	IF(@GInterestPaymentType in (16,17,18)) 
	BEGIN
		select @Gdivdays = 180 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)
	END
	ELSE
	IF(@GInterestPaymentType in (7,8,9)) 
	BEGIN
		select @Gdivdays = 30 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)
	END
	ELSE
	BEGIN
		select @Gdivdays = dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)  
	END    

		Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)/ @Gintdays *  @Gdivdays

                                                  
	End               

	IF (@GRecCouponDate > @GLastCouponDate)
	BEGIN

        if @GInstrumentTypePK in (2,9,13,15)
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FGetDateDIffGovermentBond](@GRecCouponDate,@GMaturityDate)) 
        END
        ELSE
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FgetDateDiffCorporateBond](@GRecCouponDate,@GMaturityDate)) 
        END                
	END
	ELSE
	BEGIN
		set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
	END

	set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount
END


  
IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@GMaturityDate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
    --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    --Select  @FundJournalPK,3,1,2,@GTaxExpenseAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GTaxExpenseAmount,                   
    --@GTaxExpenseAmount,0,1,@GTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GTaxExpenseAcc and Status = 2                   

    --INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    --,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    --Select @FundJournalPK,4,1,2,@GInterestIncometAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GTaxExpenseAmount,                   
    --0,@GTaxExpenseAmount,1,0,@GTaxExpenseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestIncometAcc and Status = 2  



END

END    


           
END                  

		
Fetch next From G Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate      
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent,@GInterestPaymentType,@GRecCouponDate                  
END
Close G
Deallocate G  









-----------------------------------------------------------------------------------------------------------

-- D. COPY FUND CLIENT POSITION --    
    

if not exists(
	select * from FundClientPosition where date = dbo.FWorkingDay(@ValueDate, 1) and FundPK = @XFundPK
)
BEGIN

    
Declare @CPFundPK int           
Declare A Cursor For              
Select FundPK From Fund Where status = 2 and FundPK = @XFundPK              
Open  A              
Fetch Next From  A              
into @CPFundPK              
While @@Fetch_Status = 0              
BEGIN              
Insert into FundClientPosition(Date,FundClientPk,FundPK,CashAmount,UnitAmount,LastUpdate)              
Select dbo.FWorkingDay(@ValueDate, 1),FundClientPK,FundPK,CashAmount,UnitAmount,@LastUpdate              
From FundClientPosition where Date = @ValueDate and FundPK = @CPFundPK           
Fetch next From A                   
Into @CPFundPK              
END                  
Close A                  
Deallocate A


END    




-- E. PENDING UNIT REGISTRY
-- 1. SUBSCRIPTION
Declare @SValueDate Datetime,@SFundPK int,@SCashRefPK int,@SFundClientPK int,@SFundClientName nvarchar(100),@STotalCashAmount numeric(22,4),@SCurrencyPK int ,@SType nvarchar(5)  
Declare @SPendingSubscription int,@SSubscription int,@SCashAtBankAcc int   
Declare @SPendingRedemption int,@SRedemption int
Declare @SCashAmount numeric(22,4), @SFeeAmount numeric(22,4)
Declare @SPayableSubsAcc int                 
DECLARE @BitPendingSubscription bit		
Declare @UnitRegistryPK int    				 
Declare @IssueDate datetime

Declare A Cursor For                  
Select ClientSubscriptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,TotalCashAmount,CurrencyPK,'SUBS' Type
,CashAmount, SubscriptionFeeAmount          
From ClientSubscription A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.status not in (3,4) and ValueDate = @ValueDate and A.FundPK = @XFundPK  
union all
Select ClientRedemptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,case when TotalCashAmount = 0 then TotalUnitAmount * dbo.FgetCloseNav(@DateYesterday,A.FundPK) else TotalCashAmount End TotalCashAmount,CurrencyPK,'RED' Type         
,CashAmount, RedemptionFeeAmount
From ClientRedemption A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.Status <>  3  and ValueDate = @ValueDate and A.FundPK = @XFundPK
	            
Open A                  
Fetch Next From A                  
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK,@SType,
@SCashAmount,@SFeeAmount
While @@FETCH_STATUS = 0                  
Begin 
IF (@SType = 'SUBS')
BEGIN

select @IssueDate = IssueDate from Fund where status in (1,2) and FundPK = @SFundPK

SELECT @BitPendingSubscription = ISNULL(BitPendingSubscription,1) FROM dbo.FundFee WHERE fundPK = @SFundPK
AND date = 
(
SELECT MAX(Date) FROM dbo.FundFee WHERE Date <= @SValueDate AND FundPK = @SFundPK
AND status = 2
) and STATUS = 2

set @BitPendingSubscription = isnull(@BitPendingSubscription,0)

set @SCashAtBankAcc = NULL

Select @SCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @SCashRefPK
if (@SCashAtBankAcc is null or @SCashAtBankAcc  = '')
BEGIN
set @SCashAtBankAcc = 3
END

IF (@ValueDate = @IssueDate)
BEGIN

    Select @SSubscription = Subscription From FundAccountingSetup where Status = 2  and FundPK = @SFundPK
                     
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SSubscription and Status = 2   


END
ELSE 
BEGIN

    IF(@BitPendingSubscription = 1)
    BEGIN
    Select @SPendingSubscription = PendingSubscription,@SSubscription = Subscription
    ,@SPayableSubsAcc = payablesubscriptionfee
    From FundAccountingSetup 
    where Status = 2  and FundPK = @SFundPK

                       
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SPendingSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPendingSubscription and Status = 2   

        if @SFeeAmount > 0
        BEGIN

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select @FundJournalPK,3,1,2,@SPayableSubsAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@SFeeAmount,                   
        0,@SFeeAmount,1,0,@SFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPayableSubsAcc and Status = 2   
        END

    END


END                                  

  

         
END
         
Fetch next From A                   
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK ,@SType,@SCashAmount,@SFeeAmount
END                  
Close A                  
Deallocate A

  UPDATE A 
SET A.AvgNAV = dbo.FGetAVGForFundClientPosition(@ValueDate,A.FundClientPK,A.FundPK), A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
FROM FundClientPosition A
    LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
    LEFT JOIN FundClientPosition C ON A.FundPK = C.FundPK AND A.FundClientPK = C.FundClientPK AND C.Date = @DateYesterday
WHERE A.Date = @ValueDate and A.FundPK = @XFundPK

UPDATE A 
SET A.AUM = ISNULL(B.AUM,0),A.AvgNAV = ISNULL(B.AvgNAV,0) 
FROM dbo.FundClientPositionSummary A
    LEFT JOIN dbo.FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK AND B.Date  = @ValueDate
where  A.FundPK = @XFundPK
-------------------------------------------
-- JOURNAL CORPORATE ACTION



--DIVIDEN SAHAM
-- Tarik Balance Cum / Valuedate - 1 + movement dengan batas settleddate <= recordingDate and ValueDate >= CumDate 
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn,TaxDueDate)
Select  B.FundPK,B.InstrumentPK,B.Balance + ISNULL(C.BalanceFromInv,0) LastBalance,
A.PaymentDate,A.RecordingDate,A.Hold,A.Earn,ISNULL(A.TaxDueDate,1)
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 and FundPK = @XFundPK
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
and C.ValueDate >= A.ValueDate
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate and B.FundPK = @XFundPK



Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn,TaxDueDate)
Select B.FundPK,B.InstrumentPK,isnull(B.BalanceFromInv,0),A.PaymentDate,A.RecordingDate,A.Hold,A.Earn,ISNULL(A.TaxDueDate,1)
from CorporateAction A
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 and FundPK = @XFundPK
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)B on  B.SettlementDate <= A.RecordingDate and  A.InstrumentPK = B.InstrumentPK
and B.ValueDate >= A.ValueDate
left join #ZDividenSaham C on B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK 
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate
and C.FundPK is null and C.InstrumentPK is null 

Declare @TIncomeDividend int
Declare @TARDividend int
Declare @TotalAmount numeric(22,4)
Declare @TWithHoldingTaxPPH23 int


Declare @TInstrumentPK int
declare @TFundPK int
declare @TLastVolume numeric(22,4)
declare @TPaymentDate datetime
declare @TRecordingDate datetime
declare @TEarn numeric(22,4)
declare @THold numeric(22,4)
declare @TTaxDueDate int

Declare @TTaxPercentage numeric(8,4)
Declare @pph23Amount numeric(22,4)

Declare A Cursor For   
Select * From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold,@TTaxDueDate
While @@FETCH_STATUS = 0                  
Begin 

Select @TIncomeDividend = IncomeDividend,@TARDividend = ARDividend,@TWithHoldingTaxPPH23 = prepaidTaxDividend 
,@TTaxPercentage = TaxPercentageDividend
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume/@THold * @TEarn
   
if @TotalAmount > 0
BEGIN
	IF (@TTaxDueDate = 1)
	BEGIN
			----------- TO
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
		INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
		,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
		'','DIVIDEND CASH CUM DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,1,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','D',@TotalAmount,                   
		@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2                   


		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,2,1,2,@TIncomeDividend,CurrencyPK,@TFundPK,0,0,'INCOME DIVIDEND','C',@TotalAmount,                   
		0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TIncomeDividend and Status = 2   

		--------------- PAYMENT DATE

		
		set @pph23Amount = @TotalAmount * @TTaxPercentage/100

		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
		INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
		,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@TPaymentDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
		'','DIVIDEND CASH PAYMENT DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,1,1,2,@DefaultCashAtBankPK,CurrencyPK,@TFundPK,0,0,'DIVIDEND','D',@TotalAmount - @pph23Amount,                   
		@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DefaultCashAtBankPK and Status = 2                   


		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,2,1,2,@TWithHoldingTaxPPH23,CurrencyPK,@TFundPK,0,0,'TAX DIVIDEND','D',@pph23Amount,                   
		@pph23Amount,0,1,@pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TWithHoldingTaxPPH23 and Status = 2     

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,3,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','C',@TotalAmount,                   
		0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2   

	END
	ELSE
	BEGIN

		set @pph23Amount = @TotalAmount * @TTaxPercentage/100

			----------- TO
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
		INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
		,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
		'','DIVIDEND CASH CUM DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,1,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','D',@TotalAmount - @pph23Amount,                   
		@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2                   


		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,2,1,2,@TIncomeDividend,CurrencyPK,@TFundPK,0,0,'INCOME DIVIDEND','C',@TotalAmount,                   
		0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TIncomeDividend and Status = 2   

		
		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,2,1,2,@TWithHoldingTaxPPH23,CurrencyPK,@TFundPK,0,0,'TAX DIVIDEND','D',@pph23Amount,                   
		@pph23Amount,0,1,@pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TWithHoldingTaxPPH23 and Status = 2     


		--------------- PAYMENT DATE




		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
		INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
		,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@TPaymentDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
		'','DIVIDEND CASH PAYMENT DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,1,1,2,@DefaultCashAtBankPK,CurrencyPK,@TFundPK,0,0,'DIVIDEND','D',@TotalAmount - @pph23Amount,                   
		@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DefaultCashAtBankPK and Status = 2                   


		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
		,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,3,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','C',@TotalAmount - @pph23Amount,                   
		0,@TotalAmount - @pph23Amount,1,0,@TotalAmount - @pph23Amount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2   

	END

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold,@TTaxDueDate
END                  
Close A                  
Deallocate A
------------------------------------------------------------------------------

Update A set BitValidate = 1, LogMessages = B.ID + ' - ' + B.Name from EndDayTrails A  
left join Fund B on A.FundPK = B.FundPK and B.status in (1,2)
where A.FundPK = @XFundPK and A.Status = 2 and ValueDate = @ValueDate     


Fetch next From X   
Into @XFundPK,@XFundID                
End                  
Close X                  
Deallocate X  

Select @maxEndDayTrailsPK LastPK     
                             
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.Parameters.AddWithValue("@ClientCode", Tools.ClientCode);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToInt32(dr["LastPK"]);

                            }
                            return 0;
                        }

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }

        public bool ValidateGenerateToday(DateTime _valueDate)
        {
            try
            {
                DateTime _dateTimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {

                        cmd.CommandText = @" if Exists(select * From EndDayTrails where Status in (1,2) and ValueDate = @Valuedate)  
                                             BEGIN Select 1 Result END ELSE 
											 BEGIN   
                                            Select 0 Result END   ";



                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToBoolean(dr["Result"]);

                            }
                            return false;
                        }
                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }

        }


        public int EndDayTrails_GenerateParamFund(string _usersID, DateTime _valueDate, EndDayTrails _edt)
        {
            try
            {
                DateTime _datetimeNow = DateTime.Now;
                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        string _paramFund = "";

                        if (!_host.findString(_edt.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_edt.FundFrom))
                        {
                            _paramFund = "And A.FundPK in ( " + _edt.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
                        Declare @XFundPK int
                        Declare @XFundID nvarchar(50)
                        Declare @TrailsPK int

                        DECLARE X CURSOR FOR     

                        select FundPK,ID from Fund A where status in (1,2)  " + _paramFund + @" and MaturityDate >= @ValueDate and IssueDate <= @ValueDate

                        Open X
                        Fetch Next From X
                        Into @XFundPK,@XFundID

                        While @@FETCH_STATUS = 0
                        BEGIN  

                      
                        --VOID EDT FUND JOURNAL ONLY

                        update FundJournal set Posted = 0,Status = 3,VoidUsersID = @UsersID ,VoidTime= @lastUpdate, LastUpdate = @LastUpdate 			
                        where  Type not in (1,11) and Status = 2 and TrxName <> 'SUBSCRIPTION' and TrxNo =
                        (
                        Select EndDayTrailsPK from EndDayTrails where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal' and FundPK = @XFundPK
                        )  

                        update EndDayTrails set status = 3,VoidUsersID = @UsersID,VoidTime = @LastUpdate,LastUpdate=@lastUpdate    
                        where ValueDate = @ValueDate and status = 2 and Notes = 'Fund Journal'   and FundPK = @XFundPK
                        

                         
                        update CloseNav set status = 3,VoidUsersID = @UsersID ,VoidTime= @LastUpdate, LastUpdate = @LastUpdate 
                        where Date = @ValueDate and status <> 3  and FundPK = @XFundPK

                        Fetch next From X   
                        Into @XFundPK,@XFundID                
                        End                  
                        Close X                  
                        Deallocate X 
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);
                        cmd.ExecuteNonQuery();



                    }
                }

                using (SqlConnection DbCon = new SqlConnection(Tools.conString))
                {
                    DbCon.Open();
                    using (SqlCommand cmd = DbCon.CreateCommand())
                    {
                        string _paramFund = "";

                        if (!_host.findString(_edt.FundFrom.ToLower(), "0", ",") && !string.IsNullOrEmpty(_edt.FundFrom))
                        {
                            _paramFund = "And A.FundPK in ( " + _edt.FundFrom + " ) ";
                        }
                        else
                        {
                            _paramFund = "";
                        }

                        cmd.CommandTimeout = 0;
                        cmd.CommandText = @"
  

Declare @BDateFrom datetime
Declare @BTotalDays int

select @BDateFrom = DateFrom from Period where @ValueDate between DateFrom and DateTo and status = 2
select @BTotalDays = datediff(Day,@BDateFrom,dateadd(year,1,@BDateFrom))

Create Table #TempInterest
(
InstrumentID nvarchar(100),
InterestAmount numeric(22,4),
TaxAmount numeric(22,4),
FinalAmount numeric(22,4)
)


Create Table #Mature
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int
)

Create Table #RecCoupon
(
InstrumentPK int,FundPK int,TrxAmount numeric(22,4),
MarketValue numeric(22,4),InstrumentTypePK int,CurrencyPK int,
InstrumentID nvarchar(50),LastCouponDate datetime,NextCouponDate datetime,Balance numeric(22,4),
TaxExpensePercent numeric(22,4), AcqDate datetime, MaturityDate datetime
,PaymentModeOnMaturity int, InterestDaysType int, InterestPercent numeric(18,8)
, InterestPaymentType int, RecCouponDate datetime
)

Create Table #ZFundFee               
(                  
DateOfPayment int,  
FundPK int,                  
ManagementFeePercent numeric(18,8),
CustodiFeePercent numeric(18,8),
AuditFeeAmount numeric(18,4),
MovementFeeAmount numeric(18,4),
ManagementFeeDays int,
CustodiFeeDays int,
AuditFeeDays int,
SinvestFeeDays int,
FundType int,
BitSinvestFee bit,
OtherFeeOneAmount numeric(18,4),
OtherFeeTwoAmount numeric(18,4),
)   

Create Table #ZDividenSaham                  
(                  
InstrumentPK int,     
FundPK int,                  
LastVolume numeric(18,4),
PaymentDate datetime,
RecordingDate datetime,
Earn numeric(22,4),
Hold numeric(22,4)
)   

Create table #dayTemp
(
IntDay  int
)


Declare @XFundPK int
Declare @XFundID nvarchar(50)
Declare @TrailsPK int

DECLARE X CURSOR FOR     


select FundPK,ID from Fund A where status in (1,2)  " + _paramFund + @"

Open X
Fetch Next From X
Into @XFundPK,@XFundID

While @@FETCH_STATUS = 0
BEGIN  


Declare @MSG nvarchar (Max)   
Declare @PeriodPK int                  
Declare @maxEndDayTrailsPK int    
Declare @DateYesterday datetime 
Declare @DefaultCashAtBankPK int


set @DefaultCashAtBankPK = 3

Select  @DateYesterday  = ValueDate From EndDayTrailsFundPortfolio
where status = 2 and valuedate =(
Select Max(valueDate) From EndDayTrailsFundPortfolio where status = 2 and ValueDate < @ValueDate and FundPK = @XFundPK
) and FundPK = @XFundPK


Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                
Select @maxEndDayTrailsPK = ISNULL(EndDayTrailsPK,0) + 1 from EndDayTrails     

set @maxEndDayTrailsPK = isnull(@maxEndDayTrailsPK,1)               



Insert into EndDayTrails(EndDayTrailsPK,HistoryPK,Status,Notes,ValueDate,FundPK,BitValidate,LogMessages
,EntryUsersID,EntryTime,LastUpdate)                    
Select @maxEndDayTrailsPK,1,2,'Fund Journal',@ValueDate,@XFundPK,1,'',@UsersID,@LastUpdate,@LastUpdate  

---- NEW -----
--if Not Exists(              
--Select * from CloseNAV where Status = 2 and date = @DateYesterday             
--)              
--BEGIN              
--Set @MSG = 'MISSING DATA: Close NAV Yesterday For Fund : ' + @XFundID              
--Update EndDayTrails set BitValidate = 0,LogMessages = @MSG where EndDayTrailsPK = @maxEndDayTrailsPK and Status = 2 and FundPK = @XFundPK              
--Select @maxEndDayTrailsPK LastPK                   
--RETURN;                   
--END              



-- Parameter untuk masuk Ke Jurnal                  
Declare @InvestmentAcc   int                  
Declare @PayablePurchaseAcc  int                  
Declare @CashAtBankAcc   int                  
Declare @CommissionAcc   int                  
Declare @LevyAcc    int                  
Declare @VatAcc     int                  
Declare @WhtAcc     int                  
                
Declare @TaxExpenseAcc   int                  
Declare @WHTTaxPayableAccrInterest int     
Declare @InterestRecAcc int 
--BOND
Declare @InvestmentAccBond   int 
Declare @InterestRecBuySellAccBond int      
Declare @InterestRecAccBond   int 
Declare @RealisedAccBond int   
Declare @ReceivableSaleAccBond int 
Declare @TaxCapitalGainAccBond int 
Declare @TaxInterestAccBond int 

-- Sell              
Declare @ReceivableSaleAcc int              
Declare @RealisedAcc int              
Declare @IncomeSaleTaxAcc int                 
-- Untuk variabel Posting                  
Declare @PValueDate        datetime                  
Declare @PPeriodPK        int                  
Declare @PReference        nvarchar(50)                  
Declare @PTrxType        int                
Declare @PCounterpartPK       int                  
Declare @PInstrumentPK       int                  
Declare @PInstrumentTypePK      int                  
Declare @PFundPK        int                  
Declare @PFundCashRefPK       int                  
Declare @PDoneAccruedInterest  Numeric(18,6)                  
Declare @PSettlementDate      Datetime       
Declare @PAcqDate      Datetime            
Declare @PDoneVolume       numeric(18,0)   
Declare @PAmount       numeric(18,0)               
Declare @PDoneAmount       numeric(18,0)                  
Declare @PCommissionAmount      numeric(18,6)                  
Declare @PLevyAmount       numeric(18,6)                  
Declare @PKPEIAmount       numeric(18,6)                  
Declare @PVATAmount        numeric(18,6)                  
Declare @PWHTAmount        numeric(18,6)                  
Declare @POTCAmount        numeric(18,6)                   
Declare @PIncomeTaxSellAmount     numeric(18,6)                   
Declare @PIncomeTaxInterestAmount    numeric(18,6)                   
Declare @PIncomeTaxGainAmount     numeric(18,6) 
Declare @PTotalAmount       numeric(19,6)                   
Declare @PCurrencyRate       numeric(18,8)                  
Declare @InstrumentType int                  
Declare @FundJournalPK int                  
Declare @InstrumentID nvarchar(30)                  
Declare @FPayablePurchaseAmount numeric(19,6)                  
Declare @InstrumentCurrencyPK int     
Declare @BondDayAccrued int      
Declare @PInterestPercent Numeric(22,6)          

Declare @SellAvgPrice numeric(18,6)  
Declare @AvgAmount numeric(22,6)              
Declare @RealisedAmount numeric(22,6)
Declare @InvestmentShareAmount numeric(22,6)   
Declare @ReceivableSellBondAmount numeric(22,6)    

Declare @PTaxExpenseAmount numeric(22,6) 
Declare @PTaxExpensePercent numeric(22,6) 
Declare @PInterestAmount numeric(22,6) 
Declare @PFinalAmount numeric(22,6)
     
Declare @WHTDueDate int

-- REKSADANA
Declare @ReksadanaTypePK int
Declare @CashForMutualFund int
Declare @MInterestAmount numeric(18,4)
Declare @BDate datetime
Declare @InterestReceivableSellMutualFund int
Declare @InvestmentMutualFundAmount numeric(18,4)

               
-- A. Posting Investment   
-- 1. BUY EQUITY --  
-- 2. SELL EQUITY --
-- 3. BUY BOND -- 
-- 4. SELL BOND -- 
-- 5. PLACEMENT DEPOSITO -- 
-- 6. LIQUIDATE DEPOSITO -- 
-- 7. ROLLOVER DEPOSITO -- 


-- B. Daily Fee dan Payment Fee 	 	            
-- 1. GENERATE DAILY FEE --    
-- 2. PAYMENT FEE -- 
-- 3. BANK INTEREST --
	                       
-- C. Reval, Interest Accrued Bond, Interest Accrued Time Deposit, Mature Bond, Mature Time Deposit
-- 1. REVALUATION EQUITY & BOND --   
-- 2. GENERATE INTEREST ACCRUED BOND           
-- 3. MATURE TIME DEPOSIT YANG BELOM SAMPE UJUNG           
-- 4. MATURE BOND & TIME DEPOSIT
-- 5. REC COUPON BOND
	
-- D. Copy Fund Client Position 

-- E. Pending Subscription

-- A. POSTING INVESTMENT --        

Declare @PBreakInterestPercent numeric(8,4)
Declare @PSettlementPK int

Declare A Cursor For                  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                   
FundPK,FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,Amount,DoneAmount,                  
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                  
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate            
From Investment         
Where StatusSettlement = 2 and Posted = 0 and Valuedate in (
select valuedate from investment where valuedate between @DateYesterday and @valuedate and valuedate <> @DateYesterday and FundPK = @XFundPK)  and InstrumentTypePK <> 6  and FundPK = @XFundPK 

UNION ALL -- REKSADANA
  
Select ValueDate,PeriodPK,Reference,TrxType,CounterpartPK,InstrumentPK,                     
FundPK,case when FundCashRefPK = 0 then 3 else FundCashRefPK end FundCashRefPK,DoneAccruedInterest,SettlementDate,DoneVolume,DoneAmount,isnull(DoneAmount,0),                    
CommissionAmount,LevyAmount,KPEIAmount,VATAmount,WHTAmount,OTCAmount,IncomeTaxSellAmount,                    
IncomeTaxInterestAmount,IncomeTaxGainAmount,TotalAmount,InstrumentTypePK,CurrencyRate,BreakInterestPercent,SettlementPK,TaxExpensePercent,InterestPercent,AcqDate             
From Investment           
Where StatusInvestment = 2 and StatusDealing <> 3 and StatusSettlement <> 3 and Valuedate = @ValueDate 
and InstrumentTypePK = 6 and FundPK = @XFundPK
     
   
Open A                  
Fetch Next From A                  
Into @PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,
@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount
,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount
,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,@PBreakInterestPercent,@PSettlementPK ,@PTaxExpensePercent,@PInterestPercent,@PAcqDate             
While @@FETCH_STATUS = 0                  
Begin                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK              
-- 1 = REGULER                  
-- 2 = G-BOND                  
-- 3 = C-BOND                  
-- 4 = RI                  
-- 5 = DEPOSITO                  
-- 6 = WARRANT 
                
-- A1. BUY EQUITY --  
Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2

               
if @PTrxType = 1 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentEquity,@PayablePurchaseAcc = PayablePurchaseEquity 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 EQUITY BUY: ' + @InstrumentID 
,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled EQUITY BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A2. SELL EQUITY --   
Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2           
if @PTrxType = 2 and @PInstrumentTypePK = 1                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentEquity,@ReceivableSaleAcc = AccountReceivableSaleEquity,@RealisedAcc = RealisedEquity From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             

Declare @SellArAmount numeric(22,6) 
    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 EQUITY SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED EQUITY SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

-- A3. BUY BOND --                  
if @PTrxType = 1 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15)                 
BEGIN  
              
-- 2 = G-BOND                  
-- 3 = C-BOND                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                                           

if @InstrumentType in (2,3,8,9,11,13,14,15)          
BEGIN                  
Select @InvestmentAcc = InvestmentBond,@InterestRecAcc = InterestRecBond,@PayablePurchaseAcc = PayablePurRecBond, 
@WHTTaxPayableAccrInterest = WHTTaxPayableAccrInterestBond,@BondDayAccrued = InterestAccrBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                   
END                  
                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
	
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,2,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,3,1,2,@WHTTaxPayableAccrInterest,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,                
0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,1,0,@PIncomeTaxGainAmount + @PIncomeTaxInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WHTTaxPayableAccrInterest and Status = 2                  

set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PDoneAccruedInterest,0) - isnull(@PIncomeTaxGainAmount,0) 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

-- T Settled                
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
	
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'D',@PTotalAmount,                   
@PTotalAmount,0,1,@PTotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND BUY: ' + @InstrumentID,'C',@PTotalAmount,                   
0,@PTotalAmount,1,0,@PTotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,3,1,2,@BondDayAccrued,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BondDayAccrued and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select @FundJournalPK,4,1,2,@InterestRecAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled BOND BUY: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                  
END                  


-- A4.SELL BOND --
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (2,3,8,9,11,13,14,15) 
BEGIN               
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
Select @InvestmentAccBond = InvestmentBond,@InterestRecBuySellAccBond = InterestRecBond,@InterestRecAccBond = InterestAccrBond,
@RealisedAccBond = RealisedBond, @ReceivableSaleAccBond = AccountReceivableSaleBond,
@TaxCapitalGainAccBond = TaxCapitalGainBond,@TaxInterestAccBond = WHTTaxPayableAccrInterestBond
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
                                  
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                

set @PTaxExpenseAmount = (@PTaxExpensePercent / 100) * @PDoneAccruedInterest                  
set @PFinalAmount = @PDoneAccruedInterest - @PTaxExpenseAmount   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                 
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


declare @BondSellAmount numeric (19,2)

set @BondSellAmount = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)/100 * @PDoneVolume


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InvestmentAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@BondSellAmount,                   
0,@BondSellAmount,1,0,@BondSellAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAccBond and Status = 2    



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


--INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
--,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
--Select @FundJournalPK,2,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest,                   
--0,@PDoneAccruedInterest,1,0,@PDoneAccruedInterest,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                  



INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,3,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxGainAmount,                   
@PIncomeTaxGainAmount,0,1,@PIncomeTaxGainAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2        


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,4,1,2,@TaxCapitalGainAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@PIncomeTaxInterestAmount,                   
@PIncomeTaxInterestAmount,0,1,@PIncomeTaxInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxCapitalGainAccBond and Status = 2            

         
	
--Select @SellAvgPrice = AvgPrice From FundPosition where Date = @DateYesterday and Status =  2 and FundPK = @PFundPK and InstrumentPK = @PInstrumentPK                              
--set @AvgAmount = (@SellAvgPrice/100) * @PDoneVolume              
--set @RealisedAmount = abs(@PDoneAmount - @AvgAmount)
set @RealisedAmount = abs(@PDoneAmount - @BondSellAmount)



-- Gain Realised
if @BondSellAmount > @PDoneAmount              
Begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
		@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                  

	set  @ReceivableSellBondAmount = @BondSellAmount - @RealisedAmount +@PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount               
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
End       
     
-- Loss Realised
if @BondSellAmount <= @PDoneAmount              
begin              
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

		Select  @FundJournalPK,5,1,2,@RealisedAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
		0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAccBond and Status = 2                 
			 
	set  @ReceivableSellBondAmount = @BondSellAmount + @RealisedAmount + @PDoneAccruedInterest  - @PIncomeTaxGainAmount -  @PIncomeTaxInterestAmount              
	set @ReceivableSellBondAmount = isnull(@ReceivableSellBondAmount,0)
end     

                        

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,6,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T Settled       
         
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled BOND SELL: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,1,1,2,@InterestRecBuySellAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@PDoneAccruedInterest,                   
@PDoneAccruedInterest,0,1,@PDoneAccruedInterest,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecBuySellAccBond and Status = 2   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select  @FundJournalPK,2,1,2,@ReceivableSaleAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@ReceivableSellBondAmount,                   
0,@ReceivableSellBondAmount,1,0,@ReceivableSellBondAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAccBond and Status = 2                  


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,3,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'D',@ReceivableSellBondAmount,                   
@ReceivableSellBondAmount,0,1,@ReceivableSellBondAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,4,1,2,@InterestRecAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),                   
0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount) ,1,0,@PDoneAccruedInterest - (@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount),@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAccBond and Status = 2                


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 
Select @FundJournalPK,5,1,2,@TaxInterestAccBond,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED BOND SELL: ' + @InstrumentID,'C',@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,                   
0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,1,0,@PIncomeTaxInterestAmount + @PIncomeTaxGainAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxInterestAccBond and Status = 2                



END 


-- A5.PLACEMENT DEPOSITO & ROLLOVER DEPOSITO          
if @PTrxType in (1,3) and @PInstrumentTypePK in (5,10) -- 5 Deposito biasa 10 NCD
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                           

if @InstrumentType in (5,10)                  
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                                    

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                 

IF dbo.CheckTodayIsHoliday (@PValueDate) = 1
BEGIN
    select @PValueDate = dbo.Fworkingday(@PValueDate, 1)
END


-- T0                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                   

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT BUY: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                 

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                          

Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT BUY: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
END                  

-- A6. LIQUIDATE DEPOSITO --            
if @PTrxType = 2 and @PInstrumentTypePK in (5,10)                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK,@InstrumentCurrencyPK = CurrencyPK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
	
if @InstrumentType in (5,10)
BEGIN                  
Select @InvestmentAcc = InvestmentTimeDeposit From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
END                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  

-- T0              
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                        

Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 DEPOSIT LIQUIDATE: ' + @InstrumentID,'C',@PDoneAmount,                   
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               
	
	
-- LOGIK BREAK INTEREST DISINI
	
Declare @IncomeDeposito int
Declare @ARInterestDeposito int
Declare @TaxDeposito int
    
Select @ARInterestDeposito = InterestAccrTimeDeposit,@IncomeDeposito = IncomeInterestTimeDeposit, 
@TaxDeposito = TaxExpenseInterestIncomeTimeDeposit
From FundAccountingSetup where Status = 2  and FundPK = @PFundPK                
	
Declare @ARInterestDepositoAmount numeric(22,4)
Declare @IncomeDepositoAmount numeric(22,4)
Declare @TaxDepositoAmount numeric(22,4)


set @IncomeDepositoAmount = [dbo].FGetDepositoInterestAccruedForPayment (@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,DateAdd(day,1,@PAcqDate),1,@ValueDate,1)
set @ARInterestDepositoAmount = 0.8 * @IncomeDepositoAmount
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount

--set @ARInterestDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@ARInterestDeposito,@PInstrumentPK,@PFundPK)
--set @IncomeDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@IncomeDeposito,@PInstrumentPK,@PFundPK)
--set @TaxDepositoAmount = [dbo].[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK] (@ValueDate,@TaxDeposito,@PInstrumentPK,@PFundPK)
	

if @PBreakInterestPercent > 0


BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @IncomeDepositoAmount > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'D',@IncomeDepositoAmount,                   
	@IncomeDepositoAmount,0,1,@IncomeDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

if @ARInterestDepositoAmount > 0 
BEGIN

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,                   
	0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    
END
IF (@IncomeDeposito <> @TaxDeposito)
BEGIN
    if @TaxDepositoAmount > 0
    BEGIN
	    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	    Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	    0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    
    END


END
ELSE
BEGIN
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE BREAK INTEREST: ' + @InstrumentID,'C',@TaxDepositoAmount,                   
	0,@TaxDepositoAmount,1,0,@TaxDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    
END

Declare @BDNewInterestAmount numeric(22,4)
Declare @BDBalance numeric(22,4)
Declare @BDInterestDaysType int
Declare @BDInterestPercent numeric(8,4)
Declare @BDAcqDate datetime
Declare @BDInterestPaymentType int
Declare @BDMaturityDate datetime
Declare @BDPaymentModeOnMaturity int
Declare @BDTaxPercent numeric(8,4)

Select @BDBalance = Balance,@BDInterestDaysType = InterestDaysType
,@BDInterestPercent = InterestPercent
,@BDAcqDate = AcqDate
,@BDInterestPaymentType = InterestPaymentType
,@BDMaturityDate = MaturityDate
,@BDPaymentModeOnMaturity = PaymentModeOnMaturity
,@BDTaxPercent = TaxExpensePercent
From FundPosition where Date = @DateYesterday and InstrumentPK = @PInstrumentPK


set @BDNewInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment](@ValueDate,@PInstrumentPK,@BDBalance,@BDInterestDaysType,@PBreakInterestPercent,@BDAcqDate,@BDInterestPaymentType,@ValueDate,@BDPaymentModeOnMaturity)
		
if @BDNewInterestAmount > 0
BEGIN
	Declare @BDTaxAmount numeric(22,4)
	Declare @BDIncomeAmount numeric(22,4)
	set @BDTaxAmount = @BDNewInterestAmount * @BDTaxPercent/100
	set @BDIncomeAmount = @BDNewInterestAmount - @BDTaxAmount
					
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
				
	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

		Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
		@PReference,'LIQUIDATE NEW INTEREST: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDIncomeAmount,                   
	@BDIncomeAmount,0,1,@BDIncomeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2        
				
		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'C',@BDNewInterestAmount,0,@BDNewInterestAmount,1,0,@BDNewInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2    

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'LIQUIDATE NEW INTEREST: ' + @InstrumentID,'D',@BDTaxAmount,@BDTaxAmount,0,1,@BDTaxAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2    

END
END
ELSE
BEGIN

set @IncomeDepositoAmount = dbo.FGetDepositoInterestAccrued(@ValueDate,@PInstrumentPK,@PDoneVolume,4,@PInterestPercent,@ValueDate)
set @TaxDepositoAmount = 0.2 * @IncomeDepositoAmount


select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                      

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'LIQUIDATE: ' + @InstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate  

if @ARInterestDepositoAmount > 0 and @PBreakInterestPercent > 0
BEGIN
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,                   
	@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount ,0,1,@ARInterestDepositoAmount + @IncomeDepositoAmount - @TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

	Select  @FundJournalPK,3,1,2,@TaxDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@TaxDepositoAmount,                   
	@TaxDepositoAmount,0,1,@TaxDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxDeposito and Status = 2             

 		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
 	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

 		Select  @FundJournalPK,4,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@IncomeDepositoAmount,
    0,@IncomeDepositoAmount,1,0,@IncomeDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2

END
ELSE IF @ARInterestDepositoAmount > 0 and @PBreakInterestPercent = 0
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

    Select  @FundJournalPK,1,1,2,@IncomeDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'D',@ARInterestDepositoAmount,                   
	@ARInterestDepositoAmount,0,1,@ARInterestDepositoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeDeposito and Status = 2             

		INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
	,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                            

		Select  @FundJournalPK,2,1,2,@ARInterestDeposito,CurrencyPK,@PFundPK,@PInstrumentPK,0,'EARLY LIQUIDATE INTEREST: ' + @InstrumentID,'C',@ARInterestDepositoAmount,
    0,@ARInterestDepositoAmount,1,0,@ARInterestDepositoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ARInterestDeposito and Status = 2    

    

END
END
	

END  

-- A8. BUY MUTUAL FUND --                    
if @PTrxType = 1 and @PInstrumentTypePK in (6)                   
BEGIN    
	 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)    
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@PayablePurchaseAcc = PayablePurchaseProtectedFund, @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@PayablePurchaseAcc = PayablePurchasePrivateEquityFund  , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END
	 ELSE
	 BEGIN
	 	Select @InvestmentAcc = InvestmentMutualFund,@PayablePurchaseAcc = PayablePurchaseMutualFund , @CashForMutualFund = CashForMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK  
	 END					                      
                   
               

 -- Setup Account kelar diatas, Next masukin ke Fund Journal   
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
 -- T0                    
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T0 MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
   
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  
  
  
 -- T Settled                  
 select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
   
 INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
 ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
  
 Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
 @PReference,'T-Settled MUTUAL FUND BUY: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'D',@PDoneAmount,                     
 @PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                     
  
    
 INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
 ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
  
 Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-Settled MUTUAL FUND BUY: ' + @InstrumentID,'C',@PDoneAmount,                     
 0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                    
  
  
  
   
              
END                    
  -- A9.SELL MUTUAL FUND --  
ELSE if @PTrxType = 2 and @PInstrumentTypePK in (6)   
BEGIN               
 select @ReksadanaTypePK = ReksadanaTypePK from Instrument where InstrumentPK = @PInstrumentPK and status in (1,2)   
	 IF (@ReksadanaTypePK = 7) --PROTEKSI
	 BEGIN
		Select @InvestmentAcc = InvestmentProtectedFund,@ReceivableSaleAcc = AccountReceivableSaleProtectedFund , @CashForMutualFund = CashForMutualFund, @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellProtectedFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE IF (@ReksadanaTypePK = 6) --RDPT           
	 BEGIN
	 	Select @InvestmentAcc = InvestmentPrivateEquityFund,@ReceivableSaleAcc = AccountReceivableSalePrivateEquityFund, @CashForMutualFund = CashForMutualFund , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellPrivateEquityFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK      
	 END
	 ELSE
	 BEGIN
		Select @InvestmentAcc = InvestmentMutualFund,@ReceivableSaleAcc = AccountReceivableSaleMutualFund, @CashForMutualFund = CashForMutualFund  , @RealisedAcc = RealisedMutualFund,@InterestReceivableSellMutualFund =  InterestReceivableSellMutualFund
		From FundAccountingSetup where Status = 2 and FundPK = @PFundPK     
	 END			                
   
                                                     
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                  
  
  
-- T0                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                   
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T0 MUTUAL FUND SELL: '  + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2      

set @MInterestAmount = 0
select @BDate = DATEADD(m, DATEDIFF(m, 0, @ValueDate), 0)
select @MInterestAmount = (InterestPercent/100 * @PDoneVolume/365) * datediff(day,@BDate,@ValueDate) from ReksadanaInstrument where ReksadanaPK = @PInstrumentPK and status in (1,2)
select @MInterestAmount = isnull(@MInterestAmount,0)


IF (@MInterestAmount <> 0)
BEGIN
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,4,1,2,@InterestReceivableSellMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@MInterestAmount,                     
0,@MInterestAmount,1,0,@MInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestReceivableSellMutualFund and Status = 2                    
END               
			
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                              
set @AvgAmount = @SellAvgPrice * @PDoneVolume                
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount) 

  -- Gain Realised  
  if @AvgAmount <= @PDoneAmount                
  Begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@RealisedAmount,                     
  0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                    
  
  set  @InvestmentMutualFundAmount = @PDoneAmount - @RealisedAmount                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)   - isnull(@MInterestAmount,0)
  End         
       
  -- Loss Realised  
  if @AvgAmount > @PDoneAmount                
  begin                
  INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
  ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                    
  
  Select  @FundJournalPK,3,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'D',@RealisedAmount,                     
  @RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                   
      
  set  @InvestmentMutualFundAmount = @PDoneAmount + @RealisedAmount               
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  - isnull(@MInterestAmount,0)
  end                
  set @InvestmentMutualFundAmount = isnull(@InvestmentMutualFundAmount,0)  
 
 
    
        
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 MUTUAL FUND SELL: ' + @InstrumentID,'C',@InvestmentMutualFundAmount,                     
0,@InvestmentMutualFundAmount,1,0,@InvestmentMutualFundAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                    
  






-- T Settled         
           
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal   
  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                    
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                    
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                    
@PReference,'T-Settled MUTUAL FUND SELL: ' + @InstrumentID + ', PRICE : ' + convert(varchar,cast(@PDoneAmount/@PDoneVolume as money), 1) + ', VOLUME : ' + convert(varchar,cast(@PDoneVolume as money), 1) 
  
  ,1,@UsersID,@LastUpdate,@LastUpdate                                        
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select  @FundJournalPK,1,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'C',@PDoneAmount,                     
0,@PDoneAmount,1,0,@PDoneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                    
  
  
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                    
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                   
Select @FundJournalPK,2,1,2,@CashForMutualFund,CurrencyPK,@PFundPK,@PInstrumentPK,0,'TSETTLED MUTUAL FUND SELL: ' + @InstrumentID,'D',@PDoneAmount,                     
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashForMutualFund and Status = 2                  
  
  
  
END   


-- A10. BUY RIGHTS --   

Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2  
if @PTrxType = 1 and @PInstrumentTypePK = 4                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  

IF @InstrumentType in (1,4,16)                  
BEGIN                  
Select @InvestmentAcc = InvestmentRights,@PayablePurchaseAcc = PayablePurchaseRights
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK
END    
                            
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                 
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
set @FundJournalPK = isnull(@FundJournalPK,0)
-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference],[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1
,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK
,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',@PReference,'T0 RIGHTS BUY: ' + @InstrumentID 
,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PDoneAmount,                   
@PDoneAmount,0,1,@PDoneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2                  


select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK

IF (@WHTDueDate = 1)
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0) - isnull(@PWHTAmount,0)  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,6,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        

END
ELSE
BEGIN
    set @FPayablePurchaseAmount = @PDoneAmount + isnull(@PCommissionAmount,0) + isnull(@PLevyAmount,0) + isnull(@PKPEIAmount,0) + isnull(@PVATAmount,0)  --AURORA               
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

set @PLevyAmount = @PLevyAmount + @PKPeIAmount                

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PLevyAmount,                   
@PLevyAmount,0,1,@PLevyAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,5,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS BUY: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

             

-- T Settled  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   
                
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-Settled RIGHTS BUY: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

Select  @FundJournalPK,1,1,2,@PayablePurchaseAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'D',@FPayablePurchaseAmount,@FPayablePurchaseAmount,0,1,@FPayablePurchaseAmount,0,@LastUpdate   
From FundJournalAccount Where FundJournalAccountPK = @PayablePurchaseAcc and Status = 2                  



IF (@WHTDueDate = 1)
BEGIN

   INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount,                   
    0,@FPayablePurchaseAmount,1,0,@FPayablePurchaseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                        

END
ELSE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                 

    Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@FPayablePurchaseAmount - @PWHTAmount,                   
    0,@FPayablePurchaseAmount - @PWHTAmount,1,0,@FPayablePurchaseAmount - @PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  


    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS BUY: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2        
END





END   
               
-- A11. SELL RIGHTS --              

Select @PInstrumentTypePK =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2  
if @PTrxType = 2 and @PInstrumentTypePK = 4                  
BEGIN                  
Select @InstrumentType =  InstrumentTypePK From Instrument where InstrumentPK = @PInstrumentPK and Status = 2                  
IF @InstrumentType in (1,4,16)                  
BEGIN                 
Select @InvestmentAcc = InvestmentRights,@ReceivableSaleAcc = AccountReceivableSaleRights,@RealisedAcc = RealisedRights From FundAccountingSetup where Status = 2 and FundPK = @PFundPK                  
END                  
        
Select @CommissionAcc = BrokerCommission,@LevyAcc = BrokerLevy,@VatAcc = BrokerVat,@WhtAcc = WithHoldingTaxPPH23 
,@IncomeSaleTaxAcc = BrokerSalesTax
From FundAccountingSetup where Status = 2 and FundPK = @PFundPK    
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @PFundCashRefPK                  
Select @InstrumentID = ID From Instrument where Status = 2 and InstrumentPK = @PInstrumentPK                  

-- Setup Account kelar diatas, Next masukin ke Fund Journal                  
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

-- T0                  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]         
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PValueDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T0 RIGHTS SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@CommissionAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PCommissionAmount,                   
@PCommissionAmount,0,1,@PCommissionAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CommissionAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@LevyAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PLevyAmount + @PKPEIAmount,                   
@PLevyAmount + @PKPEIAmount,0,1,@PLevyAmount + @PKPEIAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @LevyAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@VatAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PVATAmount,                   
@PVATAmount,0,1,@PVATAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @VatAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,4,1,2,@IncomeSaleTaxAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@PIncomeTaxSellAmount,                   
@PIncomeTaxSellAmount,0,1,@PIncomeTaxSellAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @IncomeSaleTaxAcc and Status = 2                  

select @WHTDueDate = WHTDueDate from Fund where status = 2 and FundPK = @PFundPK             


    
IF (@WHTDueDate = 1)
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) + isnull(@PWHTAmount,0)            

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED EQUITY SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

END
ELSE
BEGIN
    Set @SellArAmount = @PDoneAmount -  isnull(@PCommissionAmount,0) - isnull(@PLevyAmount,0)- isnull(@PKPEIAmount,0) - isnull(@PVATAmount,0) - isnull(@PIncomeTaxSellAmount,0) --AURORA                   
END


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount,                   
@SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                   

           
	
select @SellAvgPrice = dbo.FGetLastAvgFromInvestment(@PValueDate,@PInstrumentPK,@PFundPK)                            
set @AvgAmount = @SellAvgPrice * @PDoneVolume              
set @RealisedAmount = abs(@AvgAmount - @PDoneAmount)      

      

-- Gain Realised
if @AvgAmount <= @PDoneAmount              
Begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'C',@RealisedAmount,                   
0,@RealisedAmount,1,0,@RealisedAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                  

set  @InvestmentShareAmount = @PDoneAmount - @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
End       
     
-- Loss Realised
if @AvgAmount > @PDoneAmount              
begin              
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,6,1,2,@RealisedAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'D',@RealisedAmount,                   
@RealisedAmount,0,1,@RealisedAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RealisedAcc and Status = 2                 
			 
set  @InvestmentShareAmount = @PDoneAmount + @RealisedAmount              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
end              
set @InvestmentShareAmount = isnull(@InvestmentShareAmount,0)
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,7,1,2,@InvestmentAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T0 RIGHTS SELL: ' + @InstrumentID,'C',@InvestmentShareAmount,                   
0,@InvestmentShareAmount,1,0,@InvestmentShareAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InvestmentAcc and Status = 2               

-- T SETTLED              
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PPeriodPK,@PSettlementDate,5,@maxEndDayTrailsPK,'TRANSACTION',                  
@PReference,'T-SETTLED RIGHTS SELL: ' + @InstrumentID ,0,@UsersID,@LastUpdate,@LastUpdate                  


IF (@WHTDueDate = 1) -- VALUEDATE
BEGIN
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount,                   
    @SellArAmount,0,1,@SellArAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
            

END    
ELSE
BEGIN
   
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@CashAtBankAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'D',@SellArAmount + @PWHTAmount,                   
    @SellArAmount + @PWHTAmount,0,1,@SellArAmount + @PWHTAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@ReceivableSaleAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@SellArAmount,                   
    0,@SellArAmount,1,0,@SellArAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ReceivableSaleAcc and Status = 2                      
             

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK],[FundClientPK]                  
    ,[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,3,1,2,@WhtAcc,CurrencyPK,@PFundPK,@PInstrumentPK,0,'T-SETTLED RIGHTS SELL: ' + @InstrumentID,'C',@PWHTAmount,                   
    0,@PWHTAmount,1,0,@PWHTAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @WhtAcc and Status = 2  

      
END  




END   

  
  

	           
Fetch next From A Into                  
@PValueDate,@PPeriodPK,@PReference,@PTrxType,@PCounterpartPK,@PInstrumentPK,@PFundPK,@PFundCashRefPK,                  
@PDoneAccruedInterest,@PSettlementDate,@PDoneVolume,@PAmount,@PDoneAmount,@PCommissionAmount,@PLevyAmount,@PKPEIAmount,                  
@PVATAmount,@PWHTAmount,@POTCAmount,@PIncomeTaxSellAmount,@PIncomeTaxInterestAmount,@PIncomeTaxGainAmount,@PTotalAmount,@PInstrumentTypePK,@PCurrencyRate,
@PBreakInterestPercent,@PSettlementPK,@PTaxExpensePercent,@PInterestPercent,@PAcqDate       
END                  
Close A                  
Deallocate A                
-------------------------------------------------------------------------------------------------------------------
-- B. DAILY FEE & PAYMENT FEE --

Declare @DecimalPlaces   int                  
Declare @RoundingMode   int                  
Declare @FundID     nvarchar(50)       
Declare @LastEndDayTrailsDate datetime       

Select @PeriodPK = PeriodPK From Period where @ValueDate Between DateFrom and DateTo  and status = 2                

Declare @ManagementFeeExpAcc    int                  
Declare @CustodianFeeExpAcc     int                  
Declare @AuditFeeExpAcc      int    
Declare @SinvestFeeExpAcc      int   
Declare @MovementFeeExpAcc    int                
Declare @PayableManagementFeeAcc   int                  
Declare @PayableCustodianFeeAcc    int                  
Declare @PayableAuditFeeAcc     int      
Declare @PayableSinvestFeeAcc     int
Declare @PayableMovementFeeAcc     int                
               
Declare @feeDays  int          
Declare @PayableSubscriptionFee int,@PayableRedemptionFee int
declare @BPayableSwitchingFee int
    

Select @feeDays =  DateDiff(day,ValueDate,@ValueDate),@LastEndDayTrailsDate = ValueDate From EndDayTrails          
Where ValueDate = 
(
Select Max(ValueDate) From EndDayTrails Where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK
)  and FundPK = @XFundPK           

set @feeDays = isnull(@feeDays,0)         

Declare @BFundPK int                  
Declare @BManagementFeePercent numeric(18,6)                  
Declare @BCustodiFeePercent  numeric(18,6)                  
Declare @BAuditFeePercent  numeric(18,6) 


Declare @BSinvestFeePercent  numeric(18,8) 

Declare @BManagementFeeDays  int                  
Declare @BCustodiFeeDays  int                  
Declare @BAuditFeeDays   int   
Declare @BSinvestFeeDays  int   
Declare @BFundType  int    
Declare @BBitSinvestFee  bit         

     

Declare @BDateOfPayment  int                  
Declare @BAum     numeric(22,8)                  
Declare @BManagementFeeAmount numeric(18,6)                  
Declare @BCustodiFeeAmount  numeric(18,6)                  
Declare @BAuditFeeAmount  numeric(18,6)   
Declare @BMovementFeeAmount  numeric(18,6)      

Declare @BSinvestFeeAmount  numeric(18,8)                  

Declare @BPayableSubscriptionFeeAmount numeric(18,6)
Declare @BPayableRedemptionFeeAmount numeric(18,6)
Declare @BPayableSwitchingFeeAmount numeric(18,6)

Declare @BOtherFeeOneAmount  numeric(18,6) 
Declare @BOtherFeeTwoAmount  numeric(18,6) 

Declare @BCBESTAmount  numeric(18,6) 
Declare @BCBESTEquityAmount  numeric(18,6) 
Declare @BCBESTCorpBondAmount  numeric(18,6) 
Declare @BCBESTGovBondAmount  numeric(18,6) 

Declare @BCBESTTrxEquity int
Declare @BCBESTTrxCorpBond int
Declare @BCBESTTrxGovBond int


Declare @BPayableOtherFeeOne  int    
Declare @BPayableOtherFeeTwo  int   
Declare @BOtherFeeOneExpense  int    
Declare @BOtherFeeTwoExpense  int 
Declare @BPayableCBEST  int    
Declare @BCBESTExpense  int 



Declare @FundFeeSetup Table
(
	FundPK int,
	MIFeePercent numeric(18,8)
)

insert into @FundFeeSetup
select FundPK,MiFeePercent from FundFeeSetup A
where A.Date = (
Select max(date) from FundFeeSetup B where B.date	<= @ValueDate     and B.status = 2 and A.FundPK = B.FundPK
) and A.status in (1,2) and A.FundPK = @XFundPK


insert into #ZFundFee
Select DateOfPayment,A.FundPK,D.MIFeePercent,CustodiFeePercent,
AuditFeeAmount,MovementFeeAmount, @BTotalDays,@BTotalDays,@BTotalDays,@BTotalDays,Type,B.BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount                  
From FundFee A
left join Fund B on A.FundPK = B.FundPK and B.Status = 2
left join @FundFeeSetup D on A.FundPK = D.FundPK
Where A.status = 2 and A.Date = (
Select max(date) from FundFee C where C.date	<= @ValueDate     and C.status = 2 and A.FundPK = C.FundPK
) and A.FundPK = @XFundPK


Declare B Cursor For                  
Select FundPK,ManagementFeePercent ,CustodiFeePercent ,
 AuditFeeAmount,MovementFeeAmount, ManagementFeeDays ,CustodiFeeDays,AuditFeeDays,SInvestFeeDays,DateOfPayment,FundType,BitSinvestFee,OtherFeeOneAmount,OtherFeeTwoAmount   from #ZFundFee where FundPK = @XFundPK
Open B                  
Fetch Next From B                  
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount, @BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount                   
While @@FETCH_STATUS = 0                  
Begin                  
Select @ManagementFeeExpAcc = ManagementFeeExpense, @CustodianFeeExpAcc =CustodianFeeExpense , @AuditFeeExpAcc = AuditFeeExpense,@MovementFeeExpAcc = MovementFeeExpense,                  
@PayableManagementFeeAcc = PayableManagementFee,@PayableCustodianFeeAcc = PayableCustodianFee,@PayableAuditFeeAcc = PayableAuditFee,@PayableMovementFeeAcc = PayableMovementFee    
,@PayableSubscriptionFee = PayableSubscriptionFee,@PayableRedemptionFee = PayableRedemptionFee 
,@BPayableSwitchingFee = PayableSwitchingFee,@PayableSinvestFeeAcc = PayableSInvestFee, @SinvestFeeExpAcc = SInvestFee
,@BPayableOtherFeeOne = PayableOtherFeeOne, @BPayableOtherFeeTwo = PayableOtherFeeTwo,@BOtherFeeOneExpense = OtherFeeOneExpense, @BOtherFeeTwoExpense = OtherFeeTwoExpense             
From FundAccountingSetup Where Status = 2    and FundPK = @BFundPK    

-- B1. GENERATE DAILY FEE                  
set @BAum = 0


Select @BAum =  AUM From CloseNAV where Date = @DateYesterday and Status =  2 and FundPK = @BFundPK                  
Select @DecimalPlaces = JournalDecimalPlaces, @RoundingMode = JournalRoundingMode, @FundID = A.ID From Fund A 
left join BankBranch B on A.BankBranchPK = B.BankBranchPK and B.status = 2
left join Bank C on B.BankPK = C.BankPK and C.status = 2
where A.Status = 2 and A.FundPK = @BFundPK             


--1	STRUCTURED FUND : GUARANTEED FUND ok
--2	FIXED INCOME FUND ok
--3	MONEY MARKET FUND ok
--4	STRUCTURED FUND : CAPITAL PROTECTED FUND ok
--5	EQUITY FUND ok
--6	STRUCTURED FUND : INDEX FUND ok
--7	CIC ASSET BACKED SECURITIES ok
--8	DISCETIONARY FUND ok
--9	MIXED ASSET FUND ok
--10 EXCHANGE TRADED FUND ok
--11 REAL ESTATE INVESTMENT TRUST ok
--12 PRIVATE EQUITY FUND ok

Select @BSinvestFeeDays = SinvestFeeDays from SInvestSetup where status = 2

IF (@BFundType in (1,3,4,6,8,11,12))
BEGIN
	Select @BSinvestFeePercent = SinvestMoneyMarketFeePercent from SInvestSetup where status = 2
END
ELSE IF (@BFundType in (2,7,9))
BEGIN
	Select @BSinvestFeePercent = SinvestBondFeePercent from SInvestSetup where status = 2
END
ELSE
BEGIN
	Select @BSinvestFeePercent = SinvestEquityFeePercent from SInvestSetup where status = 2
END



-- 1 = UP, 2 = DOWN , 3 = NONE                  	
If @RoundingMode = 1                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(CEILING((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0) * @FeeDays                      
Set @BCustodiFeeAmount = isnull(CEILING((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0)  * @FeeDays  
Set @BSinvestFeeAmount = isnull(CEILING((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(CEILING(@BAuditFeeAmount),0)  * @FeeDays  
Set @BMovementFeeAmount = isnull(CEILING(@BMovementFeeAmount),0)  * @FeeDays   
Set @BOtherFeeOneAmount = isnull(CEILING(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(CEILING(@BOtherFeeTwoAmount),0)  * @FeeDays                
END                  

If @RoundingMode = 2                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(FLOOR((@BAum * (@BManagementFeePercent/100))/ @BManagementFeeDays),0)  * @FeeDays                    
Set @BCustodiFeeAmount = isnull(FLOOR((@BAum * (@BCustodiFeePercent/100))/ @BCustodiFeeDays),0) * @FeeDays 
Set @BSinvestFeeAmount = isnull(FLOOR((@BAum * (@BSinvestFeePercent/100))/ @BSinvestFeeDays),0)  * @FeeDays  
END
Set @BAuditFeeAmount = isnull(FLOOR(@BAuditFeeAmount),0)  * @FeeDays 
Set @BMovementFeeAmount = isnull(FLOOR(@BMovementFeeAmount),0)  * @FeeDays  
Set @BOtherFeeOneAmount = isnull(FLOOR(@BOtherFeeOneAmount),0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(FLOOR(@BOtherFeeTwoAmount),0)  * @FeeDays               
END                  

If @RoundingMode = 3                      
BEGIN                    
IF @BAum > 0 and ((@BManagementFeePercent > 0 and @BManagementFeeDays >0) or (@BCustodiFeePercent > 0 and @BCustodiFeeDays >0) or (@BSinvestFeePercent > 0 and @BSinvestFeeDays >0))
BEGIN
Set @BManagementFeeAmount = isnull(ROUND((@BAum * (@BManagementFeePercent/100))/@BManagementFeeDays,@DecimalPlaces),0)  * @FeeDays                 
Set @BCustodiFeeAmount = isnull(ROUND((@BAum * (@BCustodiFeePercent/100))/@BCustodiFeeDays,@DecimalPlaces),0)    * @FeeDays   
Set @BSinvestFeeAmount = isnull(ROUND((@BAum * (@BSinvestFeePercent/100))/@BSinvestFeeDays,@DecimalPlaces),0)  * @FeeDays
END
Set @BAuditFeeAmount = isnull(@BAuditFeeAmount,0)  * @FeeDays    
Set @BMovementFeeAmount = isnull(@BMovementFeeAmount,0)  * @FeeDays      
Set @BOtherFeeOneAmount = isnull(@BOtherFeeOneAmount,0)  * @FeeDays  
Set @BOtherFeeTwoAmount = isnull(@BOtherFeeTwoAmount,0)  * @FeeDays       
END                  





if isnull(@BAum,0) = 0
begin
set @BManagementFeeAmount = 0
set @BCustodiFeeAmount = 0
set @BAuditFeeAmount = 0
set @BMovementFeeAmount = 0
set @BSinvestFeeAmount = 0
set @BOtherFeeOneAmount = 0
set @BOtherFeeTwoAmount = 0
end




-- Setup Account kelar diatas, Next masukin ke Fund Journal  
if @BManagementFeeAmount > 0 or @BCustodiFeeAmount > 0 or @BAuditFeeAmount > 0
BEGIN
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'DAILY FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
END    

if @BManagementFeeAmount > 0
BEGIN
		
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@ManagementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @ManagementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                  

END

if @BCustodiFeeAmount > 0
BEGIN

	
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@CustodianFeeExpAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CustodianFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,4,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'CUSTODI FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2       

END
  
if @BAuditFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,5,1,2,@AuditFeeExpAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'D',@BAuditFeeAmount,                   
@BAuditFeeAmount,0,1,@BAuditFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @AuditFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,6,1,2,@PayableAuditFeeAcc,CurrencyPK,@BFundPK,0,0,'AUDIT FEE FUND ID: ' + @FundID,'C',@BAuditFeeAmount,                   
0,@BAuditFeeAmount,1,0,@BAuditFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableAuditFeeAcc and Status = 2                  
		
END

IF (@BBitSInvestFee = 1)
BEGIN

    if @BSinvestFeeAmount > 0
    BEGIN

	
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,7,1,2,@SinvestFeeExpAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
    @BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SinvestFeeExpAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
    ,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,8,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'SINVEST FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
    0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2       

    END
END


if @BMovementFeeAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,9,1,2,@MovementFeeExpAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'D',@BMovementFeeAmount,                   
@BMovementFeeAmount,0,1,@BMovementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @MovementFeeExpAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,10,1,2,@PayableMovementFeeAcc,CurrencyPK,@BFundPK,0,0,'MOVEMENT FEE FUND ID: ' + @FundID,'C',@BMovementFeeAmount,                   
0,@BMovementFeeAmount,1,0,@BMovementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableMovementFeeAcc and Status = 2                  
		
END


if @BOtherFeeOneAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,11,1,2,@BOtherFeeOneExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeOneAmount,                   
@BOtherFeeOneAmount,0,1,@BOtherFeeOneAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeOneExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,12,1,2,@BPayableOtherFeeOne,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeOneAmount,                   
0,@BOtherFeeOneAmount,1,0,@BOtherFeeOneAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeOne and Status = 2                  
		
END


if @BOtherFeeTwoAmount > 0
BEGIN         
INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,13,1,2,@BOtherFeeTwoExpense,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'D',@BOtherFeeTwoAmount,                   
@BOtherFeeTwoAmount,0,1,@BOtherFeeTwoAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BOtherFeeTwoExpense and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,14,1,2,@BPayableOtherFeeTwo,CurrencyPK,@BFundPK,0,0,'OTHER FEE FUND ID: ' + @FundID,'C',@BOtherFeeTwoAmount,                   
0,@BOtherFeeTwoAmount,1,0,@BOtherFeeTwoAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableOtherFeeTwo and Status = 2                  
		
END

	            

---------------- TINGGAL TEST SUDAH TAMBAH PAYABLE SUBS DAN REDEMPT FEE
-- B2. GENERATE PAYMENT FEE

Declare @EOMonthForFee datetime
Select @CashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @BFundPK
if(@BDateOfPayment = day(@ValueDate) or (@BDateOfPayment >= day(@LastEndDayTrailsDate) and @BDateOfPayment <= day(@ValueDate)))
BEGIN
Declare @BManagementFeeAmountCheck numeric(22,4)
Declare @BCustodiFeeAmountCheck numeric(22,4)
Declare @BSinvestFeeAmountCheck numeric(22,4)
Declare @BPayableRedemptionFeeAmountCheck numeric(22,4)
Declare @BPayableSubscriptionFeeAmountCheck numeric(22,4)
Declare @BPayableSwitchingFeeAmountCheck numeric(22,4)

set @EOMonthForFee = dateadd(month,-1,@ValueDate)
set @EOMonthForFee = EOMONTH (@EOMonthForFee)
	
set @BManagementFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmount = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@EOMonthForFee,@BPayableSwitchingFee,@BFundPK)

set @BManagementFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableManagementFeeAcc,@BFundPK)
set @BCustodiFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableCustodianFeeAcc,@BFundPK)
set @BSinvestFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSinvestFeeAcc,@BFundPK)

set @BPayableRedemptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableRedemptionFee,@BFundPK)
set @BPayableSubscriptionFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@PayableSubscriptionFee,@BFundPK)
set @BPayableSwitchingFeeAmountCheck = [dbo].[FGetAccountFundJournalBalanceByFundPK] (@ValueDate,@BPayableSwitchingFee,@BFundPK)

Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 
			                    
if @BManagementFeeAmount > 0  or @BCustodiFeeAmount > 0 or @BSinvestFeeAmount > 0 or @BPayableRedemptionFeeAmount > 0   or  
@BPayableSubscriptionFeeAmount > 0  or 
@BPayableSwitchingFeeAmount > 0   
Begin                                    
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  
                      
Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'PAYMENT FEE',                  
'','FUND ID: ' + @FundID ,1,@UsersID,@LastUpdate,@LastUpdate                  
                        
if @BManagementFeeAmount > 0  and @BManagementFeeAmount < @BManagementFeeAmountCheck                
Begin                       
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,1,1,2,@PayableManagementFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'D',@BManagementFeeAmount,                   
		@BManagementFeeAmount,0,1,@BManagementFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableManagementFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,2,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT MANAGEMENT FEE FUND ID: ' + @FundID,'C',@BManagementFeeAmount,                   
		0,@BManagementFeeAmount,1,0,@BManagementFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
end                  
if @BCustodiFeeAmount > 0  and @BCustodiFeeAmount < @BCustodiFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,3,1,2,@PayableCustodianFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'D',@BCustodiFeeAmount,                   
		@BCustodiFeeAmount,0,1,@BCustodiFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableCustodianFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,4,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BCustodiFeeAmount,                   
		0,@BCustodiFeeAmount,1,0,@BCustodiFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BSinvestFeeAmount > 0  and @BSinvestFeeAmount < @BSinvestFeeAmountCheck                
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,5,1,2,@PayableSinvestFeeAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT SINVEST FEE FUND ID: ' + @FundID,'D',@BSinvestFeeAmount,                   
		@BSinvestFeeAmount,0,1,@BSinvestFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSinvestFeeAcc and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,6,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT CUSTODIAN FEE FUND ID: ' + @FundID,'C',@BSinvestFeeAmount,                   
		0,@BSinvestFeeAmount,1,0,@BSinvestFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableRedemptionFeeAmount > 0   and @BPayableRedemptionFeeAmount < @BPayableRedemptionFeeAmountCheck               
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,7,1,2,@PayableRedemptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'D',@BPayableRedemptionFeeAmount,                   
		@BPayableRedemptionFeeAmount,0,1,@BPayableRedemptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableRedemptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,8,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP REDEMPTION FEE FUND ID: ' + @FundID,'C',@BPayableRedemptionFeeAmount,                   
		0,@BPayableRedemptionFeeAmount,1,0,@BPayableRedemptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSubscriptionFeeAmount > 0        and @BPayableSubscriptionFeeAmount < @BPayableSubscriptionFeeAmountCheck           
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,9,1,2,@PayableSubscriptionFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSubscriptionFeeAmount,                					@BPayableSubscriptionFeeAmount,0,1,@BPayableSubscriptionFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @PayableSubscriptionFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,10,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSubscriptionFeeAmount,                   
		0,@BPayableSubscriptionFeeAmount,1,0,@BPayableSubscriptionFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

if @BPayableSwitchingFeeAmount > 0    and @BPayableSwitchingFeeAmount < @BPayableSwitchingFeeAmountCheck              
Begin                            
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                      
		Select  @FundJournalPK,11,1,2,@BPayableSwitchingFee,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'D',@BPayableSwitchingFeeAmount,                					@BPayableSwitchingFeeAmount,0,1,@BPayableSwitchingFeeAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @BPayableSwitchingFee and Status = 2                   
                  
	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  
                  
		Select @FundJournalPK,12,1,2,@CashAtBankAcc,CurrencyPK,@BFundPK,0,0,'PAYMENT AP SUBSCRIPTION FEE FUND ID: ' + @FundID,'C',@BPayableSwitchingFeeAmount,                   
		0,@BPayableSwitchingFeeAmount,1,0,@BPayableSwitchingFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @CashAtBankAcc and Status = 2                  
End 

End

END

Fetch next From B   
Into @BFundPK,@BManagementFeePercent,@BCustodiFeePercent,
@BAuditFeeAmount,@BMovementFeeAmount,@BManagementFeeDays,@BCustodiFeeDays,@BAuditFeeDays,@BSInvestFeeDays,@BDateOfPayment,@BFundType,@BBitSinvestFee,@BOtherFeeOneAmount,@BOtherFeeTwoAmount
                     
End                  
Close B                  
Deallocate B    
---------------------------------------------------------------------------------------------------------------------------
 -- B3. BANK INTEREST


declare @EFundPK int
declare @EFundID nvarchar(50)
declare @ECashAcc int
declare @EInterestPercent numeric (18,6)
declare @EInterestDays numeric (22,6)
declare @EBalance numeric (22,6)
declare @EMinimumBalance numeric (18,6)
declare @EBankInterestAmount numeric (22,6)
declare @EBankInterestAcc int
declare @EBankInterestIncomeAcc int

--declare @DateYesterDay datetime
--set @DateYesterDay = dbo.FWorkingDay(@ValueDate, - 1)

DECLARE E CURSOR FOR 
Select FundPK,ID From Fund where status in (1,2) and FundPK = @XFundPK
        	
Open E
Fetch Next From E
Into @EFundPK,@EFundID
        
While @@FETCH_STATUS = 0
BEGIN  
    set @EBankInterestAmount = 0

    IF EXISTS(select * from BankInterestSetup A left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
    where A.status in (1,2) and B.FundPK = @EFundPK)
    BEGIN
        DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and B.FundPK = @EFundPK and Date <= @ValueDate
        )
        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
			    set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END
	ELSE
	BEGIN
		DECLARE F CURSOR FOR 
        select MinimumBalance,InterestPercent,InterestDays from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date = (
        Select max(date) from BankInterestSetup A 
		left join Fund B on A.BankBranchPK = B.BankBranchPK and B.status in (1,2)
        where A.status in (1,2) and A.BankBranchPK = 0 and Date <= @ValueDate
        )

        	
        Open F
        Fetch Next From F
        Into @EMinimumBalance,@EInterestPercent,@EInterestDays
        
        While @@FETCH_STATUS = 0
        BEGIN  
			select @ECashAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @EFundPK and Type = 3
			select @EBalance = dbo.FGetAccountFundJournalBalanceByFundPK(@DateYesterday,@ECashAcc,@EFundPK)

			IF(@EBalance >= @EMinimumBalance)
			BEGIN
				set @EBankInterestAmount =  isnull((@EBalance * (@EInterestPercent/100))/ @EInterestDays * @FeeDays,0) 
			END
			ELSE
			BEGIN 
				set @EBankInterestAmount = 0
			END
				
			--select @EFundPK,@EBalance,@EInterestPercent,@EInterestDays

		Fetch next From F Into @EMinimumBalance,@EInterestPercent,@EInterestDays
		END
		Close F
		Deallocate F 
	END


	
	-- Setup Account kelar diatas, Next masukin ke Fund Journal  
	if @EBankInterestAmount > 0
	BEGIN
	select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

	INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
	,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                 

	Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,6,@maxEndDayTrailsPK,'BANK DAILY INTEREST',                  
	'','FUND ID: ' + @EFundID,1,@UsersID,@LastUpdate,@LastUpdate                  
	END    

	if @EBankInterestAmount > 0
	BEGIN
		
		select @EBankInterestAcc = InterestAccrGiro,@EBankInterestIncomeAcc = IncomeInterestGiro from FundAccountingSetup where FundPK = @EFundPK and status in (1,2)

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select  @FundJournalPK,1,1,2,@EBankInterestAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'D',@EBankInterestAmount,                   
	@EBankInterestAmount,0,1,@EBankInterestAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestAcc and Status = 2                   

	INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[FundClientPK]                  
	,[InstrumentPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

	Select @FundJournalPK,2,1,2,@EBankInterestIncomeAcc,CurrencyPK,@EFundPK,0,0,'BANK DAILY INTEREST FUND ID: ' + @EFundID,'C',@EBankInterestAmount,                   
	0,@EBankInterestAmount,1,0,@EBankInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @EBankInterestIncomeAcc and Status = 2                  

	END


	
Fetch next From E Into @EFundPK,@EFundID
END
Close E
Deallocate E 

---------------------------------------------------------------------------------------------------------------------------

-- C. REVAL,GENERATE BOND,DEPOSITO ACCRUED  --             

declare @RevalEquity int
declare @InvestEquity int
declare @RevalBond int
declare @InvestBond int
declare @MarketValue numeric(22,6)   
declare @PrevMarketValue numeric(22,6) 

Declare @RevaluationAcc    int                  
Declare @UnrealisedAcc    int                  
Declare @FInstrumentPK    int         
Declare @FInstrumentID    nvarchar(100)                  
Declare @FFundPK     int                  
Declare @FTrxAmount     numeric(22,6)                  
Declare @FMarketValue    numeric(22,6)                  
Declare @FInstrumentTypePK   int                  
Declare @FCurrencyPK    int                  
Declare @FPrevRevaluationAmount  numeric(22,6)                  
Declare @FFinalAmount    numeric(22,6)                  
Declare @FLastCouponDate   datetime                  
Declare @FInterestAmount   numeric(18,6)                  
Declare @FBalance     numeric(18,0)                  
Declare @FTaxExpenseAmount   numeric(18,6)                  
Declare @FTaxExpensePercent   numeric(18,8)                  
Declare @FAcqDate   datetime                                  
Declare @FMaturityDate  datetime  
Declare @FSell   int 
Declare @FBuy   int 
Declare @FDoneAmount    numeric(22,6) 
Declare @FInterestDaysType int
Declare @FInterestPaymentType int
Declare @FInterestPercent numeric(18,8)
Declare @FPaymentModeOnMaturity int
Declare @FReksadanaTypePK int


--Select TaxExpensePercent,* from instrument where instrumentTYpePK in(2,3,15)
--update instrument set TaxExpensePercent = 5 where instrumentTYpePK in(2,3,15)

Declare D Cursor For   


    Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16) and FundPK = @XFundPK
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK  


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16)  and FundPK = @XFundPK
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and valuedate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2  and FundPK = @XFundPK and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate and C.FundPK = @XFundPK)

    and B.InstrumentTypePK in (1,2,3,4,8,9,13,14,15,16) and FundPK = @XFundPK
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 

-- REKSADANA
union all

	Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0,isnull(B.ReksadanaTypePK,0)                  
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (6) and FundPK = @XFundPK
    and NOT EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL

   Select A.InstrumentPK,A.FundPK
    ,sum(A.CostValue) CostValue -- isnull(C.CostValueSell,0)
    ,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1,isnull(B.ReksadanaTypePK,0)              
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
    ) 
    and B.InstrumentTypePK in (6) and FundPK = @XFundPK 
    and  EXISTS 
    (  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and statussettlement  = 2 and SettlementDate = @valuedate and C.FundPK = @XFundPK)
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK


    UNION ALL
    Select A.InstrumentPK,A.FundPK,sum(A.CostValue) CostValue,sum(A.MarketValue) MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)  Balance                  
    ,B.TaxExpensePercent, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 ,isnull(B.ReksadanaTypePK,0)               
    From FundPosition A                 
    Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
    where A.status = 2 and TrailsPK = 
    (              
    Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and FundPK = @XFundPK and 
    ValueDate =  (select max(ValueDate) From EndDayTrailsFundPortfolio where ValueDate < @ValueDate and status = 2 and FundPK = @XFundPK)
    ) 

    and NOT EXISTS 
    (  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and status  = 2 and date = @ValueDate and C.FundPK = @XFundPK)

    and B.InstrumentTypePK in (6) and FundPK = @XFundPK
    group by A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,B.TaxExpensePercent, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,B.ReksadanaTypePK 




Open D                  
Fetch Next From D                  
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance
,@FTaxExpensePercent,@FMaturityDate,@FSell,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent ,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK    
While @@FETCH_STATUS = 0                  
Begin                  
    -- C1. REVALUATION EQUITY & BOND --

    select @RevalEquity = RevaluationEquity,@InvestEquity = InvestmentEquity,@RevalBond = RevaluationBond,@InvestBond = InvestmentBond from FundAccountingSetup where status = 2 and fundPK = @FFundPK
    IF(@RevalEquity = @InvestEquity) OR (@RevalBond = @InvestBond)
    BEGIN
	    IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK  
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2  and fundPK = @FFundPK   


            IF (@FBuy = 1)
            BEGIN

                --select @MarketValue =  dbo.FGetLastVolumeInv(@valuedate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                --select @PrevMarketValue = dbo.FGetLastVolumeInv(dbo.FWorkingDay(@valuedate,-1),@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.FWorkingDay(@valuedate,-1),@FInstrumentPK,@FFundPK)/100)     
                --select @FDoneAmount = dbo.FGetDoneAmountInv(@valuedate,@FFundPK,@FInstrumentPK)
                --set @FFinalAmount = @MarketValue - (@PrevMarketValue + @FDoneAmount) 
                
                
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 


            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * (dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)/100)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * (dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK)/100) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue  
				   
            END
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2  and fundPK = @FFundPK

            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END  

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    
	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END


            IF (@FBuy = 1)
            BEGIN
                select @MarketValue =  dbo.FGetUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)
                select @PrevMarketValue = dbo.FGetPrevUnrealisedInv(@valuedate,@FFundPK,@FInstrumentPK)

                set @FFinalAmount = @MarketValue -@PrevMarketValue 
            END
            ELSE IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(sum(@FMarketValue - @FTrxAmount),0)
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)

            END
            ELSE
            BEGIN
                select @MarketValue =  dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK)   * dbo.FGetLastClosePriceFromFundPosition(@ValueDate,@FInstrumentPK,@FFundPK)           
                select @PrevMarketValue = dbo.FGetLastVolumeInv(@ValueDate,@FFundPK,@FInstrumentPK) * dbo.FGetLastClosePriceFromFundPosition(dbo.Fworkingday(@ValueDate,-1),@FInstrumentPK,@FFundPK) 
                set @FFinalAmount = @MarketValue - @PrevMarketValue 
				    
            END  
        END   


    END
    ELSE
    BEGIN
        IF @FInstrumentTypePK in (2,3,8,9,11,13,14,15) -- GBOND,CBOND,SUKUK
        BEGIN     
            Select @RevaluationAcc = RevaluationBond From FundAccountingSetup where Status = 2    and fundPK = @FFundPK
            Select @UnrealisedAcc = UnrealisedBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @InterestRecAcc = InterestAccrBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @TaxExpenseAcc = TaxExpenseInterestIncomeBond From FundAccountingSetup where Status = 2   and fundPK = @FFundPK      
        END    
   
        ELSE IF @FInstrumentTypePK in (1,4,16)    
        BEGIN    
            Select @RevaluationAcc = RevaluationEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            Select @UnrealisedAcc = UnrealisedEquity From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
        END    

        ELSE IF @FInstrumentTypePK in (6)    
        BEGIN    

	        IF (@FReksadanaTypePK = 7) --PROTEKSI
	        BEGIN
                Select @RevaluationAcc = RevaluationProtectedFund,@UnrealisedAcc = UnrealisedProtectedFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE IF (@FReksadanaTypePK = 6)
            BEGIN
                Select @RevaluationAcc = RevaluationPrivateEquityFund,@UnrealisedAcc = UnrealisedPrivateEquityFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END
            ELSE
            BEGIN
                Select @RevaluationAcc = RevaluationMutualFund,@UnrealisedAcc = UnrealisedMutualFund From FundAccountingSetup where Status = 2   and fundPK = @FFundPK 
            END

        END   

        IF @FInstrumentTypePK in(1,2,3,4,6,8,9,13,14,15,16)    
        BEGIN  
            IF (@FSell  = 1)
            BEGIN
                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FPrevRevaluationAmount * -1,0)
				
            END
            ELSE
            BEGIN

                select @FPrevRevaluationAmount = isnull(dbo.[FGetAccountBalanceFundJournalByDateByFundPKByInstrumentPK](@ValueDate,@RevaluationAcc,@FInstrumentPK,@FFundPK),0)    
                Set @FFinalAmount = isnull(@FMarketValue,0) - isnull(@FTrxAmount,0) - @FPrevRevaluationAmount 
			
            END
        END
   
    END






	IF Exists(              
    Select * from ClosePrice where Status = 2 and date = @ValueDate              
    )  
    BEGIN
        IF isnull(@FFinalAmount,0) > 0 --Nilai Revaluasi Acc di Debit    
        BEGIN    
        -- Setup Account kelar diatas, Next masukin ke Fund Journal  
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal     
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)  


        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
    
        Select @FundJournalPK,2,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2        
        END  

        IF isnull(@FFinalAmount,0) < 0    
        BEGIN  
        -- Setup Account kelar diatas, Next masukin ke Fund Journal    
        Select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    
        set @FFinalAmount = isnull(ABS(@FFinalAmount),0)    
        
        INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]    
        ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])    
        
        Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,5,@maxEndDayTrailsPK,'PORTFOLIO REVALUATION',    
        '','INSTRUMENT: ' + @FInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate    
           
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])        
            
        Select  @FundJournalPK,1,1,2,@UnrealisedAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'D',@FFinalAmount,     
        @FFinalAmount,0,1,@FFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @UnrealisedAcc and Status = 2     
    
        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]    
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])     
        
        Select @FundJournalPK,2,1,2,@RevaluationAcc,CurrencyPK,@FFundPK,@FInstrumentPK,0,'INSTRUMENT: ' + @FInstrumentID,'C',@FFinalAmount,     
        0,@FFinalAmount,1,0,@FFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @RevaluationAcc and Status = 2    
        END  
    END  	 







	    
Fetch next From D                   
Into @FInstrumentPK,@FFundPK,@FTrxAmount,@FMarketValue,@FInstrumentTypePK,@FCurrencyPK,@FInstrumentID,@FLastCouponDate,@FBalance,@FTaxExpensePercent,@FMaturityDate,@FSell    
,@FInterestDaysType,@FInterestPaymentType,@FInterestPercent,@FPaymentModeOnMaturity,@FBuy, @FReksadanaTypePK   
END        
Close D                  
Deallocate D

--AAAAAAAA


Declare @IncDays int            
Declare @CInstrumentPK    int         
Declare @CInstrumentID    nvarchar(100)                  
Declare @CFundPK     int                  
Declare @CTrxAmount     numeric(22,6)                  
Declare @CMarketValue    numeric(22,6)                  
Declare @CInstrumentTypePK   int                  
Declare @CCurrencyPK    int                  
Declare @CPrevRevaluationAmount  numeric(22,6)                  
Declare @CFinalAmount    numeric(22,6)                  
Declare @CLastCouponDate   datetime                  
Declare @CInterestAmount   numeric(18,6)                  
Declare @CBalance     numeric(18,0)                  
Declare @CTaxExpenseAmount   numeric(18,6)                  
Declare @CTaxExpensePercent   numeric(18,8)                  
Declare @CAcqDate   datetime                  
Declare @InterestIncometAcc   int                  
Declare @CMaturityDate  datetime  
Declare @CSell   int
Declare @CRoll   int  
Declare @FundTypeInternal int
Declare @KPDTaxPercent numeric(18,2)


declare @CPaymentDays int
declare @CHoldDays int
declare @CPrevHoldDays int
declare @CGrossInterestAmountRound numeric(19,2)
declare @CPrevGrossInterestAmountRound numeric(19,2)
declare @CLastGrossInterestAmountRound numeric(19,2)
declare @CLastPrevGrossInterestAmountRound numeric(19,2)
declare @CGrossInterestAmount numeric(19,2)
declare @CPrevGrossInterestAmount numeric(19,2)
declare @CTaxGrossInterestAmount numeric(19,2)
declare @CPrevTaxGrossInterestAmount numeric(19,2)
declare @CGrossInterestAmountA numeric(19,2)


declare @CNetInterestAmount numeric(19,2)
declare @CPrevNetInterestAmount numeric(19,2)
declare @CTaxNetInterestAmount numeric(19,2)
declare @CPrevTaxNetInterestAmount numeric(19,2)

declare @CGrossDaily numeric(19,2)
declare @CTaxDaily numeric(19,2)
declare @CDivDays int
declare @CLastAcqDays int
declare @CLastPrevAcqDays int
declare @CAcqDays int
declare @CPrevAcqDays int
declare @CDivGrossInterestAmount numeric(19,2)
declare @CPrevDivGrossInterestAmount numeric(19,2)
declare @CInterestDays int

Declare @CInterestDaysType int
Declare @CInterestPaymentType int
Declare @CInterestPercent numeric(18,8)
Declare @CPaymentModeOnMaturity int
declare @ZValueDate datetime

Declare C Cursor For   
 
  Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
)
and B.InstrumentTypePK <> 5 and FundPK = @XFundPK

and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and C.StatusSettlement  = 2 and @ValueDate <= SettlementDate and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity
 
UNION ALL

--JUAL BOND MASIH BELUM SETTLED

Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and B.InstrumentTypePK <> 5 and FundPK = @XFundPK
and EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and StatusSettlement  = 2 and TrxType = 2 and @ValueDate between ValueDate and SettlementDate   and A.[Identity] = C.TrxBuy and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
UNION ALL

-- MATURE DIHITUNG

Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      

where A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@ValueDate,-1) and FundPK = @XFundPK
)
and B.InstrumentTypePK not in (1,5) and FundPK = @XFundPK
and   EXISTS 
(  SELECT * FROM FundPosition C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK  and Status  = 2 and MaturityDate = @ValueDate and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent, A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

 
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
)
and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
and A.AcqDate not in (
select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.statussettlement = 2 and D.FundPK = @XFundPK)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity





--MATURE INTEREST WEEKEND
UNION ALL       
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) 
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1) and FundPK = @XFundPK
)
and A.MaturityDate <= @valuedate and B.InstrumentTypePK = 5 and FundPK = @XFundPK

and  NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity


--ROLLOVER INTEREST WEEKEND
UNION ALL
              
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,0 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,1 Roll              
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @ValueDate and FundPK = @XFundPK
)
and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
and A.AcqDate  in (
select D.valuedate from investment D where D.valuedate between @DateYesterday and @valuedate and D.valuedate <> @DateYesterday  and D.FundPK = A.FundPK and D.FundPK = @XFundPK)
and NOT EXISTS 
(  SELECT * FROM Investment C WHERE A.InstrumentPK = C.InstrumentPK AND A.FundPK = C.FundPK and A.AcqDate = C.AcqDate and StatusSettlement  = 2 and ValueDate = @ValueDate and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity

UNION ALL

-- JUAL H+1 HARI LIBUR
Select A.InstrumentPK,A.FundPK
,sum(A.CostValue) -- isnull(C.CostValueSell,0)
,sum(A.MarketValue),B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),sum(A.Balance)                   
,A.TaxExpensePercent, A.AcqDate AcqDate, A.MaturityDate,1 Sell,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity,0 Roll             
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2      
where  A.status = 2 and TrailsPK = 
(              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = dbo.FWorkingDay(@valuedate,-1)  and FundPK = @XFundPK
)
and A.MaturityDate > @ValueDate and B.InstrumentTypePK = 5 and FundPK = @XFundPK
and exists (
select * from investment C where TrxType = 2 and valuedate = @valuedate and A.InstrumentPK = C.InstrumentPK and A.AcqDate = C.AcqDate  and C.FundPK = A.FundPK  and C.statussettlement = 2 and C.FundPK = @XFundPK)
Group By A.InstrumentPK,A.FundPK,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,A.TaxExpensePercent,A.AcqDate, A.MaturityDate,A.InterestDaysType,A.InterestPaymentType,A.InterestPercent,A.PaymentModeOnMaturity




Open C                  
Fetch Next From C                  
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance
,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent ,@CPaymentModeOnMaturity,@CRoll     
While @@FETCH_STATUS = 0                  
Begin              

  
-- C2. GENERATE INTEREST ACCRUED BOND                  

IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)             
BEGIN                  
Select @InterestRecAcc = InterestAccrBond
,@TaxExpenseAcc = TaxExpenseInterestIncomeBond,@InterestIncometAcc = IncomeInterestBond
From FundAccountingSetup where Status = 2  and FundPK = @CFundPK                  
END                  

IF @CInstrumentTypePK = 5 -- NCD INTEREST BLOM TAU GIMANA PAS MATURED
BEGIN                  
Select @InterestRecAcc = InterestAccrTimeDeposit,@TaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@InterestIncometAcc = IncomeInterestTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @CFundPK
END              

-- KPD TAX
select @FundTypeInternal = FundTypeInternal from Fund where status = 2 and FundPK = @CFundPK 
select @KPDTaxPercent = KPDTaxExpenseForBond from SettlementSetup where status = 2

IF(@FundTypeInternal = 2)
BEGIN
   set @CTaxExpensePercent = @KPDTaxPercent
END
    
IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)     -- and  @CLastCouponDate < @ValueDate        
BEGIN       
if @CAcqDate < @Valuedate
BEGIN


        IF (@CMarketValue = 0)
        BEGIN
            set @CInterestAmount  = 0
            set @CTaxExpenseAmount = 0 
            set @CFinalAmount = 0 
        END
        ELSE
        BEGIN

            IF (@CInstrumentTypePK in (2,13)) -- BOND DAN SUKUK
            BEGIN

            select @CPaymentDays = 12 / [priority] FROM instrument A
            LEFT JOIN mastervalue B ON A.interestpaymenttype = B.code AND B.id = 'InterestPaymentType' AND B.status = 2 
            where A.InstrumentPK = @CInstrumentPK and A.status = 2


            truncate table #TempInterest

            DECLARE ZZ CURSOR FOR

            SELECT  TOP (DATEDIFF(DAY, dbo.FworkingDay(@ValueDate,-1), @ValueDate)) Dates = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id), dbo.FworkingDay(@ValueDate,-1))
            FROM sys.all_objects a CROSS JOIN sys.all_objects b

            Open ZZ
            Fetch Next From ZZ
            Into @ZValueDate

            While @@FETCH_STATUS = 0
            BEGIN


            set @CDivDays = datediff(day,@CLastCouponDate,dbo.FGetNextCouponDate(@valuedate,@CInstrumentPK)) 

            set @CHoldDays = datediff(day,@CLastCouponDate,@ZValueDate)  
            set @CPrevHoldDays = datediff(day,@CLastCouponDate,@ZValueDate - 1) 

			set @CLastAcqDays = datediff(day,@CLastCouponDate,@CAcqDate) 
            set @CLastPrevAcqDays = datediff(day,@CAcqDate,@ZValueDate - 1)

            set @CAcqDays = datediff(day,@CAcqDate,@ZValueDate) 
            set @CPrevAcqDays = datediff(day,@CAcqDate,@ZValueDate - 1)




IF (@CAcqDate <= @CLastCouponDate)
BEGIN

set @CGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
set @CPrevGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)

--Untuk Tax

set @CTaxGrossInterestAmount =  (@CTaxExpensePercent/100) * @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
set @CPrevTaxGrossInterestAmount = (@CTaxExpensePercent/100) * @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)

END
ELSE
BEGIN



--Last Coupon ke AcqDate
set @CGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CHoldDays * 1000000,0)
set @CPrevGrossInterestAmountRound =  @CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevHoldDays * 1000000,0)


--Untuk Tax
set @CTaxGrossInterestAmount =  (@CTaxExpensePercent/100) *@CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CAcqDays * 1000000,0)
set @CPrevTaxGrossInterestAmount =  (@CTaxExpensePercent/100) *@CBalance /1000000 * round(@CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevAcqDays * 1000000,0)


--set @CTaxGrossInterestAmount =  round((@CTaxExpensePercent/100) * @CBalance * @CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CAcqDays/500,0)*500
--set @CPrevTaxGrossInterestAmount = round((@CTaxExpensePercent/100) * @CBalance * @CInterestPercent / 100 / @CDivDays /@CPaymentDays * @CPrevAcqDays/500,0)*500

				
END

set @CInterestAmount = (@CGrossInterestAmountRound) - (@CPrevGrossInterestAmountRound)

set @CTaxExpenseAmount =  @CTaxGrossInterestAmount - @CPrevTaxGrossInterestAmount


set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)

insert into #TempInterest(InterestAmount,TaxAmount,FinalAmount)
select @CInterestAmount,@CTaxExpenseAmount,@CFinalAmount
         

                Fetch next From ZZ Into @ZValueDate
                END
                Close ZZ
                Deallocate ZZ

                    select @CInterestAmount = sum(InterestAmount) from #TempInterest
                    select @CTaxExpenseAmount = sum(TaxAmount) from #TempInterest
                    select @CFinalAmount = sum(FinalAmount) from #TempInterest
            END
            ELSE
            BEGIN
                Select @CInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance)            
	            set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
	            set @CFinalAmount = (@CInterestAmount - @CTaxExpenseAmount)  
            END
        END



      
		IF @CInstrumentTypePK in (2,3,8,9,11,13,14,15)                    
		BEGIN                 	         
		-- Setup Account kelar diatas, Next masukin ke Fund Journal   
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

		IF @CInterestAmount > 0                  
		BEGIN           
		select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal 

        IF((day(@valuedate) <> 31 AND @CInstrumentTypePK not in (2,13)) OR (@CInstrumentTypePK in (2,13)))
        BEGIN
                INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
                ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

                Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,9,@maxEndDayTrailsPK,'INTEREST BOND',                  
                '','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

                Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
                @CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

                Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
                0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

                INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
                ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

                Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
                @CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2   
        
           

        END

	                              
		END
		END            
END
END        

IF @CInstrumentTypePK = 5  
BEGIN   
--IF NOT EXISTS(
--Select * from investment
--where ValueDate = @ValueDate and StatusSettlement = 2 and TrxType = 2 and InstrumentPK = @CInstrumentPK
--)
BEGIN
	
    IF (@CRoll = 0 AND @CSell = 0)
    BEGIN
        IF  @CMaturityDate > @DateYesterday and @CMaturityDate <= @ValueDate
        BEGIN
            Declare @RealMaturedDate datetime
            if @CPaymentModeOnMaturity = 1
            begin
            set @RealMaturedDate = @CMaturityDate
            end
            if @CPaymentModeOnMaturity = 2
            begin
            set @RealMaturedDate = @ValueDate
            end
            Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@RealMaturedDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)           

            if @CPaymentModeOnMaturity = 3
            begin
            set @CInterestAmount = 0
            end

        END
        ELSE
        BEGIN
	
            if (@ValueDate = @CAcqDate)
            BEGIN
                Select @CInterestAmount = 0
            END
            ELSE
            BEGIN
                Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@ValueDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate)        
            END
	
		 
        END
    END
    ELSE IF (@CRoll = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,@CAcqDate,@ValueDate)

    END
    ELSE IF (@CSell = 1 and @CMaturityDate > @ValueDate)
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) *  DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),dateadd(day,-1,@valuedate))

    END
    ELSE
    BEGIN
        Select @CInterestAmount = dbo.[FGetDepositoInterestAccruedPerFundPK] (@CAcqDate,@CFundPK,@CInstrumentPK,@CBalance,@CInterestDaysType,@CInterestPercent,@CAcqDate) * DateDiff(Day,dbo.Fworkingday(@ValueDate,-1),@CMaturityDate)
    END


--       select @ValueDate,@CAcqDate,@CInterestAmount,@CInstrumentPK,@CInterestPercent,@CFundPK
-- where @CInstrumentPK in 
-- (
	--select A.instrumentPK from fundposition A
	--left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.status = 2

	--where fundpk = 2 and trailsPK = 2 and B.InstrumentTypePK = 5		   
-- )
-- CEK LOGIK PAYMENT INTEREST TYPE DISINI

-- Setup Account kelar diatas, Next masukin ke Fund Journal   
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

IF @CInterestAmount > 0                  
BEGIN                  
set @CTaxExpenseAmount = (@CTaxExpensePercent / 100) * @CInterestAmount                  
set @CFinalAmount = @CInterestAmount - @CTaxExpenseAmount       

INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,7,@maxEndDayTrailsPK,'INTEREST DEPOSIT',                  
'','INSTRUMENT: ' + @CInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@InterestRecAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CFinalAmount,                   
@CFinalAmount,0,1,@CFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@InterestIncometAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'C',@CInterestAmount,                   
0,@CInterestAmount,1,0,@CInterestAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @InterestIncometAcc and Status = 2                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,3,1,2,@TaxExpenseAcc,CurrencyPK,@CFundPK,@CInstrumentPK,0,'INSTRUMENT: ' + @CInstrumentID,'D',@CTaxExpenseAmount,                   
@CTaxExpenseAmount,0,1,@CTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TaxExpenseAcc and Status = 2                   
END        
END

	          
END

                                              
	
 

 
Fetch next From C                   
Into @CInstrumentPK,@CFundPK,@CTrxAmount,@CMarketValue,@CInstrumentTypePK,@CCurrencyPK,@CInstrumentID,@CLastCouponDate,@CBalance,@CTaxExpensePercent,@CAcqDate,@CMaturityDate,@CSell    
,@CInterestDaysType,@CInterestPaymentType,@CInterestPercent,@CPaymentModeOnMaturity,@CRoll
END        
Close C                  
Deallocate C

                          
-- C4. MATURE BOND & TIME DEPOSIT & DEPOSITO BELUM SAMPE UJUNG   
Declare @DInstrumentPK    int  
Declare @DRealisedAccBond    int      
Declare @DRevaluationAccBond    int         
Declare @DInstrumentID    nvarchar(100)                  
Declare @DFundPK     int                  
Declare @DTrxAmount     numeric(22,6)                  
Declare @DMarketValue    numeric(22,6)                  
Declare @DInstrumentTypePK   int                  
Declare @DCurrencyPK    int                                   
Declare @DFinalAmount    numeric(22,6)                  
Declare @DNextCouponDate   datetime                  
Declare @DInterestAmount   numeric(18,6)                  
Declare @DBalance     numeric(18,0)                  
Declare @DTaxExpenseAmount   numeric(18,6)                  
Declare @DTaxExpensePercent   numeric(18,8)                  
Declare @DAcqDate   datetime                                  
Declare @DMaturityDate  datetime  
Declare @PrevInterestAmount numeric(22,6)
Declare @PrevFinalAmount numeric(22,6)
Declare @PrevTaxExpenseAmount numeric(22,6)
declare @divdays int
declare @intdays int

Declare @DInterestRecAcc int
Declare @DTaxExpenseAcc int
Declare @DInterestIncometAcc int
Declare @DCashAtBankAcc   int  
Declare @DInvestmentBond int
Declare @DInvestmentTimeDeposit int
Declare @DInterestPaymentType int


Declare @DPaymentModeOnMaturity int
Declare @DInterestDaysType int
Declare @DInterestPercent numeric(18,4)


--DISINI

insert into #Mature(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType)

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetNextCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and A.MaturityDate >= @DateYesterday and A.MaturityDate <= @valuedate and B.InstrumentTypePK in (5,10) and FundPK = @XFundPK  and A.InterestPaymentType <> 7
and A.[Identity] not in(
Select isnull(TrxBuy,0) from Investment where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and FundPK = @XFundPK
)


-- INI UNTUK KASUS TERIMA KUPON BULANAN, PAKAI INTERESTPAYMENTTYPE = 7 (MONTHLY)
union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,cast(cast(DATEPART(MONTH, @valuedate) as nvarchar(2)) + '/' + cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime),A.Balance                   
,B.TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,A.MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime) AcqDate,A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType            
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              

Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and A.MaturityDate >= @DateYesterday and A.InterestPaymentType = 7 
--and DATEPART(DAY,A.MaturityDate) >= DATEPART(DAY,@DateYesterday) and DATEPART(DAY,A.MaturityDate) <= DATEPART(DAY,@valuedate) 
and B.InstrumentTypePK in (5,10)
and A.InstrumentPK not in(
Select InstrumentPK from Investment C where Valuedate between @DateYesterday and  @ValueDate and StatusSettlement = 2 and TrxType in (2) and A.FundPK = C.FundPK and A.InstrumentPK = C.InstrumentPK
)

union all

Select A.InstrumentPK,A.FundPK,A.CostValue,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType                       
From FundPosition A                 
Left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2                  
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio where status = 2 and ValueDate = @DateYesterday and FundPK = @XFundPK
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15) and FundPK = @XFundPK
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
--and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and AcqDate < @valuedate       


DECLARE D CURSOR FOR 
-- ni buat bulanan
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where NextCouponDate > @DateYesterday and NextCouponDate <= @valuedate and NextCouponDate <> MaturityDate and InstrumentTypePK in (5,10) and InterestPaymentType = 7	 and FundPK = @XFundPK
union all
-- ni buat bulanan tapi udah mature
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,MaturityDate,Balance                   
,TaxExpensePercent, cast(cast(DATEPART(mm, DATEADD(mm,-1, @valuedate)) as nvarchar(2)) + '/' + case when cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) = 31 then cast(DATEPART(DAY,EOMONTH (@Valuedate, -1)) as nvarchar(2)) else cast(DATEPART(DAY,MaturityDate) as nvarchar(2)) end + '/' + cast(DATEPART(YEAR,@valuedate) as nvarchar(4)) as datetime), MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate > @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType = 7  and FundPK = @XFundPK
union all

select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate  and InstrumentTypePK in (5,10) and InterestPaymentType <> 7	 and FundPK = @XFundPK
union all
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType
from #Mature where MaturityDate >= @DateYesterday and MaturityDate <= @valuedate and InstrumentTypePK in (2,3,8,9,11,13,14,15)  and FundPK = @XFundPK


Open D
Fetch Next From D
Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate   
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent ,@DInterestPaymentType         
While @@FETCH_STATUS = 0
BEGIN       
  

IF @DInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @DInterestRecAcc = InterestAccrBond
,@DTaxExpenseAcc = TaxExpenseInterestIncomeBond,@DInterestIncometAcc = IncomeInterestBond,@DInvestmentBond = InvestmentBond,
@DRealisedAccBond = RealisedBond,@DRevaluationAccBond = RevaluationBond
From FundAccountingSetup where Status = 2  and FundPK = @DFundPK  

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

               

Begin           
Select @intdays =  DateDiff(day,@DateYesterday,@valuedate) 
IF(@DInterestPaymentType in (10,11,12)) 
BEGIN
	select @divdays = 90
END
ELSE
IF(@DInterestPaymentType in (16,17,18)) 
BEGIN
	select @divdays = 180
END
ELSE
IF(@DInterestPaymentType in (7,8,9)) 
BEGIN
	select @divdays = 30
END
ELSE
BEGIN
	select @divdays = datediff(day,@DAcqDate,@DMaturityDate)   
END       
Select @DInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@DFundPK,@DInstrumentPK,@DBalance) / @intdays *  @divdays                                                 
End               

set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@DFundPK,@DInstrumentPK,@DBalance) * (datediff(day,@DAcqDate,@DMaturityDate) - 1)                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

  

IF @DInterestAmount > 0                  
BEGIN    
	
IF (@DMaturityDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'MATURE TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@DRealisedAccBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DTrxAmount - @DBalance,                   
    @DTrxAmount - @DBalance,0,1,@DTrxAmount - @DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DRealisedAccBond and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@DInvestmentBond,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DTrxAmount - @DBalance,                   
    0,@DTrxAmount - @DBalance,1,0,@DTrxAmount - @DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentBond and Status = 2  

END

ELSE
BEGIN
-- Setup Account kelar diatas, Next masukin ke Fund Journal 
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal           
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                  
END
END               
END                  

ELSE IF @DInstrumentTypePK in (5,10)                
BEGIN   


Select @DInterestRecAcc = InterestAccrTimeDeposit,@DTaxExpenseAcc = TaxExpenseInterestIncomeTimeDeposit 
,@DInterestIncometAcc = IncomeInterestTimeDeposit, @DInvestmentTimeDeposit = InvestmentTimeDeposit
From FundAccountingSetup 
where Status = 2  and FundPK = @DFundPK

Select @DCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @DFundPK

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal                   

Begin         
	
IF (@DInterestPaymentType = 7)
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccrued]  (@ValueDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate) / @intdays *  DATEDIFF(day,dateadd(month,-1,@DAcqDate),@DNextCouponDate)               
END
ELSE
BEGIN
    Select @DInterestAmount = dbo.[FGetDepositoInterestAccruedForPayment]  (@DMaturityDate,@DInstrumentPK,@DBalance,@DInterestDaysType,@DInterestPercent,@DAcqDate,@DInterestPaymentType,@DMaturityDate,@DPaymentModeOnMaturity)  End              
END


set @DTaxExpenseAmount = (@DTaxExpensePercent / 100) * @DInterestAmount                  
set @DFinalAmount = @DInterestAmount - @DTaxExpenseAmount

IF @DInterestAmount > 0                  
BEGIN    

--BALIKIN NILAI INTEREST KE BANK
             
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'AR INTEREST TO BANK',                  
'','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DFinalAmount,                   
@DFinalAmount,0,1,@DFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestRecAcc and Status = 2                   

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@DInterestRecAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'AR INTEREST TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DFinalAmount,                   
0,@DFinalAmount,1,0,@DFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInterestIncometAcc and Status = 2                  
END


IF @DInterestPaymentType not in (7) 
BEGIN


    if @DPaymentModeOnMaturity = 2 -- ACQ TO MATURITY DATE NWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end
    else if @DPaymentModeOnMaturity = 3 -- ACQ TO MATURITY DATE BWD
    begin
    set @DMaturityDate = dbo.fworkingDay(@DMaturityDate,1)
    end else
    BEGIN
    set @DMaturityDate = @DMaturityDate
    END

    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal          
       
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'INV DEPOSIT TO BANK',                  
    '','INSTRUMENT: ' + @DInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@DCashAtBankAcc,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'D',@DBalance,                   
    @DBalance,0,1,@DBalance,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@DInvestmentTimeDeposit,CurrencyPK,@DFundPK,@DInstrumentPK,0,'INV DEPOSIT TO BANK INSTRUMENT: ' + @DInstrumentID,'C',@DBalance,                   
    0,@DBalance,1,0,@DBalance,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DInvestmentTimeDeposit and Status = 2                 



    END       

        

END

		
Fetch next From D Into @DInstrumentPK,@DFundPK,@DTrxAmount,@DMarketValue,@DInstrumentTypePK,@DCurrencyPK,@DInstrumentID,@DNextCouponDate,@DBalance,@DTaxExpensePercent,@DAcqDate,@DMaturityDate      
,@DPaymentModeOnMaturity,@DInterestDaysType, @DInterestPercent     ,@DInterestPaymentType                  
END
Close D
Deallocate D    
-------------------------------------------------------------------
-- C5. REC COUPON BOND

Declare @GInstrumentPK    int       
Declare @GInstrumentID    nvarchar(100)                  
Declare @GFundPK     int                  
Declare @GTrxAmount     numeric(22,6)                  
Declare @GMarketValue    numeric(22,6)                  
Declare @GInstrumentTypePK   int                  
Declare @GCurrencyPK    int                                   
Declare @GFinalAmount    numeric(22,6)   
Declare @GLastCouponDate   datetime                  
Declare @GNextCouponDate   datetime                  
Declare @GInterestAmount   numeric(18,6)                  
Declare @GBalance     numeric(18,0)                  
Declare @GTaxExpenseAmount   numeric(18,6)                  
Declare @GTaxExpensePercent   numeric(18,8)                  
Declare @GAcqDate   datetime                                  
Declare @GMaturityDate  datetime  
Declare @GPrevInterestAmount numeric(22,6)
Declare @GPrevFinalAmount numeric(22,6)
Declare @GPrevTaxExpenseAmount numeric(22,6)
declare @Gdivdays int
declare @Gintdays int

Declare @GInterestRecAcc int
Declare @GTaxExpenseAcc int
Declare @GInterestIncometAcc int
Declare @GCashAtBankAcc   int  
Declare @GInterestAccrBond int
Declare @GInvestmentTimeDeposit int
Declare @GInterestPaymentType int


Declare @GPaymentModeOnMaturity int
Declare @GInterestDaysType int
Declare @GInterestPercent numeric(18,4)
Declare @GRecCouponDate   datetime   


--DISINI

insert into #RecCoupon(InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK,CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance,
TaxExpensePercent, AcqDate, MaturityDate,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType,RecCouponDate)


Select A.InstrumentPK,A.FundPK,A.TrxAmount,A.MarketValue,B.InstrumentTypePK, B.CurrencyPK,A.InstrumentID,
case when A.InterestPaymentType in (10,11,12) then dateadd(month,-3,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) else case when A.InterestPaymentType in (16,17,18) then dateadd(month,-6,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK))
else case when A.InterestPaymentType in (7,8,9) then dateadd(month,-1,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK)) end end end
,dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK),A.Balance                   
,B.TaxExpensePercent, A.AcqDate, A.MaturityDate, A.PaymentModeOnMaturity,A.InterestDaysType,A.InterestPercent,A.InterestPaymentType,case when C.SettlementDate is null then dbo.FgetLastCouponDate(A.Date,A.InstrumentPK) else C.SettlementDate end RecCouponDate                       
From FundPosition A                 
left join Instrument B on A.InstrumentPK = B.InstrumentPK and B.Status = 2  
left join 
(
select InstrumentPK,FundPK,SettlementDate,sum(DoneVolume) DoneVolume from 
Investment  where  StatusSettlement = 2 and TrxType = 1 
group by InstrumentPK,FundPK,SettlementDate
)C on A.InstrumentPK = C.InstrumentPK and A.FundPK = C.FundPK and A.AcqDate = C.SettlementDate            
where  A.status = 2 and TrailsPK = (              
Select EndDayTrailsFundPortfolioPK from EndDayTrailsFundPortfolio D where D.status = 2 and D.ValueDate = @DateYesterday and D.FundPK = @XFundPK
) 
and B.InstrumentTypePK in (2,3,8,9,11,13,14,15)
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) > @DateYesterday 
and dbo.FgetLastCouponDate(@ValueDate,A.InstrumentPK) <= @valuedate 
and A.AcqDate  < @valuedate and A.FundPK = @XFundPK


DECLARE G CURSOR FOR 
select InstrumentPK,FundPK,TrxAmount,MarketValue,InstrumentTypePK, CurrencyPK,InstrumentID,LastCouponDate,NextCouponDate,Balance                   
,TaxExpensePercent, AcqDate, MaturityDate 
,PaymentModeOnMaturity,InterestDaysType,InterestPercent,InterestPaymentType,RecCouponDate
from #RecCoupon where (NextCouponDate >= @DateYesterday and NextCouponDate <= @valuedate) and InstrumentTypePK in (2,3,8,9,11,13,14,15) and FundPK = @XFundPK
Open G
Fetch Next From G
Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate   
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent ,@GInterestPaymentType,@GRecCouponDate         
While @@FETCH_STATUS = 0
BEGIN      
  

IF @GInstrumentTypePK in (2,3,8,9,11,13,14,15)            
BEGIN                  
Select @GInterestRecAcc = InterestAccrBond
,@GTaxExpenseAcc = WHTTaxPayableAccrInterestBond,@GInterestIncometAcc = IncomeInterestBond,@GInterestAccrBond = InterestAccrBond
From FundAccountingSetup where Status = 2  and FundPK = @GFundPK  

Select @GCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundPK = @GFundPK


---- TERIMA KUPON 
IF(datediff(day,@GNextCouponDate,@GMaturityDate)) > 15
BEGIN
    Begin           
	Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate) 
	IF(@GInterestPaymentType in (10,11,12)) 
	BEGIN
		select @Gdivdays = 90
	END
	ELSE
	IF(@GInterestPaymentType in (16,17,18)) 
	BEGIN
		select @Gdivdays = 180
	END
	ELSE
	IF(@GInterestPaymentType in (7,8,9)) 
	BEGIN
		select @Gdivdays = 30
	END
	ELSE
	BEGIN
		select @Gdivdays = datediff(day,@GAcqDate,@GNextCouponDate)   
	END    

		Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance) / @Gintdays *  @Gdivdays

                                                  
	End               

	IF (@GRecCouponDate > @GLastCouponDate)
	BEGIN
        if @GInstrumentTypePK in (2,9,13,15)
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FGetDateDIffGovermentBond](@GRecCouponDate,@GNextCouponDate)) 
        END
        ELSE
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FgetDateDiffCorporateBond](@GRecCouponDate,@GNextCouponDate)) 
        END
	END
	ELSE
	BEGIN
		set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
	END

	set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount

	
IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@valuedate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@GTaxExpenseAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GTaxExpenseAmount,                   
    @GTaxExpenseAmount,0,1,@GTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GTaxExpenseAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@GInterestIncometAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GTaxExpenseAmount,                   
    0,@GTaxExpenseAmount,1,0,@GTaxExpenseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestIncometAcc and Status = 2  



END

END    



END  
ELSE
BEGIN
	Begin      
	Select @Gintdays =  DateDiff(day,@DateYesterday,@valuedate)      
	IF(@GInterestPaymentType in (10,11,12)) 
	BEGIN
		select @Gdivdays = 90 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)

	END
	ELSE
	IF(@GInterestPaymentType in (16,17,18)) 
	BEGIN
		select @Gdivdays = 180 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)
	END
	ELSE
	IF(@GInterestPaymentType in (7,8,9)) 
	BEGIN
		select @Gdivdays = 30 + dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)
	END
	ELSE
	BEGIN
		select @Gdivdays = dbo.FgetDateDiffCorporateBond(@GNextCouponDate,@GMaturityDate)  
	END    

		Select @GInterestAmount = dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)/ @Gintdays *  @Gdivdays

                                                  
	End               

	IF (@GRecCouponDate > @GLastCouponDate)
	BEGIN

        if @GInstrumentTypePK in (2,9,13,15)
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FGetDateDIffGovermentBond](@GRecCouponDate,@GMaturityDate)) 
        END
        ELSE
        BEGIN
        set @GTaxExpenseAmount = (((dbo.[FGetBondInterestAccrued_ForFundJournalPerFundPK] (@valuedate,@GFundPK,@GInstrumentPK,@GBalance)) / @Gintdays   * @GTaxExpensePercent/100)  * dbo.[FgetDateDiffCorporateBond](@GRecCouponDate,@GMaturityDate)) 
        END                
	END
	ELSE
	BEGIN
		set @GTaxExpenseAmount = (@GTaxExpensePercent / 100) * @GInterestAmount
	END

	set @GFinalAmount = @GInterestAmount - @GTaxExpenseAmount
END


  
IF @GInterestAmount > 0                  
BEGIN    
	
IF (@GNextCouponDate <= @valuedate)
BEGIN
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal    
    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@GMaturityDate,8,@maxEndDayTrailsPK,'REC COUPON',                  
    '','INSTRUMENT: ' + @GInstrumentID ,1,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@GCashAtBankAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GFinalAmount,                   
    @GFinalAmount,0,1,@GFinalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@GInterestAccrBond,CurrencyPK,@GFundPK,@GInstrumentPK,0,'AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GFinalAmount,                   
    0,@GFinalAmount,1,0,@GFinalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestAccrBond and Status = 2  

  
    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,3,1,2,@GTaxExpenseAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'D',@GTaxExpenseAmount,                   
    @GTaxExpenseAmount,0,1,@GTaxExpenseAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GTaxExpenseAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,4,1,2,@GInterestIncometAcc,CurrencyPK,@GFundPK,@GInstrumentPK,0,'TAX AR TO BANK INSTRUMENT: ' + @GInstrumentID,'C',@GTaxExpenseAmount,                   
    0,@GTaxExpenseAmount,1,0,@GTaxExpenseAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @GInterestIncometAcc and Status = 2  



END

END    


           
END                  

		
Fetch next From G Into @GInstrumentPK,@GFundPK,@GTrxAmount,@GMarketValue,@GInstrumentTypePK,@GCurrencyPK,@GInstrumentID,@GLastCouponDate,@GNextCouponDate,@GBalance,@GTaxExpensePercent,@GAcqDate,@GMaturityDate      
,@GPaymentModeOnMaturity,@GInterestDaysType, @GInterestPercent,@GInterestPaymentType,@GRecCouponDate                  
END
Close G
Deallocate G  









-----------------------------------------------------------------------------------------------------------

-- D. COPY FUND CLIENT POSITION --    
    

if not exists(
	select * from FundClientPosition where date = dbo.FWorkingDay(@ValueDate, 1) and FundPK = @XFundPK
)
BEGIN

    
Declare @CPFundPK int           
Declare A Cursor For              
Select FundPK From Fund Where status = 2 and FundPK = @XFundPK              
Open  A              
Fetch Next From  A              
into @CPFundPK              
While @@Fetch_Status = 0              
BEGIN              
Insert into FundClientPosition(Date,FundClientPk,FundPK,CashAmount,UnitAmount,LastUpdate)              
Select dbo.FWorkingDay(@ValueDate, 1),FundClientPK,FundPK,CashAmount,UnitAmount,@LastUpdate              
From FundClientPosition where Date = @ValueDate and FundPK = @CPFundPK           
Fetch next From A                   
Into @CPFundPK              
END                  
Close A                  
Deallocate A


END    




-- E. PENDING UNIT REGISTRY
-- 1. SUBSCRIPTION
Declare @SValueDate Datetime,@SFundPK int,@SCashRefPK int,@SFundClientPK int,@SFundClientName nvarchar(100),@STotalCashAmount numeric(22,4),@SCurrencyPK int ,@SType nvarchar(5)  
Declare @SPendingSubscription int,@SSubscription int,@SCashAtBankAcc int   
Declare @SPendingRedemption int,@SRedemption int
Declare @SCashAmount numeric(22,4), @SFeeAmount numeric(22,4)
Declare @SPayableSubsAcc int                 
DECLARE @BitPendingSubscription bit		
Declare @UnitRegistryPK int    				 
Declare @IssueDate datetime

Declare A Cursor For                  
Select ClientSubscriptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,TotalCashAmount,CurrencyPK,'SUBS' Type
,CashAmount, SubscriptionFeeAmount          
From ClientSubscription A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.status not in (3,4) and ValueDate = @ValueDate and A.FundPK = @XFundPK  
union all
Select ClientRedemptionPK,ValueDate,FundPK,CashRefPK,A.FundClientPK,B.Name,case when TotalCashAmount = 0 then TotalUnitAmount * dbo.FgetCloseNav(@DateYesterday,A.FundPK) else TotalCashAmount End TotalCashAmount,CurrencyPK,'RED' Type         
,CashAmount, RedemptionFeeAmount
From ClientRedemption A 
left join FundClient B on A.FundClientPK = B.FundClientPK and B.status in (1,2)        
Where A.Status <>  3  and ValueDate = @ValueDate and A.FundPK = @XFundPK
	            
Open A                  
Fetch Next From A                  
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK,@SType,
@SCashAmount,@SFeeAmount
While @@FETCH_STATUS = 0                  
Begin 
IF (@SType = 'SUBS')
BEGIN

select @IssueDate = IssueDate from Fund where status in (1,2) and FundPK = @SFundPK

SELECT @BitPendingSubscription = ISNULL(BitPendingSubscription,1) FROM dbo.FundFee WHERE fundPK = @SFundPK
AND date = 
(
SELECT MAX(Date) FROM dbo.FundFee WHERE Date <= @SValueDate AND FundPK = @SFundPK
AND status = 2
) and STATUS = 2

set @BitPendingSubscription = isnull(@BitPendingSubscription,0)

set @SCashAtBankAcc = NULL

Select @SCashAtBankAcc = isnull(FundJournalAccountPK,@DefaultCashAtBankPK) From FundCashRef where Status = 2 and FundCashRefPK = @SCashRefPK
if (@SCashAtBankAcc is null or @SCashAtBankAcc  = '')
BEGIN
set @SCashAtBankAcc = 3
END

IF (@ValueDate = @IssueDate)
BEGIN

    Select @SSubscription = Subscription From FundAccountingSetup where Status = 2  and FundPK = @SFundPK
                     
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SSubscription and Status = 2   


END
ELSE 
BEGIN

    IF(@BitPendingSubscription = 1)
    BEGIN
    Select @SPendingSubscription = PendingSubscription,@SSubscription = Subscription
    ,@SPayableSubsAcc = payablesubscriptionfee
    From FundAccountingSetup 
    where Status = 2  and FundPK = @SFundPK

                       
    -- T0
    select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  

    INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
    ,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

    Select  @FundJournalPK, 1,1,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@SValueDate,2,@maxEndDayTrailsPK,'Pending Subscription',                  
    @UnitRegistryPK,'Pending Subscription T0 Fund Client : ' + @SFundClientName ,0,@UsersID,@LastUpdate,@LastUpdate                  

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select  @FundJournalPK,1,1,2,@SCashAtBankAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'D',@SCashAmount,                   
    @SCashAmount,0,1,@SCashAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SCashAtBankAcc and Status = 2                   

    INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
    ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

    Select @FundJournalPK,2,1,2,@SPendingSubscription,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@STotalCashAmount,                   
    0,@STotalCashAmount,1,0,@STotalCashAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPendingSubscription and Status = 2   

        if @SFeeAmount > 0
        BEGIN

        INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
        ,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

        Select @FundJournalPK,3,1,2,@SPayableSubsAcc,@SCurrencyPK,@SFundPK,0,@SFundClientPK,'Subscription Fund Client : ' + @SFundClientName,'C',@SFeeAmount,                   
        0,@SFeeAmount,1,0,@SFeeAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @SPayableSubsAcc and Status = 2   
        END

    END


END                                  

  

         
END
         
Fetch next From A                   
Into @UnitRegistryPK,@SValueDate,@SFundPK,@SCashRefPK,@SFundClientPK,@SFundClientName,@STotalCashAmount,@SCurrencyPK ,@SType,@SCashAmount,@SFeeAmount
END                  
Close A                  
Deallocate A

  UPDATE A 
SET A.AvgNAV = dbo.FGetAVGForFundClientPosition(@ValueDate,A.FundClientPK,A.FundPK), A.AUM = ISNULL(C.UnitAmount,0) * ISNULL(B.Nav,0)
FROM FundClientPosition A
    LEFT JOIN CloseNAV B on A.FUndPK = B.FundPK and B.status = 2 and B.date = @ValueDate
    LEFT JOIN FundClientPosition C ON A.FundPK = C.FundPK AND A.FundClientPK = C.FundClientPK AND C.Date = @DateYesterday
WHERE A.Date = @ValueDate and A.FundPK = @XFundPK

UPDATE A 
SET A.AUM = ISNULL(B.AUM,0),A.AvgNAV = ISNULL(B.AvgNAV,0) 
FROM dbo.FundClientPositionSummary A
    LEFT JOIN dbo.FundClientPosition B ON A.FundPK = B.FundPK AND A.FundClientPK = B.FundClientPK AND B.Date  = @ValueDate
where  A.FundPK = @XFundPK


-------------------------------------------
-- JOURNAL CORPORATE ACTION


--DIVIDEN SAHAM
-- Tarik Balance Cum / Valuedate - 1 + movement dengan batas settleddate <= recordingDate and ValueDate >= CumDate 
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select  B.FundPK,B.InstrumentPK,B.Balance + ISNULL(C.BalanceFromInv,0) LastBalance,
A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 and FundPK = @XFundPK
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
and C.ValueDate >= A.ValueDate
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate and B.FundPK = @XFundPK



Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,RecordingDate,Hold,Earn)
Select B.FundPK,B.InstrumentPK,isnull(B.BalanceFromInv,0),A.PaymentDate,A.RecordingDate,A.Hold,A.Earn
from CorporateAction A
Left join (
select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
, SettlementDate, ValueDate 
from Investment where statusSettlement = 2
and InstrumentTypePK = 1 and FundPK = @XFundPK
Group by InstrumentPK,FundPK,SettlementDate,ValueDate
)B on  B.SettlementDate <= A.RecordingDate and  A.InstrumentPK = B.InstrumentPK
and B.ValueDate >= A.ValueDate
left join #ZDividenSaham C on B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK 
where A.Type = 1 and A.Status = 2 and A.ExDate = @ValueDate
and C.FundPK is null and C.InstrumentPK is null 

Declare @TIncomeDividend int
Declare @TARDividend int
Declare @TotalAmount numeric(22,4)
Declare @TWithHoldingTaxPPH23 int


Declare @TInstrumentPK int
declare @TFundPK int
declare @TLastVolume numeric(22,4)
declare @TPaymentDate datetime
declare @TRecordingDate datetime
declare @TEarn numeric(22,4)
declare @THold numeric(22,4)

Declare @TTaxPercentage numeric(8,4)

Declare A Cursor For   
Select * From #ZDividenSaham
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TIncomeDividend = IncomeDividend,@TARDividend = ARDividend,@TWithHoldingTaxPPH23 = prepaidTaxDividend 
,@TTaxPercentage = TaxPercentageDividend
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume/@THold * @TEarn
   
if @TotalAmount > 0
BEGIN
	
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH CUM DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TIncomeDividend,CurrencyPK,@TFundPK,0,0,'INCOME DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TIncomeDividend and Status = 2   

--------------- PAYMENT DATE

declare @pph23Amount numeric(22,4)
set @pph23Amount = @TotalAmount * @TTaxPercentage/100

select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@TPaymentDate,12,@maxEndDayTrailsPK,'DIVIDEND',                  
'','DIVIDEND CASH PAYMENT DATE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@DefaultCashAtBankPK,CurrencyPK,@TFundPK,0,0,'DIVIDEND','D',@TotalAmount - @pph23Amount,                   
@TotalAmount - @pph23Amount,0,1,@TotalAmount - @pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @DefaultCashAtBankPK and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,2,1,2,@TWithHoldingTaxPPH23,CurrencyPK,@TFundPK,0,0,'TAX DIVIDEND','D',@pph23Amount,                   
@pph23Amount,0,1,@pph23Amount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TWithHoldingTaxPPH23 and Status = 2     

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,3,1,2,@TARDividend,CurrencyPK,@TFundPK,0,0,'AR DIVIDEND','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TARDividend and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A



---BOND AMORTIZE
TRUNCATE TABLE #ZDividenSaham
Insert into #ZDividenSaham(FundPK,InstrumentPK,LastVolume,PaymentDate,Earn,Hold)
Select  B.FundPK,B.InstrumentPK,B.Balance  LastBalance,A.PaymentDate,A.Earn,A.Hold
--B.Balance + C.BalanceFromInv LastBalance
From CorporateAction A 
left join FundPosition B on A.InstrumentPK = B.InstrumentPK 
and B.Date = dbo.fworkingday(A.ValueDate,-1) and B.status = 2
--Left join (
--	select sum(Case when TrxType = 1 then DoneVolume else DoneVolume * -1 end) BalanceFromInv,FundPK, InstrumentPK
--	, SettlementDate, ValueDate 
--	from Investment where statusSettlement = 2
--	and InstrumentTypePK  in (2,3,9,15)
--	Group by InstrumentPK,FundPK,SettlementDate,ValueDate
--)C on   C.SettlementDate <= A.RecordingDate and B.FundPK = C.FundPK and B.InstrumentPK = C.InstrumentPK
--and C.ValueDate >= A.ValueDate
where A.Type = 6 and A.Status = 2 and A.PaymentDate = @ValueDate and B.FundPK = @XFundPK


Declare @TInvestmentInBond int
Declare @TBondAmortized int


Declare A Cursor For   
Select InstrumentPK,FundPK,LastVolume,PaymentDate,PaymentDate,Earn,Hold From #ZDividenSaham where FundPK = @XFundPK
Open A                  
Fetch Next From A                  
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
While @@FETCH_STATUS = 0                  
Begin 

Select @TInvestmentInBond = InvestmentBond,@TBondAmortized = BondAmortization
From FundAccountingSetup where Status = 2  and FundPK = @TFundPK
set @TotalAmount = 0
set @TotalAmount = @TLastVolume *  @TEarn / @THold * -1
   
if @TotalAmount < 0
BEGIN
SET @TotalAmount = ABS(@TotalAmount)
----------- TO
select @FundJournalPK = isnull(max(FundJournalPK),0) + 1 From FundJournal  
INSERT INTO [FundJournal]([FundJournalPK],[HistoryPK],[Status],[Notes],[PeriodPK],[ValueDate],[Type],[TrxNo],[TrxName],[Reference]                  
,[Description],[Posted],[EntryUsersID],[EntryTime],[LastUpdate])                  

Select  @FundJournalPK, 1,2,'Posting End Day Trails No: ' + CAST(@maxEndDayTrailsPK as nvarchar(15)),@PeriodPK,@ValueDate,12,@maxEndDayTrailsPK,'BOND AMORTIZE',                  
'','CORPORATE ACTION BOND AMORTIZE' ,1,@UsersID,@LastUpdate,@LastUpdate                  

INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select  @FundJournalPK,1,1,2,@TBondAmortized,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','D',@TotalAmount,                   
@TotalAmount,0,1,@TotalAmount,0,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TBondAmortized and Status = 2                   


INSERT INTO [FundJournalDetail]([FundJournalPK],[AutoNo],[HistoryPK],[Status],[FundJournalAccountPK],[CurrencyPK],[FundPK],[InstrumentPK]                  
,[FundClientPK],[DetailDescription],[DebitCredit],[Amount],[Debit],[Credit],[CurrencyRate],[BaseDebit],[BaseCredit],[LastUpdate])                  

Select @FundJournalPK,2,1,2,@TInvestmentInBond,CurrencyPK,@TFundPK,0,0,'CORPORATE ACTION BOND AMORTIZE','C',@TotalAmount,                   
0,@TotalAmount,1,0,@TotalAmount,@LastUpdate From FundJournalAccount Where FundJournalAccountPK = @TInvestmentInBond and Status = 2   

END
   
Fetch next From A                   
Into @TInstrumentPK,@TFundPK,@TLastVolume,@TPaymentDate,@TRecordingDate,@TEarn,@THold
END                  
Close A                  
Deallocate A
------------------------------------------------------------------------------

Update A set BitValidate = 1, LogMessages = B.ID + ' - ' + B.Name from EndDayTrails A  
left join Fund B on A.FundPK = B.FundPK and B.status in (1,2)
where A.FundPK = @XFundPK and A.Status = 2 and ValueDate = @ValueDate     


Fetch next From X   
Into @XFundPK,@XFundID                
End                  
Close X                  
Deallocate X  

Select @maxEndDayTrailsPK LastPK     
                             
                        ";
                        cmd.Parameters.AddWithValue("@ValueDate", _valueDate);
                        cmd.Parameters.AddWithValue("@UsersID", _usersID);
                        cmd.Parameters.AddWithValue("@LastUpdate", _datetimeNow);

                        using (SqlDataReader dr = cmd.ExecuteReader())
                        {
                            if (dr.HasRows)
                            {
                                dr.Read();
                                return Convert.ToInt32(dr["LastPK"]);

                            }
                            return 0;
                        }

                    }
                }
            }
            catch (Exception err)
            {
                throw err;
            }
        }


    }
}